import{a as yn,b as xn,c as W,d as gt,e as Il,f as ls,g as Pl,h as er,i as us,j as Ue,k as Ml,l as Ll,m as bn,n as Io,o as Cl,p as Ol,q as Po,r as hs}from"./chunk-OQ43XKI2.js";import{a as d,b as M,c as Al,e as Qn,g as B,h as gn,i as tr,k as _n}from"./chunk-ATDPNAVO.js";function Se(r,t){if(!r)throw new Error(t||"loader assertion failed.")}var Jt={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},Cp=Jt.self||Jt.window||Jt.global||{},Op=Jt.window||Jt.self||Jt.global||{},Rp=Jt.global||Jt.self||Jt.window||{},Np=Jt.document||{};var Be=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser);var Rl=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),Dp=Rl&&parseFloat(Rl[1])||0;var Mo="4.3.3",Fp=Mo[0]>="0"&&Mo[0]<="9"?`v${Mo}`:"";function Vp(){let r=new yn({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=r,globalThis.loaders.version=Fp,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=r,r}var Lo=Vp();function Co(r,t){return Nl(r||{},t)}function Nl(r,t,e=0){if(e>3)return t;let n=d({},r);for(let[s,i]of Object.entries(t))i&&typeof i=="object"&&!Array.isArray(i)?n[s]=Nl(n[s]||{},t[s],e+1):n[s]=t[s];return n}var Dl="latest";function Up(){return globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}var Oo=Up();function bt(r,t){if(!r)throw new Error(t||"loaders.gl assertion failed.")}var Qt={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},$b=Qt.self||Qt.window||Qt.global||{},Wb=Qt.window||Qt.self||Qt.global||{},Gb=Qt.global||Qt.self||Qt.window||{},Hb=Qt.document||{};var Nt=typeof process!="object"||String(process)!=="[object process]"||process.browser;var Vl=typeof window<"u"&&typeof window.orientation<"u",Fl=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),qb=Fl&&parseFloat(Fl[1])||0;var fs=class{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(t,e){this.name=t,this.workerThread=e,this.result=new Promise((n,s)=>{this._resolve=n,this._reject=s})}postMessage(t,e){this.workerThread.postMessage({source:"loaders.gl",type:t,payload:e})}done(t){bt(this.isRunning),this.isRunning=!1,this._resolve(t)}error(t){bt(this.isRunning),this.isRunning=!1,this._reject(t)}};var wn=class{terminate(){}};var Ro=new Map;function Ul(r){bt(r.source&&!r.url||!r.source&&r.url);let t=Ro.get(r.source||r.url);return t||(r.url&&(t=Bp(r.url),Ro.set(r.url,t)),r.source&&(t=Bl(r.source),Ro.set(r.source,t))),bt(t),t}function Bp(r){if(!r.startsWith("http"))return r;let t=zp(r);return Bl(t)}function Bl(r){let t=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(t)}function zp(r){return`try {
  importScripts('${r}');
} catch (error) {
  console.error(error);
  throw error;
}`}function No(r,t=!0,e){let n=e||new Set;if(r){if(zl(r))n.add(r);else if(zl(r.buffer))n.add(r.buffer);else if(!ArrayBuffer.isView(r)){if(t&&typeof r=="object")for(let s in r)No(r[s],t,n)}}return e===void 0?Array.from(n):[]}function zl(r){return r?r instanceof ArrayBuffer||typeof MessagePort<"u"&&r instanceof MessagePort||typeof ImageBitmap<"u"&&r instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&r instanceof OffscreenCanvas:!1}var Do=()=>{},ze=class{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return typeof Worker<"u"&&Nt||typeof wn<"u"&&!Nt}constructor(t){let{name:e,source:n,url:s}=t;bt(n||s),this.name=e,this.source=n,this.url=s,this.onMessage=Do,this.onError=i=>console.log(i),this.worker=Nt?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=Do,this.onError=Do,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(t,e){e=e||No(t),this.worker.postMessage(t,e)}_getErrorFromErrorEvent(t){let e="Failed to load ";return e+=`worker ${this.name} from ${this.url}. `,t.message&&(e+=`${t.message} in `),t.lineno&&(e+=`:${t.lineno}:${t.colno}`),new Error(e)}_createBrowserWorker(){this._loadableURL=Ul({source:this.source,url:this.url});let t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},t.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},t.onmessageerror=e=>console.error(e),t}_createNodeWorker(){let t;if(this.url){let n=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;t=new wn(n,{eval:!1})}else if(this.source)t=new wn(this.source,{eval:!0});else throw new Error("no worker");return t.on("message",e=>{this.onMessage(e)}),t.on("error",e=>{this.onError(e)}),t.on("exit",e=>{}),t}};var ps=class{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return ze.isSupported()}constructor(t){this.source=t.source,this.url=t.url,this.setProps(t)}destroy(){this.idleQueue.forEach(t=>t.destroy()),this.isDestroyed=!0}setProps(t){this.props=d(d({},this.props),t),t.name!==void 0&&(this.name=t.name),t.maxConcurrency!==void 0&&(this.maxConcurrency=t.maxConcurrency),t.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=t.maxMobileConcurrency),t.reuseWorkers!==void 0&&(this.reuseWorkers=t.reuseWorkers),t.onDebug!==void 0&&(this.onDebug=t.onDebug)}startJob(t,e=(s,i,o)=>s.done(o),n=(s,i)=>s.error(i)){return B(this,null,function*(){let s=new Promise(i=>(this.jobQueue.push({name:t,onMessage:e,onError:n,onStart:i}),this));return this._startQueuedJob(),yield s})}_startQueuedJob(){return B(this,null,function*(){if(!this.jobQueue.length)return;let t=this._getAvailableWorker();if(!t)return;let e=this.jobQueue.shift();if(e){this.onDebug({message:"Starting job",name:e.name,workerThread:t,backlog:this.jobQueue.length});let n=new fs(e.name,t);t.onMessage=s=>e.onMessage(n,s.type,s.payload),t.onError=s=>e.onError(n,s),e.onStart(n);try{yield n.result}catch(s){console.error(`Worker exception: ${s}`)}finally{this.returnWorkerToQueue(t)}}})}returnWorkerToQueue(t){!Nt||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(t.destroy(),this.count--):this.idleQueue.push(t),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let t=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new ze({name:t,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Vl?this.maxMobileConcurrency:this.maxConcurrency}};var jp={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},ds=(()=>{class r{props;workerPools=new Map;static _workerFarm;static isSupported(){return ze.isSupported()}static getWorkerFarm(e={}){return r._workerFarm=r._workerFarm||new r({}),r._workerFarm.setProps(e),r._workerFarm}constructor(e){this.props=d({},jp),this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props=d(d({},this.props),e);for(let n of this.workerPools.values())n.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:n,source:s,url:i}=e,o=this.workerPools.get(n);return o||(o=new ps({name:n,source:s,url:i}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(n,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}return r})();function Fo(r,t={}){let e=t[r.id]||{},n=Nt?`${r.id}-worker.js`:`${r.id}-worker-node.js`,s=e.workerUrl;if(!s&&r.id==="compression"&&(s=t.workerUrl),t._workerType==="test"&&(Nt?s=`modules/${r.module}/dist/${n}`:s=`modules/${r.module}/src/workers/${r.id}-worker-node.ts`),!s){let i=r.version;i==="latest"&&(i=Dl);let o=i?`@${i}`:"";s=`https://unpkg.com/@loaders.gl/${r.module}${o}/dist/${n}`}return bt(s),s}function Vo(r,t=Oo){bt(r,"no worker provided");let e=r.version;return!(!t||!e)}function Uo(r,t){return!ds.isSupported()||!Nt&&!t?._nodeWorkers?!1:r.worker&&t?.worker}function Bo(r,t,e,n,s){return B(this,null,function*(){let i=r.id,o=Fo(r,e),c=ds.getWorkerFarm(e).getWorkerPool({name:i,url:o});e=JSON.parse(JSON.stringify(e)),n=JSON.parse(JSON.stringify(n||{}));let l=yield c.startJob("process-on-worker",$p.bind(null,s));return l.postMessage("process",{input:t,options:e,context:n}),yield(yield l.result).result})}function $p(r,t,e,n){return B(this,null,function*(){switch(e){case"done":t.done(n);break;case"error":t.error(new Error(n.error));break;case"process":let{id:s,input:i,options:o}=n;try{let a=yield r(i,o);t.postMessage("done",{id:s,result:a})}catch(a){let c=a instanceof Error?a.message:"unknown error";t.postMessage("error",{id:s,error:c})}break;default:console.warn(`parse-with-worker unknown message ${e}`)}})}function zo(r,t,e){if(e=e||r.byteLength,r.byteLength<e||t.byteLength<e)return!1;let n=new Uint8Array(r),s=new Uint8Array(t);for(let i=0;i<n.length;++i)if(n[i]!==s[i])return!1;return!0}function jo(...r){return jl(r)}function jl(r){let t=r.map(i=>i instanceof ArrayBuffer?new Uint8Array(i):i),e=t.reduce((i,o)=>i+o.byteLength,0),n=new Uint8Array(e),s=0;for(let i of t)n.set(i,s),s+=i.byteLength;return n.buffer}function $o(r){return B(this,null,function*(){let t=[];try{for(var e=_n(r),n,s,i;n=!(s=yield e.next()).done;n=!1){let o=s.value;t.push(o)}}catch{i=[s]}finally{try{n&&(s=e.return)&&(yield s.call(e))}finally{if(i)throw i[0]}}return jo(...t)})}var Wp="",$l={};function Wo(r){for(let t in $l)if(r.startsWith(t)){let e=$l[t];r=r.replace(t,e)}return!r.startsWith("http://")&&!r.startsWith("https://")&&(r=`${Wp}${r}`),r}function Wl(r){return r&&typeof r=="object"&&r.isBuffer}function ms(r){if(Wl(r))return r;if(r instanceof ArrayBuffer)return r;if(ArrayBuffer.isView(r))return r.byteOffset===0&&r.byteLength===r.buffer.byteLength?r.buffer:r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);if(typeof r=="string"){let t=r;return new TextEncoder().encode(t).buffer}if(r&&typeof r=="object"&&r._toArrayBuffer)return r._toArrayBuffer();throw new Error("toArrayBuffer")}var je={};Qn(je,{dirname:()=>Hp,filename:()=>Gp,join:()=>qp,resolve:()=>Yp});function Gl(){if(typeof process<"u"&&typeof process.cwd<"u")return process.cwd();let r=window.location?.pathname;return r?.slice(0,r.lastIndexOf("/")+1)||""}function Gp(r){let t=r?r.lastIndexOf("/"):-1;return t>=0?r.substr(t+1):""}function Hp(r){let t=r?r.lastIndexOf("/"):-1;return t>=0?r.substr(0,t):""}function qp(...r){return r=r.map((e,n)=>(n&&(e=e.replace(new RegExp("^/"),"")),n!==r.length-1&&(e=e.replace(new RegExp("/$"),"")),e)),r.join("/")}function Yp(...r){let t=[];for(let i=0;i<r.length;i++)t[i]=r[i];let e="",n=!1,s;for(let i=t.length-1;i>=-1&&!n;i--){let o;i>=0?o=t[i]:(s===void 0&&(s=Gl()),o=s),o.length!==0&&(e=`${o}/${e}`,n=o.charCodeAt(0)===nr)}return e=Xp(e,!n),n?`/${e}`:e.length>0?e:"."}var nr=47,Go=46;function Xp(r,t){let e="",n=-1,s=0,i,o=!1;for(let a=0;a<=r.length;++a){if(a<r.length)i=r.charCodeAt(a);else{if(i===nr)break;i=nr}if(i===nr){if(!(n===a-1||s===1))if(n!==a-1&&s===2){if(e.length<2||!o||e.charCodeAt(e.length-1)!==Go||e.charCodeAt(e.length-2)!==Go){if(e.length>2){let c=e.length-1,l=c;for(;l>=0&&e.charCodeAt(l)!==nr;--l);if(l!==c){e=l===-1?"":e.slice(0,l),n=a,s=0,o=!1;continue}}else if(e.length===2||e.length===1){e="",n=a,s=0,o=!1;continue}}t&&(e.length>0?e+="/..":e="..",o=!0)}else{let c=r.slice(n+1,a);e.length>0?e+=`/${c}`:e=c,o=!1}n=a,s=0}else i===Go&&s!==-1?++s:s=-1}return e}var Zp=r=>typeof r=="boolean",rr=r=>typeof r=="function",$e=r=>r!==null&&typeof r=="object",Ho=r=>$e(r)&&r.constructor==={}.constructor;var Hl=r=>!!r&&typeof r[Symbol.iterator]=="function",ql=r=>r&&typeof r[Symbol.asyncIterator]=="function";var Dt=r=>typeof Response<"u"&&r instanceof Response||r&&r.arrayBuffer&&r.text&&r.json;var Ft=r=>typeof Blob<"u"&&r instanceof Blob,Yl=r=>r&&typeof r=="object"&&r.isBuffer;var Kp=r=>typeof ReadableStream<"u"&&r instanceof ReadableStream||$e(r)&&rr(r.tee)&&rr(r.cancel)&&rr(r.getReader);var Jp=r=>$e(r)&&rr(r.read)&&rr(r.pipe)&&Zp(r.readable),gs=r=>Kp(r)||Jp(r);var _s=class extends Error{constructor(t,e){super(t),this.reason=e.reason,this.url=e.url,this.response=e.response}reason;url;response};var Qp=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,td=/^([-\w.]+\/[-\w.+]+)/;function qo(r,t){return r.toLowerCase()===t.toLowerCase()}function Xl(r){let t=td.exec(r);return t?t[1]:r}function Yo(r){let t=Qp.exec(r);return t?t[1]:""}var Zl=/\?.*/;function Kl(r){let t=r.match(Zl);return t&&t[0]}function vn(r){return r.replace(Zl,"")}function Jl(r){if(r.length<50)return r;let t=r.slice(r.length-15);return`${r.substr(0,32)}...${t}`}function We(r){return Dt(r)?r.url:Ft(r)?r.name||"":typeof r=="string"?r:""}function sr(r){if(Dt(r)){let t=r,e=t.headers.get("content-type")||"",n=vn(t.url);return Xl(e)||Yo(n)}return Ft(r)?r.type||"":typeof r=="string"?Yo(r):""}function Ql(r){return Dt(r)?r.headers["content-length"]||-1:Ft(r)?r.size:typeof r=="string"?r.length:r instanceof ArrayBuffer||ArrayBuffer.isView(r)?r.byteLength:-1}function ys(r){return B(this,null,function*(){if(Dt(r))return r;let t={},e=Ql(r);e>=0&&(t["content-length"]=String(e));let n=We(r),s=sr(r);s&&(t["content-type"]=s);let i=yield nd(r);i&&(t["x-first-bytes"]=i),typeof r=="string"&&(r=new TextEncoder().encode(r));let o=new Response(r,{headers:t});return Object.defineProperty(o,"url",{value:n}),o})}function tu(r){return B(this,null,function*(){if(!r.ok)throw yield ed(r)})}function ed(r){return B(this,null,function*(){let t=Jl(r.url),e=`Failed to fetch resource (${r.status}) ${r.statusText}: ${t}`;e=e.length>100?`${e.slice(0,100)}...`:e;let n={reason:r.statusText,url:r.url,response:r};try{let s=r.headers.get("Content-Type");n.reason=!r.bodyUsed&&s?.includes("application/json")?yield r.json():yield r.text()}catch{}return new _s(e,n)})}function nd(r){return B(this,null,function*(){if(typeof r=="string")return`data:,${r.slice(0,5)}`;if(r instanceof Blob){let e=r.slice(0,5);return yield new Promise(n=>{let s=new FileReader;s.onload=i=>n(i?.target?.result),s.readAsDataURL(e)})}if(r instanceof ArrayBuffer){let e=r.slice(0,5);return`data:base64,${rd(e)}`}return null})}function rd(r){let t="",e=new Uint8Array(r);for(let n=0;n<e.byteLength;n++)t+=String.fromCharCode(e[n]);return btoa(t)}function sd(r){return!id(r)&&!od(r)}function id(r){return r.startsWith("http:")||r.startsWith("https:")}function od(r){return r.startsWith("data:")}function Xo(r,t){return B(this,null,function*(){if(typeof r=="string"){let e=Wo(r);return sd(e)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(e,t):yield fetch(e,t)}return yield ys(r)})}var Zo=new yn({id:"loaders.gl"}),xs=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},bs=class{console;constructor(){this.console=console}log(...t){return this.console.log.bind(this.console,...t)}info(...t){return this.console.info.bind(this.console,...t)}warn(...t){return this.console.warn.bind(this.console,...t)}error(...t){return this.console.error.bind(this.console,...t)}};var Ko={fetch:null,mimeType:void 0,nothrow:!1,log:new bs,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:Be,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},eu={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function Jo(){globalThis.loaders=globalThis.loaders||{};let{loaders:r}=globalThis;return r._state||(r._state={}),r._state}function Qo(){let r=Jo();return r.globalOptions=r.globalOptions||d({},Ko),r.globalOptions}function su(r,t,e,n){return e=e||[],e=Array.isArray(e)?e:[e],ad(r,e),ld(t,r,n)}function ad(r,t){nu(r,null,Ko,eu,t);for(let e of t){let n=r&&r[e.id]||{},s=e.options&&e.options[e.id]||{},i=e.deprecatedOptions&&e.deprecatedOptions[e.id]||{};nu(n,e.id,s,i,t)}}function nu(r,t,e,n,s){let i=t||"Top level",o=t?`${t}.`:"";for(let a in r){let c=!t&&$e(r[a]),l=a==="baseUri"&&!t,u=a==="workerUrl"&&t;if(!(a in e)&&!l&&!u){if(a in n)Zo.warn(`${i} loader option '${o}${a}' no longer supported, use '${n[a]}'`)();else if(!c){let h=cd(a,s);Zo.warn(`${i} loader option '${o}${a}' not recognized. ${h}`)()}}}}function cd(r,t){let e=r.toLowerCase(),n="";for(let s of t)for(let i in s.options){if(r===i)return`Did you mean '${s.id}.${i}'?`;let o=i.toLowerCase();(e.startsWith(o)||o.startsWith(e))&&(n=n||`Did you mean '${s.id}.${i}'?`)}return n}function ld(r,t,e){let n=r.options||{},s=d({},n);return ud(s,e),s.log===null&&(s.log=new xs),ru(s,Qo()),ru(s,t),s}function ru(r,t){for(let e in t)if(e in t){let n=t[e];Ho(n)&&Ho(r[e])?r[e]=d(d({},r[e]),t[e]):r[e]=t[e]}}function ud(r,t){t&&!("baseUri"in r)&&(r.baseUri=t)}function ir(r){return r?(Array.isArray(r)&&(r=r[0]),Array.isArray(r?.extensions)):!1}function or(r){Se(r,"null loader"),Se(ir(r),"invalid loader");let t;return Array.isArray(r)&&(t=r[1],r=r[0],r=M(d({},r),{options:d(d({},r.options),t)})),(r?.parseTextSync||r?.parseText)&&(r.text=!0),r.text||(r.binary=!0),r}var iu=()=>{let r=Jo();return r.loaderRegistry=r.loaderRegistry||[],r.loaderRegistry};function ta(r){let t=iu();r=Array.isArray(r)?r:[r];for(let e of r){let n=or(e);t.find(s=>n===s)||t.unshift(n)}}function ou(){return iu()}var hd=/\.([^.]+)$/;function lu(s){return B(this,arguments,function*(r,t=[],e,n){if(!uu(r))return null;let i=au(r,t,M(d({},e),{nothrow:!0}),n);if(i)return i;if(Ft(r)&&(r=yield r.slice(0,10).arrayBuffer(),i=au(r,t,e,n)),!i&&!e?.nothrow)throw new Error(hu(r));return i})}function au(r,t=[],e,n){if(!uu(r))return null;if(t&&!Array.isArray(t))return or(t);let s=[];t&&(s=s.concat(t)),e?.ignoreRegisteredLoaders||s.push(...ou()),pd(s);let i=fd(r,s,e,n);if(!i&&!e?.nothrow)throw new Error(hu(r));return i}function fd(r,t,e,n){let s=We(r),i=sr(r),o=vn(s)||n?.url,a=null,c="";return e?.mimeType&&(a=ea(t,e?.mimeType),c=`match forced by supplied MIME type ${e?.mimeType}`),a=a||dd(t,o),c=c||(a?`matched url ${o}`:""),a=a||ea(t,i),c=c||(a?`matched MIME type ${i}`:""),a=a||gd(t,r),c=c||(a?`matched initial data ${fu(r)}`:""),e?.fallbackMimeType&&(a=a||ea(t,e?.fallbackMimeType),c=c||(a?`matched fallback MIME type ${i}`:"")),c&&Lo.log(1,`selectLoader selected ${a?.name}: ${c}.`),a}function uu(r){return!(r instanceof Response&&r.status===204)}function hu(r){let t=We(r),e=sr(r),n="No valid loader found (";n+=t?`${je.filename(t)}, `:"no url provided, ",n+=`MIME type: ${e?`"${e}"`:"not provided"}, `;let s=r?fu(r):"";return n+=s?` first bytes: "${s}"`:"first bytes: not available",n+=")",n}function pd(r){for(let t of r)or(t)}function dd(r,t){let e=t&&hd.exec(t),n=e&&e[1];return n?md(r,n):null}function md(r,t){t=t.toLowerCase();for(let e of r)for(let n of e.extensions)if(n.toLowerCase()===t)return e;return null}function ea(r,t){for(let e of r)if(e.mimeTypes?.some(n=>qo(t,n))||qo(t,`application/x.${e.id}`))return e;return null}function gd(r,t){if(!t)return null;for(let e of r)if(typeof t=="string"){if(_d(t,e))return e}else if(ArrayBuffer.isView(t)){if(cu(t.buffer,t.byteOffset,e))return e}else if(t instanceof ArrayBuffer&&cu(t,0,e))return e;return null}function _d(r,t){return t.testText?t.testText(r):(Array.isArray(t.tests)?t.tests:[t.tests]).some(n=>r.startsWith(n))}function cu(r,t,e){return(Array.isArray(e.tests)?e.tests:[e.tests]).some(s=>yd(r,t,e,s))}function yd(r,t,e,n){if(n instanceof ArrayBuffer)return zo(n,r,n.byteLength);switch(typeof n){case"function":return n(r);case"string":let s=na(r,t,n.length);return n===s;default:return!1}}function fu(r,t=5){return typeof r=="string"?r.slice(0,t):ArrayBuffer.isView(r)?na(r.buffer,r.byteOffset,t):r instanceof ArrayBuffer?na(r,0,t):""}function na(r,t,e){if(r.byteLength<t+e)return"";let n=new DataView(r),s="";for(let i=0;i<e;i++)s+=String.fromCharCode(n.getUint8(t+i));return s}function*pu(r,t){let e=t?.chunkSize||262144,n=0,s=new TextEncoder;for(;n<r.length;){let i=Math.min(r.length-n,e),o=r.slice(n,n+i);n+=i,yield s.encode(o)}}function*du(r,t={}){let{chunkSize:e=262144}=t,n=0;for(;n<r.byteLength;){let s=Math.min(r.byteLength-n,e),i=new ArrayBuffer(s),o=new Uint8Array(r,n,s);new Uint8Array(i).set(o),n+=s,yield i}}function mu(r,t){return tr(this,null,function*(){let e=t?.chunkSize||1048576,n=0;for(;n<r.size;){let s=n+e,i=yield new gn(r.slice(n,s).arrayBuffer());n=s,yield i}})}function ra(r,t){return Be?xd(r,t):bd(r,t)}function xd(r,t){return tr(this,null,function*(){let e=r.getReader(),n;try{for(;;){let s=n||e.read();t?._streamReadAhead&&(n=e.read());let{done:i,value:o}=yield new gn(s);if(i)return;yield ms(o)}}catch{e.releaseLock()}})}function bd(r,t){return tr(this,null,function*(){try{for(var e=_n(r),n,s,i;n=!(s=yield new gn(e.next())).done;n=!1){let o=s.value;yield ms(o)}}catch{i=[s]}finally{try{n&&(s=e.return)&&(yield new gn(s.call(e)))}finally{if(i)throw i[0]}}})}function gu(r,t){if(typeof r=="string")return pu(r,t);if(r instanceof ArrayBuffer)return du(r,t);if(Ft(r))return mu(r,t);if(gs(r))return ra(r,t);if(Dt(r))return ra(r.body,t);throw new Error("makeIterator")}var _u="Cannot convert supplied data type";function wd(r,t,e){if(t.text&&typeof r=="string")return r;if(Yl(r)&&(r=r.buffer),r instanceof ArrayBuffer){let n=r;return t.text&&!t.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(r)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(r);let n=r.buffer,s=r.byteLength||r.length;return(r.byteOffset!==0||s!==n.byteLength)&&(n=n.slice(r.byteOffset,r.byteOffset+s)),n}throw new Error(_u)}function yu(r,t,e){return B(this,null,function*(){let n=r instanceof ArrayBuffer||ArrayBuffer.isView(r);if(typeof r=="string"||n)return wd(r,t,e);if(Ft(r)&&(r=yield ys(r)),Dt(r)){let s=r;return yield tu(s),t.binary?yield s.arrayBuffer():yield s.text()}if(gs(r)&&(r=gu(r,e)),Hl(r)||ql(r))return $o(r);throw new Error(_u)})}function ws(r,t){let e=Qo(),n=r||e;return typeof n.fetch=="function"?n.fetch:$e(n.fetch)?s=>Xo(s,n.fetch):t?.fetch?t?.fetch:Xo}function xu(r,t,e){if(e)return e;let n=d({fetch:ws(t,r)},r);if(n.url){let s=vn(n.url);n.baseUrl=s,n.queryString=Kl(n.url),n.filename=je.filename(s),n.baseUrl=je.dirname(s)}return Array.isArray(n.loaders)||(n.loaders=null),n}function bu(r,t){if(r&&!Array.isArray(r))return r;let e;if(r&&(e=Array.isArray(r)?r:[r]),t&&t.loaders){let n=Array.isArray(t.loaders)?t.loaders:[t.loaders];e=e?[...e,...n]:n}return e&&e.length?e:void 0}function ar(r,t,e,n){return B(this,null,function*(){t&&!Array.isArray(t)&&!ir(t)&&(n=void 0,e=t,t=void 0),r=yield r,e=e||{};let s=We(r),o=bu(t,n),a=yield lu(r,o,e);return a?(e=su(e,a,o,s),n=xu({url:s,_parse:ar,loaders:o},e,n||null),yield vd(a,r,e,n)):null})}function vd(r,t,e,n){return B(this,null,function*(){if(Vo(r),e=Co(r.options,e),Dt(t)){let i=t,{ok:o,redirected:a,status:c,statusText:l,type:u,url:h}=i,f=Object.fromEntries(i.headers.entries());n.response={headers:f,ok:o,redirected:a,status:c,statusText:l,type:u,url:h}}t=yield yu(t,r,e);let s=r;if(s.parseTextSync&&typeof t=="string")return s.parseTextSync(t,e,n);if(Uo(r,e))return yield Bo(r,t,e,n,ar);if(s.parseText&&typeof t=="string")return yield s.parseText(t,e,n);if(s.parse)return yield s.parse(t,e,n);throw bt(!s.parseSync),new Error(`${r.id} loader - no parser found and worker is disabled`)})}function Tn(r,t,e,n){return B(this,null,function*(){let s,i;!Array.isArray(t)&&!ir(t)?(s=[],i=t,n=void 0):(s=t,i=e);let o=ws(i),a=r;return typeof r=="string"&&(a=yield o(r)),Ft(r)&&(a=yield o(r)),Array.isArray(s)?yield ar(a,s,i):yield ar(a,s,i)})}var wu="4.3.3";var Td=globalThis.loaders?.parseImageNode,sa=typeof Image<"u",ia=typeof ImageBitmap<"u",kd=!!Td,oa=Be?!0:kd;function vu(r){switch(r){case"auto":return ia||sa||oa;case"imagebitmap":return ia;case"image":return sa;case"data":return oa;default:throw new Error(`@loaders.gl/images: image ${r} not supported in this environment`)}}function Tu(){if(ia)return"imagebitmap";if(sa)return"image";if(oa)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function Ed(r){let t=Sd(r);if(!t)throw new Error("Not an image");return t}function ku(r){switch(Ed(r)){case"data":return r;case"image":case"imagebitmap":let t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("getImageData");return t.width=r.width,t.height=r.height,e.drawImage(r,0,0),e.getImageData(0,0,r.width,r.height);default:throw new Error("getImageData")}}function Sd(r){return typeof ImageBitmap<"u"&&r instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&r instanceof Image?"image":r&&typeof r=="object"&&r.data&&r.width&&r.height?"data":null}var Ad=/^data:image\/svg\+xml/,Id=/\.svg((\?|#).*)?$/;function vs(r){return r&&(Ad.test(r)||Id.test(r))}function Eu(r,t){if(vs(t)){let n=new TextDecoder().decode(r);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(n=unescape(encodeURIComponent(n)))}catch(i){throw new Error(i.message)}return`data:image/svg+xml;base64,${btoa(n)}`}return aa(r,t)}function aa(r,t){if(vs(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(r)])}function Ts(r,t,e){return B(this,null,function*(){let n=Eu(r,e),s=self.URL||self.webkitURL,i=typeof n!="string"&&s.createObjectURL(n);try{return yield Pd(i||n,t)}finally{i&&s.revokeObjectURL(i)}})}function Pd(r,t){return B(this,null,function*(){let e=new Image;return e.src=r,t.image&&t.image.decode&&e.decode?(yield e.decode(),e):yield new Promise((n,s)=>{try{e.onload=()=>n(e),e.onerror=i=>{let o=i instanceof Error?i.message:"error";s(new Error(o))}}catch(i){s(i)}})})}var Md={},Su=!0;function Au(r,t,e){return B(this,null,function*(){let n;vs(e)?n=yield Ts(r,t,e):n=aa(r,e);let s=t&&t.imagebitmap;return yield Ld(n,s)})}function Ld(r,t=null){return B(this,null,function*(){if((Cd(t)||!Su)&&(t=null),t)try{return yield createImageBitmap(r,t)}catch(e){console.warn(e),Su=!1}return yield createImageBitmap(r)})}function Cd(r){for(let t in r||Md)return!1;return!0}function Iu(r){return!Dd(r,"ftyp",4)||(r[8]&96)===0?null:Od(r)}function Od(r){switch(Rd(r,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function Rd(r,t,e){return String.fromCharCode(...r.slice(t,e))}function Nd(r){return[...r].map(t=>t.charCodeAt(0))}function Dd(r,t,e=0){let n=Nd(t);for(let s=0;s<n.length;++s)if(n[s]!==r[s+e])return!1;return!0}var te=!1,cr=!0;function ks(r){let t=lr(r);return Vd(t)||zd(t)||Ud(t)||Bd(t)||Fd(t)}function Fd(r){let t=new Uint8Array(r instanceof DataView?r.buffer:r),e=Iu(t);return e?{mimeType:e.mimeType,width:0,height:0}:null}function Vd(r){let t=lr(r);return t.byteLength>=24&&t.getUint32(0,te)===2303741511?{mimeType:"image/png",width:t.getUint32(16,te),height:t.getUint32(20,te)}:null}function Ud(r){let t=lr(r);return t.byteLength>=10&&t.getUint32(0,te)===1195984440?{mimeType:"image/gif",width:t.getUint16(6,cr),height:t.getUint16(8,cr)}:null}function Bd(r){let t=lr(r);return t.byteLength>=14&&t.getUint16(0,te)===16973&&t.getUint32(2,cr)===t.byteLength?{mimeType:"image/bmp",width:t.getUint32(18,cr),height:t.getUint32(22,cr)}:null}function zd(r){let t=lr(r);if(!(t.byteLength>=3&&t.getUint16(0,te)===65496&&t.getUint8(2)===255))return null;let{tableMarkers:n,sofMarkers:s}=jd(),i=2;for(;i+9<t.byteLength;){let o=t.getUint16(i,te);if(s.has(o))return{mimeType:"image/jpeg",height:t.getUint16(i+5,te),width:t.getUint16(i+7,te)};if(!n.has(o))return null;i+=2,i+=t.getUint16(i,te)}return null}function jd(){let r=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)r.add(e);return{tableMarkers:r,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function lr(r){if(r instanceof DataView)return r;if(ArrayBuffer.isView(r))return new DataView(r.buffer);if(r instanceof ArrayBuffer)return new DataView(r);throw new Error("toDataView")}function Pu(r,t){return B(this,null,function*(){let{mimeType:e}=ks(r)||{},n=globalThis.loaders?.parseImageNode;return Se(n),yield n(r,e)})}function Mu(r,t,e){return B(this,null,function*(){t=t||{};let s=(t.image||{}).type||"auto",{url:i}=e||{},o=$d(s),a;switch(o){case"imagebitmap":a=yield Au(r,t,i);break;case"image":a=yield Ts(r,t,i);break;case"data":a=yield Pu(r,t);break;default:Se(!1)}return s==="data"&&(a=ku(a)),a})}function $d(r){switch(r){case"auto":case"data":return Tu();default:return vu(r),r}}var Wd=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],Gd=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],Hd={image:{type:"auto",decode:!0}},ca={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:wu,mimeTypes:Gd,extensions:Wd,parse:Mu,tests:[r=>!!ks(new DataView(r))],options:Hd};var qd=new yn({id:"deck"}),$=qd;var la={};function Lu(r){la=r}function st(r,t,e,n){$.level>0&&la[r]&&la[r].call(null,t,e,n)}function Yd(r){let t=r[0],e=r[r.length-1];return t==="{"&&e==="}"||t==="["&&e==="]"}var Cu={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:Yd,parseTextSync:JSON.parse};function Xd(){let r="9.2.6",t=globalThis.deck&&globalThis.deck.VERSION;if(t&&t!==r)throw new Error(`deck.gl - multiple versions detected: ${t} vs ${r}`);return t||($.log(1,`deck.gl ${r}`)(),globalThis.deck=M(d({},globalThis.deck),{VERSION:r,version:r,log:$,_registerLoggers:Lu}),ta([Cu,[ca,{imagebitmap:{premultiplyAlpha:"none"}}]])),r}var ua=Xd();function Es(r,t){if(!r)throw new Error(t||"shadertools: assertion failed.")}var ha={number:{type:"number",validate(r,t){return Number.isFinite(r)&&typeof t=="object"&&(t.max===void 0||r<=t.max)&&(t.min===void 0||r>=t.min)}},array:{type:"array",validate(r,t){return Array.isArray(r)||ArrayBuffer.isView(r)}}};function Ru(r){let t={};for(let[e,n]of Object.entries(r))t[e]=Zd(n);return t}function Zd(r){let t=Ou(r);if(t!=="object")return M(d({value:r},ha[t]),{type:t});if(typeof r=="object")return r?r.type!==void 0?M(d(d({},r),ha[r.type]),{type:r.type}):r.value===void 0?{type:"object",value:r}:(t=Ou(r.value),M(d(d({},r),ha[t]),{type:t})):{type:"object",value:null};throw new Error("props")}function Ou(r){return Array.isArray(r)||ArrayBuffer.isView(r)?"array":typeof r}var Nu=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,Du=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var Kd={vertex:Nu,fragment:Du},Fu=/void\s+main\s*\([^)]*\)\s*\{\n?/,Vu=/}\n?[^{}]*$/,fa=[],ur="__LUMA_INJECT_DECLARATIONS__";function Uu(r){let t={vertex:{},fragment:{}};for(let e in r){let n=r[e],s=Jd(e);typeof n=="string"&&(n={order:0,injection:n}),t[s][e]=n}return t}function Jd(r){let t=r.slice(0,2);switch(t){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(t)}}function hr(r,t,e,n=!1){let s=t==="vertex";for(let i in e){let o=e[i];o.sort((c,l)=>c.order-l.order),fa.length=o.length;for(let c=0,l=o.length;c<l;++c)fa[c]=o[c].injection;let a=`${fa.join(`
`)}
`;switch(i){case"vs:#decl":s&&(r=r.replace(ur,a));break;case"vs:#main-start":s&&(r=r.replace(Fu,c=>c+a));break;case"vs:#main-end":s&&(r=r.replace(Vu,c=>a+c));break;case"fs:#decl":s||(r=r.replace(ur,a));break;case"fs:#main-start":s||(r=r.replace(Fu,c=>c+a));break;case"fs:#main-end":s||(r=r.replace(Vu,c=>a+c));break;default:r=r.replace(i,c=>c+a)}}return r=r.replace(ur,""),n&&(r=r.replace(/\}\s*$/,i=>i+Kd[t])),r}function Ge(r){r.map(t=>Ss(t))}function Ss(r){if(r.instance)return;Ge(r.dependencies||[]);let{propTypes:t={},deprecations:e=[],inject:n={}}=r,s={normalizedInjections:Uu(n),parsedDeprecations:Qd(e)};t&&(s.propValidators=Ru(t)),r.instance=s;let i={};t&&(i=Object.entries(t).reduce((o,[a,c])=>{let l=c?.value;return l&&(o[a]=l),o},{})),r.defaultUniforms=d(d({},r.defaultUniforms),i)}function pa(r,t,e){r.deprecations?.forEach(n=>{n.regex?.test(t)&&(n.deprecated?e.deprecated(n.old,n.new)():e.removed(n.old,n.new)())})}function Qd(r){return r.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp(`\\b${t.old}\\(`);break;default:t.regex=new RegExp(`${t.type} ${t.old};`)}}),r}function kn(r){Ge(r);let t={},e={};Bu({modules:r,level:0,moduleMap:t,moduleDepth:e});let n=Object.keys(e).sort((s,i)=>e[i]-e[s]).map(s=>t[s]);return Ge(n),n}function Bu(r){let{modules:t,level:e,moduleMap:n,moduleDepth:s}=r;if(e>=5)throw new Error("Possible loop in shader dependency graph");for(let i of t)n[i.name]=i,(s[i.name]===void 0||s[i.name]<e)&&(s[i.name]=e);for(let i of t)i.dependencies&&Bu({modules:i.dependencies,level:e+1,moduleMap:n,moduleDepth:s})}function zu(r){switch(r?.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function $u(r,t){if(Number(r.match(/^#version[ \t]+(\d+)/m)?.[1]||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(t){case"vertex":return r=ju(r,tm),r;case"fragment":return r=ju(r,em),r;default:throw new Error(t)}}var Wu=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],tm=[...Wu,[da("attribute"),"in $1"],[da("varying"),"out $1"]],em=[...Wu,[da("varying"),"in $1"]];function ju(r,t){for(let[e,n]of t)r=r.replace(e,n);return r}function da(r){return new RegExp(`\\b${r}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function ma(r,t){let e="";for(let n in r){let s=r[n];if(e+=`void ${s.signature} {
`,s.header&&(e+=`  ${s.header}`),t[n]){let i=t[n];i.sort((o,a)=>o.order-a.order);for(let o of i)e+=`  ${o.injection}
`}s.footer&&(e+=`  ${s.footer}`),e+=`}
`}return e}function ga(r){let t={vertex:{},fragment:{}};for(let e of r){let n,s;typeof e!="string"?(n=e,s=n.hook):(n={},s=e),s=s.trim();let[i,o]=s.split(":"),a=s.replace(/\(.+/,""),c=Object.assign(n,{signature:o});switch(i){case"vs":t.vertex[a]=c;break;case"fs":t.fragment[a]=c;break;default:throw new Error(i)}}return t}function Gu(r,t){return{name:nm(r,t),language:"glsl",version:rm(r)}}function nm(r,t="unnamed"){let n=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(r);return n?n[1]:t}function rm(r){let t=100,e=r.match(/[^\s]+/g);if(e&&e.length>=2&&e[0]==="#version"){let n=parseInt(e[1],10);Number.isFinite(n)&&(t=n)}if(t!==100&&t!==300)throw new Error(`Invalid GLSL version ${t}`);return t}var qu=`

${ur}
`,sm=`precision highp float;
`;function Yu(r){let t=kn(r.modules||[]);return{source:im(r.platformInfo,M(d({},r),{source:r.source,stage:"vertex",modules:t})),getUniforms:Zu(t)}}function Xu(r){let{vs:t,fs:e}=r,n=kn(r.modules||[]);return{vs:Hu(r.platformInfo,M(d({},r),{source:t,stage:"vertex",modules:n})),fs:Hu(r.platformInfo,M(d({},r),{source:e,stage:"fragment",modules:n})),getUniforms:Zu(n)}}function im(r,t){let{source:e,stage:n,modules:s,hookFunctions:i=[],inject:o={},log:a}=t;Es(typeof e=="string","shader source must be a string");let c=e,l="",u=ga(i),h={},f={},p={};for(let x in o){let y=typeof o[x]=="string"?{injection:o[x],order:0}:o[x],T=/^(v|f)s:(#)?([\w-]+)$/.exec(x);if(T){let I=T[2],k=T[3];I?k==="decl"?f[x]=[y]:p[x]=[y]:h[x]=[y]}else p[x]=[y]}let _=s;for(let x of _){a&&pa(x,c,a);let y=Ku(x,"wgsl");l+=y;let T=x.injections?.[n]||{};for(let I in T){let k=/^(v|f)s:#([\w-]+)$/.exec(I);if(k){let P=k[2]==="decl"?f:p;P[I]=P[I]||[],P[I].push(T[I])}else h[I]=h[I]||[],h[I].push(T[I])}}return l+=qu,l=hr(l,n,f),l+=ma(u[n],h),l+=c,l=hr(l,n,p),l}function Hu(r,t){let{source:e,stage:n,language:s="glsl",modules:i,defines:o={},hookFunctions:a=[],inject:c={},prologue:l=!0,log:u}=t;Es(typeof e=="string","shader source must be a string");let h=s==="glsl"?Gu(e).version:-1,f=r.shaderLanguageVersion,p=h===100?"#version 100":"#version 300 es",x=e.split(`
`).slice(1).join(`
`),y={};i.forEach(L=>{Object.assign(y,L.defines)}),Object.assign(y,o);let T="";switch(s){case"wgsl":break;case"glsl":T=l?`${p}

// ----- PROLOGUE -------------------------
${`#define SHADER_TYPE_${n.toUpperCase()}`}

${zu(r)}
${n==="fragment"?sm:""}

// ----- APPLICATION DEFINES -------------------------

${om(y)}

`:`${p}
`;break}let I=ga(a),k={},S={},P={};for(let L in c){let F=typeof c[L]=="string"?{injection:c[L],order:0}:c[L],D=/^(v|f)s:(#)?([\w-]+)$/.exec(L);if(D){let R=D[2],O=D[3];R?O==="decl"?S[L]=[F]:P[L]=[F]:k[L]=[F]}else P[L]=[F]}for(let L of i){u&&pa(L,x,u);let F=Ku(L,n);T+=F;let D=L.instance?.normalizedInjections[n]||{};for(let R in D){let O=/^(v|f)s:#([\w-]+)$/.exec(R);if(O){let j=O[2]==="decl"?S:P;j[R]=j[R]||[],j[R].push(D[R])}else k[R]=k[R]||[],k[R].push(D[R])}}return T+="// ----- MAIN SHADER SOURCE -------------------------",T+=qu,T=hr(T,n,S),T+=ma(I[n],k),T+=x,T=hr(T,n,P),s==="glsl"&&h!==f&&(T=$u(T,n)),T.trim()}function Zu(r){return function(e){let n={};for(let s of r){let i=s.getUniforms?.(e,n);Object.assign(n,i)}return n}}function om(r={}){let t="";for(let e in r){let n=r[e];(n||Number.isFinite(n))&&(t+=`#define ${e.toUpperCase()} ${r[e]}
`)}return t}function Ku(r,t){let e;switch(t){case"vertex":e=r.vs||"";break;case"fragment":e=r.fs||"";break;case"wgsl":e=r.source||"";break;default:Es(!1)}if(!r.name)throw new Error("Shader module must have a name");let n=r.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),s=`// ----- MODULE ${r.name} ---------------

`;return t!=="wgsl"&&(s+=`#define MODULE_${n}
`),s+=`${e}
`,s}var am=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,cm=/^\s*\#\s*endif\s*$/;function Ju(r,t){let e=r.split(`
`),n=[],s=!0,i=null;for(let o of e){let a=o.match(am),c=o.match(cm);a?(i=a[1],s=!!t?.defines?.[i]):c?s=!0:s&&n.push(o)}return n.join(`
`)}var fr=(()=>{class r{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return r.defaultShaderAssembler=r.defaultShaderAssembler||new r,r.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(n=>n.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){let n=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(s=>s.name!==n)}addShaderHook(e,n){n&&(e=Object.assign(n,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){let n=this._getModuleList(e.modules),s=this._hookFunctions,{source:i,getUniforms:o}=Yu(M(d({},e),{source:e.source,modules:n,hookFunctions:s}));return{source:e.platformInfo.shaderLanguage==="wgsl"?Ju(i):i,getUniforms:o,modules:n}}assembleGLSLShaderPair(e){let n=this._getModuleList(e.modules),s=this._hookFunctions,i=Xu(M(d({},e),{vs:e.vs,fs:e.fs,modules:n,hookFunctions:s}));return M(d({},i),{modules:n})}_getModuleList(e=[]){let n=new Array(this._defaultModules.length+e.length),s={},i=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let c=this._defaultModules[o],l=c.name;n[i++]=c,s[l]=!0}for(let o=0,a=e.length;o<a;++o){let c=e[o],l=c.name;s[l]||(n[i++]=c,s[l]=!0)}return n.length=i,Ge(n),n}}return r})();var lm=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,um=`#version 300 es
${lm}`;function pr(r){let{input:t,inputChannels:e,output:n}=r||{};if(!t)return um;if(!e)throw new Error("inputChannels");let s=hm(e),i=Qu(t,e);return`#version 300 es
in ${s} ${t};
out vec4 ${n};
void main() {
  ${n} = ${i};
}`}function hm(r){switch(r){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${r}`)}}function Qu(r,t){switch(t){case 1:return`vec4(${r}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${r}, 0.0, 1.0)`;case 3:return`vec4(${r}, 1.0)`;case 4:return r;default:throw new Error(`invalid channels: ${t}`)}}var kt=class{constructor(t,e){this.name=t,this.attributes=e,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}},As=class{constructor(t,e,n){this.name=t,this.type=e,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},ee=class extends kt{constructor(t,e){super(t,e),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}},ne=class extends kt{constructor(t,e){super(t,e),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}},mr=class extends kt{constructor(t,e,n){super(t,n),this.format=e}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}},le=class extends kt{constructor(t,e,n,s){super(t,n),this.format=e,this.access=s}get isTemplate(){return!0}getTypeName(){let t=this.name;if(this.format!==null){if(t==="vec2"||t==="vec3"||t==="vec4"||t==="mat2x2"||t==="mat2x3"||t==="mat2x4"||t==="mat3x2"||t==="mat3x3"||t==="mat3x4"||t==="mat4x2"||t==="mat4x3"||t==="mat4x4"){if(this.format.name==="f32")return t+="f",t;if(this.format.name==="i32")return t+="i",t;if(this.format.name==="u32")return t+="u",t;if(this.format.name==="bool")return t+="b",t;if(this.format.name==="f16")return t+="h",t}t+=`<${this.format.name}>`}else if(t==="vec2"||t==="vec3"||t==="vec4")return t;return t}},Ae;(r=>{r[r.Uniform=0]="Uniform",r[r.Storage=1]="Storage",r[r.Texture=2]="Texture",r[r.Sampler=3]="Sampler",r[r.StorageTexture=4]="StorageTexture"})(Ae||(Ae={}));var En=class{constructor(t,e,n,s,i,o,a){this.name=t,this.type=e,this.group=n,this.binding=s,this.attributes=i,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}},xa=class{constructor(t,e){this.name=t,this.type=e}},ba=class{constructor(t,e,n,s){this.name=t,this.type=e,this.locationType=n,this.location=s,this.interpolation=null}},Is=class{constructor(t,e,n,s){this.name=t,this.type=e,this.locationType=n,this.location=s}},wa=class{constructor(t,e,n,s){this.name=t,this.type=e,this.attributes=n,this.id=s}},va=class{constructor(t,e,n){this.name=t,this.type=e,this.attributes=n}},Ta=class{constructor(t,e=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=t,this.stage=e,this.attributes=n}},ka=class{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}};function fm(r){var t=(32768&r)>>15,e=(31744&r)>>10,n=1023&r;return e==0?(t?-1:1)*Math.pow(2,-14)*(n/Math.pow(2,10)):e==31?n?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,e-15)*(1+n/Math.pow(2,10))}var nh=new Float32Array(1),pm=new Int32Array(nh.buffer),_t=new Uint16Array(1);function dm(r){nh[0]=r;let t=pm[0],e=t>>31&1,n=t>>23&255,s=8388607&t;if(n===255)return _t[0]=e<<15|31744|(s!==0?512:0),_t[0];if(n===0){if(s===0)return _t[0]=e<<15,_t[0];s|=8388608;let i=113;for(;!(8388608&s);)s<<=1,i--;return n=127-i,s&=8388607,n>0?(s=(s>>126-n)+(s>>127-n&1),_t[0]=e<<15|n<<10|s>>13,_t[0]):(_t[0]=e<<15,_t[0])}return n=n-127+15,n>=31?(_t[0]=e<<15|31744,_t[0]):n<=0?n<-10?(_t[0]=e<<15,_t[0]):(s=(8388608|s)>>1-n,_t[0]=e<<15|s>>13,_t[0]):(s>>=13,_t[0]=e<<15|n<<10|s,_t[0])}var Ua=new Uint32Array(1),rh=new Float32Array(Ua.buffer,0,1);function th(r){let t=112+(r>>6&31)<<23|(63&r)<<17;return Ua[0]=t,rh[0]}function mm(r,t,e,n,s,i,o,a,c){let l=n*(o>>=s)*(i>>=s)+e*o+t*a;switch(c){case"r8unorm":return[Z(r,l,"8unorm",1)[0]];case"r8snorm":return[Z(r,l,"8snorm",1)[0]];case"r8uint":return[Z(r,l,"8uint",1)[0]];case"r8sint":return[Z(r,l,"8sint",1)[0]];case"rg8unorm":{let u=Z(r,l,"8unorm",2);return[u[0],u[1]]}case"rg8snorm":{let u=Z(r,l,"8snorm",2);return[u[0],u[1]]}case"rg8uint":{let u=Z(r,l,"8uint",2);return[u[0],u[1]]}case"rg8sint":{let u=Z(r,l,"8sint",2);return[u[0],u[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{let u=Z(r,l,"8unorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8snorm":{let u=Z(r,l,"8snorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8uint":{let u=Z(r,l,"8uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba8sint":{let u=Z(r,l,"8sint",4);return[u[0],u[1],u[2],u[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{let u=Z(r,l,"8unorm",4);return[u[2],u[1],u[0],u[3]]}case"r16uint":return[Z(r,l,"16uint",1)[0]];case"r16sint":return[Z(r,l,"16sint",1)[0]];case"r16float":return[Z(r,l,"16float",1)[0]];case"rg16uint":{let u=Z(r,l,"16uint",2);return[u[0],u[1]]}case"rg16sint":{let u=Z(r,l,"16sint",2);return[u[0],u[1]]}case"rg16float":{let u=Z(r,l,"16float",2);return[u[0],u[1]]}case"rgba16uint":{let u=Z(r,l,"16uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16sint":{let u=Z(r,l,"16sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16float":{let u=Z(r,l,"16float",4);return[u[0],u[1],u[2],u[3]]}case"r32uint":return[Z(r,l,"32uint",1)[0]];case"r32sint":return[Z(r,l,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[Z(r,l,"32float",1)[0]];case"rg32uint":{let u=Z(r,l,"32uint",2);return[u[0],u[1]]}case"rg32sint":{let u=Z(r,l,"32sint",2);return[u[0],u[1]]}case"rg32float":{let u=Z(r,l,"32float",2);return[u[0],u[1]]}case"rgba32uint":{let u=Z(r,l,"32uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32sint":{let u=Z(r,l,"32sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32float":{let u=Z(r,l,"32float",4);return[u[0],u[1],u[2],u[3]]}case"rg11b10ufloat":{let u=new Uint32Array(r.buffer,l,1)[0],h=(4192256&u)>>11,f=(4290772992&u)>>22;return[th(2047&u),th(h),(function(p){let _=112+(p>>5&31)<<23|(31&p)<<18;return Ua[0]=_,rh[0]})(f),1]}}return null}function Z(r,t,e,n){let s=[0,0,0,0];for(let i=0;i<n;++i)switch(e){case"8unorm":s[i]=r[t]/255,t++;break;case"8snorm":s[i]=r[t]/255*2-1,t++;break;case"8uint":s[i]=r[t],t++;break;case"8sint":s[i]=r[t]-127,t++;break;case"16uint":s[i]=r[t]|r[t+1]<<8,t+=2;break;case"16sint":s[i]=(r[t]|r[t+1]<<8)-32768,t+=2;break;case"16float":s[i]=fm(r[t]|r[t+1]<<8),t+=2;break;case"32uint":case"32sint":s[i]=r[t]|r[t+1]<<8|r[t+2]<<16|r[t+3]<<24,t+=4;break;case"32float":s[i]=new Float32Array(r.buffer,t,1)[0],t+=4}return s}function K(r,t,e,n,s){for(let i=0;i<n;++i)switch(e){case"8unorm":r[t]=255*s[i],t++;break;case"8snorm":r[t]=.5*(s[i]+1)*255,t++;break;case"8uint":r[t]=s[i],t++;break;case"8sint":r[t]=s[i]+127,t++;break;case"16uint":new Uint16Array(r.buffer,t,1)[0]=s[i],t+=2;break;case"16sint":new Int16Array(r.buffer,t,1)[0]=s[i],t+=2;break;case"16float":{let o=dm(s[i]);new Uint16Array(r.buffer,t,1)[0]=o,t+=2;break}case"32uint":new Uint32Array(r.buffer,t,1)[0]=s[i],t+=4;break;case"32sint":new Int32Array(r.buffer,t,1)[0]=s[i],t+=4;break;case"32float":new Float32Array(r.buffer,t,1)[0]=s[i],t+=4}return s}var _a={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}},fe=(()=>{class r{constructor(){this.id=r._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,n){if(e){n(Cn.instance);for(let s of e)s instanceof Array?this.searchBlock(s,n):s.search(n);n(On.instance)}}constEvaluate(e,n){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}return r._id=0,r})(),Cn=class extends fe{};Cn.instance=new Cn;var On=class extends fe{};On.instance=new On;var sh=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]),tt=class extends fe{constructor(){super()}},Ze=class extends tt{constructor(t,e,n,s,i,o){super(),this.calls=new Set,this.name=t,this.args=e,this.returnType=n,this.body=s,this.startLine=i,this.endLine=o}get astNodeType(){return"function"}search(t){if(this.attributes)for(let e of this.attributes)t(e);t(this);for(let e of this.args)t(e);this.searchBlock(this.body,t)}},Ea=class extends tt{constructor(t){super(),this.expression=t}get astNodeType(){return"staticAssert"}search(t){this.expression.search(t)}},Ps=class extends tt{constructor(t,e){super(),this.condition=t,this.body=e}get astNodeType(){return"while"}search(t){this.condition.search(t),this.searchBlock(this.body,t)}},gr=class extends tt{constructor(t,e){super(),this.body=t,this.loopId=e}get astNodeType(){return"continuing"}search(t){this.searchBlock(this.body,t)}},Ms=class extends tt{constructor(t,e,n,s){super(),this.init=t,this.condition=e,this.increment=n,this.body=s}get astNodeType(){return"for"}search(t){var e,n,s;(e=this.init)===null||e===void 0||e.search(t),(n=this.condition)===null||n===void 0||n.search(t),(s=this.increment)===null||s===void 0||s.search(t),this.searchBlock(this.body,t)}},Wt=class extends tt{constructor(t,e,n,s,i){super(),this.attributes=null,this.name=t,this.type=e,this.storage=n,this.access=s,this.value=i}get astNodeType(){return"var"}search(t){var e;t(this),(e=this.value)===null||e===void 0||e.search(t)}},_r=class extends tt{constructor(t,e,n){super(),this.attributes=null,this.name=t,this.type=e,this.value=n}get astNodeType(){return"override"}search(t){var e;(e=this.value)===null||e===void 0||e.search(t)}},qe=class extends tt{constructor(t,e,n,s,i){super(),this.attributes=null,this.name=t,this.type=e,this.storage=n,this.access=s,this.value=i}get astNodeType(){return"let"}search(t){var e;t(this),(e=this.value)===null||e===void 0||e.search(t)}},In=class extends tt{constructor(t,e,n,s,i){super(),this.attributes=null,this.name=t,this.type=e,this.storage=n,this.access=s,this.value=i}get astNodeType(){return"const"}constEvaluate(t,e){return this.value.constEvaluate(t,e)}search(t){var e;t(this),(e=this.value)===null||e===void 0||e.search(t)}},Sn,dr,A,w;(r=>{r.increment="++",r.decrement="--"})(Sn||(Sn={})),(r=>{r.parse=function(t){let e=t;if(e=="parse")throw new Error("Invalid value for IncrementOperator");return r[e]}})(Sn||(Sn={}));var Ls=class extends tt{constructor(t,e){super(),this.operator=t,this.variable=e}get astNodeType(){return"increment"}search(t){this.variable.search(t)}};(r=>{r.assign="=",r.addAssign="+=",r.subtractAssin="-=",r.multiplyAssign="*=",r.divideAssign="/=",r.moduloAssign="%=",r.andAssign="&=",r.orAssign="|=",r.xorAssign="^=",r.shiftLeftAssign="<<=",r.shiftRightAssign=">>="})(dr||(dr={})),(r=>{r.parse=function(t){let e=t;if(e=="parse")throw new Error("Invalid value for AssignOperator");return e}})(dr||(dr={}));var Cs=class extends tt{constructor(t,e,n){super(),this.operator=t,this.variable=e,this.value=n}get astNodeType(){return"assign"}search(t){this.variable.search(t),this.value.search(t)}},yr=class extends tt{constructor(t,e){super(),this.name=t,this.args=e}get astNodeType(){return"call"}isBuiltin(){return sh.has(this.name)}search(t){for(let e of this.args)e.search(t);t(this)}},Os=class extends tt{constructor(t,e){super(),this.body=t,this.continuing=e}get astNodeType(){return"loop"}search(t){var e;this.searchBlock(this.body,t),(e=this.continuing)===null||e===void 0||e.search(t)}},Rs=class extends tt{constructor(t,e){super(),this.condition=t,this.cases=e}get astNodeType(){return"switch"}search(t){t(this);for(let e of this.cases)e.search(t)}},Ns=class extends tt{constructor(t,e,n,s){super(),this.condition=t,this.body=e,this.elseif=n,this.else=s}get astNodeType(){return"if"}search(t){this.condition.search(t),this.searchBlock(this.body,t),this.searchBlock(this.elseif,t),this.searchBlock(this.else,t)}},Ds=class extends tt{constructor(t){super(),this.value=t}get astNodeType(){return"return"}search(t){var e;(e=this.value)===null||e===void 0||e.search(t)}},Sa=class extends tt{constructor(t){super(),this.name=t}get astNodeType(){return"enable"}},Aa=class extends tt{constructor(t){super(),this.extensions=t}get astNodeType(){return"requires"}},Fs=class extends tt{constructor(t,e){super(),this.severity=t,this.rule=e}get astNodeType(){return"diagnostic"}},xr=class extends tt{constructor(t,e){super(),this.name=t,this.type=e}get astNodeType(){return"alias"}},Ia=class extends tt{constructor(){super()}get astNodeType(){return"discard"}},Vs=class extends tt{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}},Us=class extends tt{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}},C=class r extends tt{constructor(t){super(),this.attributes=null,this.name=t}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(t){let e=t[0];if(e.name==="f32")return e;for(let n=1;n<t.length;++n){let s=r._priority.get(e.name);r._priority.get(t[n].name)<s&&(e=t[n])}return e.name==="x32"?r.i32:e}getTypeName(){return this.name}};C.x32=new C("x32"),C.f32=new C("f32"),C.i32=new C("i32"),C.u32=new C("u32"),C.f16=new C("f16"),C.bool=new C("bool"),C.void=new C("void"),C._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);var Bs=class extends C{constructor(t){super(t)}},$t=class extends C{constructor(t,e,n,s){super(t),this.members=e,this.startLine=n,this.endLine=s}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(t){for(let e=0;e<this.members.length;e++)if(this.members[e].name==t)return e;return-1}search(t){for(let e of this.members)t(e)}},E=class extends C{constructor(t,e,n){super(t),this.format=e,this.access=n}get astNodeType(){return"template"}getTypeName(){let t=this.name;if(this.format!==null){if(t==="vec2"||t==="vec3"||t==="vec4"||t==="mat2x2"||t==="mat2x3"||t==="mat2x4"||t==="mat3x2"||t==="mat3x3"||t==="mat3x4"||t==="mat4x2"||t==="mat4x3"||t==="mat4x4"){if(this.format.name==="f32")return t+="f",t;if(this.format.name==="i32")return t+="i",t;if(this.format.name==="u32")return t+="u",t;if(this.format.name==="bool")return t+="b",t;if(this.format.name==="f16")return t+="h",t}t+=`<${this.format.name}>`}else if(t==="vec2"||t==="vec3"||t==="vec4")return t;return t}};E.vec2f=new E("vec2",C.f32,null),E.vec3f=new E("vec3",C.f32,null),E.vec4f=new E("vec4",C.f32,null),E.vec2i=new E("vec2",C.i32,null),E.vec3i=new E("vec3",C.i32,null),E.vec4i=new E("vec4",C.i32,null),E.vec2u=new E("vec2",C.u32,null),E.vec3u=new E("vec3",C.u32,null),E.vec4u=new E("vec4",C.u32,null),E.vec2h=new E("vec2",C.f16,null),E.vec3h=new E("vec3",C.f16,null),E.vec4h=new E("vec4",C.f16,null),E.vec2b=new E("vec2",C.bool,null),E.vec3b=new E("vec3",C.bool,null),E.vec4b=new E("vec4",C.bool,null),E.mat2x2f=new E("mat2x2",C.f32,null),E.mat2x3f=new E("mat2x3",C.f32,null),E.mat2x4f=new E("mat2x4",C.f32,null),E.mat3x2f=new E("mat3x2",C.f32,null),E.mat3x3f=new E("mat3x3",C.f32,null),E.mat3x4f=new E("mat3x4",C.f32,null),E.mat4x2f=new E("mat4x2",C.f32,null),E.mat4x3f=new E("mat4x3",C.f32,null),E.mat4x4f=new E("mat4x4",C.f32,null),E.mat2x2h=new E("mat2x2",C.f16,null),E.mat2x3h=new E("mat2x3",C.f16,null),E.mat2x4h=new E("mat2x4",C.f16,null),E.mat3x2h=new E("mat3x2",C.f16,null),E.mat3x3h=new E("mat3x3",C.f16,null),E.mat3x4h=new E("mat3x4",C.f16,null),E.mat4x2h=new E("mat4x2",C.f16,null),E.mat4x3h=new E("mat4x3",C.f16,null),E.mat4x4h=new E("mat4x4",C.f16,null),E.mat2x2i=new E("mat2x2",C.i32,null),E.mat2x3i=new E("mat2x3",C.i32,null),E.mat2x4i=new E("mat2x4",C.i32,null),E.mat3x2i=new E("mat3x2",C.i32,null),E.mat3x3i=new E("mat3x3",C.i32,null),E.mat3x4i=new E("mat3x4",C.i32,null),E.mat4x2i=new E("mat4x2",C.i32,null),E.mat4x3i=new E("mat4x3",C.i32,null),E.mat4x4i=new E("mat4x4",C.i32,null),E.mat2x2u=new E("mat2x2",C.u32,null),E.mat2x3u=new E("mat2x3",C.u32,null),E.mat2x4u=new E("mat2x4",C.u32,null),E.mat3x2u=new E("mat3x2",C.u32,null),E.mat3x3u=new E("mat3x3",C.u32,null),E.mat3x4u=new E("mat3x4",C.u32,null),E.mat4x2u=new E("mat4x2",C.u32,null),E.mat4x3u=new E("mat4x3",C.u32,null),E.mat4x4u=new E("mat4x4",C.u32,null);var Pn=class extends C{constructor(t,e,n,s){super(t),this.storage=e,this.type=n,this.access=s}get astNodeType(){return"pointer"}},Ye=class extends C{constructor(t,e,n,s){super(t),this.attributes=e,this.format=n,this.count=s}get astNodeType(){return"array"}get isArray(){return!0}},He=class extends C{constructor(t,e,n){super(t),this.format=e,this.access=n}get astNodeType(){return"sampler"}},Pt=class extends fe{constructor(){super(),this.postfix=null}},ue=class extends Pt{constructor(t){super(),this.value=t}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}},Vt=class extends Pt{constructor(t,e){super(),this.type=t,this.args=e}get astNodeType(){return"createExpr"}search(t){if(t(this),this.args)for(let e of this.args)e.search(t)}constEvaluate(t,e){return e&&(e[0]=this.type),t.evalExpression(this,t.context)}},br=class extends Pt{constructor(t,e){super(),this.cachedReturnValue=null,this.name=t,this.args=e}get astNodeType(){return"callExpr"}setCachedReturnValue(t){this.cachedReturnValue=t}get isBuiltin(){return sh.has(this.name)}constEvaluate(t,e){return t.evalExpression(this,t.context)}search(t){for(let e of this.args)e.search(t);t(this)}},vt=class extends Pt{constructor(t){super(),this.name=t}get astNodeType(){return"varExpr"}search(t){t(this),this.postfix&&this.postfix.search(t)}constEvaluate(t,e){return t.evalExpression(this,t.context)}},zs=class extends Pt{constructor(t,e){super(),this.name=t,this.initializer=e}get astNodeType(){return"constExpr"}constEvaluate(t,e){if(this.initializer){let n=t.evalExpression(this.initializer,t.context);return n!==null&&this.postfix?n.getSubData(t,this.postfix,t.context):n}return null}search(t){this.initializer.search(t)}},ct=class extends Pt{constructor(t,e){super(),this.value=t,this.type=e}get astNodeType(){return"literalExpr"}constEvaluate(t,e){return e!==void 0&&(e[0]=this.type),this.value}get isScalar(){return this.value instanceof v}get isVector(){return this.value instanceof g||this.value instanceof z}get scalarValue(){return this.value instanceof v?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof g||this.value instanceof z?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}},js=class extends Pt{constructor(t,e){super(),this.type=t,this.value=e}get astNodeType(){return"bitcastExpr"}search(t){this.value.search(t)}};var Pe=class extends Pt{constructor(t){super(),this.index=t}search(t){this.index.search(t)}},$s=class extends Pt{constructor(){super()}},it=class extends $s{constructor(t,e){super(),this.operator=t,this.right=e}get astNodeType(){return"unaryOp"}constEvaluate(t,e){return t.evalExpression(this,t.context)}search(t){this.right.search(t)}},It=class extends $s{constructor(t,e,n){super(),this.operator=t,this.left=e,this.right=n}get astNodeType(){return"binaryOp"}_getPromotedType(t,e){return t.name===e.name?t:t.name==="f32"||e.name==="f32"?C.f32:t.name==="u32"||e.name==="u32"?C.u32:C.i32}constEvaluate(t,e){return t.evalExpression(this,t.context)}search(t){this.left.search(t),this.right.search(t)}},Ws=class extends fe{constructor(t){super(),this.body=t}search(t){t(this),this.searchBlock(this.body,t)}},Mn=class extends Pt{constructor(){super()}get astNodeType(){return"default"}},Gs=class extends Ws{constructor(t,e){super(e),this.selectors=t}get astNodeType(){return"case"}search(t){this.searchBlock(this.body,t)}},Hs=class extends Ws{constructor(t){super(t)}get astNodeType(){return"default"}search(t){this.searchBlock(this.body,t)}},qs=class extends fe{constructor(t,e,n){super(),this.name=t,this.type=e,this.attributes=n}get astNodeType(){return"argument"}},Pa=class extends fe{constructor(t,e){super(),this.condition=t,this.body=e}get astNodeType(){return"elseif"}search(t){this.condition.search(t),this.searchBlock(this.body,t)}},Ys=class extends fe{constructor(t,e,n){super(),this.name=t,this.type=e,this.attributes=n}get astNodeType(){return"member"}},Xs=class extends fe{constructor(t,e){super(),this.name=t,this.value=e}get astNodeType(){return"attribute"}},he=(()=>{class r{constructor(e,n){this.parent=null,this.typeInfo=e,this.parent=n,this.id=r._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,n,s,i){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,n,s){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}return r._id=0,r})(),wr=class extends he{constructor(){super(new kt("void",null),null)}toString(){return"void"}};wr.void=new wr;var Ie=class extends he{constructor(t){super(new mr("pointer",t.typeInfo,null),null),this.reference=t}clone(){return this}setDataValue(t,e,n,s){this.reference.setDataValue(t,e,n,s)}getSubData(t,e,n){return e?this.reference.getSubData(t,e,n):this}toString(){return`&${this.reference.toString()}`}},v=class r extends he{constructor(t,e,n=null){super(e,n),t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array?this.data=t:this.typeInfo.name==="x32"?t-Math.floor(t)!==0?this.data=new Float32Array([t]):this.data=t>=0?new Uint32Array([t]):new Int32Array([t]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([t]):this.typeInfo.name==="u32"?this.data=new Uint32Array([t]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([t]):console.error("ScalarData2: Invalid type",e)}clone(){if(this.data instanceof Float32Array)return new r(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new r(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new r(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(t){this.data[0]=t}setDataValue(t,e,n,s){if(n)return void console.error("SetDataValue: Scalar data does not support postfix",n);if(!(e instanceof r))return void console.error("SetDataValue: Invalid value",e);let i=e.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?i=Math.floor(i):this.typeInfo.name==="bool"&&(i=i?1:0),this.data[0]=i}getSubData(t,e,n){return e?(console.error("getSubData: Scalar data does not support postfix",e),null):this}toString(){return`${this.value}`}};function gm(r,t,e){let n=t.length;return n===2?e==="f32"?new g(new Float32Array(t),r.getTypeInfo("vec2f")):e==="i32"||e==="bool"?new g(new Int32Array(t),r.getTypeInfo("vec2i")):e==="u32"?new g(new Uint32Array(t),r.getTypeInfo("vec2u")):e==="f16"?new g(new Float32Array(t),r.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${e}`),null):n===3?e==="f32"?new g(new Float32Array(t),r.getTypeInfo("vec3f")):e==="i32"||e==="bool"?new g(new Int32Array(t),r.getTypeInfo("vec3i")):e==="u32"?new g(new Uint32Array(t),r.getTypeInfo("vec3u")):e==="f16"?new g(new Float32Array(t),r.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${e}`),null):n===4?e==="f32"?new g(new Float32Array(t),r.getTypeInfo("vec4f")):e==="i32"||e==="bool"?new g(new Int32Array(t),r.getTypeInfo("vec4i")):e==="u32"?new g(new Uint32Array(t),r.getTypeInfo("vec4u")):e==="f16"?new g(new Float32Array(t),r.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${e}`),null):(console.error(`getSubData: Invalid vector size ${t.length}`),null)}var g=class r extends he{constructor(t,e,n=null){if(super(e,n),t instanceof Float32Array||t instanceof Uint32Array||t instanceof Int32Array)this.data=t;else{let s=this.typeInfo.name;s==="vec2f"||s==="vec3f"||s==="vec4f"?this.data=new Float32Array(t):s==="vec2i"||s==="vec3i"||s==="vec4i"?this.data=new Int32Array(t):s==="vec2u"||s==="vec3u"||s==="vec4u"?this.data=new Uint32Array(t):s==="vec2h"||s==="vec3h"||s==="vec4h"?this.data=new Float32Array(t):s==="vec2b"||s==="vec3b"||s==="vec4b"?this.data=new Int32Array(t):s==="vec2"||s==="vec3"||s==="vec4"?this.data=new Float32Array(t):console.error(`VectorData: Invalid type ${s}`)}}clone(){if(this.data instanceof Float32Array)return new r(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new r(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new r(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(t,e,n,s){n instanceof ue?console.error("TODO: Set vector postfix"):e instanceof r?this.data=e.data:console.error("SetDataValue: Invalid value",e)}getSubData(t,e,n){if(e===null)return this;let s=t.getTypeInfo("f32");if(this.typeInfo instanceof le)s=this.typeInfo.format||s;else{let o=this.typeInfo.name;o==="vec2f"||o==="vec3f"||o==="vec4f"?s=t.getTypeInfo("f32"):o==="vec2i"||o==="vec3i"||o==="vec4i"?s=t.getTypeInfo("i32"):o==="vec2b"||o==="vec3b"||o==="vec4b"?s=t.getTypeInfo("bool"):o==="vec2u"||o==="vec3u"||o==="vec4u"?s=t.getTypeInfo("u32"):o==="vec2h"||o==="vec3h"||o==="vec4h"?s=t.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${o}`)}let i=this;for(;e!==null&&i!==null;){if(e instanceof Pe){let o=e.index,a=-1;if(o instanceof ct){if(!(o.value instanceof v))return console.error(`GetSubData: Invalid array index ${o.value}`),null;a=o.value.value}else{let c=t.evalExpression(o,n);if(!(c instanceof v))return console.error("GetSubData: Unknown index type",o),null;a=c.value}if(a<0||a>=i.data.length)return console.error("GetSubData: Index out of range",a),null;if(i.data instanceof Float32Array){let c=new Float32Array(i.data.buffer,i.data.byteOffset+4*a,1);return new v(c,s)}if(i.data instanceof Int32Array){let c=new Int32Array(i.data.buffer,i.data.byteOffset+4*a,1);return new v(c,s)}if(i.data instanceof Uint32Array){let c=new Uint32Array(i.data.buffer,i.data.byteOffset+4*a,1);return new v(c,s)}throw"GetSubData: Invalid data type"}if(!(e instanceof ue))return console.error("GetSubData: Unknown postfix",e),null;{let o=e.value.toLowerCase();if(o.length===1){let c=0;if(o==="x"||o==="r")c=0;else if(o==="y"||o==="g")c=1;else if(o==="z"||o==="b")c=2;else{if(o!=="w"&&o!=="a")return console.error(`GetSubData: Unknown member ${o}`),null;c=3}if(this.data instanceof Float32Array){let l=new Float32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new v(l,s,this)}if(this.data instanceof Int32Array){let l=new Int32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new v(l,s,this)}if(this.data instanceof Uint32Array){let l=new Uint32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new v(l,s,this)}}let a=[];for(let c of o)c==="x"||c==="r"?a.push(this.data[0]):c==="y"||c==="g"?a.push(this.data[1]):c==="z"||c==="b"?a.push(this.data[2]):c==="w"||c==="a"?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${c}`);i=gm(t,a,s.name)}e=e.postfix}return i}toString(){let t=`${this.data[0]}`;for(let e=1;e<this.data.length;++e)t+=`, ${this.data[e]}`;return t}},z=class r extends he{constructor(t,e,n=null){super(e,n),t instanceof Float32Array?this.data=t:this.data=new Float32Array(t)}clone(){return new r(new Float32Array(this.data),this.typeInfo,null)}setDataValue(t,e,n,s){n instanceof ue?console.error("TODO: Set matrix postfix"):e instanceof r?this.data=e.data:console.error("SetDataValue: Invalid value",e)}getSubData(t,e,n){if(e===null)return this;let s=this.typeInfo.name;if(t.getTypeInfo("f32"),this.typeInfo instanceof le)this.typeInfo.format;else if(s.endsWith("f"))t.getTypeInfo("f32");else if(s.endsWith("i"))t.getTypeInfo("i32");else if(s.endsWith("u"))t.getTypeInfo("u32");else{if(!s.endsWith("h"))return console.error(`GetDataValue: Unknown type ${s}`),null;t.getTypeInfo("f16")}if(e instanceof Pe){let i=e.index,o=-1;if(i instanceof ct){if(!(i.value instanceof v))return console.error(`GetDataValue: Invalid array index ${i.value}`),null;o=i.value.value}else{let l=t.evalExpression(i,n);if(!(l instanceof v))return console.error("GetDataValue: Unknown index type",i),null;o=l.value}if(o<0||o>=this.data.length)return console.error("GetDataValue: Index out of range",o),null;let a=s.endsWith("h")?"h":"f",c;if(s==="mat2x2"||s==="mat2x2f"||s==="mat2x2h"||s==="mat3x2"||s==="mat3x2f"||s==="mat3x2h"||s==="mat4x2"||s==="mat4x2f"||s==="mat4x2h")c=new g(new Float32Array(this.data.buffer,this.data.byteOffset+2*o*4,2),t.getTypeInfo(`vec2${a}`));else if(s==="mat2x3"||s==="mat2x3f"||s==="mat2x3h"||s==="mat3x3"||s==="mat3x3f"||s==="mat3x3h"||s==="mat4x3"||s==="mat4x3f"||s==="mat4x3h")c=new g(new Float32Array(this.data.buffer,this.data.byteOffset+3*o*4,3),t.getTypeInfo(`vec3${a}`));else{if(s!=="mat2x4"&&s!=="mat2x4f"&&s!=="mat2x4h"&&s!=="mat3x4"&&s!=="mat3x4f"&&s!=="mat3x4h"&&s!=="mat4x4"&&s!=="mat4x4f"&&s!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${s}`),null;c=new g(new Float32Array(this.data.buffer,this.data.byteOffset+4*o*4,4),t.getTypeInfo(`vec4${a}`))}return e.postfix?c.getSubData(t,e.postfix,n):c}return console.error("GetDataValue: Invalid postfix",e),null}toString(){let t=`${this.data[0]}`;for(let e=1;e<this.data.length;++e)t+=`, ${this.data[e]}`;return t}},lt=class r extends he{constructor(t,e,n=0,s=null){super(e,s),this.buffer=t instanceof ArrayBuffer?t:t.buffer,this.offset=n}clone(){let t=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new r(t.buffer,this.typeInfo,0,null)}setDataValue(t,e,n,s){if(e===null)return void console.log("setDataValue: NULL data.");let i=this.offset,o=this.typeInfo;for(;n;){if(n instanceof Pe)if(o instanceof ne){let a=n.index;if(a instanceof ct){if(!(a.value instanceof v))return void console.error(`SetDataValue: Invalid index type ${a.value}`);i+=a.value.value*o.stride}else{let c=t.evalExpression(a,s);if(!(c instanceof v))return void console.error("SetDataValue: Unknown index type",a);i+=c.value*o.stride}o=o.format}else console.error(`SetDataValue: Type ${o.getTypeName()} is not an array`);else{if(!(n instanceof ue))return void console.error("SetDataValue: Unknown postfix type",n);{let a=n.value;if(o instanceof ee){let c=!1;for(let l of o.members)if(l.name===a){i+=l.offset,o=l.type,c=!0;break}if(!c)return void console.error(`SetDataValue: Member ${a} not found`)}else if(o instanceof kt){let c=o.getTypeName(),l=0;if(a==="x"||a==="r")l=0;else if(a==="y"||a==="g")l=1;else if(a==="z"||a==="b")l=2;else{if(a!=="w"&&a!=="a")return void console.error(`SetDataValue: Unknown member ${a}`);l=3}if(!(e instanceof v))return void console.error("SetDataValue: Invalid value",e);let u=e.value;return c==="vec2f"?void(new Float32Array(this.buffer,i,2)[l]=u):c==="vec3f"?void(new Float32Array(this.buffer,i,3)[l]=u):c==="vec4f"?void(new Float32Array(this.buffer,i,4)[l]=u):c==="vec2i"?void(new Int32Array(this.buffer,i,2)[l]=u):c==="vec3i"?void(new Int32Array(this.buffer,i,3)[l]=u):c==="vec4i"?void(new Int32Array(this.buffer,i,4)[l]=u):c==="vec2u"?void(new Uint32Array(this.buffer,i,2)[l]=u):c==="vec3u"?void(new Uint32Array(this.buffer,i,3)[l]=u):c==="vec4u"?void(new Uint32Array(this.buffer,i,4)[l]=u):void console.error(`SetDataValue: Type ${c} is not a struct`)}}}n=n.postfix}this.setData(t,e,o,i,s)}setData(t,e,n,s,i){let o=n.getTypeName();if(o!=="f32"&&o!=="f16")if(o!=="i32"&&o!=="atomic<i32>"&&o!=="x32")if(o!=="u32"&&o!=="atomic<u32>")if(o!=="bool"){if(o==="vec2f"||o==="vec2h"){let a=new Float32Array(this.buffer,s,2);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1]))}if(o==="vec3f"||o==="vec3h"){let a=new Float32Array(this.buffer,s,3);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2]))}if(o==="vec4f"||o==="vec4h"){let a=new Float32Array(this.buffer,s,4);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3]))}if(o==="vec2i"){let a=new Int32Array(this.buffer,s,2);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1]))}if(o==="vec3i"){let a=new Int32Array(this.buffer,s,3);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2]))}if(o==="vec4i"){let a=new Int32Array(this.buffer,s,4);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3]))}if(o==="vec2u"){let a=new Uint32Array(this.buffer,s,2);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1]))}if(o==="vec3u"){let a=new Uint32Array(this.buffer,s,3);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2]))}if(o==="vec4u"){let a=new Uint32Array(this.buffer,s,4);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3]))}if(o==="vec2b"){let a=new Uint32Array(this.buffer,s,2);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1]):(a[0]=e[0],a[1]=e[1]))}if(o==="vec3b"){let a=new Uint32Array(this.buffer,s,3);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2]):(a[0]=e[0],a[1]=e[1],a[2]=e[2]))}if(o==="vec4b"){let a=new Uint32Array(this.buffer,s,4);return void(e instanceof g?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3]))}if(o==="mat2x2f"||o==="mat2x2h"){let a=new Float32Array(this.buffer,s,4);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3]))}if(o==="mat2x3f"||o==="mat2x3h"){let a=new Float32Array(this.buffer,s,6);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5]))}if(o==="mat2x4f"||o==="mat2x4h"){let a=new Float32Array(this.buffer,s,8);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7]))}if(o==="mat3x2f"||o==="mat3x2h"){let a=new Float32Array(this.buffer,s,6);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5]))}if(o==="mat3x3f"||o==="mat3x3h"){let a=new Float32Array(this.buffer,s,9);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8]))}if(o==="mat3x4f"||o==="mat3x4h"){let a=new Float32Array(this.buffer,s,12);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8],a[9]=e.data[9],a[10]=e.data[10],a[11]=e.data[11]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11]))}if(o==="mat4x2f"||o==="mat4x2h"){let a=new Float32Array(this.buffer,s,8);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7]))}if(o==="mat4x3f"||o==="mat4x3h"){let a=new Float32Array(this.buffer,s,12);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8],a[9]=e.data[9],a[10]=e.data[10],a[11]=e.data[11]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11]))}if(o==="mat4x4f"||o==="mat4x4h"){let a=new Float32Array(this.buffer,s,16);return void(e instanceof z?(a[0]=e.data[0],a[1]=e.data[1],a[2]=e.data[2],a[3]=e.data[3],a[4]=e.data[4],a[5]=e.data[5],a[6]=e.data[6],a[7]=e.data[7],a[8]=e.data[8],a[9]=e.data[9],a[10]=e.data[10],a[11]=e.data[11],a[12]=e.data[12],a[13]=e.data[13],a[14]=e.data[14],a[15]=e.data[15]):(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11],a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15]))}if(e instanceof r){if(n===e.typeInfo)return void new Uint8Array(this.buffer,s,e.buffer.byteLength).set(new Uint8Array(e.buffer));console.error("SetDataValue: Type mismatch",o,e.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${o}`)}else e instanceof v&&(new Int32Array(this.buffer,s,1)[0]=e.value);else e instanceof v&&(new Uint32Array(this.buffer,s,1)[0]=e.value);else e instanceof v&&(new Int32Array(this.buffer,s,1)[0]=e.value);else e instanceof v&&(new Float32Array(this.buffer,s,1)[0]=e.value)}getSubData(t,e,n){var s,i,o;if(e===null)return this;let a=this.offset,c=this.typeInfo;for(;e;){if(e instanceof Pe){let u=e.index,h=u instanceof Pt?t.evalExpression(u,n):u,f=0;if(h instanceof v?f=h.value:typeof h=="number"?f=h:console.error("GetDataValue: Invalid index type",u),c instanceof ne)a+=f*c.stride,c=c.format;else{let p=c.getTypeName();p==="mat4x4"||p==="mat4x4f"||p==="mat4x4h"?(a+=16*f,c=t.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${c.getTypeName()} is not an array`)}}else{if(!(e instanceof ue))return console.error("GetDataValue: Unknown postfix type",e),null;{let u=e.value;if(c instanceof ee){let h=!1;for(let f of c.members)if(f.name===u){a+=f.offset,c=f.type,h=!0;break}if(!h)return console.error(`GetDataValue: Member ${u} not found`),null}else if(c instanceof kt){let h=c.getTypeName();if(h==="vec2f"||h==="vec3f"||h==="vec4f"||h==="vec2i"||h==="vec3i"||h==="vec4i"||h==="vec2u"||h==="vec3u"||h==="vec4u"||h==="vec2b"||h==="vec3b"||h==="vec4b"||h==="vec2h"||h==="vec3h"||h==="vec4h"||h==="vec2"||h==="vec3"||h==="vec4"){if(u.length>0&&u.length<5){let f="f",p=[];for(let _=0;_<u.length;++_){let x=u[_].toLowerCase(),y=0;if(x==="x"||x==="r")y=0;else if(x==="y"||x==="g")y=1;else if(x==="z"||x==="b")y=2;else{if(x!=="w"&&x!=="a")return console.error(`Unknown member ${u}`),null;y=3}if(u.length===1){if(h.endsWith("f"))return this.buffer.byteLength<a+4*y+4?(console.log("Insufficient buffer data"),null):new v(new Float32Array(this.buffer,a+4*y,1),t.getTypeInfo("f32"),this);if(h.endsWith("h"))return new v(new Float32Array(this.buffer,a+4*y,1),t.getTypeInfo("f16"),this);if(h.endsWith("i"))return new v(new Int32Array(this.buffer,a+4*y,1),t.getTypeInfo("i32"),this);if(h.endsWith("b"))return new v(new Int32Array(this.buffer,a+4*y,1),t.getTypeInfo("bool"),this);if(h.endsWith("u"))return new v(new Uint32Array(this.buffer,a+4*y,1),t.getTypeInfo("i32"),this)}if(h==="vec2f")p.push(new Float32Array(this.buffer,a,2)[y]);else if(h==="vec3f"){if(a+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;let T=new Float32Array(this.buffer,a,3);p.push(T[y])}else if(h==="vec4f")p.push(new Float32Array(this.buffer,a,4)[y]);else if(h==="vec2i")f="i",p.push(new Int32Array(this.buffer,a,2)[y]);else if(h==="vec3i")f="i",p.push(new Int32Array(this.buffer,a,3)[y]);else if(h==="vec4i")f="i",p.push(new Int32Array(this.buffer,a,4)[y]);else if(h==="vec2u"){f="u";let T=new Uint32Array(this.buffer,a,2);p.push(T[y])}else h==="vec3u"?(f="u",p.push(new Uint32Array(this.buffer,a,3)[y])):h==="vec4u"&&(f="u",p.push(new Uint32Array(this.buffer,a,4)[y]))}return p.length===2?c=t.getTypeInfo(`vec2${f}`):p.length===3?c=t.getTypeInfo(`vec3${f}`):p.length===4?c=t.getTypeInfo(`vec4${f}`):console.error(`GetDataValue: Invalid vector length ${p.length}`),new g(p,c,null)}return console.error(`GetDataValue: Unknown member ${u}`),null}return console.error(`GetDataValue: Type ${h} is not a struct`),null}}}e=e.postfix}let l=c.getTypeName();return l==="f32"?new v(new Float32Array(this.buffer,a,1),c,this):l==="i32"?new v(new Int32Array(this.buffer,a,1),c,this):l==="u32"?new v(new Uint32Array(this.buffer,a,1),c,this):l==="vec2f"?new g(new Float32Array(this.buffer,a,2),c,this):l==="vec3f"?new g(new Float32Array(this.buffer,a,3),c,this):l==="vec4f"?new g(new Float32Array(this.buffer,a,4),c,this):l==="vec2i"?new g(new Int32Array(this.buffer,a,2),c,this):l==="vec3i"?new g(new Int32Array(this.buffer,a,3),c,this):l==="vec4i"?new g(new Int32Array(this.buffer,a,4),c,this):l==="vec2u"?new g(new Uint32Array(this.buffer,a,2),c,this):l==="vec3u"?new g(new Uint32Array(this.buffer,a,3),c,this):l==="vec4u"?new g(new Uint32Array(this.buffer,a,4),c,this):c instanceof le&&c.name==="atomic"?((s=c.format)===null||s===void 0?void 0:s.name)==="u32"?new v(new Uint32Array(this.buffer,a,1)[0],c.format,this):((i=c.format)===null||i===void 0?void 0:i.name)==="i32"?new v(new Int32Array(this.buffer,a,1)[0],c.format,this):(console.error(`GetDataValue: Invalid atomic format ${(o=c.format)===null||o===void 0?void 0:o.name}`),null):new r(this.buffer,c,a,this)}toString(){let t="";if(this.typeInfo instanceof ne)if(this.typeInfo.format.name==="f32"){let e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}`;for(let n=1;n<e.length;++n)t+=`, ${e[n]}`}else if(this.typeInfo.format.name==="i32"){let e=new Int32Array(this.buffer,this.offset);t=`[${e[0]}`;for(let n=1;n<e.length;++n)t+=`, ${e[n]}`}else if(this.typeInfo.format.name==="u32"){let e=new Uint32Array(this.buffer,this.offset);t=`[${e[0]}`;for(let n=1;n<e.length;++n)t+=`, ${e[n]}`}else if(this.typeInfo.format.name==="vec2f"){let e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}, ${e[1]}]`;for(let n=1;n<e.length/2;++n)t+=`, [${e[2*n]}, ${e[2*n+1]}]`}else if(this.typeInfo.format.name==="vec3f"){let e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}, ${e[1]}, ${e[2]}]`;for(let n=4;n<e.length;n+=4)t+=`, [${e[n]}, ${e[n+1]}, ${e[n+2]}]`}else if(this.typeInfo.format.name==="vec4f"){let e=new Float32Array(this.buffer,this.offset);t=`[${e[0]}, ${e[1]}, ${e[2]}, ${e[3]}]`;for(let n=4;n<e.length;n+=4)t+=`, [${e[n]}, ${e[n+1]}, ${e[n+2]}, ${e[n+3]}]`}else t="[...]";else this.typeInfo instanceof ee?t+="{...}":t="[...]";return t}},ce=class r extends he{constructor(t,e,n,s){super(e,null),this.data=t,this.descriptor=n,this.view=s}clone(){return new r(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var t,e;let n=this.descriptor.size;return n instanceof Array&&n.length>0?(t=n[0])!==null&&t!==void 0?t:0:n instanceof Object&&(e=n.width)!==null&&e!==void 0?e:0}get height(){var t,e;let n=this.descriptor.size;return n instanceof Array&&n.length>1?(t=n[1])!==null&&t!==void 0?t:0:n instanceof Object&&(e=n.height)!==null&&e!==void 0?e:0}get depthOrArrayLayers(){var t,e;let n=this.descriptor.size;return n instanceof Array&&n.length>2?(t=n[2])!==null&&t!==void 0?t:0:n instanceof Object&&(e=n.depthOrArrayLayers)!==null&&e!==void 0?e:0}get format(){var t;return this.descriptor&&(t=this.descriptor.format)!==null&&t!==void 0?t:"rgba8unorm"}get sampleCount(){var t;return this.descriptor&&(t=this.descriptor.sampleCount)!==null&&t!==void 0?t:1}get mipLevelCount(){var t;return this.descriptor&&(t=this.descriptor.mipLevelCount)!==null&&t!==void 0?t:1}get dimension(){var t;return this.descriptor&&(t=this.descriptor.dimension)!==null&&t!==void 0?t:"2d"}getMipLevelSize(t){if(t>=this.mipLevelCount)return[0,0,0];let e=[this.width,this.height,this.depthOrArrayLayers];for(let n=0;n<e.length;++n)e[n]=Math.max(1,e[n]>>t);return e}get texelByteSize(){let t=this.format,e=_a[t];return e?e.isDepthStencil?4:e.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){let t=this.format,e=_a[t];return!!e&&e.isDepthStencil}getGpuSize(){let t=this.format,e=_a[t],n=this.width;if(!t||n<=0||!e)return-1;let s=this.height,i=this.depthOrArrayLayers,o=this.dimension;return n/e.blockWidth*(o==="1d"?1:s/e.blockHeight)*e.bytesPerBlock*i}getPixel(t,e,n=0,s=0){let i=this.texelByteSize,o=this.bytesPerRow,a=this.height,c=this.data[s];return mm(new Uint8Array(c),t,e,n,s,a,o,i,this.format)}setPixel(t,e,n,s,i){let o=this.texelByteSize,a=this.bytesPerRow,c=this.height,l=this.data[s];(function(u,h,f,p,_,x,y,T,I,k){let S=p*(y>>=_)*(x>>=_)+f*y+h*T;switch(I){case"r8unorm":return void K(u,S,"8unorm",1,k);case"r8snorm":return void K(u,S,"8snorm",1,k);case"r8uint":return void K(u,S,"8uint",1,k);case"r8sint":return void K(u,S,"8sint",1,k);case"rg8unorm":return void K(u,S,"8unorm",2,k);case"rg8snorm":return void K(u,S,"8snorm",2,k);case"rg8uint":return void K(u,S,"8uint",2,k);case"rg8sint":return void K(u,S,"8sint",2,k);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void K(u,S,"8unorm",4,k);case"rgba8snorm":return void K(u,S,"8snorm",4,k);case"rgba8uint":return void K(u,S,"8uint",4,k);case"rgba8sint":return void K(u,S,"8sint",4,k);case"r16uint":return void K(u,S,"16uint",1,k);case"r16sint":return void K(u,S,"16sint",1,k);case"r16float":return void K(u,S,"16float",1,k);case"rg16uint":return void K(u,S,"16uint",2,k);case"rg16sint":return void K(u,S,"16sint",2,k);case"rg16float":return void K(u,S,"16float",2,k);case"rgba16uint":return void K(u,S,"16uint",4,k);case"rgba16sint":return void K(u,S,"16sint",4,k);case"rgba16float":return void K(u,S,"16float",4,k);case"r32uint":return void K(u,S,"32uint",1,k);case"r32sint":return void K(u,S,"32sint",1,k);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void K(u,S,"32float",1,k);case"rg32uint":return void K(u,S,"32uint",2,k);case"rg32sint":return void K(u,S,"32sint",2,k);case"rg32float":return void K(u,S,"32float",2,k);case"rgba32uint":return void K(u,S,"32uint",4,k);case"rgba32sint":return void K(u,S,"32sint",4,k);case"rgba32float":return void K(u,S,"32float",4,k);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(l),t,e,n,s,c,a,o,this.format,i)}};(r=>{r[r.token=0]="token",r[r.keyword=1]="keyword",r[r.reserved=2]="reserved"})(w||(w={}));var b=class{constructor(t,e,n){this.name=t,this.type=e,this.rule=n}toString(){return this.name}},m=class{};A=m,m.none=new b("",w.reserved,""),m.eof=new b("EOF",w.token,""),m.reserved={asm:new b("asm",w.reserved,"asm"),bf16:new b("bf16",w.reserved,"bf16"),do:new b("do",w.reserved,"do"),enum:new b("enum",w.reserved,"enum"),f16:new b("f16",w.reserved,"f16"),f64:new b("f64",w.reserved,"f64"),handle:new b("handle",w.reserved,"handle"),i8:new b("i8",w.reserved,"i8"),i16:new b("i16",w.reserved,"i16"),i64:new b("i64",w.reserved,"i64"),mat:new b("mat",w.reserved,"mat"),premerge:new b("premerge",w.reserved,"premerge"),regardless:new b("regardless",w.reserved,"regardless"),typedef:new b("typedef",w.reserved,"typedef"),u8:new b("u8",w.reserved,"u8"),u16:new b("u16",w.reserved,"u16"),u64:new b("u64",w.reserved,"u64"),unless:new b("unless",w.reserved,"unless"),using:new b("using",w.reserved,"using"),vec:new b("vec",w.reserved,"vec"),void:new b("void",w.reserved,"void")},m.keywords={array:new b("array",w.keyword,"array"),atomic:new b("atomic",w.keyword,"atomic"),bool:new b("bool",w.keyword,"bool"),f32:new b("f32",w.keyword,"f32"),i32:new b("i32",w.keyword,"i32"),mat2x2:new b("mat2x2",w.keyword,"mat2x2"),mat2x3:new b("mat2x3",w.keyword,"mat2x3"),mat2x4:new b("mat2x4",w.keyword,"mat2x4"),mat3x2:new b("mat3x2",w.keyword,"mat3x2"),mat3x3:new b("mat3x3",w.keyword,"mat3x3"),mat3x4:new b("mat3x4",w.keyword,"mat3x4"),mat4x2:new b("mat4x2",w.keyword,"mat4x2"),mat4x3:new b("mat4x3",w.keyword,"mat4x3"),mat4x4:new b("mat4x4",w.keyword,"mat4x4"),ptr:new b("ptr",w.keyword,"ptr"),sampler:new b("sampler",w.keyword,"sampler"),sampler_comparison:new b("sampler_comparison",w.keyword,"sampler_comparison"),struct:new b("struct",w.keyword,"struct"),texture_1d:new b("texture_1d",w.keyword,"texture_1d"),texture_2d:new b("texture_2d",w.keyword,"texture_2d"),texture_2d_array:new b("texture_2d_array",w.keyword,"texture_2d_array"),texture_3d:new b("texture_3d",w.keyword,"texture_3d"),texture_cube:new b("texture_cube",w.keyword,"texture_cube"),texture_cube_array:new b("texture_cube_array",w.keyword,"texture_cube_array"),texture_multisampled_2d:new b("texture_multisampled_2d",w.keyword,"texture_multisampled_2d"),texture_storage_1d:new b("texture_storage_1d",w.keyword,"texture_storage_1d"),texture_storage_2d:new b("texture_storage_2d",w.keyword,"texture_storage_2d"),texture_storage_2d_array:new b("texture_storage_2d_array",w.keyword,"texture_storage_2d_array"),texture_storage_3d:new b("texture_storage_3d",w.keyword,"texture_storage_3d"),texture_depth_2d:new b("texture_depth_2d",w.keyword,"texture_depth_2d"),texture_depth_2d_array:new b("texture_depth_2d_array",w.keyword,"texture_depth_2d_array"),texture_depth_cube:new b("texture_depth_cube",w.keyword,"texture_depth_cube"),texture_depth_cube_array:new b("texture_depth_cube_array",w.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new b("texture_depth_multisampled_2d",w.keyword,"texture_depth_multisampled_2d"),texture_external:new b("texture_external",w.keyword,"texture_external"),u32:new b("u32",w.keyword,"u32"),vec2:new b("vec2",w.keyword,"vec2"),vec3:new b("vec3",w.keyword,"vec3"),vec4:new b("vec4",w.keyword,"vec4"),bitcast:new b("bitcast",w.keyword,"bitcast"),block:new b("block",w.keyword,"block"),break:new b("break",w.keyword,"break"),case:new b("case",w.keyword,"case"),continue:new b("continue",w.keyword,"continue"),continuing:new b("continuing",w.keyword,"continuing"),default:new b("default",w.keyword,"default"),diagnostic:new b("diagnostic",w.keyword,"diagnostic"),discard:new b("discard",w.keyword,"discard"),else:new b("else",w.keyword,"else"),enable:new b("enable",w.keyword,"enable"),fallthrough:new b("fallthrough",w.keyword,"fallthrough"),false:new b("false",w.keyword,"false"),fn:new b("fn",w.keyword,"fn"),for:new b("for",w.keyword,"for"),function:new b("function",w.keyword,"function"),if:new b("if",w.keyword,"if"),let:new b("let",w.keyword,"let"),const:new b("const",w.keyword,"const"),loop:new b("loop",w.keyword,"loop"),while:new b("while",w.keyword,"while"),private:new b("private",w.keyword,"private"),read:new b("read",w.keyword,"read"),read_write:new b("read_write",w.keyword,"read_write"),return:new b("return",w.keyword,"return"),requires:new b("requires",w.keyword,"requires"),storage:new b("storage",w.keyword,"storage"),switch:new b("switch",w.keyword,"switch"),true:new b("true",w.keyword,"true"),alias:new b("alias",w.keyword,"alias"),type:new b("type",w.keyword,"type"),uniform:new b("uniform",w.keyword,"uniform"),var:new b("var",w.keyword,"var"),override:new b("override",w.keyword,"override"),workgroup:new b("workgroup",w.keyword,"workgroup"),write:new b("write",w.keyword,"write"),r8unorm:new b("r8unorm",w.keyword,"r8unorm"),r8snorm:new b("r8snorm",w.keyword,"r8snorm"),r8uint:new b("r8uint",w.keyword,"r8uint"),r8sint:new b("r8sint",w.keyword,"r8sint"),r16uint:new b("r16uint",w.keyword,"r16uint"),r16sint:new b("r16sint",w.keyword,"r16sint"),r16float:new b("r16float",w.keyword,"r16float"),rg8unorm:new b("rg8unorm",w.keyword,"rg8unorm"),rg8snorm:new b("rg8snorm",w.keyword,"rg8snorm"),rg8uint:new b("rg8uint",w.keyword,"rg8uint"),rg8sint:new b("rg8sint",w.keyword,"rg8sint"),r32uint:new b("r32uint",w.keyword,"r32uint"),r32sint:new b("r32sint",w.keyword,"r32sint"),r32float:new b("r32float",w.keyword,"r32float"),rg16uint:new b("rg16uint",w.keyword,"rg16uint"),rg16sint:new b("rg16sint",w.keyword,"rg16sint"),rg16float:new b("rg16float",w.keyword,"rg16float"),rgba8unorm:new b("rgba8unorm",w.keyword,"rgba8unorm"),rgba8unorm_srgb:new b("rgba8unorm_srgb",w.keyword,"rgba8unorm_srgb"),rgba8snorm:new b("rgba8snorm",w.keyword,"rgba8snorm"),rgba8uint:new b("rgba8uint",w.keyword,"rgba8uint"),rgba8sint:new b("rgba8sint",w.keyword,"rgba8sint"),bgra8unorm:new b("bgra8unorm",w.keyword,"bgra8unorm"),bgra8unorm_srgb:new b("bgra8unorm_srgb",w.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new b("rgb10a2unorm",w.keyword,"rgb10a2unorm"),rg11b10float:new b("rg11b10float",w.keyword,"rg11b10float"),rg32uint:new b("rg32uint",w.keyword,"rg32uint"),rg32sint:new b("rg32sint",w.keyword,"rg32sint"),rg32float:new b("rg32float",w.keyword,"rg32float"),rgba16uint:new b("rgba16uint",w.keyword,"rgba16uint"),rgba16sint:new b("rgba16sint",w.keyword,"rgba16sint"),rgba16float:new b("rgba16float",w.keyword,"rgba16float"),rgba32uint:new b("rgba32uint",w.keyword,"rgba32uint"),rgba32sint:new b("rgba32sint",w.keyword,"rgba32sint"),rgba32float:new b("rgba32float",w.keyword,"rgba32float"),static_assert:new b("static_assert",w.keyword,"static_assert")},m.tokens={decimal_float_literal:new b("decimal_float_literal",w.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new b("hex_float_literal",w.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new b("int_literal",w.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new b("uint_literal",w.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new b("name",w.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new b("ident",w.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new b("and",w.token,"&"),and_and:new b("and_and",w.token,"&&"),arrow:new b("arrow ",w.token,"->"),attr:new b("attr",w.token,"@"),forward_slash:new b("forward_slash",w.token,"/"),bang:new b("bang",w.token,"!"),bracket_left:new b("bracket_left",w.token,"["),bracket_right:new b("bracket_right",w.token,"]"),brace_left:new b("brace_left",w.token,"{"),brace_right:new b("brace_right",w.token,"}"),colon:new b("colon",w.token,":"),comma:new b("comma",w.token,","),equal:new b("equal",w.token,"="),equal_equal:new b("equal_equal",w.token,"=="),not_equal:new b("not_equal",w.token,"!="),greater_than:new b("greater_than",w.token,">"),greater_than_equal:new b("greater_than_equal",w.token,">="),shift_right:new b("shift_right",w.token,">>"),less_than:new b("less_than",w.token,"<"),less_than_equal:new b("less_than_equal",w.token,"<="),shift_left:new b("shift_left",w.token,"<<"),modulo:new b("modulo",w.token,"%"),minus:new b("minus",w.token,"-"),minus_minus:new b("minus_minus",w.token,"--"),period:new b("period",w.token,"."),plus:new b("plus",w.token,"+"),plus_plus:new b("plus_plus",w.token,"++"),or:new b("or",w.token,"|"),or_or:new b("or_or",w.token,"||"),paren_left:new b("paren_left",w.token,"("),paren_right:new b("paren_right",w.token,")"),semicolon:new b("semicolon",w.token,";"),star:new b("star",w.token,"*"),tilde:new b("tilde",w.token,"~"),underscore:new b("underscore",w.token,"_"),xor:new b("xor",w.token,"^"),plus_equal:new b("plus_equal",w.token,"+="),minus_equal:new b("minus_equal",w.token,"-="),times_equal:new b("times_equal",w.token,"*="),division_equal:new b("division_equal",w.token,"/="),modulo_equal:new b("modulo_equal",w.token,"%="),and_equal:new b("and_equal",w.token,"&="),or_equal:new b("or_equal",w.token,"|="),xor_equal:new b("xor_equal",w.token,"^="),shift_right_equal:new b("shift_right_equal",w.token,">>="),shift_left_equal:new b("shift_left_equal",w.token,"<<=")},m.simpleTokens={"@":A.tokens.attr,"{":A.tokens.brace_left,"}":A.tokens.brace_right,":":A.tokens.colon,",":A.tokens.comma,"(":A.tokens.paren_left,")":A.tokens.paren_right,";":A.tokens.semicolon},m.literalTokens={"&":A.tokens.and,"&&":A.tokens.and_and,"->":A.tokens.arrow,"/":A.tokens.forward_slash,"!":A.tokens.bang,"[":A.tokens.bracket_left,"]":A.tokens.bracket_right,"=":A.tokens.equal,"==":A.tokens.equal_equal,"!=":A.tokens.not_equal,">":A.tokens.greater_than,">=":A.tokens.greater_than_equal,">>":A.tokens.shift_right,"<":A.tokens.less_than,"<=":A.tokens.less_than_equal,"<<":A.tokens.shift_left,"%":A.tokens.modulo,"-":A.tokens.minus,"--":A.tokens.minus_minus,".":A.tokens.period,"+":A.tokens.plus,"++":A.tokens.plus_plus,"|":A.tokens.or,"||":A.tokens.or_or,"*":A.tokens.star,"~":A.tokens.tilde,_:A.tokens.underscore,"^":A.tokens.xor,"+=":A.tokens.plus_equal,"-=":A.tokens.minus_equal,"*=":A.tokens.times_equal,"/=":A.tokens.division_equal,"%=":A.tokens.modulo_equal,"&=":A.tokens.and_equal,"|=":A.tokens.or_equal,"^=":A.tokens.xor_equal,">>=":A.tokens.shift_right_equal,"<<=":A.tokens.shift_left_equal},m.regexTokens={decimal_float_literal:A.tokens.decimal_float_literal,hex_float_literal:A.tokens.hex_float_literal,int_literal:A.tokens.int_literal,uint_literal:A.tokens.uint_literal,ident:A.tokens.ident},m.storage_class=[A.keywords.function,A.keywords.private,A.keywords.workgroup,A.keywords.uniform,A.keywords.storage],m.access_mode=[A.keywords.read,A.keywords.write,A.keywords.read_write],m.sampler_type=[A.keywords.sampler,A.keywords.sampler_comparison],m.sampled_texture_type=[A.keywords.texture_1d,A.keywords.texture_2d,A.keywords.texture_2d_array,A.keywords.texture_3d,A.keywords.texture_cube,A.keywords.texture_cube_array],m.multisampled_texture_type=[A.keywords.texture_multisampled_2d],m.storage_texture_type=[A.keywords.texture_storage_1d,A.keywords.texture_storage_2d,A.keywords.texture_storage_2d_array,A.keywords.texture_storage_3d],m.depth_texture_type=[A.keywords.texture_depth_2d,A.keywords.texture_depth_2d_array,A.keywords.texture_depth_cube,A.keywords.texture_depth_cube_array,A.keywords.texture_depth_multisampled_2d],m.texture_external_type=[A.keywords.texture_external],m.any_texture_type=[...A.sampled_texture_type,...A.multisampled_texture_type,...A.storage_texture_type,...A.depth_texture_type,...A.texture_external_type],m.texel_format=[A.keywords.r8unorm,A.keywords.r8snorm,A.keywords.r8uint,A.keywords.r8sint,A.keywords.r16uint,A.keywords.r16sint,A.keywords.r16float,A.keywords.rg8unorm,A.keywords.rg8snorm,A.keywords.rg8uint,A.keywords.rg8sint,A.keywords.r32uint,A.keywords.r32sint,A.keywords.r32float,A.keywords.rg16uint,A.keywords.rg16sint,A.keywords.rg16float,A.keywords.rgba8unorm,A.keywords.rgba8unorm_srgb,A.keywords.rgba8snorm,A.keywords.rgba8uint,A.keywords.rgba8sint,A.keywords.bgra8unorm,A.keywords.bgra8unorm_srgb,A.keywords.rgb10a2unorm,A.keywords.rg11b10float,A.keywords.rg32uint,A.keywords.rg32sint,A.keywords.rg32float,A.keywords.rgba16uint,A.keywords.rgba16sint,A.keywords.rgba16float,A.keywords.rgba32uint,A.keywords.rgba32sint,A.keywords.rgba32float],m.const_literal=[A.tokens.int_literal,A.tokens.uint_literal,A.tokens.decimal_float_literal,A.tokens.hex_float_literal,A.keywords.true,A.keywords.false],m.literal_or_ident=[A.tokens.ident,A.tokens.int_literal,A.tokens.uint_literal,A.tokens.decimal_float_literal,A.tokens.hex_float_literal,A.tokens.name],m.element_count_expression=[A.tokens.int_literal,A.tokens.uint_literal,A.tokens.ident],m.template_types=[A.keywords.vec2,A.keywords.vec3,A.keywords.vec4,A.keywords.mat2x2,A.keywords.mat2x3,A.keywords.mat2x4,A.keywords.mat3x2,A.keywords.mat3x3,A.keywords.mat3x4,A.keywords.mat4x2,A.keywords.mat4x3,A.keywords.mat4x4,A.keywords.atomic,A.keywords.bitcast,...A.any_texture_type],m.attribute_name=[A.tokens.ident,A.keywords.block,A.keywords.diagnostic],m.assignment_operators=[A.tokens.equal,A.tokens.plus_equal,A.tokens.minus_equal,A.tokens.times_equal,A.tokens.division_equal,A.tokens.modulo_equal,A.tokens.and_equal,A.tokens.or_equal,A.tokens.xor_equal,A.tokens.shift_right_equal,A.tokens.shift_left_equal],m.increment_operators=[A.tokens.plus_plus,A.tokens.minus_minus];var Zs=class{constructor(t,e,n,s,i){this.type=t,this.lexeme=e,this.line=n,this.start=s,this.end=i}toString(){return this.lexeme}isTemplateType(){return m.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==m.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}},Ma=class{constructor(t){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=t??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Zs(m.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let t=this._advance();if(t==`
`)return this._line++,!0;if(this._isWhitespace(t))return!0;if(t=="/"){if(this._peekAhead()=="/"){for(;t!=`
`;){if(this._isAtEnd())return!0;t=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(t=this._advance(),t==`
`)this._line++;else if(t=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else t=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}let e=m.simpleTokens[t];if(e)return this._addToken(e),!0;let n=m.none,s=this._isAlpha(t),i=t==="_";if(this._isAlphaNumeric(t)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)t+=this._advance(),o=this._peekAhead()}if(s){let o=m.keywords[t];if(o)return this._addToken(o),!0}if(s||i)return this._addToken(m.tokens.ident),!0;for(;;){let o=this._findType(t),a=this._peekAhead();if(t=="-"&&this._tokens.length>0){if(a=="=")return this._current++,t+=a,this._addToken(m.tokens.minus_equal),!0;if(a=="-")return this._current++,t+=a,this._addToken(m.tokens.minus_minus),!0;let c=this._tokens.length-1;if((m.literal_or_ident.indexOf(this._tokens[c].type)!=-1||this._tokens[c].type==m.tokens.paren_right)&&a!=">")return this._addToken(o),!0}if(t==">"&&(a==">"||a=="=")){let c=!1,l=this._tokens.length-1;for(let u=0;u<5&&l>=0&&m.assignment_operators.indexOf(this._tokens[l].type)===-1;++u,--l)if(this._tokens[l].type===m.tokens.less_than){l>0&&this._tokens[l-1].isArrayOrTemplateType()&&(c=!0);break}if(c)return this._addToken(o),!0}if(o===m.none){let c=t,l=0,u=2;for(let h=0;h<u;++h)if(c+=this._peekAhead(h),o=this._findType(c),o!==m.none){l=h;break}if(o===m.none)return n!==m.none&&(this._current--,this._addToken(n),!0);t=c,this._current+=l+1}if(n=o,this._isAtEnd())break;t+=this._advance()}return n!==m.none&&(this._addToken(n),!0)}_findType(t){for(let n in m.regexTokens){let s=m.regexTokens[n];if(this._match(t,s.rule))return s}return m.literalTokens[t]||m.none}_match(t,e){let n=e.exec(t);return n&&n.index==0&&n[0]==t}_isAtEnd(){return this._current>=this._source.length}_isAlpha(t){return!this._isNumeric(t)&&!this._isWhitespace(t)&&t!=="_"&&t!=="."&&t!=="("&&t!==")"&&t!=="["&&t!=="]"&&t!=="{"&&t!=="}"&&t!==","&&t!==";"&&t!==":"&&t!=="="&&t!=="!"&&t!=="<"&&t!==">"&&t!=="+"&&t!=="-"&&t!=="*"&&t!=="/"&&t!=="%"&&t!=="&"&&t!=="|"&&t!=="^"&&t!=="~"&&t!=="@"&&t!=="#"&&t!=="?"&&t!=="'"&&t!=="`"&&t!=='"'&&t!=="\\"&&t!==`
`&&t!=="\r"&&t!=="	"&&t!=="\0"}_isNumeric(t){return t>="0"&&t<="9"}_isAlphaNumeric(t){return this._isAlpha(t)||this._isNumeric(t)||t==="_"}_isWhitespace(t){return t==" "||t=="	"||t=="\r"}_advance(t=0){let e=this._source[this._current];return t=t||0,t++,this._current+=t,e}_peekAhead(t=0){return t=t||0,this._current+t>=this._source.length?"\0":this._source[this._current+t]}_addToken(t){let e=this._source.substring(this._start,this._current);this._tokens.push(new Zs(t,e,this._line,this._start,this._current))}};function N(r){return Array.isArray(r)||r?.buffer instanceof ArrayBuffer}var Ks=new Float32Array(1),_m=new Uint32Array(Ks.buffer),ym=new Uint32Array(Ks.buffer),Js=new Int32Array(1),xm=new Float32Array(Js.buffer),bm=new Uint32Array(Js.buffer),Qs=new Uint32Array(1),wm=new Float32Array(Qs.buffer),vm=new Int32Array(Qs.buffer);function eh(r,t,e){if(t===e)return r;if(t==="f32"){if(e==="i32"||e==="x32")return Ks[0]=r,_m[0];if(e==="u32")return Ks[0]=r,ym[0]}else if(t==="i32"||t==="x32"){if(e==="f32")return Js[0]=r,xm[0];if(e==="u32")return Js[0]=r,bm[0]}else if(t==="u32"){if(e==="f32")return Qs[0]=r,wm[0];if(e==="i32"||e==="x32")return Qs[0]=r,vm[0]}return console.error(`Unsupported cast from ${t} to ${e}`),r}var La=class{constructor(t){this.resources=null,this.inUse=!1,this.info=null,this.node=t}},An=class{constructor(t,e){this.align=t,this.size=e}},Xe=class r{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new ka,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(t){return t.name=="texture_storage_1d"||t.name=="texture_storage_2d"||t.name=="texture_storage_2d_array"||t.name=="texture_storage_3d"}updateAST(t){for(let e of t)e instanceof Ze&&this._functions.set(e.name,new La(e));for(let e of t)if(e instanceof $t){let n=this.getTypeInfo(e,null);n instanceof ee&&this.structs.push(n)}for(let e of t)if(e instanceof xr)this.aliases.push(this._getAliasInfo(e));else{if(e instanceof _r){let n=e,s=this._getAttributeNum(n.attributes,"id",0),i=n.type!=null?this.getTypeInfo(n.type,n.attributes):null;this.overrides.push(new wa(n.name,i,n.attributes,s));continue}if(this._isUniformVar(e)){let n=e,s=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=new En(n.name,o,s,i,n.attributes,Ae.Uniform,n.access);a.access||(a.access="read"),this.uniforms.push(a);continue}if(this._isStorageVar(e)){let n=e,s=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=this._isStorageTexture(o),c=new En(n.name,o,s,i,n.attributes,a?Ae.StorageTexture:Ae.Storage,n.access);c.access||(c.access="read"),this.storage.push(c);continue}if(this._isTextureVar(e)){let n=e,s=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=this._isStorageTexture(o),c=new En(n.name,o,s,i,n.attributes,a?Ae.StorageTexture:Ae.Texture,n.access);c.access||(c.access="read"),a?this.storage.push(c):this.textures.push(c);continue}if(this._isSamplerVar(e)){let n=e,s=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=new En(n.name,o,s,i,n.attributes,Ae.Sampler,n.access);this.samplers.push(a);continue}}for(let e of t)if(e instanceof Ze){let n=this._getAttribute(e,"vertex"),s=this._getAttribute(e,"fragment"),i=this._getAttribute(e,"compute"),o=n||s||i,a=new Ta(e.name,o?.name,e.attributes);a.attributes=e.attributes,a.startLine=e.startLine,a.endLine=e.endLine,this.functions.push(a),this._functions.get(e.name).info=a,o&&(this._functions.get(e.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(e,!!o),a.inputs=this._getInputs(e.args),a.outputs=this._getOutputs(e.returnType),this.entry[o.name].push(a)),a.arguments=e.args.map(c=>new va(c.name,this.getTypeInfo(c.type,c.attributes),c.attributes)),a.returnType=e.returnType?this.getTypeInfo(e.returnType,e.attributes):null;continue}for(let e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(let e of this._functions.values())e.node.search(n=>{var s,i,o;if(n instanceof Xs){if(n.value)if(N(n.value))for(let a of n.value)for(let c of this.overrides)a===c.name&&((s=e.info)===null||s===void 0||s.overrides.push(c));else for(let a of this.overrides)n.value===a.name&&((i=e.info)===null||i===void 0||i.overrides.push(a))}else if(n instanceof vt)for(let a of this.overrides)n.name===a.name&&((o=e.info)===null||o===void 0||o.overrides.push(a))});for(let e of this.uniforms)this._markStructsInUse(e.type);for(let e of this.storage)this._markStructsInUse(e.type)}getFunctionInfo(t){for(let e of this.functions)if(e.name==t)return e;return null}getStructInfo(t){for(let e of this.structs)if(e.name==t)return e;return null}getOverrideInfo(t){for(let e of this.overrides)if(e.name==t)return e;return null}_markStructsInUse(t){if(t)if(t.isStruct){if(t.inUse=!0,t.members)for(let e of t.members)this._markStructsInUse(e.type)}else if(t.isArray)this._markStructsInUse(t.format);else if(t.isTemplate)t.format&&this._markStructsInUse(t.format);else{let e=this._getAlias(t.name);e&&this._markStructsInUse(e)}}_addCalls(t,e){var n;for(let s of t.calls){let i=(n=this._functions.get(s.name))===null||n===void 0?void 0:n.info;i&&e.add(i)}}findResource(t,e,n){if(n){for(let s of this.entry.compute)if(s.name===n){for(let i of s.resources)if(i.group==t&&i.binding==e)return i}for(let s of this.entry.vertex)if(s.name===n){for(let i of s.resources)if(i.group==t&&i.binding==e)return i}for(let s of this.entry.fragment)if(s.name===n){for(let i of s.resources)if(i.group==t&&i.binding==e)return i}}for(let s of this.uniforms)if(s.group==t&&s.binding==e)return s;for(let s of this.storage)if(s.group==t&&s.binding==e)return s;for(let s of this.textures)if(s.group==t&&s.binding==e)return s;for(let s of this.samplers)if(s.group==t&&s.binding==e)return s;return null}_findResource(t){for(let e of this.uniforms)if(e.name==t)return e;for(let e of this.storage)if(e.name==t)return e;for(let e of this.textures)if(e.name==t)return e;for(let e of this.samplers)if(e.name==t)return e;return null}_markStructsFromAST(t){let e=this.getTypeInfo(t,null);this._markStructsInUse(e)}_findResources(t,e){let n=[],s=this,i=[];return t.search(o=>{if(o instanceof Cn)i.push({});else if(o instanceof On)i.pop();else if(o instanceof Wt){let a=o;e&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof Vt){let a=o;e&&a.type!==null&&this._markStructsFromAST(a.type)}else if(o instanceof qe){let a=o;e&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof vt){let a=o;if(i.length>0&&i[i.length-1][a.name])return;let c=s._findResource(a.name);c&&n.push(c)}else if(o instanceof br){let a=o,c=s._functions.get(a.name);c&&(e&&(c.inUse=!0),t.calls.add(c.node),c.resources===null&&(c.resources=s._findResources(c.node,e)),n.push(...c.resources))}else if(o instanceof yr){let a=o,c=s._functions.get(a.name);c&&(e&&(c.inUse=!0),t.calls.add(c.node),c.resources===null&&(c.resources=s._findResources(c.node,e)),n.push(...c.resources))}}),[...new Map(n.map(o=>[o.name,o])).values()]}getBindGroups(){let t=[];function e(n,s){n>=t.length&&(t.length=n+1),t[n]===void 0&&(t[n]=[]),s>=t[n].length&&(t[n].length=s+1)}for(let n of this.uniforms)e(n.group,n.binding),t[n.group][n.binding]=n;for(let n of this.storage)e(n.group,n.binding),t[n.group][n.binding]=n;for(let n of this.textures)e(n.group,n.binding),t[n.group][n.binding]=n;for(let n of this.samplers)e(n.group,n.binding),t[n.group][n.binding]=n;return t}_getOutputs(t,e=void 0){if(e===void 0&&(e=[]),t instanceof $t)this._getStructOutputs(t,e);else{let n=this._getOutputInfo(t);n!==null&&e.push(n)}return e}_getStructOutputs(t,e){for(let n of t.members)if(n.type instanceof $t)this._getStructOutputs(n.type,e);else{let s=this._getAttribute(n,"location")||this._getAttribute(n,"builtin");if(s!==null){let i=this.getTypeInfo(n.type,n.type.attributes),o=this._parseInt(s.value),a=new Is(n.name,i,s.name,o);e.push(a)}}}_getOutputInfo(t){let e=this._getAttribute(t,"location")||this._getAttribute(t,"builtin");if(e!==null){let n=this.getTypeInfo(t,t.attributes),s=this._parseInt(e.value);return new Is("",n,e.name,s)}return null}_getInputs(t,e=void 0){e===void 0&&(e=[]);for(let n of t)if(n.type instanceof $t)this._getStructInputs(n.type,e);else{let s=this._getInputInfo(n);s!==null&&e.push(s)}return e}_getStructInputs(t,e){for(let n of t.members)if(n.type instanceof $t)this._getStructInputs(n.type,e);else{let s=this._getInputInfo(n);s!==null&&e.push(s)}}_getInputInfo(t){let e=this._getAttribute(t,"location")||this._getAttribute(t,"builtin");if(e!==null){let n=this._getAttribute(t,"interpolation"),s=this.getTypeInfo(t.type,t.attributes),i=this._parseInt(e.value),o=new ba(t.name,s,e.name,i);return n!==null&&(o.interpolation=this._parseString(n.value)),o}return null}_parseString(t){return t instanceof Array&&(t=t[0]),t}_parseInt(t){t instanceof Array&&(t=t[0]);let e=parseInt(t);return isNaN(e)?t:e}_getAlias(t){for(let e of this.aliases)if(e.name==t)return e.type;return null}_getAliasInfo(t){return new xa(t.name,this.getTypeInfo(t.type,null))}getTypeInfoByName(t){for(let e of this.structs)if(e.name==t)return e;for(let e of this.aliases)if(e.name==t)return e.type;return null}getTypeInfo(t,e=null){if(this._types.has(t))return this._types.get(t);if(t instanceof Pn){let s=t.type?this.getTypeInfo(t.type,t.attributes):null,i=new mr(t.name,s,e);return this._types.set(t,i),this._updateTypeInfo(i),i}if(t instanceof Ye){let s=t,i=s.format?this.getTypeInfo(s.format,s.attributes):null,o=new ne(s.name,e);return o.format=i,o.count=s.count,this._types.set(t,o),this._updateTypeInfo(o),o}if(t instanceof $t){let s=t,i=new ee(s.name,e);i.startLine=s.startLine,i.endLine=s.endLine;for(let o of s.members){let a=this.getTypeInfo(o.type,o.attributes);i.members.push(new As(o.name,a,o.attributes))}return this._types.set(t,i),this._updateTypeInfo(i),i}if(t instanceof He){let s=t,i=s.format instanceof C,o=s.format?i?this.getTypeInfo(s.format,null):new kt(s.format,null):null,a=new le(s.name,o,e,s.access);return this._types.set(t,a),this._updateTypeInfo(a),a}if(t instanceof E){let s=t,i=s.format?this.getTypeInfo(s.format,null):null,o=new le(s.name,i,e,s.access);return this._types.set(t,o),this._updateTypeInfo(o),o}let n=new kt(t.name,e);return this._types.set(t,n),this._updateTypeInfo(n),n}_updateTypeInfo(t){var e,n,s;let i=this._getTypeSize(t);if(t.size=(e=i?.size)!==null&&e!==void 0?e:0,t instanceof ne&&t.format){let o=this._getTypeSize(t.format);t.stride=Math.max((n=o?.size)!==null&&n!==void 0?n:0,(s=o?.align)!==null&&s!==void 0?s:0),this._updateTypeInfo(t.format)}t instanceof mr&&this._updateTypeInfo(t.format),t instanceof ee&&this._updateStructInfo(t)}_updateStructInfo(t){var e;let n=0,s=0,i=0,o=0;for(let a=0,c=t.members.length;a<c;++a){let l=t.members[a],u=this._getTypeSize(l);if(!u)continue;(e=this._getAlias(l.type.name))!==null&&e!==void 0||l.type;let h=u.align,f=u.size;n=this._roundUp(h,n+s),s=f,i=n,o=Math.max(o,h),l.offset=n,l.size=f,this._updateTypeInfo(l.type)}t.size=this._roundUp(o,i+s),t.align=o}_getTypeSize(t){var e,n;if(t==null)return null;let s=this._getAttributeNum(t.attributes,"size",0),i=this._getAttributeNum(t.attributes,"align",0);if(t instanceof As&&(t=t.type),t instanceof kt){let o=this._getAlias(t.name);o!==null&&(t=o)}{let o=r._typeInfo[t.name];if(o!==void 0){let a=((e=t.format)===null||e===void 0?void 0:e.name)==="f16"?2:1;return new An(Math.max(i,o.align/a),Math.max(s,o.size/a))}}{let o=r._typeInfo[t.name.substring(0,t.name.length-1)];if(o){let a=t.name[t.name.length-1]==="h"?2:1;return new An(Math.max(i,o.align/a),Math.max(s,o.size/a))}}if(t instanceof ne){let o=t,a=8,c=8,l=this._getTypeSize(o.format);return l!==null&&(c=l.size,a=l.align),c=o.count*this._getAttributeNum((n=t?.attributes)!==null&&n!==void 0?n:null,"stride",this._roundUp(a,c)),s&&(c=s),new An(Math.max(i,a),Math.max(s,c))}if(t instanceof ee){let o=0,a=0,c=0,l=0,u=0;for(let h of t.members){let f=this._getTypeSize(h.type);f!==null&&(o=Math.max(f.align,o),c=this._roundUp(f.align,c+l),l=f.size,u=c)}return a=this._roundUp(o,u+l),new An(Math.max(i,o),Math.max(s,a))}return null}_isUniformVar(t){return t instanceof Wt&&t.storage=="uniform"}_isStorageVar(t){return t instanceof Wt&&t.storage=="storage"}_isTextureVar(t){return t instanceof Wt&&t.type!==null&&r._textureTypes.indexOf(t.type.name)!=-1}_isSamplerVar(t){return t instanceof Wt&&t.type!==null&&r._samplerTypes.indexOf(t.type.name)!=-1}_getAttribute(t,e){let n=t;if(!n||!n.attributes)return null;let s=n.attributes;for(let i of s)if(i.name==e)return i;return null}_getAttributeNum(t,e,n){if(t===null)return n;for(let s of t)if(s.name==e){let i=s!==null&&s.value!==null?s.value:n;return i instanceof Array&&(i=i[0]),typeof i=="number"?i:typeof i=="string"?parseInt(i):n}return n}_roundUp(t,e){return Math.ceil(e/t)*t}};Xe._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Xe._textureTypes=m.any_texture_type.map(r=>r.name),Xe._samplerTypes=m.sampler_type.map(r=>r.name);var Ba=0,Ca=class r{constructor(t,e,n){this.id=Ba++,this.name=t,this.value=e,this.node=n}clone(){return new r(this.name,this.value,this.node)}},Oa=class r{constructor(t){this.id=Ba++,this.name=t.name,this.node=t}clone(){return new r(this.node)}},Ra=class r{constructor(t){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=Ba++,t&&(this.parent=t,this.currentFunctionName=t.currentFunctionName)}getVariable(t){var e;return this.variables.has(t)?(e=this.variables.get(t))!==null&&e!==void 0?e:null:this.parent?this.parent.getVariable(t):null}getFunction(t){var e;return this.functions.has(t)?(e=this.functions.get(t))!==null&&e!==void 0?e:null:this.parent?this.parent.getFunction(t):null}createVariable(t,e,n){this.variables.set(t,new Ca(t,e,n??null))}setVariable(t,e,n){let s=this.getVariable(t);s!==null?s.value=e:this.createVariable(t,e,n)}getVariableValue(t){var e;let n=this.getVariable(t);return(e=n?.value)!==null&&e!==void 0?e:null}clone(){return new r(this)}},Na=class{evalExpression(t,e){return null}getTypeInfo(t){return null}getVariableName(t,e){return""}},Da=class{constructor(t){this.exec=t}getTypeInfo(t){return this.exec.getTypeInfo(t)}All(t,e){let n=this.exec.evalExpression(t.args[0],e),s=!0;if(n instanceof g)return n.data.forEach(i=>{i||(s=!1)}),new v(s?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${t.line}`)}Any(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g){let s=n.data.some(i=>i);return new v(s?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${t.line}`)}Select(t,e){let n=this.exec.evalExpression(t.args[2],e);if(!(n instanceof v))throw new Error(`Select() expects a bool condition. Line ${t.line}`);return n.value?this.exec.evalExpression(t.args[1],e):this.exec.evalExpression(t.args[0],e)}ArrayLength(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.evalExpression(n,e);if(s instanceof lt&&s.typeInfo.size===0){let i=s.typeInfo,o=s.buffer.byteLength/i.stride;return new v(o,this.getTypeInfo("u32"))}return new v(s.typeInfo.size,this.getTypeInfo("u32"))}Abs(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.abs(i)),n.typeInfo);let s=n;return new v(Math.abs(s.value),s.typeInfo)}Acos(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.acos(i)),n.typeInfo);let s=n;return new v(Math.acos(s.value),n.typeInfo)}Acosh(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.acosh(i)),n.typeInfo);let s=n;return new v(Math.acosh(s.value),n.typeInfo)}Asin(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.asin(i)),n.typeInfo);let s=n;return new v(Math.asin(s.value),n.typeInfo)}Asinh(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.asinh(i)),n.typeInfo);let s=n;return new v(Math.asinh(s.value),n.typeInfo)}Atan(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.atan(i)),n.typeInfo);let s=n;return new v(Math.atan(s.value),n.typeInfo)}Atanh(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.atanh(i)),n.typeInfo);let s=n;return new v(Math.atanh(s.value),n.typeInfo)}Atan2(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g)return new g(n.data.map((a,c)=>Math.atan2(a,s.data[c])),n.typeInfo);let i=n,o=s;return new v(Math.atan2(i.value,o.value),n.typeInfo)}Ceil(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.ceil(i)),n.typeInfo);let s=n;return new v(Math.ceil(s.value),n.typeInfo)}_clamp(t,e,n){return Math.min(Math.max(t,e),n)}Clamp(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e);if(n instanceof g&&s instanceof g&&i instanceof g)return new g(n.data.map((l,u)=>this._clamp(l,s.data[u],i.data[u])),n.typeInfo);let o=n,a=s,c=i;return new v(this._clamp(o.value,a.value,c.value),n.typeInfo)}Cos(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.cos(i)),n.typeInfo);let s=n;return new v(Math.cos(s.value),n.typeInfo)}Cosh(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.cosh(i)),n.typeInfo);let s=n;return new v(Math.cos(s.value),n.typeInfo)}CountLeadingZeros(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.clz32(i)),n.typeInfo);let s=n;return new v(Math.clz32(s.value),n.typeInfo)}_countOneBits(t){let e=0;for(;t!==0;)1&t&&e++,t>>=1;return e}CountOneBits(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>this._countOneBits(i)),n.typeInfo);let s=n;return new v(this._countOneBits(s.value),n.typeInfo)}_countTrailingZeros(t){if(t===0)return 32;let e=0;for(;!(1&t);)t>>=1,e++;return e}CountTrailingZeros(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>this._countTrailingZeros(i)),n.typeInfo);let s=n;return new v(this._countTrailingZeros(s.value),n.typeInfo)}Cross(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g){if(n.data.length!==3||s.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${t.line}`),null;let i=n.data,o=s.data;return new g([i[1]*o[2]-o[1]*i[2],i[2]*o[0]-o[2]*i[0],i[0]*o[1]-o[0]*i[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${t.line}`),null}Degrees(t,e){let n=this.exec.evalExpression(t.args[0],e),s=180/Math.PI;return n instanceof g?new g(n.data.map(i=>i*s),n.typeInfo):new v(n.value*s,this.getTypeInfo("f32"))}Determinant(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof z){let s=n.data,i=n.typeInfo.getTypeName(),o=i.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(i==="mat2x2"||i==="mat2x2f"||i==="mat2x2h")return new v(s[0]*s[3]-s[1]*s[2],o);if(i==="mat2x3"||i==="mat2x3f"||i==="mat2x3h")return new v(s[0]*(s[4]*s[8]-s[5]*s[7])-s[1]*(s[3]*s[8]-s[5]*s[6])+s[2]*(s[3]*s[7]-s[4]*s[6]),o);if(i==="mat2x4"||i==="mat2x4f"||i==="mat2x4h")console.error(`TODO: Determinant for ${i}`);else if(i==="mat3x2"||i==="mat3x2f"||i==="mat3x2h")console.error(`TODO: Determinant for ${i}`);else{if(i==="mat3x3"||i==="mat3x3f"||i==="mat3x3h")return new v(s[0]*(s[4]*s[8]-s[5]*s[7])-s[1]*(s[3]*s[8]-s[5]*s[6])+s[2]*(s[3]*s[7]-s[4]*s[6]),o);i==="mat3x4"||i==="mat3x4f"||i==="mat3x4h"||i==="mat4x2"||i==="mat4x2f"||i==="mat4x2h"||i==="mat4x3"||i==="mat4x3f"||i==="mat4x3h"?console.error(`TODO: Determinant for ${i}`):i!=="mat4x4"&&i!=="mat4x4f"&&i!=="mat4x4h"||console.error(`TODO: Determinant for ${i}`)}}return console.error(`Determinant expects a matrix argument. Line ${t.line}`),null}Distance(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g){let a=0;for(let c=0;c<n.data.length;++c)a+=(n.data[c]-s.data[c])*(n.data[c]-s.data[c]);return new v(Math.sqrt(a),this.getTypeInfo("f32"))}let i=n,o=s;return new v(Math.abs(i.value-o.value),n.typeInfo)}_dot(t,e){let n=0;for(let s=0;s<t.length;++s)n+=e[s]*t[s];return n}Dot(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);return n instanceof g&&s instanceof g?new v(this._dot(n.data,s.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${t.line}`),null)}Dot4U8Packed(t,e){return console.error(`TODO: dot4U8Packed. Line ${t.line}`),null}Dot4I8Packed(t,e){return console.error(`TODO: dot4I8Packed. Line ${t.line}`),null}Exp(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.exp(i)),n.typeInfo);let s=n;return new v(Math.exp(s.value),n.typeInfo)}Exp2(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.pow(2,i)),n.typeInfo);let s=n;return new v(Math.pow(2,s.value),n.typeInfo)}ExtractBits(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e);if(s.typeInfo.name!=="u32"&&s.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${t.line}`),null;if(i.typeInfo.name!=="u32"&&i.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${t.line}`),null;let o=s.value,a=i.value;if(n instanceof g)return new g(n.data.map(l=>l>>o&(1<<a)-1),n.typeInfo);if(n.typeInfo.name!=="i32"&&n.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${t.line}`),null;let c=n.value;return new v(c>>o&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e);if(n instanceof g&&s instanceof g&&i instanceof g){let o=this._dot(s.data,i.data);return new g(o<0?Array.from(n.data):n.data.map(a=>-a),n.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${t.line}`),null}_firstLeadingBit(t){return t===0?-1:31-Math.clz32(t)}FirstLeadingBit(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>this._firstLeadingBit(i)),n.typeInfo);let s=n;return new v(this._firstLeadingBit(s.value),n.typeInfo)}_firstTrailingBit(t){return t===0?-1:Math.log2(t&-t)}FirstTrailingBit(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>this._firstTrailingBit(i)),n.typeInfo);let s=n;return new v(this._firstTrailingBit(s.value),n.typeInfo)}Floor(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.floor(i)),n.typeInfo);let s=n;return new v(Math.floor(s.value),n.typeInfo)}Fma(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e);if(n instanceof g&&s instanceof g&&i instanceof g)return n.data.length!==s.data.length||n.data.length!==i.data.length?(console.error(`Fma() expects vectors of the same length. Line ${t.line}`),null):new g(n.data.map((l,u)=>l*s.data[u]+i.data[u]),n.typeInfo);let o=n,a=s,c=i;return new v(o.value*a.value+c.value,o.typeInfo)}Fract(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>i-Math.floor(i)),n.typeInfo);let s=n;return new v(s.value-Math.floor(s.value),n.typeInfo)}Frexp(t,e){return console.error(`TODO: frexp. Line ${t.line}`),null}InsertBits(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e),o=this.exec.evalExpression(t.args[3],e);if(i.typeInfo.name!=="u32"&&i.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${t.line}`),null;let a=i.value,c=(1<<o.value)-1<<a,l=~c;if(n instanceof g&&s instanceof g)return new g(n.data.map((f,p)=>f&l|s.data[p]<<a&c),n.typeInfo);let u=n.value,h=s.value;return new v(u&l|h<<a&c,n.typeInfo)}InverseSqrt(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>1/Math.sqrt(i)),n.typeInfo);let s=n;return new v(1/Math.sqrt(s.value),n.typeInfo)}Ldexp(t,e){return console.error(`TODO: ldexp. Line ${t.line}`),null}Length(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g){let i=0;return n.data.forEach(o=>{i+=o*o}),new v(Math.sqrt(i),this.getTypeInfo("f32"))}let s=n;return new v(Math.abs(s.value),n.typeInfo)}Log(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.log(i)),n.typeInfo);let s=n;return new v(Math.log(s.value),n.typeInfo)}Log2(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.log2(i)),n.typeInfo);let s=n;return new v(Math.log2(s.value),n.typeInfo)}Max(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g)return new g(n.data.map((a,c)=>Math.max(a,s.data[c])),n.typeInfo);let i=n,o=s;return new v(Math.max(i.value,o.value),n.typeInfo)}Min(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g)return new g(n.data.map((a,c)=>Math.min(a,s.data[c])),n.typeInfo);let i=n,o=s;return new v(Math.min(i.value,o.value),n.typeInfo)}Mix(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e);if(n instanceof g&&s instanceof g&&i instanceof g)return new g(n.data.map((c,l)=>n.data[l]*(1-i.data[l])+s.data[l]*i.data[l]),n.typeInfo);let o=s,a=i;return new v(n.value*(1-a.value)+o.value*a.value,n.typeInfo)}Modf(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g)return new g(n.data.map((o,a)=>o%s.data[a]),n.typeInfo);let i=s;return new v(n.value%i.value,n.typeInfo)}Normalize(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g){let s=this.Length(t,e).value;return new g(n.data.map(i=>i/s),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${t.line}`),null}Pow(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g)return new g(n.data.map((a,c)=>Math.pow(a,s.data[c])),n.typeInfo);let i=n,o=s;return new v(Math.pow(i.value,o.value),n.typeInfo)}QuantizeToF16(t,e){let n=this.exec.evalExpression(t.args[0],e);return n instanceof g?new g(n.data.map(s=>s),n.typeInfo):new v(n.value,n.typeInfo)}Radians(t,e){let n=this.exec.evalExpression(t.args[0],e);return n instanceof g?new g(n.data.map(s=>s*Math.PI/180),n.typeInfo):new v(n.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(n instanceof g&&s instanceof g){let i=this._dot(n.data,s.data);return new g(n.data.map((o,a)=>o-2*i*s.data[a]),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${t.line}`),null}Refract(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e);if(n instanceof g&&s instanceof g&&i instanceof v){let o=this._dot(s.data,n.data);return new g(n.data.map((a,c)=>{let l=1-i.value*i.value*(1-o*o);if(l<0)return 0;let u=Math.sqrt(l);return i.value*a-(i.value*o+u)*s.data[c]}),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${t.line}`),null}ReverseBits(t,e){return console.error(`TODO: reverseBits. Line ${t.line}`),null}Round(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.round(i)),n.typeInfo);let s=n;return new v(Math.round(s.value),n.typeInfo)}Saturate(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.min(Math.max(i,0),1)),n.typeInfo);let s=n;return new v(Math.min(Math.max(s.value,0),1),n.typeInfo)}Sign(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.sign(i)),n.typeInfo);let s=n;return new v(Math.sign(s.value),n.typeInfo)}Sin(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.sin(i)),n.typeInfo);let s=n;return new v(Math.sin(s.value),n.typeInfo)}Sinh(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.sinh(i)),n.typeInfo);let s=n;return new v(Math.sinh(s.value),n.typeInfo)}_smoothstep(t,e,n){let s=Math.min(Math.max((n-t)/(e-t),0),1);return s*s*(3-2*s)}SmoothStep(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e),i=this.exec.evalExpression(t.args[2],e);if(i instanceof g&&n instanceof g&&s instanceof g)return new g(i.data.map((l,u)=>this._smoothstep(n.data[u],s.data[u],l)),i.typeInfo);let o=n,a=s,c=i;return new v(this._smoothstep(o.value,a.value,c.value),i.typeInfo)}Sqrt(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.sqrt(i)),n.typeInfo);let s=n;return new v(Math.sqrt(s.value),n.typeInfo)}Step(t,e){let n=this.exec.evalExpression(t.args[0],e),s=this.exec.evalExpression(t.args[1],e);if(s instanceof g&&n instanceof g)return new g(s.data.map((o,a)=>o<n.data[a]?0:1),s.typeInfo);let i=n;return new v(s.value<i.value?0:1,i.typeInfo)}Tan(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.tan(i)),n.typeInfo);let s=n;return new v(Math.tan(s.value),n.typeInfo)}Tanh(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.tanh(i)),n.typeInfo);let s=n;return new v(Math.tanh(s.value),n.typeInfo)}_getTransposeType(t){let e=t.getTypeName();return e==="mat2x2f"||e==="mat2x2h"?t:e==="mat2x3f"?this.getTypeInfo("mat3x2f"):e==="mat2x3h"?this.getTypeInfo("mat3x2h"):e==="mat2x4f"?this.getTypeInfo("mat4x2f"):e==="mat2x4h"?this.getTypeInfo("mat4x2h"):e==="mat3x2f"?this.getTypeInfo("mat2x3f"):e==="mat3x2h"?this.getTypeInfo("mat2x3h"):e==="mat3x3f"||e==="mat3x3h"?t:e==="mat3x4f"?this.getTypeInfo("mat4x3f"):e==="mat3x4h"?this.getTypeInfo("mat4x3h"):e==="mat4x2f"?this.getTypeInfo("mat2x4f"):e==="mat4x2h"?this.getTypeInfo("mat2x4h"):e==="mat4x3f"?this.getTypeInfo("mat3x4f"):e==="mat4x3h"?this.getTypeInfo("mat3x4h"):(e==="mat4x4f"||e==="mat4x4h"||console.error(`Invalid matrix type ${e}`),t)}Transpose(t,e){let n=this.exec.evalExpression(t.args[0],e);if(!(n instanceof z))return console.error(`Transpose() expects a matrix argument. Line ${t.line}`),null;let s=this._getTransposeType(n.typeInfo);if(n.typeInfo.name==="mat2x2"||n.typeInfo.name==="mat2x2f"||n.typeInfo.name==="mat2x2h"){let i=n.data;return new z([i[0],i[2],i[1],i[3]],s)}if(n.typeInfo.name==="mat2x3"||n.typeInfo.name==="mat2x3f"||n.typeInfo.name==="mat2x3h"){let i=n.data;return new z([i[0],i[3],i[6],i[1],i[4],i[7]],s)}if(n.typeInfo.name==="mat2x4"||n.typeInfo.name==="mat2x4f"||n.typeInfo.name==="mat2x4h"){let i=n.data;return new z([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13]],s)}if(n.typeInfo.name==="mat3x2"||n.typeInfo.name==="mat3x2f"||n.typeInfo.name==="mat3x2h"){let i=n.data;return new z([i[0],i[3],i[1],i[4],i[2],i[5]],s)}if(n.typeInfo.name==="mat3x3"||n.typeInfo.name==="mat3x3f"||n.typeInfo.name==="mat3x3h"){let i=n.data;return new z([i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]],s)}if(n.typeInfo.name==="mat3x4"||n.typeInfo.name==="mat3x4f"||n.typeInfo.name==="mat3x4h"){let i=n.data;return new z([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14]],s)}if(n.typeInfo.name==="mat4x2"||n.typeInfo.name==="mat4x2f"||n.typeInfo.name==="mat4x2h"){let i=n.data;return new z([i[0],i[4],i[1],i[5],i[2],i[6]],s)}if(n.typeInfo.name==="mat4x3"||n.typeInfo.name==="mat4x3f"||n.typeInfo.name==="mat4x3h"){let i=n.data;return new z([i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]],s)}if(n.typeInfo.name==="mat4x4"||n.typeInfo.name==="mat4x4f"||n.typeInfo.name==="mat4x4h"){let i=n.data;return new z([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14],i[3],i[7],i[11],i[15]],s)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(t,e){let n=this.exec.evalExpression(t.args[0],e);if(n instanceof g)return new g(n.data.map(i=>Math.trunc(i)),n.typeInfo);let s=n;return new v(Math.trunc(s.value),n.typeInfo)}Dpdx(t,e){return console.error(`TODO: dpdx. Line ${t.line}`),null}DpdxCoarse(t,e){return console.error(`TODO: dpdxCoarse. Line ${t.line}`),null}DpdxFine(t,e){return console.error("TODO: dpdxFine"),null}Dpdy(t,e){return console.error("TODO: dpdy"),null}DpdyCoarse(t,e){return console.error("TODO: dpdyCoarse"),null}DpdyFine(t,e){return console.error("TODO: dpdyFine"),null}Fwidth(t,e){return console.error("TODO: fwidth"),null}FwidthCoarse(t,e){return console.error("TODO: fwidthCoarse"),null}FwidthFine(t,e){return console.error("TODO: fwidthFine"),null}TextureDimensions(t,e){let n=t.args[0],s=t.args.length>1?this.exec.evalExpression(t.args[1],e).value:0;if(n instanceof vt){let i=n.name,o=e.getVariableValue(i);if(o instanceof ce){if(s<0||s>=o.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${t.line}`),null;let a=o.getMipLevelSize(s),c=o.dimension;return c==="1d"?new v(a[0],this.getTypeInfo("u32")):c==="3d"?new g(a,this.getTypeInfo("vec3u")):c==="2d"?new g(a.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${c} not found. Line ${t.line}`),null)}return console.error(`Texture ${i} not found. Line ${t.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${t.line}`),null}TextureGather(t,e){return console.error("TODO: textureGather"),null}TextureGatherCompare(t,e){return console.error("TODO: textureGatherCompare"),null}TextureLoad(t,e){let n=t.args[0],s=this.exec.evalExpression(t.args[1],e),i=t.args.length>2?this.exec.evalExpression(t.args[2],e).value:0;if(!(s instanceof g)||s.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${t.line}`),null;if(n instanceof vt){let o=n.name,a=e.getVariableValue(o);if(a instanceof ce){let c=Math.floor(s.data[0]),l=Math.floor(s.data[1]);if(c<0||c>=a.width||l<0||l>=a.height)return console.error(`Texture ${o} out of bounds. Line ${t.line}`),null;let u=a.getPixel(c,l,0,i);return u===null?(console.error(`Invalid texture format for textureLoad. Line ${t.line}`),null):new g(u,this.getTypeInfo("vec4f"))}return console.error(`Texture ${o} not found. Line ${t.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${t.line}`),null}TextureNumLayers(t,e){let n=t.args[0];if(n instanceof vt){let s=n.name,i=e.getVariableValue(s);return i instanceof ce?new v(i.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${t.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${t.line}`),null}TextureNumLevels(t,e){let n=t.args[0];if(n instanceof vt){let s=n.name,i=e.getVariableValue(s);return i instanceof ce?new v(i.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${t.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${t.line}`),null}TextureNumSamples(t,e){let n=t.args[0];if(n instanceof vt){let s=n.name,i=e.getVariableValue(s);return i instanceof ce?new v(i.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${s} not found. Line ${t.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${t.line}`),null}TextureSample(t,e){return console.error("TODO: textureSample"),null}TextureSampleBias(t,e){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(t,e){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(t,e){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(t,e){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(t,e){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(t,e){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(t,e){let n=t.args[0],s=this.exec.evalExpression(t.args[1],e),i=t.args.length===4?this.exec.evalExpression(t.args[2],e).value:0,o=t.args.length===4?this.exec.evalExpression(t.args[3],e).data:this.exec.evalExpression(t.args[2],e).data;if(o.length!==4)return console.error(`Invalid value argument for textureStore. Line ${t.line}`),null;if(!(s instanceof g)||s.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${t.line}`),null;if(n instanceof vt){let a=n.name,c=e.getVariableValue(a);if(c instanceof ce){let l=c.getMipLevelSize(0),u=Math.floor(s.data[0]),h=Math.floor(s.data[1]);return u<0||u>=l[0]||h<0||h>=l[1]?(console.error(`Texture ${a} out of bounds. Line ${t.line}`),null):(c.setPixel(u,h,0,i,Array.from(o)),null)}return console.error(`Texture ${a} not found. Line ${t.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${t.line}`),null}AtomicLoad(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e);return e.getVariable(s).value.getSubData(this.exec,n.postfix,e)}AtomicStore(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e);return c instanceof v&&a instanceof v&&(c.value=a.value),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),null}AtomicAdd(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value+=a.value),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicSub(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value-=a.value),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicMax(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value=Math.max(c.value,a.value)),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicMin(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value=Math.min(c.value,a.value)),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicAnd(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value=c.value&a.value),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicOr(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value=c.value|a.value),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicXor(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value=c.value^a.value),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicExchange(t,e){let n=t.args[0];n instanceof it&&(n=n.right);let s=this.exec.getVariableName(n,e),i=e.getVariable(s),o=t.args[1],a=this.exec.evalExpression(o,e),c=i.value.getSubData(this.exec,n.postfix,e),l=new v(c.value,c.typeInfo);return c instanceof v&&a instanceof v&&(c.value=a.value),i.value instanceof lt&&i.value.setDataValue(this.exec,c,n.postfix,e),l}AtomicCompareExchangeWeak(t,e){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(t,e){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(t,e){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(t,e){return console.error("TODO: pack4xI8"),null}Pack4xU8(t,e){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(t,e){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(t,e){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(t,e){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(t,e){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(t,e){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(t,e){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(t,e){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(t,e){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(t,e){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(t,e){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(t,e){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(t,e){return console.error("TODO: unpack2x16float"),null}StorageBarrier(t,e){return null}TextureBarrier(t,e){return null}WorkgroupBarrier(t,e){return null}WorkgroupUniformLoad(t,e){return null}SubgroupAdd(t,e){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(t,e){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(t,e){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(t,e){return console.error("TODO: subgroupAll"),null}SubgroupAnd(t,e){return console.error("TODO: subgroupAnd"),null}SubgroupAny(t,e){return console.error("TODO: subgroupAny"),null}SubgroupBallot(t,e){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(t,e){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(t,e){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(t,e){return console.error("TODO: subgroupElect"),null}SubgroupMax(t,e){return console.error("TODO: subgroupMax"),null}SubgroupMin(t,e){return console.error("TODO: subgroupMin"),null}SubgroupMul(t,e){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(t,e){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(t,e){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(t,e){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(t,e){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(t,e){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(t,e){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(t,e){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(t,e){return console.error("TODO: subgroupXor"),null}QuadBroadcast(t,e){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(t,e){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(t,e){return console.error("TODO: quadSwapX"),null}QuadSwapY(t,e){return console.error("TODO: quadSwapY"),null}},ya={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},wt={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]},Ln=class r extends Na{constructor(t,e){var n;super(),this.ast=t??[],this.reflection=new Xe,this.reflection.updateAST(this.ast),this.context=(n=e?.clone())!==null&&n!==void 0?n:new Ra,this.builtins=new Da(this),this.typeInfo={bool:this.getTypeInfo(C.bool),i32:this.getTypeInfo(C.i32),u32:this.getTypeInfo(C.u32),f32:this.getTypeInfo(C.f32),f16:this.getTypeInfo(C.f16),vec2f:this.getTypeInfo(E.vec2f),vec2u:this.getTypeInfo(E.vec2u),vec2i:this.getTypeInfo(E.vec2i),vec2h:this.getTypeInfo(E.vec2h),vec3f:this.getTypeInfo(E.vec3f),vec3u:this.getTypeInfo(E.vec3u),vec3i:this.getTypeInfo(E.vec3i),vec3h:this.getTypeInfo(E.vec3h),vec4f:this.getTypeInfo(E.vec4f),vec4u:this.getTypeInfo(E.vec4u),vec4i:this.getTypeInfo(E.vec4i),vec4h:this.getTypeInfo(E.vec4h),mat2x2f:this.getTypeInfo(E.mat2x2f),mat2x3f:this.getTypeInfo(E.mat2x3f),mat2x4f:this.getTypeInfo(E.mat2x4f),mat3x2f:this.getTypeInfo(E.mat3x2f),mat3x3f:this.getTypeInfo(E.mat3x3f),mat3x4f:this.getTypeInfo(E.mat3x4f),mat4x2f:this.getTypeInfo(E.mat4x2f),mat4x3f:this.getTypeInfo(E.mat4x3f),mat4x4f:this.getTypeInfo(E.mat4x4f)}}getVariableValue(t){var e,n;let s=(n=(e=this.context.getVariable(t))===null||e===void 0?void 0:e.value)!==null&&n!==void 0?n:null;if(s===null)return null;if(s instanceof v)return s.value;if(s instanceof g||s instanceof z)return Array.from(s.data);if(s instanceof lt&&s.typeInfo instanceof ne){if(s.typeInfo.format.name==="u32")return Array.from(new Uint32Array(s.buffer,s.offset,s.typeInfo.count));if(s.typeInfo.format.name==="i32")return Array.from(new Int32Array(s.buffer,s.offset,s.typeInfo.count));if(s.typeInfo.format.name==="f32")return Array.from(new Float32Array(s.buffer,s.offset,s.typeInfo.count))}return console.error(`Unsupported return variable type ${s.typeInfo.name}`),null}execute(t){(t=t??{}).constants&&this._setOverrides(t.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(t,e,n,s){let i=this.context.clone();(s=s??{}).constants&&this._setOverrides(s.constants,i),this._execStatements(this.ast,i);let o=i.getFunction(t);if(!o)return void console.error(`Function ${t} not found`);if(typeof e=="number")e=[e,1,1];else{if(e.length===0)return void console.error("Invalid dispatch count");e.length===1?e=[e[0],1,1]:e.length===2?e=[e[0],e[1],1]:e.length>3&&(e=[e[0],e[1],e[2]])}let a=e[0],c=e[1],l=e[2],u=this.getTypeInfo("vec3u");i.setVariable("@num_workgroups",new g(e,u));let h=this.reflection.getFunctionInfo(t);h===null&&console.error(`Function ${t} not found in reflection data`);for(let f in n)for(let p in n[f]){let _=n[f][p];i.variables.forEach(x=>{var y;let T=x.node;if(T?.attributes){let I=null,k=null;for(let S of T.attributes)S.name==="binding"?I=S.value:S.name==="group"&&(k=S.value);if(p==I&&f==k){let S=!1;for(let P of h.resources)if(P.name===x.name&&P.group===parseInt(f)&&P.binding===parseInt(p)){S=!0;break}if(S)if(_.texture!==void 0&&_.descriptor!==void 0){let P=new ce(_.texture,this.getTypeInfo(T.type),_.descriptor,(y=_.texture.view)!==null&&y!==void 0?y:null);x.value=P}else _.uniform!==void 0?x.value=new lt(_.uniform,this.getTypeInfo(T.type)):x.value=new lt(_,this.getTypeInfo(T.type))}}})}for(let f=0;f<l;++f)for(let p=0;p<c;++p)for(let _=0;_<a;++_)i.setVariable("@workgroup_id",new g([_,p,f],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(o,[_,p,f],i)}execStatement(t,e){if(t instanceof Ds)return this.evalExpression(t.value,e);if(t instanceof Vs){if(t.condition){let n=this.evalExpression(t.condition,e);if(!(n instanceof v))throw new Error("Invalid break-if condition");if(!n.value)return null}return r._breakObj}if(t instanceof Us)return r._continueObj;if(t instanceof qe)this._let(t,e);else if(t instanceof Wt)this._var(t,e);else if(t instanceof In)this._const(t,e);else if(t instanceof Ze)this._function(t,e);else{if(t instanceof Ns)return this._if(t,e);if(t instanceof Rs)return this._switch(t,e);if(t instanceof Ms)return this._for(t,e);if(t instanceof Ps)return this._while(t,e);if(t instanceof Os)return this._loop(t,e);if(t instanceof gr){let n=e.clone();return n.currentFunctionName=e.currentFunctionName,this._execStatements(t.body,n)}if(t instanceof Cs)this._assign(t,e);else if(t instanceof Ls)this._increment(t,e);else{if(t instanceof $t)return null;if(t instanceof _r){let n=t.name;e.getVariable(n)===null&&e.setVariable(n,new v(0,this.getTypeInfo("u32")))}else if(t instanceof yr)this._call(t,e);else{if(t instanceof Fs||t instanceof xr)return null;console.error("Invalid statement type.",t,`Line ${t.line}`)}}}return null}evalExpression(t,e){return t instanceof It?this._evalBinaryOp(t,e):t instanceof ct?this._evalLiteral(t,e):t instanceof vt?this._evalVariable(t,e):t instanceof br?this._evalCall(t,e):t instanceof Vt?this._evalCreate(t,e):t instanceof zs?this._evalConst(t,e):t instanceof js?this._evalBitcast(t,e):t instanceof it?this._evalUnaryOp(t,e):(console.error("Invalid expression type",t,`Line ${t.line}`),null)}getTypeInfo(t){var e;if(t instanceof C){let s=this.reflection.getTypeInfo(t);if(s!==null)return s}let n=(e=this.typeInfo[t])!==null&&e!==void 0?e:null;return n!==null||(n=this.reflection.getTypeInfoByName(t)),n}_setOverrides(t,e){for(let n in t){let s=t[n],i=this.reflection.getOverrideInfo(n);i!==null?(i.type===null&&(i.type=this.getTypeInfo("u32")),i.type.name==="u32"||i.type.name==="i32"||i.type.name==="f32"||i.type.name==="f16"?e.setVariable(n,new v(s,i.type)):i.type.name==="bool"?e.setVariable(n,new v(s?1:0,i.type)):i.type.name==="vec2"||i.type.name==="vec3"||i.type.name==="vec4"||i.type.name==="vec2f"||i.type.name==="vec3f"||i.type.name==="vec4f"||i.type.name==="vec2i"||i.type.name==="vec3i"||i.type.name==="vec4i"||i.type.name==="vec2u"||i.type.name==="vec3u"||i.type.name==="vec4u"||i.type.name==="vec2h"||i.type.name==="vec3h"||i.type.name==="vec4h"?e.setVariable(n,new g(s,i.type)):console.error(`Invalid constant type for ${n}`)):console.error(`Override ${n} does not exist in the shader.`)}}_dispatchWorkgroup(t,e,n){let s=[1,1,1];for(let u of t.node.attributes)if(u.name==="workgroup_size"){if(u.value.length>0){let h=n.getVariableValue(u.value[0]);s[0]=h instanceof v?h.value:parseInt(u.value[0])}if(u.value.length>1){let h=n.getVariableValue(u.value[1]);s[1]=h instanceof v?h.value:parseInt(u.value[1])}if(u.value.length>2){let h=n.getVariableValue(u.value[2]);s[2]=h instanceof v?h.value:parseInt(u.value[2])}}let i=this.getTypeInfo("vec3u"),o=this.getTypeInfo("u32");n.setVariable("@workgroup_size",new g(s,i));let a=s[0],c=s[1],l=s[2];for(let u=0,h=0;u<l;++u)for(let f=0;f<c;++f)for(let p=0;p<a;++p,++h){let _=[p,f,u],x=[p+e[0]*s[0],f+e[1]*s[1],u+e[2]*s[2]];n.setVariable("@local_invocation_id",new g(_,i)),n.setVariable("@global_invocation_id",new g(x,i)),n.setVariable("@local_invocation_index",new v(h,o)),this._dispatchExec(t,n)}}_dispatchExec(t,e){for(let n of t.node.args)for(let s of n.attributes)if(s.name==="builtin"){let i=`@${s.value}`,o=e.getVariable(i);o!==void 0&&e.variables.set(n.name,o)}this._execStatements(t.node.body,e)}getVariableName(t,e){for(;t instanceof it;)t=t.right;return t instanceof vt?t.name:(console.error("Unknown variable type",t,"Line",t.line),null)}_execStatements(t,e){for(let n of t){if(n instanceof Array){let i=e.clone(),o=this._execStatements(n,i);if(o)return o;continue}let s=this.execStatement(n,e);if(s)return s}return null}_call(t,e){let n=e.clone();n.currentFunctionName=t.name;let s=e.getFunction(t.name);if(s){for(let i=0;i<s.node.args.length;++i){let o=s.node.args[i],a=this.evalExpression(t.args[i],n);n.setVariable(o.name,a,o)}this._execStatements(s.node.body,n)}else t.isBuiltin?this._callBuiltinFunction(t,n):this.getTypeInfo(t.name)&&this._evalCreate(t,e)}_increment(t,e){let n=this.getVariableName(t.variable,e),s=e.getVariable(n);s?t.operator==="++"?s.value instanceof v?s.value.value++:console.error(`Variable ${n} is not a scalar. Line ${t.line}`):t.operator==="--"?s.value instanceof v?s.value.value--:console.error(`Variable ${n} is not a scalar. Line ${t.line}`):console.error(`Unknown increment operator ${t.operator}. Line ${t.line}`):console.error(`Variable ${n} not found. Line ${t.line}`)}_getVariableData(t,e){if(t instanceof vt){let n=this.getVariableName(t,e),s=e.getVariable(n);return s===null?(console.error(`Variable ${n} not found. Line ${t.line}`),null):s.value.getSubData(this,t.postfix,e)}if(t instanceof it){if(t.operator==="*"){let n=this._getVariableData(t.right,e);return n instanceof Ie?n.reference.getSubData(this,t.postfix,e):(console.error(`Variable ${t.right} is not a pointer. Line ${t.line}`),null)}if(t.operator==="&"){let n=this._getVariableData(t.right,e);return new Ie(n)}}return null}_assign(t,e){let n=null,s="<var>",i=null;if(t.variable instanceof it){let c=this._getVariableData(t.variable,e),l=this.evalExpression(t.value,e),u=t.operator;if(u==="="){if(c instanceof v||c instanceof g||c instanceof z){if(l instanceof v||l instanceof g||l instanceof z&&c.data.length===l.data.length)return void c.data.set(l.data);console.error(`Invalid assignment. Line ${t.line}`)}else if(c instanceof lt&&l instanceof lt&&c.buffer.byteLength-c.offset>=l.buffer.byteLength-l.offset)return void(c.buffer.byteLength%4==0?new Uint32Array(c.buffer,c.offset,c.typeInfo.size/4).set(new Uint32Array(l.buffer,l.offset,l.typeInfo.size/4)):new Uint8Array(c.buffer,c.offset,c.typeInfo.size).set(new Uint8Array(l.buffer,l.offset,l.typeInfo.size)));return console.error(`Invalid assignment. Line ${t.line}`),null}if(u==="+=")return c instanceof v||c instanceof g||c instanceof z?l instanceof v||l instanceof g||l instanceof z?void c.data.set(l.data.map((h,f)=>c.data[f]+h)):void console.error(`Invalid assignment . Line ${t.line}`):void console.error(`Invalid assignment. Line ${t.line}`);if(u==="-=")return(c instanceof v||c instanceof g||c instanceof z)&&(l instanceof v||l instanceof g||l instanceof z)?void c.data.set(l.data.map((h,f)=>c.data[f]-h)):void console.error(`Invalid assignment. Line ${t.line}`)}if(t.variable instanceof it){if(t.variable.operator==="*"){s=this.getVariableName(t.variable.right,e);let c=e.getVariable(s);if(!(c&&c.value instanceof Ie))return void console.error(`Variable ${s} is not a pointer. Line ${t.line}`);n=c.value.reference;let l=t.variable.postfix;if(!l){let u=t.variable.right;for(;u instanceof it;){if(u.postfix){l=u.postfix;break}u=u.right}}l&&(n=n.getSubData(this,l,e))}}else{i=t.variable.postfix,s=this.getVariableName(t.variable,e);let c=e.getVariable(s);if(c===null)return void console.error(`Variable ${s} not found. Line ${t.line}`);n=c.value}if(n instanceof Ie&&(n=n.reference),n===null)return void console.error(`Variable ${s} not found. Line ${t.line}`);let o=this.evalExpression(t.value,e),a=t.operator;if(a!=="="){let c=n.getSubData(this,i,e);if(c instanceof g&&o instanceof v){let l=c.data,u=o.value;if(a==="+=")for(let h=0;h<l.length;++h)l[h]+=u;else if(a==="-=")for(let h=0;h<l.length;++h)l[h]-=u;else if(a==="*=")for(let h=0;h<l.length;++h)l[h]*=u;else if(a==="/=")for(let h=0;h<l.length;++h)l[h]/=u;else if(a==="%=")for(let h=0;h<l.length;++h)l[h]%=u;else if(a==="&=")for(let h=0;h<l.length;++h)l[h]&=u;else if(a==="|=")for(let h=0;h<l.length;++h)l[h]|=u;else if(a==="^=")for(let h=0;h<l.length;++h)l[h]^=u;else if(a==="<<=")for(let h=0;h<l.length;++h)l[h]<<=u;else if(a===">>=")for(let h=0;h<l.length;++h)l[h]>>=u;else console.error(`Invalid operator ${a}. Line ${t.line}`)}else if(c instanceof g&&o instanceof g){let l=c.data,u=o.data;if(l.length!==u.length)return void console.error(`Vector length mismatch. Line ${t.line}`);if(a==="+=")for(let h=0;h<l.length;++h)l[h]+=u[h];else if(a==="-=")for(let h=0;h<l.length;++h)l[h]-=u[h];else if(a==="*=")for(let h=0;h<l.length;++h)l[h]*=u[h];else if(a==="/=")for(let h=0;h<l.length;++h)l[h]/=u[h];else if(a==="%=")for(let h=0;h<l.length;++h)l[h]%=u[h];else if(a==="&=")for(let h=0;h<l.length;++h)l[h]&=u[h];else if(a==="|=")for(let h=0;h<l.length;++h)l[h]|=u[h];else if(a==="^=")for(let h=0;h<l.length;++h)l[h]^=u[h];else if(a==="<<=")for(let h=0;h<l.length;++h)l[h]<<=u[h];else if(a===">>=")for(let h=0;h<l.length;++h)l[h]>>=u[h];else console.error(`Invalid operator ${a}. Line ${t.line}`)}else{if(!(c instanceof v&&o instanceof v))return void console.error(`Invalid type for ${t.operator} operator. Line ${t.line}`);a==="+="?c.value+=o.value:a==="-="?c.value-=o.value:a==="*="?c.value*=o.value:a==="/="?c.value/=o.value:a==="%="?c.value%=o.value:a==="&="?c.value&=o.value:a==="|="?c.value|=o.value:a==="^="?c.value^=o.value:a==="<<="?c.value<<=o.value:a===">>="?c.value>>=o.value:console.error(`Invalid operator ${a}. Line ${t.line}`)}return void(n instanceof lt&&n.setDataValue(this,c,i,e))}if(n instanceof lt)n.setDataValue(this,o,i,e);else if(i){if(!(n instanceof g||n instanceof z))return void console.error(`Variable ${s} is not a vector or matrix. Line ${t.line}`);if(i instanceof Pe){let c=this.evalExpression(i.index,e).value;if(n instanceof g){if(!(o instanceof v))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[c]=o.value}else{if(!(n instanceof z))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);{let l=this.evalExpression(i.index,e).value;if(l<0)return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);if(!(o instanceof g))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);{let u=n.typeInfo.getTypeName();if(u==="mat2x2"||u==="mat2x2f"||u==="mat2x2h"){if(!(l<2&&o.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[2*l]=o.data[0],n.data[2*l+1]=o.data[1]}else if(u==="mat2x3"||u==="mat2x3f"||u==="mat2x3h"){if(!(l<2&&o.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[3*l]=o.data[0],n.data[3*l+1]=o.data[1],n.data[3*l+2]=o.data[2]}else if(u==="mat2x4"||u==="mat2x4f"||u==="mat2x4h"){if(!(l<2&&o.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[4*l]=o.data[0],n.data[4*l+1]=o.data[1],n.data[4*l+2]=o.data[2],n.data[4*l+3]=o.data[3]}else if(u==="mat3x2"||u==="mat3x2f"||u==="mat3x2h"){if(!(l<3&&o.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[2*l]=o.data[0],n.data[2*l+1]=o.data[1]}else if(u==="mat3x3"||u==="mat3x3f"||u==="mat3x3h"){if(!(l<3&&o.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[3*l]=o.data[0],n.data[3*l+1]=o.data[1],n.data[3*l+2]=o.data[2]}else if(u==="mat3x4"||u==="mat3x4f"||u==="mat3x4h"){if(!(l<3&&o.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[4*l]=o.data[0],n.data[4*l+1]=o.data[1],n.data[4*l+2]=o.data[2],n.data[4*l+3]=o.data[3]}else if(u==="mat4x2"||u==="mat4x2f"||u==="mat4x2h"){if(!(l<4&&o.data.length===2))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[2*l]=o.data[0],n.data[2*l+1]=o.data[1]}else if(u==="mat4x3"||u==="mat4x3f"||u==="mat4x3h"){if(!(l<4&&o.data.length===3))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[3*l]=o.data[0],n.data[3*l+1]=o.data[1],n.data[3*l+2]=o.data[2]}else{if(u!=="mat4x4"&&u!=="mat4x4f"&&u!=="mat4x4h")return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);if(!(l<4&&o.data.length===4))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);n.data[4*l]=o.data[0],n.data[4*l+1]=o.data[1],n.data[4*l+2]=o.data[2],n.data[4*l+3]=o.data[3]}}}}}else if(i instanceof ue){let c=i.value;if(!(n instanceof g))return void console.error(`Invalid assignment to ${c}. Variable ${s} is not a vector. Line ${t.line}`);if(o instanceof v){if(c.length>1)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${t.line}`);if(c==="x")n.data[0]=o.value;else if(c==="y"){if(n.data.length<2)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${t.line}`);n.data[1]=o.value}else if(c==="z"){if(n.data.length<3)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${t.line}`);n.data[2]=o.value}else if(c==="w"){if(n.data.length<4)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${t.line}`);n.data[3]=o.value}}else{if(!(o instanceof g))return void console.error(`Invalid assignment to ${s}. Line ${t.line}`);if(c.length!==o.data.length)return void console.error(`Invalid assignment to ${c} for variable ${s}. Line ${t.line}`);for(let l=0;l<c.length;++l){let u=c[l];if(u==="x"||u==="r")n.data[0]=o.data[l];else if(u==="y"||u==="g"){if(o.data.length<2)return void console.error(`Invalid assignment to ${u} for variable ${s}. Line ${t.line}`);n.data[1]=o.data[l]}else if(u==="z"||u==="b"){if(o.data.length<3)return void console.error(`Invalid assignment to ${u} for variable ${s}. Line ${t.line}`);n.data[2]=o.data[l]}else{if(u!=="w"&&u!=="a")return void console.error(`Invalid assignment to ${u} for variable ${s}. Line ${t.line}`);if(o.data.length<4)return void console.error(`Invalid assignment to ${u} for variable ${s}. Line ${t.line}`);n.data[3]=o.data[l]}}}}}else n instanceof v&&o instanceof v?n.value=o.value:n instanceof g&&o instanceof g||n instanceof z&&o instanceof z?n.data.set(o.data):console.error(`Invalid assignment to ${s}. Line ${t.line}`)}_function(t,e){let n=new Oa(t);e.functions.set(t.name,n)}_const(t,e){let n=null;t.value!==null&&(n=this.evalExpression(t.value,e)),e.createVariable(t.name,n,t)}_let(t,e){let n=null;if(t.value!==null){if(n=this.evalExpression(t.value,e),n===null)return void console.error(`Invalid value for variable ${t.name}. Line ${t.line}`);t.value instanceof it||(n=n.clone())}else{let s=t.type.name;if(s==="f32"||s==="i32"||s==="u32"||s==="bool"||s==="f16"||s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2b"||s==="vec3b"||s==="vec4b"||s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"||s==="array"){let i=new Vt(t.type,[]);n=this._evalCreate(i,e)}}e.createVariable(t.name,n,t)}_var(t,e){let n=null;if(t.value!==null){if(n=this.evalExpression(t.value,e),n===null)return void console.error(`Invalid value for variable ${t.name}. Line ${t.line}`);t.value instanceof it||(n=n.clone())}else{if(t.type===null)return void console.error(`Variable ${t.name} has no type. Line ${t.line}`);let s=t.type.name;if(s==="f32"||s==="i32"||s==="u32"||s==="bool"||s==="f16"||s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2b"||s==="vec3b"||s==="vec4b"||s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"||t.type instanceof Ye||t.type instanceof $t||t.type instanceof E){let i=new Vt(t.type,[]);n=this._evalCreate(i,e)}}e.createVariable(t.name,n,t)}_switch(t,e){e=e.clone();let n=this.evalExpression(t.condition,e);if(!(n instanceof v))return console.error(`Invalid if condition. Line ${t.line}`),null;let s=null;for(let i of t.cases)if(i instanceof Gs)for(let o of i.selectors){if(o instanceof Mn){s=i;continue}let a=this.evalExpression(o,e);if(!(a instanceof v))return console.error(`Invalid case selector. Line ${t.line}`),null;if(a.value===n.value)return this._execStatements(i.body,e)}else i instanceof Hs&&(s=i);return s?this._execStatements(s.body,e):null}_if(t,e){e=e.clone();let n=this.evalExpression(t.condition,e);if(!(n instanceof v))return console.error(`Invalid if condition. Line ${t.line}`),null;if(n.value)return this._execStatements(t.body,e);for(let s of t.elseif){let i=this.evalExpression(s.condition,e);if(!(i instanceof v))return console.error(`Invalid if condition. Line ${t.line}`),null;if(i.value)return this._execStatements(s.body,e)}return t.else?this._execStatements(t.else,e):null}_getScalarValue(t){return t instanceof v?t.value:(console.error("Expected scalar value.",t),0)}_for(t,e){for(e=e.clone(),this.execStatement(t.init,e);this._getScalarValue(this.evalExpression(t.condition,e));){let n=this._execStatements(t.body,e);if(n===r._breakObj)break;if(n!==null&&n!==r._continueObj)return n;this.execStatement(t.increment,e)}return null}_loop(t,e){for(e=e.clone();;){let n=this._execStatements(t.body,e);if(n===r._breakObj)break;if(n===r._continueObj){if(t.continuing&&this._execStatements(t.continuing.body,e)===r._breakObj)break}else if(n!==null)return n}return null}_while(t,e){for(e=e.clone();this._getScalarValue(this.evalExpression(t.condition,e));){let n=this._execStatements(t.body,e);if(n===r._breakObj)break;if(n!==r._continueObj&&n!==null)return n}return null}_evalBitcast(t,e){let n=this.evalExpression(t.value,e),s=t.type;if(n instanceof v){let i=eh(n.value,n.typeInfo.name,s.name);return new v(i,this.getTypeInfo(s))}if(n instanceof g){let i=n.typeInfo.getTypeName(),o="";if(i.endsWith("f"))o="f32";else if(i.endsWith("i"))o="i32";else if(i.endsWith("u"))o="u32";else if(i.endsWith("b"))o="bool";else{if(!i.endsWith("h"))return console.error(`Unknown vector type ${i}. Line ${t.line}`),null;o="f16"}let a=s.getTypeName(),c="";if(a.endsWith("f"))c="f32";else if(a.endsWith("i"))c="i32";else if(a.endsWith("u"))c="u32";else if(a.endsWith("b"))c="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${c}. Line ${t.line}`),null;c="f16"}let l=(function(u,h,f){if(h===f)return u;let p=new Array(u.length);for(let _=0;_<u.length;_++)p[_]=eh(u[_],h,f);return p})(Array.from(n.data),o,c);return new g(l,this.getTypeInfo(s))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${t.line}`),null}_evalConst(t,e){return e.getVariableValue(t.name).clone().getSubData(this,t.postfix,e)}_evalCreate(t,e){var n;if(t instanceof Vt){if(t.type===null)return wr.void;switch(t.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(t,e);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(t,e);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(t,e)}}let s=t instanceof Vt?t.type.name:t.name,i=t instanceof Vt?this.getTypeInfo(t.type):this.getTypeInfo(t.name);if(i===null)return console.error(`Unknown type ${s}. Line ${t.line}`),null;if(i.size===0)return null;let o=new lt(new ArrayBuffer(i.size),i,0);if(i instanceof ee){if(t.args)for(let a=0;a<t.args.length;++a){let c=i.members[a],l=t.args[a],u=this.evalExpression(l,e);o.setData(this,u,c.type,c.offset,e)}}else if(i instanceof ne){let a=0;if(t.args)for(let c=0;c<t.args.length;++c){let l=t.args[c],u=this.evalExpression(l,e);i.format===null&&(((n=u.typeInfo)===null||n===void 0?void 0:n.name)==="x32"?i.format=this.getTypeInfo("i32"):i.format=u.typeInfo),o.setData(this,u,i.format,a,e),a+=i.stride}}else console.error(`Unknown type "${s}". Line ${t.line}`);return t instanceof Vt?o.getSubData(this,t.postfix,e):o}_evalLiteral(t,e){let n=this.getTypeInfo(t.type),s=n.name;return s==="x32"||s==="u32"||s==="f32"||s==="f16"||s==="i32"||s==="bool"?new v(t.scalarValue,n):s==="vec2"||s==="vec3"||s==="vec4"||s==="vec2f"||s==="vec3f"||s==="vec4f"||s==="vec2h"||s==="vec3h"||s==="vec4h"||s==="vec2i"||s==="vec3i"||s==="vec4i"||s==="vec2u"||s==="vec3u"||s==="vec4u"?this._callConstructorVec(t,e):s==="mat2x2"||s==="mat2x3"||s==="mat2x4"||s==="mat3x2"||s==="mat3x3"||s==="mat3x4"||s==="mat4x2"||s==="mat4x3"||s==="mat4x4"||s==="mat2x2f"||s==="mat2x3f"||s==="mat2x4f"||s==="mat3x2f"||s==="mat3x3f"||s==="mat3x4f"||s==="mat4x2f"||s==="mat4x3f"||s==="mat4x4f"||s==="mat2x2h"||s==="mat2x3h"||s==="mat2x4h"||s==="mat3x2h"||s==="mat3x3h"||s==="mat3x4h"||s==="mat4x2h"||s==="mat4x3h"||s==="mat4x4h"?this._callConstructorMatrix(t,e):t.value}_evalVariable(t,e){let n=e.getVariableValue(t.name);return n===null?n:n.getSubData(this,t.postfix,e)}_maxFormatTypeInfo(t){let e=t[0];if(e.name==="f32")return e;for(let n=1;n<t.length;++n){let s=r._priority.get(e.name);r._priority.get(t[n].name)<s&&(e=t[n])}return e.name==="x32"?this.getTypeInfo("i32"):e}_evalUnaryOp(t,e){let n=this.evalExpression(t.right,e);if(t.operator==="&")return new Ie(n);if(t.operator==="*")return n instanceof Ie?n.reference.getSubData(this,t.postfix,e):(console.error(`Invalid dereference. Line ${t.line}`),null);let s=n instanceof v?n.value:n instanceof g?Array.from(n.data):null;switch(t.operator){case"+":{if(N(s)){let a=s.map((c,l)=>+c);return new g(a,n.typeInfo)}let i=s,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new v(+i,o)}case"-":{if(N(s)){let a=s.map((c,l)=>-c);return new g(a,n.typeInfo)}let i=s,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new v(-i,o)}case"!":{if(N(s)){let a=s.map((c,l)=>c?0:1);return new g(a,n.typeInfo)}let i=s,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new v(i?0:1,o)}case"~":{if(N(s)){let a=s.map((c,l)=>~c);return new g(a,n.typeInfo)}let i=s,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new v(~i,o)}}return console.error(`Invalid unary operator ${t.operator}. Line ${t.line}`),null}_evalBinaryOp(t,e){let n=this.evalExpression(t.left,e),s=this.evalExpression(t.right,e),i=n instanceof v?n.value:n instanceof g||n instanceof z?Array.from(n.data):null,o=s instanceof v?s.value:s instanceof g||s instanceof z?Array.from(s.data):null;switch(t.operator){case"+":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p+h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f+u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u+f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a+c,l)}case"-":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p-h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f-u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u-f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a-c,l)}case"*":{if(N(i)&&N(o)){let u=i,h=o;if(n instanceof z&&s instanceof z){let f=(function(y,T,I,k){if(wt[T.name]===void 0||wt[k.name]===void 0)return null;let S=wt[T.name][0],P=wt[T.name][1],L=wt[k.name][0];if(S!==wt[k.name][1])return null;let F=new Array(L*P);for(let D=0;D<P;D++)for(let R=0;R<L;R++){let O=0;for(let V=0;V<S;V++)O+=y[V*P+D]*I[R*S+V];F[D*L+R]=O}return F})(u,n.typeInfo,h,s.typeInfo);if(f===null)return console.error(`Matrix multiplication failed. Line ${t.line}.`),null;let p=wt[s.typeInfo.name][0],_=wt[n.typeInfo.name][1],x=this.getTypeInfo(`mat${p}x${_}f`);return new z(f,x)}if(n instanceof z&&s instanceof g){let f=(function(p,_,x,y){if(wt[_.name]===void 0||ya[y.name]===void 0)return null;let T=wt[_.name][0],I=wt[_.name][1];if(T!==x.length)return null;let k=new Array(I);for(let S=0;S<I;S++){let P=0;for(let L=0;L<T;L++)P+=p[L*I+S]*x[L];k[S]=P}return k})(u,n.typeInfo,h,s.typeInfo);return f===null?(console.error(`Matrix vector multiplication failed. Line ${t.line}.`),null):new g(f,s.typeInfo)}if(n instanceof g&&s instanceof z){let f=(function(p,_,x,y){if(ya[_.name]===void 0||wt[y.name]===void 0)return null;let T=wt[y.name][0],I=wt[y.name][1];if(I!==p.length)return null;let k=[];for(let S=0;S<T;S++){let P=0;for(let L=0;L<I;L++)P+=p[L]*x[L*T+S];k[S]=P}return k})(u,n.typeInfo,h,s.typeInfo);return f===null?(console.error(`Matrix vector multiplication failed. Line ${t.line}.`),null):new g(f,n.typeInfo)}{if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p*h[_]);return new g(f,n.typeInfo)}}if(N(i)){let u=o,h=i.map((f,p)=>f*u);return n instanceof z?new z(h,n.typeInfo):new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u*f);return s instanceof z?new z(h,s.typeInfo):new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a*c,l)}case"%":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p%h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f%u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u%f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a%c,l)}case"/":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p/h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f/u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u/f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a/c,l)}case"&":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p&h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f&u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u&f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a&c,l)}case"|":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p|h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f|u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u|f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a|c,l)}case"^":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p^h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f^u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u^f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a^c,l)}case"<<":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p<<h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f<<u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u<<f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a<<c,l)}case">>":{if(N(i)&&N(o)){let u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let f=u.map((p,_)=>p>>h[_]);return new g(f,n.typeInfo)}if(N(i)){let u=o,h=i.map((f,p)=>f>>u);return new g(h,n.typeInfo)}if(N(o)){let u=i,h=o.map((f,p)=>u>>f);return new g(h,s.typeInfo)}let a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,s.typeInfo]);return new v(a>>c,l)}case">":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u>c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l>a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a>l?1:0);return new g(c,s.typeInfo)}return new v(i>o?1:0,this.getTypeInfo("bool"));case"<":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u<c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l<a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a<l?1:0);return new g(c,s.typeInfo)}return new v(i<o?1:0,this.getTypeInfo("bool"));case"==":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u===c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l==a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a==l?1:0);return new g(c,s.typeInfo)}return new v(i===o?1:0,this.getTypeInfo("bool"));case"!=":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u!==c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l!==a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a!==l?1:0);return new g(c,s.typeInfo)}return new v(i!==o?1:0,this.getTypeInfo("bool"));case">=":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u>=c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l>=a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a>=l?1:0);return new g(c,s.typeInfo)}return new v(i>=o?1:0,this.getTypeInfo("bool"));case"<=":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u<=c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l<=a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a<=l?1:0);return new g(c,s.typeInfo)}return new v(i<=o?1:0,this.getTypeInfo("bool"));case"&&":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u&&c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l&&a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a&&l?1:0);return new g(c,s.typeInfo)}return new v(i&&o?1:0,this.getTypeInfo("bool"));case"||":if(N(i)&&N(o)){let a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${t.line}.`),null;let l=a.map((u,h)=>u||c[h]?1:0);return new g(l,n.typeInfo)}if(N(i)){let a=o,c=i.map((l,u)=>l||a?1:0);return new g(c,n.typeInfo)}if(N(o)){let a=i,c=o.map((l,u)=>a||l?1:0);return new g(c,s.typeInfo)}return new v(i||o?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${t.operator}. Line ${t.line}`),null}_evalCall(t,e){if(t.cachedReturnValue!==null)return t.cachedReturnValue;let n=e.clone();n.currentFunctionName=t.name;let s=e.getFunction(t.name);if(!s)return t.isBuiltin?this._callBuiltinFunction(t,n):this.getTypeInfo(t.name)?this._evalCreate(t,e):(console.error(`Unknown function "${t.name}". Line ${t.line}`),null);for(let i=0;i<s.node.args.length;++i){let o=s.node.args[i],a=this.evalExpression(t.args[i],n);n.createVariable(o.name,a,o)}return this._execStatements(s.node.body,n)}_callBuiltinFunction(t,e){switch(t.name){case"all":return this.builtins.All(t,e);case"any":return this.builtins.Any(t,e);case"select":return this.builtins.Select(t,e);case"arrayLength":return this.builtins.ArrayLength(t,e);case"abs":return this.builtins.Abs(t,e);case"acos":return this.builtins.Acos(t,e);case"acosh":return this.builtins.Acosh(t,e);case"asin":return this.builtins.Asin(t,e);case"asinh":return this.builtins.Asinh(t,e);case"atan":return this.builtins.Atan(t,e);case"atanh":return this.builtins.Atanh(t,e);case"atan2":return this.builtins.Atan2(t,e);case"ceil":return this.builtins.Ceil(t,e);case"clamp":return this.builtins.Clamp(t,e);case"cos":return this.builtins.Cos(t,e);case"cosh":return this.builtins.Cosh(t,e);case"countLeadingZeros":return this.builtins.CountLeadingZeros(t,e);case"countOneBits":return this.builtins.CountOneBits(t,e);case"countTrailingZeros":return this.builtins.CountTrailingZeros(t,e);case"cross":return this.builtins.Cross(t,e);case"degrees":return this.builtins.Degrees(t,e);case"determinant":return this.builtins.Determinant(t,e);case"distance":return this.builtins.Distance(t,e);case"dot":return this.builtins.Dot(t,e);case"dot4U8Packed":return this.builtins.Dot4U8Packed(t,e);case"dot4I8Packed":return this.builtins.Dot4I8Packed(t,e);case"exp":return this.builtins.Exp(t,e);case"exp2":return this.builtins.Exp2(t,e);case"extractBits":return this.builtins.ExtractBits(t,e);case"faceForward":return this.builtins.FaceForward(t,e);case"firstLeadingBit":return this.builtins.FirstLeadingBit(t,e);case"firstTrailingBit":return this.builtins.FirstTrailingBit(t,e);case"floor":return this.builtins.Floor(t,e);case"fma":return this.builtins.Fma(t,e);case"fract":return this.builtins.Fract(t,e);case"frexp":return this.builtins.Frexp(t,e);case"insertBits":return this.builtins.InsertBits(t,e);case"inverseSqrt":return this.builtins.InverseSqrt(t,e);case"ldexp":return this.builtins.Ldexp(t,e);case"length":return this.builtins.Length(t,e);case"log":return this.builtins.Log(t,e);case"log2":return this.builtins.Log2(t,e);case"max":return this.builtins.Max(t,e);case"min":return this.builtins.Min(t,e);case"mix":return this.builtins.Mix(t,e);case"modf":return this.builtins.Modf(t,e);case"normalize":return this.builtins.Normalize(t,e);case"pow":return this.builtins.Pow(t,e);case"quantizeToF16":return this.builtins.QuantizeToF16(t,e);case"radians":return this.builtins.Radians(t,e);case"reflect":return this.builtins.Reflect(t,e);case"refract":return this.builtins.Refract(t,e);case"reverseBits":return this.builtins.ReverseBits(t,e);case"round":return this.builtins.Round(t,e);case"saturate":return this.builtins.Saturate(t,e);case"sign":return this.builtins.Sign(t,e);case"sin":return this.builtins.Sin(t,e);case"sinh":return this.builtins.Sinh(t,e);case"smoothstep":return this.builtins.SmoothStep(t,e);case"sqrt":return this.builtins.Sqrt(t,e);case"step":return this.builtins.Step(t,e);case"tan":return this.builtins.Tan(t,e);case"tanh":return this.builtins.Tanh(t,e);case"transpose":return this.builtins.Transpose(t,e);case"trunc":return this.builtins.Trunc(t,e);case"dpdx":return this.builtins.Dpdx(t,e);case"dpdxCoarse":return this.builtins.DpdxCoarse(t,e);case"dpdxFine":return this.builtins.DpdxFine(t,e);case"dpdy":return this.builtins.Dpdy(t,e);case"dpdyCoarse":return this.builtins.DpdyCoarse(t,e);case"dpdyFine":return this.builtins.DpdyFine(t,e);case"fwidth":return this.builtins.Fwidth(t,e);case"fwidthCoarse":return this.builtins.FwidthCoarse(t,e);case"fwidthFine":return this.builtins.FwidthFine(t,e);case"textureDimensions":return this.builtins.TextureDimensions(t,e);case"textureGather":return this.builtins.TextureGather(t,e);case"textureGatherCompare":return this.builtins.TextureGatherCompare(t,e);case"textureLoad":return this.builtins.TextureLoad(t,e);case"textureNumLayers":return this.builtins.TextureNumLayers(t,e);case"textureNumLevels":return this.builtins.TextureNumLevels(t,e);case"textureNumSamples":return this.builtins.TextureNumSamples(t,e);case"textureSample":return this.builtins.TextureSample(t,e);case"textureSampleBias":return this.builtins.TextureSampleBias(t,e);case"textureSampleCompare":return this.builtins.TextureSampleCompare(t,e);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(t,e);case"textureSampleGrad":return this.builtins.TextureSampleGrad(t,e);case"textureSampleLevel":return this.builtins.TextureSampleLevel(t,e);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(t,e);case"textureStore":return this.builtins.TextureStore(t,e);case"atomicLoad":return this.builtins.AtomicLoad(t,e);case"atomicStore":return this.builtins.AtomicStore(t,e);case"atomicAdd":return this.builtins.AtomicAdd(t,e);case"atomicSub":return this.builtins.AtomicSub(t,e);case"atomicMax":return this.builtins.AtomicMax(t,e);case"atomicMin":return this.builtins.AtomicMin(t,e);case"atomicAnd":return this.builtins.AtomicAnd(t,e);case"atomicOr":return this.builtins.AtomicOr(t,e);case"atomicXor":return this.builtins.AtomicXor(t,e);case"atomicExchange":return this.builtins.AtomicExchange(t,e);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(t,e);case"pack4x8snorm":return this.builtins.Pack4x8snorm(t,e);case"pack4x8unorm":return this.builtins.Pack4x8unorm(t,e);case"pack4xI8":return this.builtins.Pack4xI8(t,e);case"pack4xU8":return this.builtins.Pack4xU8(t,e);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(t,e);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(t,e);case"pack2x16snorm":return this.builtins.Pack2x16snorm(t,e);case"pack2x16unorm":return this.builtins.Pack2x16unorm(t,e);case"pack2x16float":return this.builtins.Pack2x16float(t,e);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(t,e);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(t,e);case"unpack4xI8":return this.builtins.Unpack4xI8(t,e);case"unpack4xU8":return this.builtins.Unpack4xU8(t,e);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(t,e);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(t,e);case"unpack2x16float":return this.builtins.Unpack2x16float(t,e);case"storageBarrier":return this.builtins.StorageBarrier(t,e);case"textureBarrier":return this.builtins.TextureBarrier(t,e);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(t,e);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(t,e);case"subgroupAdd":return this.builtins.SubgroupAdd(t,e);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(t,e);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(t,e);case"subgroupAll":return this.builtins.SubgroupAll(t,e);case"subgroupAnd":return this.builtins.SubgroupAnd(t,e);case"subgroupAny":return this.builtins.SubgroupAny(t,e);case"subgroupBallot":return this.builtins.SubgroupBallot(t,e);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(t,e);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(t,e);case"subgroupElect":return this.builtins.SubgroupElect(t,e);case"subgroupMax":return this.builtins.SubgroupMax(t,e);case"subgroupMin":return this.builtins.SubgroupMin(t,e);case"subgroupMul":return this.builtins.SubgroupMul(t,e);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(t,e);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(t,e);case"subgroupOr":return this.builtins.SubgroupOr(t,e);case"subgroupShuffle":return this.builtins.SubgroupShuffle(t,e);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(t,e);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(t,e);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(t,e);case"subgroupXor":return this.builtins.SubgroupXor(t,e);case"quadBroadcast":return this.builtins.QuadBroadcast(t,e);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(t,e);case"quadSwapX":return this.builtins.QuadSwapX(t,e);case"quadSwapY":return this.builtins.QuadSwapY(t,e)}let n=e.getFunction(t.name);if(n){let s=e.clone();for(let i=0;i<n.node.args.length;++i){let o=n.node.args[i],a=this.evalExpression(t.args[i],s);s.setVariable(o.name,a,o)}return this._execStatements(n.node.body,s)}return null}_callConstructorValue(t,e){if(!t.args||t.args.length===0)return new v(0,this.getTypeInfo(t.type));let n=this.evalExpression(t.args[0],e);return n.typeInfo=this.getTypeInfo(t.type),n.getSubData(this,t.postfix,e).clone()}_callConstructorVec(t,e){let n=this.getTypeInfo(t.type),s=t.type.getTypeName(),i=ya[s];if(i===void 0)return console.error(`Invalid vec constructor ${s}. Line ${t.line}`),null;let o=[];if(t instanceof ct)if(t.isVector){let a=t.vectorValue;for(let c of a)o.push(c)}else o.push(t.scalarValue);else if(t.args)for(let a of t.args){let c=this.evalExpression(a,e);if(c instanceof g){let l=c.data;for(let u=0;u<l.length;++u){let h=l[u];o.push(h)}}else if(c instanceof v){let l=c.value;o.push(l)}}if(t.type instanceof E&&t.type.format===null&&(t.type.format=E.f32),o.length===0){let a=new Array(i).fill(0);return new g(a,n).getSubData(this,t.postfix,e)}if(o.length===1)for(;o.length<i;)o.push(o[0]);return o.length<i?(console.error(`Invalid vec constructor. Line ${t.line}`),null):new g(o.length>i?o.slice(0,i):o,n).getSubData(this,t.postfix,e)}_callConstructorMatrix(t,e){let n=this.getTypeInfo(t.type),s=t.type.getTypeName(),i=wt[s];if(i===void 0)return console.error(`Invalid matrix constructor ${s}. Line ${t.line}`),null;let o=[];if(t instanceof ct)if(t.isVector){let a=t.vectorValue;for(let c of a)o.push(c)}else o.push(t.scalarValue);else if(t.args)for(let a of t.args){let c=this.evalExpression(a,e);c instanceof g?o.push(...c.data):c instanceof v?o.push(c.value):c instanceof z&&o.push(...c.data)}if(n instanceof le&&n.format===null&&(n.format=this.getTypeInfo("f32")),o.length===0){let a=new Array(i[2]).fill(0);return new z(a,n).getSubData(this,t.postfix,e)}return o.length!==i[2]?(console.error(`Invalid matrix constructor. Line ${t.line}`),null):new z(o,n).getSubData(this,t.postfix,e)}};Ln._breakObj=new he(new kt("BREAK",null),null),Ln._continueObj=new he(new kt("CONTINUE",null),null),Ln._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);var Fa=class{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}},Va=class{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new Fa,this._exec=new Ln,this._forwardTypeCount=0}parse(t){this._initialize(t),this._deferArrayCountEval.length=0;let e=[];for(;!this._isAtEnd();){let n=this._global_decl_or_directive();if(!n)break;e.push(n)}if(this._deferArrayCountEval.length>0){for(let n of this._deferArrayCountEval){let s=n.arrayType,i=n.countNode;if(i instanceof vt){let o=i.name,a=this._context.constants.get(o);if(a)try{let c=a.constEvaluate(this._exec);s.count=c}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(let n of e)n.search(s=>{s instanceof Ys||s instanceof Pn?s.type=this._forwardType(s.type):s instanceof Ye?s.format=this._forwardType(s.format):s instanceof Wt||s instanceof qe||s instanceof In?s.type=this._forwardType(s.type):s instanceof Ze?s.returnType=this._forwardType(s.returnType):s instanceof qs&&(s.type=this._forwardType(s.type))});return e}_forwardType(t){if(t instanceof Bs){let e=this._getType(t.name);if(e)return e}else t instanceof Pn?t.type=this._forwardType(t.type):t instanceof Ye&&(t.format=this._forwardType(t.format));return t}_initialize(t){if(t)if(typeof t=="string"){let e=new Ma(t);this._tokens=e.scanTokens()}else this._tokens=t;else this._tokens=[];this._current=0}_updateNode(t,e){return t.line=e??this._currentLine,t}_error(t,e){return{token:t,message:e,toString:()=>`${e}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==m.eof}_match(t){if(t instanceof b)return!!this._check(t)&&(this._advance(),!0);for(let e=0,n=t.length;e<n;++e){let s=t[e];if(this._check(s))return this._advance(),!0}return!1}_consume(t,e){if(this._check(t))return this._advance();throw this._error(this._peek(),`${e}. Line:${this._currentLine}`)}_check(t){if(this._isAtEnd())return!1;let e=this._peek();if(t instanceof Array){let n=e.type,s=!1;for(let i of t){if(n===i)return!0;i===m.tokens.name&&(s=!0)}if(s){let i=m.tokens.name.rule.exec(e.lexeme);if(i&&i.index==0&&i[0]==e.lexeme)return!0}return!1}if(e.type===t)return!0;if(t===m.tokens.name){let n=m.tokens.name.rule.exec(e.lexeme);return n&&n.index==0&&n[0]==e.lexeme}return!1}_advance(){var t,e;return this._currentLine=(e=(t=this._peek())===null||t===void 0?void 0:t.line)!==null&&e!==void 0?e:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(m.tokens.semicolon)&&!this._isAtEnd(););if(this._match(m.keywords.alias)){let e=this._type_alias();return this._consume(m.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(m.keywords.diagnostic)){let e=this._diagnostic();return this._consume(m.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(m.keywords.requires)){let e=this._requires_directive();return this._consume(m.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(m.keywords.enable)){let e=this._enable_directive();return this._consume(m.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}let t=this._attribute();if(this._check(m.keywords.var)){let e=this._global_variable_decl();return e!=null&&(e.attributes=t),this._consume(m.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(m.keywords.override)){let e=this._override_variable_decl();return e!=null&&(e.attributes=t),this._consume(m.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(m.keywords.let)){let e=this._global_let_decl();return e!=null&&(e.attributes=t),this._consume(m.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(m.keywords.const)){let e=this._global_const_decl();return e!=null&&(e.attributes=t),this._consume(m.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([e]),e}if(this._check(m.keywords.struct)){let e=this._struct_decl();return e!=null&&(e.attributes=t),this._exec.reflection.updateAST([e]),e}if(this._check(m.keywords.fn)){let e=this._function_decl();return e!=null&&(e.attributes=t),this._exec.reflection.updateAST([e]),e}return null}_function_decl(){if(!this._match(m.keywords.fn))return null;let t=this._currentLine,e=this._consume(m.tokens.ident,"Expected function name.").toString();this._consume(m.tokens.paren_left,"Expected '(' for function arguments.");let n=[];if(!this._check(m.tokens.paren_right))do{if(this._check(m.tokens.paren_right))break;let a=this._attribute(),c=this._consume(m.tokens.name,"Expected argument name.").toString();this._consume(m.tokens.colon,"Expected ':' for argument type.");let l=this._attribute(),u=this._type_decl();u!=null&&(u.attributes=l,n.push(this._updateNode(new qs(c,u,a))))}while(this._match(m.tokens.comma));this._consume(m.tokens.paren_right,"Expected ')' after function arguments.");let s=null;if(this._match(m.tokens.arrow)){let a=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=a)}let i=this._compound_statement(),o=this._currentLine;return this._updateNode(new Ze(e,n,s,i,t,o),t)}_compound_statement(){let t=[];for(this._consume(m.tokens.brace_left,"Expected '{' for block.");!this._check(m.tokens.brace_right);){let e=this._statement();e!==null&&t.push(e)}return this._consume(m.tokens.brace_right,"Expected '}' for block."),t}_statement(){for(;this._match(m.tokens.semicolon)&&!this._isAtEnd(););if(this._check(m.tokens.attr)&&this._attribute(),this._check(m.keywords.if))return this._if_statement();if(this._check(m.keywords.switch))return this._switch_statement();if(this._check(m.keywords.loop))return this._loop_statement();if(this._check(m.keywords.for))return this._for_statement();if(this._check(m.keywords.while))return this._while_statement();if(this._check(m.keywords.continuing))return this._continuing_statement();if(this._check(m.keywords.static_assert))return this._static_assert_statement();if(this._check(m.tokens.brace_left))return this._compound_statement();let t=null;if(this._check(m.keywords.return))t=this._return_statement();else if(this._check([m.keywords.var,m.keywords.let,m.keywords.const]))t=this._variable_statement();else if(this._match(m.keywords.discard))t=this._updateNode(new Ia);else if(this._match(m.keywords.break)){let e=this._updateNode(new Vs);if(this._currentLoop.length>0){let n=this._currentLoop[this._currentLoop.length-1];e.loopId=n.id}t=e,this._check(m.keywords.if)&&(this._advance(),e.condition=this._optional_paren_expression())}else if(this._match(m.keywords.continue)){let e=this._updateNode(new Us);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${e.line}`);{let n=this._currentLoop[this._currentLoop.length-1];e.loopId=n.id}t=e}else t=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return t!=null&&this._consume(m.tokens.semicolon,"Expected ';' after statement."),t}_static_assert_statement(){if(!this._match(m.keywords.static_assert))return null;let t=this._currentLine,e=this._optional_paren_expression();return this._updateNode(new Ea(e),t)}_while_statement(){if(!this._match(m.keywords.while))return null;let t=this._updateNode(new Ps(null,null));return this._currentLoop.push(t),t.condition=this._optional_paren_expression(),this._check(m.tokens.attr)&&this._attribute(),t.body=this._compound_statement(),this._currentLoop.pop(),t}_continuing_statement(){let t=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(m.keywords.continuing))return null;let e=this._currentLine,n=this._compound_statement();return this._updateNode(new gr(n,t),e)}_for_statement(){if(!this._match(m.keywords.for))return null;this._consume(m.tokens.paren_left,"Expected '('.");let t=this._updateNode(new Ms(null,null,null,null));return this._currentLoop.push(t),t.init=this._check(m.tokens.semicolon)?null:this._for_init(),this._consume(m.tokens.semicolon,"Expected ';'."),t.condition=this._check(m.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(m.tokens.semicolon,"Expected ';'."),t.increment=this._check(m.tokens.paren_right)?null:this._for_increment(),this._consume(m.tokens.paren_right,"Expected ')'."),this._check(m.tokens.attr)&&this._attribute(),t.body=this._compound_statement(),this._currentLoop.pop(),t}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(m.keywords.var)){let t=this._variable_decl();if(t===null)throw this._error(this._peek(),"Variable declaration expected.");let e=null;return this._match(m.tokens.equal)&&(e=this._short_circuit_or_expression()),this._updateNode(new Wt(t.name,t.type,t.storage,t.access,e),t.line)}if(this._match(m.keywords.let)){let t=this._currentLine,e=this._consume(m.tokens.name,"Expected name for let.").toString(),n=null;if(this._match(m.tokens.colon)){let i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}this._consume(m.tokens.equal,"Expected '=' for let.");let s=this._short_circuit_or_expression();return this._updateNode(new qe(e,n,null,null,s),t)}if(this._match(m.keywords.const)){let t=this._currentLine,e=this._consume(m.tokens.name,"Expected name for const.").toString(),n=null;if(this._match(m.tokens.colon)){let i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}this._consume(m.tokens.equal,"Expected '=' for const.");let s=this._short_circuit_or_expression();return n===null&&s instanceof ct&&(n=s.type),this._updateNode(new In(e,n,null,null,s),t)}return null}_increment_decrement_statement(){let t=this._current,e=this._unary_expression();if(e==null)return null;if(!this._check(m.increment_operators))return this._current=t,null;let n=this._consume(m.increment_operators,"Expected increment operator");return this._updateNode(new Ls(n.type===m.tokens.plus_plus?Sn.increment:Sn.decrement,e))}_assignment_statement(){let t=null,e=this._currentLine;if(this._check(m.tokens.brace_right))return null;let n=this._match(m.tokens.underscore);if(n||(t=this._unary_expression()),!n&&t==null)return null;let s=this._consume(m.assignment_operators,"Expected assignment operator."),i=this._short_circuit_or_expression();return this._updateNode(new Cs(dr.parse(s.lexeme),t,i),e)}_func_call_statement(){if(!this._check(m.tokens.ident))return null;let t=this._currentLine,e=this._current,n=this._consume(m.tokens.ident,"Expected function name."),s=this._argument_expression_list();return s===null?(this._current=e,null):this._updateNode(new yr(n.lexeme,s),t)}_loop_statement(){if(!this._match(m.keywords.loop))return null;this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Expected '{' for loop.");let t=this._updateNode(new Os([],null));this._currentLoop.push(t);let e=this._statement();for(;e!==null;){if(Array.isArray(e))for(let n of e)t.body.push(n);else t.body.push(e);if(e instanceof gr){t.continuing=e;break}e=this._statement()}return this._currentLoop.pop(),this._consume(m.tokens.brace_right,"Expected '}' for loop."),t}_switch_statement(){if(!this._match(m.keywords.switch))return null;let t=this._updateNode(new Rs(null,[]));if(this._currentLoop.push(t),t.condition=this._optional_paren_expression(),this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Expected '{' for switch."),t.cases=this._switch_body(),t.cases==null||t.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(m.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),t}_switch_body(){let t=[],e=!1;for(;this._check([m.keywords.default,m.keywords.case]);){if(this._match(m.keywords.case)){let n=this._case_selectors();for(let i of n)if(i instanceof Mn){if(e)throw this._error(this._previous(),"Multiple default cases in switch statement.");e=!0;break}this._match(m.tokens.colon),this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Exected '{' for switch case.");let s=this._case_body();this._consume(m.tokens.brace_right,"Exected '}' for switch case."),t.push(this._updateNode(new Gs(n,s)))}if(this._match(m.keywords.default)){if(e)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(m.tokens.colon),this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Exected '{' for switch default.");let n=this._case_body();this._consume(m.tokens.brace_right,"Exected '}' for switch default."),t.push(this._updateNode(new Hs(n)))}}return t}_case_selectors(){let t=[];for(this._match(m.keywords.default)?t.push(this._updateNode(new Mn)):t.push(this._shift_expression());this._match(m.tokens.comma);)this._match(m.keywords.default)?t.push(this._updateNode(new Mn)):t.push(this._shift_expression());return t}_case_body(){if(this._match(m.keywords.fallthrough))return this._consume(m.tokens.semicolon,"Expected ';'"),[];let t=this._statement();if(t==null)return[];t instanceof Array||(t=[t]);let e=this._case_body();return e.length==0?t:[...t,e[0]]}_if_statement(){if(!this._match(m.keywords.if))return null;let t=this._currentLine,e=this._optional_paren_expression();this._check(m.tokens.attr)&&this._attribute();let n=this._compound_statement(),s=[];this._match_elseif()&&(this._check(m.tokens.attr)&&this._attribute(),s=this._elseif_statement(s));let i=null;return this._match(m.keywords.else)&&(this._check(m.tokens.attr)&&this._attribute(),i=this._compound_statement()),this._updateNode(new Ns(e,n,s,i),t)}_match_elseif(){return this._tokens[this._current].type===m.keywords.else&&this._tokens[this._current+1].type===m.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(t=[]){let e=this._optional_paren_expression(),n=this._compound_statement();return t.push(this._updateNode(new Pa(e,n))),this._match_elseif()&&(this._check(m.tokens.attr)&&this._attribute(),this._elseif_statement(t)),t}_return_statement(){if(!this._match(m.keywords.return))return null;let t=this._short_circuit_or_expression();return this._updateNode(new Ds(t))}_short_circuit_or_expression(){let t=this._short_circuit_and_expr();for(;this._match(m.tokens.or_or);)t=this._updateNode(new It(this._previous().toString(),t,this._short_circuit_and_expr()));return t}_short_circuit_and_expr(){let t=this._inclusive_or_expression();for(;this._match(m.tokens.and_and);)t=this._updateNode(new It(this._previous().toString(),t,this._inclusive_or_expression()));return t}_inclusive_or_expression(){let t=this._exclusive_or_expression();for(;this._match(m.tokens.or);)t=this._updateNode(new It(this._previous().toString(),t,this._exclusive_or_expression()));return t}_exclusive_or_expression(){let t=this._and_expression();for(;this._match(m.tokens.xor);)t=this._updateNode(new It(this._previous().toString(),t,this._and_expression()));return t}_and_expression(){let t=this._equality_expression();for(;this._match(m.tokens.and);)t=this._updateNode(new It(this._previous().toString(),t,this._equality_expression()));return t}_equality_expression(){let t=this._relational_expression();return this._match([m.tokens.equal_equal,m.tokens.not_equal])?this._updateNode(new It(this._previous().toString(),t,this._relational_expression())):t}_relational_expression(){let t=this._shift_expression();for(;this._match([m.tokens.less_than,m.tokens.greater_than,m.tokens.less_than_equal,m.tokens.greater_than_equal]);)t=this._updateNode(new It(this._previous().toString(),t,this._shift_expression()));return t}_shift_expression(){let t=this._additive_expression();for(;this._match([m.tokens.shift_left,m.tokens.shift_right]);)t=this._updateNode(new It(this._previous().toString(),t,this._additive_expression()));return t}_additive_expression(){let t=this._multiplicative_expression();for(;this._match([m.tokens.plus,m.tokens.minus]);)t=this._updateNode(new It(this._previous().toString(),t,this._multiplicative_expression()));return t}_multiplicative_expression(){let t=this._unary_expression();for(;this._match([m.tokens.star,m.tokens.forward_slash,m.tokens.modulo]);)t=this._updateNode(new It(this._previous().toString(),t,this._unary_expression()));return t}_unary_expression(){return this._match([m.tokens.minus,m.tokens.bang,m.tokens.tilde,m.tokens.star,m.tokens.and])?this._updateNode(new it(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){let t=this._primary_expression(),e=this._postfix_expression();return e&&(t.postfix=e),t}_postfix_expression(){if(this._match(m.tokens.bracket_left)){let t=this._short_circuit_or_expression();this._consume(m.tokens.bracket_right,"Expected ']'.");let e=this._updateNode(new Pe(t)),n=this._postfix_expression();return n&&(e.postfix=n),e}if(this._match(m.tokens.period)){let t=this._consume(m.tokens.name,"Expected member name."),e=this._postfix_expression(),n=this._updateNode(new ue(t.lexeme));return e&&(n.postfix=e),n}return null}_getStruct(t){return this._context.aliases.has(t)?this._context.aliases.get(t).type:this._context.structs.has(t)?this._context.structs.get(t):null}_getType(t){let e=this._getStruct(t);if(e!==null)return e;switch(t){case"void":return C.void;case"bool":return C.bool;case"i32":return C.i32;case"u32":return C.u32;case"f32":return C.f32;case"f16":return C.f16;case"vec2f":return E.vec2f;case"vec3f":return E.vec3f;case"vec4f":return E.vec4f;case"vec2i":return E.vec2i;case"vec3i":return E.vec3i;case"vec4i":return E.vec4i;case"vec2u":return E.vec2u;case"vec3u":return E.vec3u;case"vec4u":return E.vec4u;case"vec2h":return E.vec2h;case"vec3h":return E.vec3h;case"vec4h":return E.vec4h;case"mat2x2f":return E.mat2x2f;case"mat2x3f":return E.mat2x3f;case"mat2x4f":return E.mat2x4f;case"mat3x2f":return E.mat3x2f;case"mat3x3f":return E.mat3x3f;case"mat3x4f":return E.mat3x4f;case"mat4x2f":return E.mat4x2f;case"mat4x3f":return E.mat4x3f;case"mat4x4f":return E.mat4x4f;case"mat2x2h":return E.mat2x2h;case"mat2x3h":return E.mat2x3h;case"mat2x4h":return E.mat2x4h;case"mat3x2h":return E.mat3x2h;case"mat3x3h":return E.mat3x3h;case"mat3x4h":return E.mat3x4h;case"mat4x2h":return E.mat4x2h;case"mat4x3h":return E.mat4x3h;case"mat4x4h":return E.mat4x4h;case"mat2x2i":return E.mat2x2i;case"mat2x3i":return E.mat2x3i;case"mat2x4i":return E.mat2x4i;case"mat3x2i":return E.mat3x2i;case"mat3x3i":return E.mat3x3i;case"mat3x4i":return E.mat3x4i;case"mat4x2i":return E.mat4x2i;case"mat4x3i":return E.mat4x3i;case"mat4x4i":return E.mat4x4i;case"mat2x2u":return E.mat2x2u;case"mat2x3u":return E.mat2x3u;case"mat2x4u":return E.mat2x4u;case"mat3x2u":return E.mat3x2u;case"mat3x3u":return E.mat3x3u;case"mat3x4u":return E.mat3x4u;case"mat4x2u":return E.mat4x2u;case"mat4x3u":return E.mat4x3u;case"mat4x4u":return E.mat4x4u}return null}_validateTypeRange(t,e){if(e.name==="i32"){if(t<-2147483648||t>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${t}. Line: ${this._currentLine}.`)}else if(e.name==="u32"&&(t<0||t>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${t}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(m.tokens.ident)){let n=this._previous().toString();if(this._check(m.tokens.paren_left)){let s=this._argument_expression_list(),i=this._getType(n);return i!==null?this._updateNode(new Vt(i,s)):this._updateNode(new br(n,s))}if(this._context.constants.has(n)){let s=this._context.constants.get(n);return this._updateNode(new zs(n,s.value))}return this._updateNode(new vt(n))}if(this._match(m.tokens.int_literal)){let n=this._previous().toString(),s=n.endsWith("i")||n.endsWith("i")?C.i32:n.endsWith("u")||n.endsWith("U")?C.u32:C.x32,i=parseInt(n);return this._validateTypeRange(i,s),this._updateNode(new ct(new v(i,this._exec.getTypeInfo(s)),s))}if(this._match(m.tokens.uint_literal)){let n=parseInt(this._previous().toString());return this._validateTypeRange(n,C.u32),this._updateNode(new ct(new v(n,this._exec.getTypeInfo(C.u32)),C.u32))}if(this._match([m.tokens.decimal_float_literal,m.tokens.hex_float_literal])){let n=this._previous().toString(),s=n.endsWith("h");s&&(n=n.substring(0,n.length-1));let i=parseFloat(n);this._validateTypeRange(i,s?C.f16:C.f32);let o=s?C.f16:C.f32;return this._updateNode(new ct(new v(i,this._exec.getTypeInfo(o)),o))}if(this._match([m.keywords.true,m.keywords.false])){let n=this._previous().toString()===m.keywords.true.rule;return this._updateNode(new ct(new v(n?1:0,this._exec.getTypeInfo(C.bool)),C.bool))}if(this._check(m.tokens.paren_left))return this._paren_expression();if(this._match(m.keywords.bitcast)){this._consume(m.tokens.less_than,"Expected '<'.");let n=this._type_decl();this._consume(m.tokens.greater_than,"Expected '>'.");let s=this._paren_expression();return this._updateNode(new js(n,s))}let t=this._type_decl(),e=this._argument_expression_list();return this._updateNode(new Vt(t,e))}_argument_expression_list(){if(!this._match(m.tokens.paren_left))return null;let t=[];do{if(this._check(m.tokens.paren_right))break;let e=this._short_circuit_or_expression();t.push(e)}while(this._match(m.tokens.comma));return this._consume(m.tokens.paren_right,"Expected ')' for agument list"),t}_optional_paren_expression(){this._match(m.tokens.paren_left);let t=this._short_circuit_or_expression();return this._match(m.tokens.paren_right),t}_paren_expression(){this._consume(m.tokens.paren_left,"Expected '('.");let t=this._short_circuit_or_expression();return this._consume(m.tokens.paren_right,"Expected ')'."),t}_struct_decl(){if(!this._match(m.keywords.struct))return null;let t=this._currentLine,e=this._consume(m.tokens.ident,"Expected name for struct.").toString();this._consume(m.tokens.brace_left,"Expected '{' for struct body.");let n=[];for(;!this._check(m.tokens.brace_right);){let o=this._attribute(),a=this._consume(m.tokens.name,"Expected variable name.").toString();this._consume(m.tokens.colon,"Expected ':' for struct member type.");let c=this._attribute(),l=this._type_decl();l!=null&&(l.attributes=c),this._check(m.tokens.brace_right)?this._match(m.tokens.comma):this._consume(m.tokens.comma,"Expected ',' for struct member."),n.push(this._updateNode(new Ys(a,l,o)))}this._consume(m.tokens.brace_right,"Expected '}' after struct body.");let s=this._currentLine,i=this._updateNode(new $t(e,n,t,s),t);return this._context.structs.set(e,i),i}_global_variable_decl(){let t=this._variable_decl();if(!t)return null;if(this._match(m.tokens.equal)){let e=this._const_expression();t.value=e}if(t.type!==null&&t.value instanceof ct){if(t.value.type.name!=="x32"&&t.type.getTypeName()!==t.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${t.value.type.name} to ${t.type.name}. Line:${this._currentLine}`);t.value.isScalar&&this._validateTypeRange(t.value.scalarValue,t.type),t.value.type=t.type}else t.type===null&&t.value instanceof ct&&(t.type=t.value.type.name==="x32"?C.i32:t.value.type,t.value.isScalar&&this._validateTypeRange(t.value.scalarValue,t.type));return t}_override_variable_decl(){let t=this._override_decl();return t&&this._match(m.tokens.equal)&&(t.value=this._const_expression()),t}_global_const_decl(){var t;if(!this._match(m.keywords.const))return null;let e=this._consume(m.tokens.name,"Expected variable name"),n=this._currentLine,s=null;if(this._match(m.tokens.colon)){let c=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=c)}let i=null;this._consume(m.tokens.equal,"const declarations require an assignment");let o=this._short_circuit_or_expression();try{let c=[C.f32],l=o.constEvaluate(this._exec,c);l instanceof v&&this._validateTypeRange(l.value,c[0]),c[0]instanceof E&&c[0].format===null&&l.typeInfo instanceof le&&l.typeInfo.format!==null&&(l.typeInfo.format.name==="f16"?c[0].format=C.f16:l.typeInfo.format.name==="f32"?c[0].format=C.f32:l.typeInfo.format.name==="i32"?c[0].format=C.i32:l.typeInfo.format.name==="u32"?c[0].format=C.u32:l.typeInfo.format.name==="bool"?c[0].format=C.bool:console.error(`TODO: impelement template format type ${l.typeInfo.format.name}`)),i=this._updateNode(new ct(l,c[0])),this._exec.context.setVariable(e.toString(),l)}catch{i=o}if(s!==null&&i instanceof ct){if(i.type.name!=="x32"&&s.getTypeName()!==i.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${i.type.name} to ${s.name}. Line:${this._currentLine}`);i.type=s,i.isScalar&&this._validateTypeRange(i.scalarValue,i.type)}else s===null&&i instanceof ct&&(s=(t=i?.type)!==null&&t!==void 0?t:C.f32,s===C.x32&&(s=C.i32));let a=this._updateNode(new In(e.toString(),s,"","",i),n);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(m.keywords.let))return null;let t=this._currentLine,e=this._consume(m.tokens.name,"Expected variable name"),n=null;if(this._match(m.tokens.colon)){let i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}let s=null;if(this._match(m.tokens.equal)&&(s=this._const_expression()),n!==null&&s instanceof ct){if(s.type.name!=="x32"&&n.getTypeName()!==s.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${s.type.name} to ${n.name}. Line:${this._currentLine}`);s.type=n}else n===null&&s instanceof ct&&(n=s.type.name==="x32"?C.i32:s.type);return s instanceof ct&&s.isScalar&&this._validateTypeRange(s.scalarValue,n),this._updateNode(new qe(e.toString(),n,"","",s),t)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(m.keywords.var))return null;let t=this._currentLine,e="",n="";this._match(m.tokens.less_than)&&(e=this._consume(m.storage_class,"Expected storage_class.").toString(),this._match(m.tokens.comma)&&(n=this._consume(m.access_mode,"Expected access_mode.").toString()),this._consume(m.tokens.greater_than,"Expected '>'."));let s=this._consume(m.tokens.name,"Expected variable name"),i=null;if(this._match(m.tokens.colon)){let o=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=o)}return this._updateNode(new Wt(s.toString(),i,e,n,null),t)}_override_decl(){if(!this._match(m.keywords.override))return null;let t=this._consume(m.tokens.name,"Expected variable name"),e=null;if(this._match(m.tokens.colon)){let n=this._attribute();e=this._type_decl(),e!=null&&(e.attributes=n)}return this._updateNode(new _r(t.toString(),e,null))}_diagnostic(){this._consume(m.tokens.paren_left,"Expected '('");let t=this._consume(m.tokens.ident,"Expected severity control name.");this._consume(m.tokens.comma,"Expected ','");let e=this._consume(m.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(m.tokens.period)&&(e+=`.${this._consume(m.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(m.tokens.paren_right,"Expected ')'"),this._updateNode(new Fs(t.toString(),e))}_enable_directive(){let t=this._consume(m.tokens.ident,"identity expected.");return this._updateNode(new Sa(t.toString()))}_requires_directive(){let t=[this._consume(m.tokens.ident,"identity expected.").toString()];for(;this._match(m.tokens.comma);){let e=this._consume(m.tokens.ident,"identity expected.");t.push(e.toString())}return this._updateNode(new Aa(t))}_type_alias(){let t=this._consume(m.tokens.ident,"identity expected.");this._consume(m.tokens.equal,"Expected '=' for type alias.");let e=this._type_decl();if(e===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let n=this._updateNode(new xr(t.toString(),e));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([m.tokens.ident,...m.texel_format,m.keywords.bool,m.keywords.f32,m.keywords.i32,m.keywords.u32])){let n=this._advance().toString();if(this._context.structs.has(n))return this._context.structs.get(n);if(this._context.aliases.has(n))return this._context.aliases.get(n).type;if(!this._getType(n)){let s=this._updateNode(new Bs(n));return this._forwardTypeCount++,s}return this._updateNode(new C(n))}let t=this._texture_sampler_types();if(t)return t;if(this._check(m.template_types)){let n=this._advance().toString(),s=null,i=null;return this._match(m.tokens.less_than)&&(s=this._type_decl(),i=null,this._match(m.tokens.comma)&&(i=this._consume(m.access_mode,"Expected access_mode for pointer").toString()),this._consume(m.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new E(n,s,i))}if(this._match(m.keywords.ptr)){let n=this._previous().toString();this._consume(m.tokens.less_than,"Expected '<' for pointer.");let s=this._consume(m.storage_class,"Expected storage_class for pointer");this._consume(m.tokens.comma,"Expected ',' for pointer.");let i=this._type_decl(),o=null;return this._match(m.tokens.comma)&&(o=this._consume(m.access_mode,"Expected access_mode for pointer").toString()),this._consume(m.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Pn(n,s.toString(),i,o))}let e=this._attribute();if(this._match(m.keywords.array)){let n=null,s=-1,i=this._previous(),o=null;if(this._match(m.tokens.less_than)){n=this._type_decl(),this._context.aliases.has(n.name)&&(n=this._context.aliases.get(n.name).type);let c="";if(this._match(m.tokens.comma)){o=this._shift_expression();try{c=o.constEvaluate(this._exec).toString(),o=null}catch{c="1"}}this._consume(m.tokens.greater_than,"Expected '>' for array."),s=c?parseInt(c):0}let a=this._updateNode(new Ye(i.toString(),e,n,s));return o&&this._deferArrayCountEval.push({arrayType:a,countNode:o}),a}return null}_texture_sampler_types(){if(this._match(m.sampler_type))return this._updateNode(new He(this._previous().toString(),null,null));if(this._match(m.depth_texture_type))return this._updateNode(new He(this._previous().toString(),null,null));if(this._match(m.sampled_texture_type)||this._match(m.multisampled_texture_type)){let t=this._previous();this._consume(m.tokens.less_than,"Expected '<' for sampler type.");let e=this._type_decl();return this._consume(m.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new He(t.toString(),e,null))}if(this._match(m.storage_texture_type)){let t=this._previous();this._consume(m.tokens.less_than,"Expected '<' for sampler type.");let e=this._consume(m.texel_format,"Invalid texel format.").toString();this._consume(m.tokens.comma,"Expected ',' after texel format.");let n=this._consume(m.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(m.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new He(t.toString(),e,n))}return null}_attribute(){let t=[];for(;this._match(m.tokens.attr);){let e=this._consume(m.attribute_name,"Expected attribute name"),n=this._updateNode(new Xs(e.toString(),null));if(this._match(m.tokens.paren_left)){if(n.value=this._consume(m.literal_or_ident,"Expected attribute value").toString(),this._check(m.tokens.comma)){this._advance();do{let s=this._consume(m.literal_or_ident,"Expected attribute value").toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(s)}while(this._match(m.tokens.comma))}this._consume(m.tokens.paren_right,"Expected ')'")}t.push(n)}return t.length==0?null:t}},ti=class extends Xe{constructor(t){super(),t&&this.update(t)}update(t){let e=new Va().parse(t);this.updateAST(e)}};function za(r){let t={attributes:[],bindings:[]},e;try{e=Tm(r)}catch(i){return W.error(i.message)(),t}for(let i of e.uniforms){let o=[];for(let a of i.type?.members||[])o.push({name:a.name,type:ih(a.type)});t.bindings.push({type:"uniform",name:i.name,group:i.group,location:i.binding,members:o})}for(let i of e.textures)t.bindings.push({type:"texture",name:i.name,group:i.group,location:i.binding});for(let i of e.samplers)t.bindings.push({type:"sampler",name:i.name,group:i.group,location:i.binding});let n=e.entry.vertex[0],s=n?.inputs.length||0;for(let i=0;i<s;i++){let o=n.inputs[i];if(o.locationType==="location"){let a=ih(o.type);t.attributes.push({name:o.name,location:Number(o.location),type:a})}}return t}function ih(r){return r?.format?`${r.name}<${r.format.name}>`:r.name}function Tm(r){try{return new ti(r)}catch(t){if(t instanceof Error)throw t;let e="WGSL parse error";throw typeof t=="object"&&t?.message&&(e+=`: ${t.message} `),typeof t=="object"&&t?.token&&(e+=t.token.line||""),new Error(e,{cause:t})}}var km=1/Math.PI*180,Em=1/180*Math.PI,Sm={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:d({},Sm)};var ut=globalThis.mathgl.config;function vr(r,{precision:t=ut.precision}={}){return r=Am(r),`${parseFloat(r.toPrecision(t))}`}function pe(r){return Array.isArray(r)||ArrayBuffer.isView(r)&&!(r instanceof DataView)}function Rn(r,t){return ja(r,e=>e*Em,t)}function Me(r,t){return ja(r,e=>e*km,t)}function X(r,t,e){return ja(r,n=>Math.max(t,Math.min(e,n)))}function de(r,t,e){return pe(r)?r.map((n,s)=>de(n,t[s],e)):e*t+(1-e)*r}function Mt(r,t,e){let n=ut.EPSILON;e&&(ut.EPSILON=e);try{if(r===t)return!0;if(pe(r)&&pe(t)){if(r.length!==t.length)return!1;for(let s=0;s<r.length;++s)if(!Mt(r[s],t[s]))return!1;return!0}return r&&r.equals?r.equals(t):t&&t.equals?t.equals(r):typeof r=="number"&&typeof t=="number"?Math.abs(r-t)<=ut.EPSILON*Math.max(1,Math.abs(r),Math.abs(t)):!1}finally{ut.EPSILON=n}}function Am(r){return Math.round(r/ut.EPSILON)*ut.EPSILON}function Im(r){return r.clone?r.clone():new Array(r.length)}function ja(r,t,e){if(pe(r)){let n=r;e=e||Im(n);for(let s=0;s<e.length&&s<n.length;++s){let i=typeof r=="number"?r:r[s];e[s]=t(i,s,e)}return e}return t(r)}var Nn=class extends Array{clone(){return new this.constructor().copy(this)}fromArray(t,e=0){for(let n=0;n<this.ELEMENTS;++n)this[n]=t[n+e];return this.check()}toArray(t=[],e=0){for(let n=0;n<this.ELEMENTS;++n)t[e+n]=this[n];return t}toObject(t){return t}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}to(t){return t===this?this:pe(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ut)}formatString(t){let e="";for(let n=0;n<this.ELEMENTS;++n)e+=(n>0?", ":"")+vr(this[n],t);return`${t.printTypes?this.constructor.name:""}[${e}]`}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!Mt(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,n){if(n===void 0)return this.lerp(this,t,e);for(let s=0;s<this.ELEMENTS;++s){let i=t[s],o=typeof e=="number"?e:e[s];this[s]=i+n*(o-i)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],t[n]),e[n]);return this.check()}add(...t){for(let e of t)for(let n=0;n<this.ELEMENTS;++n)this[n]+=e[n];return this.check()}subtract(...t){for(let e of t)for(let n=0;n<this.ELEMENTS;++n)this[n]-=e[n];return this.check()}scale(t){if(typeof t=="number")for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;else for(let e=0;e<this.ELEMENTS&&e<t.length;++e)this[e]*=t[e];return this.check()}multiplyByScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}check(){if(ut.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.multiplyByScalar(1/t)}clampScalar(t,e){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],t),e);return this.check()}get elements(){return this}};function Pm(r,t){if(r.length!==t)return!1;for(let e=0;e<r.length;++e)if(!Number.isFinite(r[e]))return!1;return!0}function yt(r){if(!Number.isFinite(r))throw new Error(`Invalid number ${JSON.stringify(r)}`);return r}function ei(r,t,e=""){if(ut.debug&&!Pm(r,t))throw new Error(`math.gl: ${e} some fields set to invalid numbers'`);return r}function $a(r,t){if(!r)throw new Error(`math.gl assertion ${t}`)}var ni=class extends Nn{get x(){return this[0]}set x(t){this[0]=yt(t)}get y(){return this[1]}set y(t){this[1]=yt(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let n=0;n<this.ELEMENTS;++n){let s=this[n]-t[n];e+=s*s}return yt(e)}dot(t){let e=0;for(let n=0;n<this.ELEMENTS;++n)e+=this[n]*t[n];return yt(e)}normalize(){let t=this.magnitude();if(t!==0)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(let e of t)for(let n=0;n<this.ELEMENTS;++n)this[n]*=e[n];return this.check()}divide(...t){for(let e of t)for(let n=0;n<this.ELEMENTS;++n)this[n]/=e[n];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return $a(t>=0&&t<this.ELEMENTS,"index is out of range"),yt(this[t])}setComponent(t,e){return $a(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}};var ht={};Qn(ht,{add:()=>Rm,angle:()=>Qm,ceil:()=>Nm,clone:()=>Mm,copy:()=>Cm,create:()=>oh,cross:()=>Hm,dist:()=>cg,distance:()=>uh,div:()=>ag,divide:()=>lh,dot:()=>Gm,equals:()=>rg,exactEquals:()=>ng,floor:()=>Dm,forEach:()=>hg,fromValues:()=>Lm,inverse:()=>$m,len:()=>sg,length:()=>fh,lerp:()=>qm,max:()=>Vm,min:()=>Fm,mul:()=>og,multiply:()=>ch,negate:()=>jm,normalize:()=>Wm,random:()=>Ym,rotate:()=>Jm,round:()=>Um,scale:()=>Bm,scaleAndAdd:()=>zm,set:()=>Om,sqrDist:()=>lg,sqrLen:()=>ug,squaredDistance:()=>hh,squaredLength:()=>ph,str:()=>eg,sub:()=>ig,subtract:()=>ah,transformMat2:()=>Xm,transformMat2d:()=>Zm,transformMat3:()=>Km,transformMat4:()=>Wa,zero:()=>tg});var ot=typeof Float32Array<"u"?Float32Array:Array,re=Math.random;function Ut(r){return r>=0?Math.round(r):r%.5===0?Math.floor(r):Math.round(r)}var I3=Math.PI/180;function oh(){let r=new ot(2);return ot!=Float32Array&&(r[0]=0,r[1]=0),r}function Mm(r){let t=new ot(2);return t[0]=r[0],t[1]=r[1],t}function Lm(r,t){let e=new ot(2);return e[0]=r,e[1]=t,e}function Cm(r,t){return r[0]=t[0],r[1]=t[1],r}function Om(r,t,e){return r[0]=t,r[1]=e,r}function Rm(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r}function ah(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r}function ch(r,t,e){return r[0]=t[0]*e[0],r[1]=t[1]*e[1],r}function lh(r,t,e){return r[0]=t[0]/e[0],r[1]=t[1]/e[1],r}function Nm(r,t){return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r}function Dm(r,t){return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r}function Fm(r,t,e){return r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r}function Vm(r,t,e){return r[0]=Math.max(t[0],e[0]),r[1]=Math.max(t[1],e[1]),r}function Um(r,t){return r[0]=Ut(t[0]),r[1]=Ut(t[1]),r}function Bm(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r}function zm(r,t,e,n){return r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r}function uh(r,t){let e=t[0]-r[0],n=t[1]-r[1];return Math.sqrt(e*e+n*n)}function hh(r,t){let e=t[0]-r[0],n=t[1]-r[1];return e*e+n*n}function fh(r){let t=r[0],e=r[1];return Math.sqrt(t*t+e*e)}function ph(r){let t=r[0],e=r[1];return t*t+e*e}function jm(r,t){return r[0]=-t[0],r[1]=-t[1],r}function $m(r,t){return r[0]=1/t[0],r[1]=1/t[1],r}function Wm(r,t){let e=t[0],n=t[1],s=e*e+n*n;return s>0&&(s=1/Math.sqrt(s)),r[0]=t[0]*s,r[1]=t[1]*s,r}function Gm(r,t){return r[0]*t[0]+r[1]*t[1]}function Hm(r,t,e){let n=t[0]*e[1]-t[1]*e[0];return r[0]=r[1]=0,r[2]=n,r}function qm(r,t,e,n){let s=t[0],i=t[1];return r[0]=s+n*(e[0]-s),r[1]=i+n*(e[1]-i),r}function Ym(r,t){t=t===void 0?1:t;let e=re()*2*Math.PI;return r[0]=Math.cos(e)*t,r[1]=Math.sin(e)*t,r}function Xm(r,t,e){let n=t[0],s=t[1];return r[0]=e[0]*n+e[2]*s,r[1]=e[1]*n+e[3]*s,r}function Zm(r,t,e){let n=t[0],s=t[1];return r[0]=e[0]*n+e[2]*s+e[4],r[1]=e[1]*n+e[3]*s+e[5],r}function Km(r,t,e){let n=t[0],s=t[1];return r[0]=e[0]*n+e[3]*s+e[6],r[1]=e[1]*n+e[4]*s+e[7],r}function Wa(r,t,e){let n=t[0],s=t[1];return r[0]=e[0]*n+e[4]*s+e[12],r[1]=e[1]*n+e[5]*s+e[13],r}function Jm(r,t,e,n){let s=t[0]-e[0],i=t[1]-e[1],o=Math.sin(n),a=Math.cos(n);return r[0]=s*a-i*o+e[0],r[1]=s*o+i*a+e[1],r}function Qm(r,t){let e=r[0],n=r[1],s=t[0],i=t[1],o=Math.sqrt((e*e+n*n)*(s*s+i*i)),a=o&&(e*s+n*i)/o;return Math.acos(Math.min(Math.max(a,-1),1))}function tg(r){return r[0]=0,r[1]=0,r}function eg(r){return`vec2(${r[0]}, ${r[1]})`}function ng(r,t){return r[0]===t[0]&&r[1]===t[1]}function rg(r,t){let e=r[0],n=r[1],s=t[0],i=t[1];return Math.abs(e-s)<=1e-6*Math.max(1,Math.abs(e),Math.abs(s))&&Math.abs(n-i)<=1e-6*Math.max(1,Math.abs(n),Math.abs(i))}var sg=fh,ig=ah,og=ch,ag=lh,cg=uh,lg=hh,ug=ph,hg=(function(){let r=oh();return function(t,e,n,s,i,o){let a,c;for(e||(e=2),n||(n=0),s?c=Math.min(s*e+n,t.length):c=t.length,a=n;a<c;a+=e)r[0]=t[a],r[1]=t[a+1],i(r,r,o),t[a]=r[0],t[a+1]=r[1];return t}})();function dh(r,t,e){let n=t[0],s=t[1],i=e[3]*n+e[7]*s||1;return r[0]=(e[0]*n+e[4]*s)/i,r[1]=(e[1]*n+e[5]*s)/i,r}function si(r,t,e){let n=t[0],s=t[1],i=t[2],o=e[3]*n+e[7]*s+e[11]*i||1;return r[0]=(e[0]*n+e[4]*s+e[8]*i)/o,r[1]=(e[1]*n+e[5]*s+e[9]*i)/o,r[2]=(e[2]*n+e[6]*s+e[10]*i)/o,r}function mh(r,t,e){let n=t[0],s=t[1];return r[0]=e[0]*n+e[2]*s,r[1]=e[1]*n+e[3]*s,r[2]=t[2],r}var Et={};Qn(Et,{add:()=>gg,angle:()=>Ja,bezier:()=>Mg,ceil:()=>_g,clone:()=>fg,copy:()=>dg,create:()=>gh,cross:()=>Ha,dist:()=>Ug,distance:()=>bh,div:()=>Vg,divide:()=>xh,dot:()=>Ga,equals:()=>Ng,exactEquals:()=>Rg,floor:()=>yg,forEach:()=>$g,fromValues:()=>pg,hermite:()=>Pg,inverse:()=>Eg,len:()=>zg,length:()=>ii,lerp:()=>Ag,max:()=>bg,min:()=>xg,mul:()=>Fg,multiply:()=>yh,negate:()=>kg,normalize:()=>Sg,random:()=>Lg,rotateX:()=>Xa,rotateY:()=>Za,rotateZ:()=>Ka,round:()=>wg,scale:()=>vg,scaleAndAdd:()=>Tg,set:()=>mg,slerp:()=>Ig,sqrDist:()=>Bg,sqrLen:()=>jg,squaredDistance:()=>wh,squaredLength:()=>vh,str:()=>Og,sub:()=>Dg,subtract:()=>_h,transformMat3:()=>qa,transformMat4:()=>Tr,transformQuat:()=>Ya,zero:()=>Cg});function gh(){let r=new ot(3);return ot!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function fg(r){let t=new ot(3);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t}function ii(r){let t=r[0],e=r[1],n=r[2];return Math.sqrt(t*t+e*e+n*n)}function pg(r,t,e){let n=new ot(3);return n[0]=r,n[1]=t,n[2]=e,n}function dg(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r}function mg(r,t,e,n){return r[0]=t,r[1]=e,r[2]=n,r}function gg(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r}function _h(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}function yh(r,t,e){return r[0]=t[0]*e[0],r[1]=t[1]*e[1],r[2]=t[2]*e[2],r}function xh(r,t,e){return r[0]=t[0]/e[0],r[1]=t[1]/e[1],r[2]=t[2]/e[2],r}function _g(r,t){return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r[2]=Math.ceil(t[2]),r}function yg(r,t){return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r[2]=Math.floor(t[2]),r}function xg(r,t,e){return r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.min(t[2],e[2]),r}function bg(r,t,e){return r[0]=Math.max(t[0],e[0]),r[1]=Math.max(t[1],e[1]),r[2]=Math.max(t[2],e[2]),r}function wg(r,t){return r[0]=Ut(t[0]),r[1]=Ut(t[1]),r[2]=Ut(t[2]),r}function vg(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r}function Tg(r,t,e,n){return r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r}function bh(r,t){let e=t[0]-r[0],n=t[1]-r[1],s=t[2]-r[2];return Math.sqrt(e*e+n*n+s*s)}function wh(r,t){let e=t[0]-r[0],n=t[1]-r[1],s=t[2]-r[2];return e*e+n*n+s*s}function vh(r){let t=r[0],e=r[1],n=r[2];return t*t+e*e+n*n}function kg(r,t){return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r}function Eg(r,t){return r[0]=1/t[0],r[1]=1/t[1],r[2]=1/t[2],r}function Sg(r,t){let e=t[0],n=t[1],s=t[2],i=e*e+n*n+s*s;return i>0&&(i=1/Math.sqrt(i)),r[0]=t[0]*i,r[1]=t[1]*i,r[2]=t[2]*i,r}function Ga(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]}function Ha(r,t,e){let n=t[0],s=t[1],i=t[2],o=e[0],a=e[1],c=e[2];return r[0]=s*c-i*a,r[1]=i*o-n*c,r[2]=n*a-s*o,r}function Ag(r,t,e,n){let s=t[0],i=t[1],o=t[2];return r[0]=s+n*(e[0]-s),r[1]=i+n*(e[1]-i),r[2]=o+n*(e[2]-o),r}function Ig(r,t,e,n){let s=Math.acos(Math.min(Math.max(Ga(t,e),-1),1)),i=Math.sin(s),o=Math.sin((1-n)*s)/i,a=Math.sin(n*s)/i;return r[0]=o*t[0]+a*e[0],r[1]=o*t[1]+a*e[1],r[2]=o*t[2]+a*e[2],r}function Pg(r,t,e,n,s,i){let o=i*i,a=o*(2*i-3)+1,c=o*(i-2)+i,l=o*(i-1),u=o*(3-2*i);return r[0]=t[0]*a+e[0]*c+n[0]*l+s[0]*u,r[1]=t[1]*a+e[1]*c+n[1]*l+s[1]*u,r[2]=t[2]*a+e[2]*c+n[2]*l+s[2]*u,r}function Mg(r,t,e,n,s,i){let o=1-i,a=o*o,c=i*i,l=a*o,u=3*i*a,h=3*c*o,f=c*i;return r[0]=t[0]*l+e[0]*u+n[0]*h+s[0]*f,r[1]=t[1]*l+e[1]*u+n[1]*h+s[1]*f,r[2]=t[2]*l+e[2]*u+n[2]*h+s[2]*f,r}function Lg(r,t){t=t===void 0?1:t;let e=re()*2*Math.PI,n=re()*2-1,s=Math.sqrt(1-n*n)*t;return r[0]=Math.cos(e)*s,r[1]=Math.sin(e)*s,r[2]=n*t,r}function Tr(r,t,e){let n=t[0],s=t[1],i=t[2],o=e[3]*n+e[7]*s+e[11]*i+e[15];return o=o||1,r[0]=(e[0]*n+e[4]*s+e[8]*i+e[12])/o,r[1]=(e[1]*n+e[5]*s+e[9]*i+e[13])/o,r[2]=(e[2]*n+e[6]*s+e[10]*i+e[14])/o,r}function qa(r,t,e){let n=t[0],s=t[1],i=t[2];return r[0]=n*e[0]+s*e[3]+i*e[6],r[1]=n*e[1]+s*e[4]+i*e[7],r[2]=n*e[2]+s*e[5]+i*e[8],r}function Ya(r,t,e){let n=e[0],s=e[1],i=e[2],o=e[3],a=t[0],c=t[1],l=t[2],u=s*l-i*c,h=i*a-n*l,f=n*c-s*a,p=s*f-i*h,_=i*u-n*f,x=n*h-s*u,y=o*2;return u*=y,h*=y,f*=y,p*=2,_*=2,x*=2,r[0]=a+u+p,r[1]=c+h+_,r[2]=l+f+x,r}function Xa(r,t,e,n){let s=[],i=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],i[0]=s[0],i[1]=s[1]*Math.cos(n)-s[2]*Math.sin(n),i[2]=s[1]*Math.sin(n)+s[2]*Math.cos(n),r[0]=i[0]+e[0],r[1]=i[1]+e[1],r[2]=i[2]+e[2],r}function Za(r,t,e,n){let s=[],i=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],i[0]=s[2]*Math.sin(n)+s[0]*Math.cos(n),i[1]=s[1],i[2]=s[2]*Math.cos(n)-s[0]*Math.sin(n),r[0]=i[0]+e[0],r[1]=i[1]+e[1],r[2]=i[2]+e[2],r}function Ka(r,t,e,n){let s=[],i=[];return s[0]=t[0]-e[0],s[1]=t[1]-e[1],s[2]=t[2]-e[2],i[0]=s[0]*Math.cos(n)-s[1]*Math.sin(n),i[1]=s[0]*Math.sin(n)+s[1]*Math.cos(n),i[2]=s[2],r[0]=i[0]+e[0],r[1]=i[1]+e[1],r[2]=i[2]+e[2],r}function Ja(r,t){let e=r[0],n=r[1],s=r[2],i=t[0],o=t[1],a=t[2],c=Math.sqrt((e*e+n*n+s*s)*(i*i+o*o+a*a)),l=c&&Ga(r,t)/c;return Math.acos(Math.min(Math.max(l,-1),1))}function Cg(r){return r[0]=0,r[1]=0,r[2]=0,r}function Og(r){return`vec3(${r[0]}, ${r[1]}, ${r[2]})`}function Rg(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]}function Ng(r,t){let e=r[0],n=r[1],s=r[2],i=t[0],o=t[1],a=t[2];return Math.abs(e-i)<=1e-6*Math.max(1,Math.abs(e),Math.abs(i))&&Math.abs(n-o)<=1e-6*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-a)<=1e-6*Math.max(1,Math.abs(s),Math.abs(a))}var Dg=_h,Fg=yh,Vg=xh,Ug=bh,Bg=wh,zg=ii,jg=vh,$g=(function(){let r=gh();return function(t,e,n,s,i,o){let a,c;for(e||(e=3),n||(n=0),s?c=Math.min(s*e+n,t.length):c=t.length,a=n;a<c;a+=e)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],i(r,r,o),t[a]=r[0],t[a+1]=r[1],t[a+2]=r[2];return t}})();var Qa=[0,0,0],oi,rt=class r extends ni{static get ZERO(){return oi||(oi=new r(0,0,0),Object.freeze(oi)),oi}constructor(t=0,e=0,n=0){super(-0,-0,-0),arguments.length===1&&pe(t)?this.copy(t):(ut.debug&&(yt(t),yt(e),yt(n)),this[0]=t,this[1]=e,this[2]=n)}set(t,e,n){return this[0]=t,this[1]=e,this[2]=n,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return ut.debug&&(yt(t.x),yt(t.y),yt(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=yt(t)}angle(t){return Ja(this,t)}cross(t){return Ha(this,this,t),this.check()}rotateX({radians:t,origin:e=Qa}){return Xa(this,this,e,t),this.check()}rotateY({radians:t,origin:e=Qa}){return Za(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=Qa}){return Ka(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return Tr(this,this,t),this.check()}transformAsVector(t){return si(this,this,t),this.check()}transformByMatrix3(t){return qa(this,this,t),this.check()}transformByMatrix2(t){return mh(this,this,t),this.check()}transformByQuaternion(t){return Ya(this,this,t),this.check()}};var ai=class extends Nn{toString(){let t="[";if(ut.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let n=0;n<this.RANK;++n)t+=` ${this[n*this.RANK+e]}`}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=` ${this[e]}`}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,n){return this[e*this.RANK+t]=yt(n),this}getColumn(t,e=new Array(this.RANK).fill(-0)){let n=t*this.RANK;for(let s=0;s<this.RANK;++s)e[s]=this[n+s];return e}setColumn(t,e){let n=t*this.RANK;for(let s=0;s<this.RANK;++s)this[n+s]=e[s];return this}};var ft={};Qn(ft,{add:()=>d_,adjoint:()=>Xg,clone:()=>Gg,copy:()=>Hg,create:()=>Wg,decompose:()=>i_,determinant:()=>nc,equals:()=>y_,exactEquals:()=>__,frob:()=>p_,fromQuat:()=>lc,fromQuat2:()=>n_,fromRotation:()=>Jg,fromRotationTranslation:()=>kh,fromRotationTranslationScale:()=>o_,fromRotationTranslationScaleOrigin:()=>a_,fromScaling:()=>Kg,fromTranslation:()=>Zg,fromValues:()=>qg,fromXRotation:()=>Qg,fromYRotation:()=>t_,fromZRotation:()=>e_,frustum:()=>uc,getRotation:()=>s_,getScaling:()=>Eh,getTranslation:()=>r_,identity:()=>Th,invert:()=>ec,lookAt:()=>pc,mul:()=>x_,multiply:()=>kr,multiplyScalar:()=>m_,multiplyScalarAndAdd:()=>g_,ortho:()=>fc,orthoNO:()=>Ah,orthoZO:()=>u_,perspective:()=>hc,perspectiveFromFieldOfView:()=>l_,perspectiveNO:()=>Sh,perspectiveZO:()=>c_,rotate:()=>ic,rotateX:()=>oc,rotateY:()=>ac,rotateZ:()=>cc,scale:()=>sc,set:()=>Yg,str:()=>f_,sub:()=>b_,subtract:()=>Ih,targetTo:()=>h_,translate:()=>rc,transpose:()=>tc});function Wg(){let r=new ot(16);return ot!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function Gg(r){let t=new ot(16);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],t}function Hg(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function qg(r,t,e,n,s,i,o,a,c,l,u,h,f,p,_,x){let y=new ot(16);return y[0]=r,y[1]=t,y[2]=e,y[3]=n,y[4]=s,y[5]=i,y[6]=o,y[7]=a,y[8]=c,y[9]=l,y[10]=u,y[11]=h,y[12]=f,y[13]=p,y[14]=_,y[15]=x,y}function Yg(r,t,e,n,s,i,o,a,c,l,u,h,f,p,_,x,y){return r[0]=t,r[1]=e,r[2]=n,r[3]=s,r[4]=i,r[5]=o,r[6]=a,r[7]=c,r[8]=l,r[9]=u,r[10]=h,r[11]=f,r[12]=p,r[13]=_,r[14]=x,r[15]=y,r}function Th(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function tc(r,t){if(r===t){let e=t[1],n=t[2],s=t[3],i=t[6],o=t[7],a=t[11];r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=e,r[6]=t[9],r[7]=t[13],r[8]=n,r[9]=i,r[11]=t[14],r[12]=s,r[13]=o,r[14]=a}else r[0]=t[0],r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=t[1],r[5]=t[5],r[6]=t[9],r[7]=t[13],r[8]=t[2],r[9]=t[6],r[10]=t[10],r[11]=t[14],r[12]=t[3],r[13]=t[7],r[14]=t[11],r[15]=t[15];return r}function ec(r,t){let e=t[0],n=t[1],s=t[2],i=t[3],o=t[4],a=t[5],c=t[6],l=t[7],u=t[8],h=t[9],f=t[10],p=t[11],_=t[12],x=t[13],y=t[14],T=t[15],I=e*a-n*o,k=e*c-s*o,S=e*l-i*o,P=n*c-s*a,L=n*l-i*a,F=s*l-i*c,D=u*x-h*_,R=u*y-f*_,O=u*T-p*_,V=h*y-f*x,j=h*T-p*x,q=f*T-p*y,H=I*q-k*j+S*V+P*O-L*R+F*D;return H?(H=1/H,r[0]=(a*q-c*j+l*V)*H,r[1]=(s*j-n*q-i*V)*H,r[2]=(x*F-y*L+T*P)*H,r[3]=(f*L-h*F-p*P)*H,r[4]=(c*O-o*q-l*R)*H,r[5]=(e*q-s*O+i*R)*H,r[6]=(y*S-_*F-T*k)*H,r[7]=(u*F-f*S+p*k)*H,r[8]=(o*j-a*O+l*D)*H,r[9]=(n*O-e*j-i*D)*H,r[10]=(_*L-x*S+T*I)*H,r[11]=(h*S-u*L-p*I)*H,r[12]=(a*R-o*V-c*D)*H,r[13]=(e*V-n*R+s*D)*H,r[14]=(x*k-_*P-y*I)*H,r[15]=(u*P-h*k+f*I)*H,r):null}function Xg(r,t){let e=t[0],n=t[1],s=t[2],i=t[3],o=t[4],a=t[5],c=t[6],l=t[7],u=t[8],h=t[9],f=t[10],p=t[11],_=t[12],x=t[13],y=t[14],T=t[15],I=e*a-n*o,k=e*c-s*o,S=e*l-i*o,P=n*c-s*a,L=n*l-i*a,F=s*l-i*c,D=u*x-h*_,R=u*y-f*_,O=u*T-p*_,V=h*y-f*x,j=h*T-p*x,q=f*T-p*y;return r[0]=a*q-c*j+l*V,r[1]=s*j-n*q-i*V,r[2]=x*F-y*L+T*P,r[3]=f*L-h*F-p*P,r[4]=c*O-o*q-l*R,r[5]=e*q-s*O+i*R,r[6]=y*S-_*F-T*k,r[7]=u*F-f*S+p*k,r[8]=o*j-a*O+l*D,r[9]=n*O-e*j-i*D,r[10]=_*L-x*S+T*I,r[11]=h*S-u*L-p*I,r[12]=a*R-o*V-c*D,r[13]=e*V-n*R+s*D,r[14]=x*k-_*P-y*I,r[15]=u*P-h*k+f*I,r}function nc(r){let t=r[0],e=r[1],n=r[2],s=r[3],i=r[4],o=r[5],a=r[6],c=r[7],l=r[8],u=r[9],h=r[10],f=r[11],p=r[12],_=r[13],x=r[14],y=r[15],T=t*o-e*i,I=t*a-n*i,k=e*a-n*o,S=l*_-u*p,P=l*x-h*p,L=u*x-h*_,F=t*L-e*P+n*S,D=i*L-o*P+a*S,R=l*k-u*I+h*T,O=p*k-_*I+x*T;return c*F-s*D+y*R-f*O}function kr(r,t,e){let n=t[0],s=t[1],i=t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=t[9],p=t[10],_=t[11],x=t[12],y=t[13],T=t[14],I=t[15],k=e[0],S=e[1],P=e[2],L=e[3];return r[0]=k*n+S*a+P*h+L*x,r[1]=k*s+S*c+P*f+L*y,r[2]=k*i+S*l+P*p+L*T,r[3]=k*o+S*u+P*_+L*I,k=e[4],S=e[5],P=e[6],L=e[7],r[4]=k*n+S*a+P*h+L*x,r[5]=k*s+S*c+P*f+L*y,r[6]=k*i+S*l+P*p+L*T,r[7]=k*o+S*u+P*_+L*I,k=e[8],S=e[9],P=e[10],L=e[11],r[8]=k*n+S*a+P*h+L*x,r[9]=k*s+S*c+P*f+L*y,r[10]=k*i+S*l+P*p+L*T,r[11]=k*o+S*u+P*_+L*I,k=e[12],S=e[13],P=e[14],L=e[15],r[12]=k*n+S*a+P*h+L*x,r[13]=k*s+S*c+P*f+L*y,r[14]=k*i+S*l+P*p+L*T,r[15]=k*o+S*u+P*_+L*I,r}function rc(r,t,e){let n=e[0],s=e[1],i=e[2],o,a,c,l,u,h,f,p,_,x,y,T;return t===r?(r[12]=t[0]*n+t[4]*s+t[8]*i+t[12],r[13]=t[1]*n+t[5]*s+t[9]*i+t[13],r[14]=t[2]*n+t[6]*s+t[10]*i+t[14],r[15]=t[3]*n+t[7]*s+t[11]*i+t[15]):(o=t[0],a=t[1],c=t[2],l=t[3],u=t[4],h=t[5],f=t[6],p=t[7],_=t[8],x=t[9],y=t[10],T=t[11],r[0]=o,r[1]=a,r[2]=c,r[3]=l,r[4]=u,r[5]=h,r[6]=f,r[7]=p,r[8]=_,r[9]=x,r[10]=y,r[11]=T,r[12]=o*n+u*s+_*i+t[12],r[13]=a*n+h*s+x*i+t[13],r[14]=c*n+f*s+y*i+t[14],r[15]=l*n+p*s+T*i+t[15]),r}function sc(r,t,e){let n=e[0],s=e[1],i=e[2];return r[0]=t[0]*n,r[1]=t[1]*n,r[2]=t[2]*n,r[3]=t[3]*n,r[4]=t[4]*s,r[5]=t[5]*s,r[6]=t[6]*s,r[7]=t[7]*s,r[8]=t[8]*i,r[9]=t[9]*i,r[10]=t[10]*i,r[11]=t[11]*i,r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function ic(r,t,e,n){let s=n[0],i=n[1],o=n[2],a=Math.sqrt(s*s+i*i+o*o),c,l,u,h,f,p,_,x,y,T,I,k,S,P,L,F,D,R,O,V,j,q,H,mt;return a<1e-6?null:(a=1/a,s*=a,i*=a,o*=a,l=Math.sin(e),c=Math.cos(e),u=1-c,h=t[0],f=t[1],p=t[2],_=t[3],x=t[4],y=t[5],T=t[6],I=t[7],k=t[8],S=t[9],P=t[10],L=t[11],F=s*s*u+c,D=i*s*u+o*l,R=o*s*u-i*l,O=s*i*u-o*l,V=i*i*u+c,j=o*i*u+s*l,q=s*o*u+i*l,H=i*o*u-s*l,mt=o*o*u+c,r[0]=h*F+x*D+k*R,r[1]=f*F+y*D+S*R,r[2]=p*F+T*D+P*R,r[3]=_*F+I*D+L*R,r[4]=h*O+x*V+k*j,r[5]=f*O+y*V+S*j,r[6]=p*O+T*V+P*j,r[7]=_*O+I*V+L*j,r[8]=h*q+x*H+k*mt,r[9]=f*q+y*H+S*mt,r[10]=p*q+T*H+P*mt,r[11]=_*q+I*H+L*mt,t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r)}function oc(r,t,e){let n=Math.sin(e),s=Math.cos(e),i=t[4],o=t[5],a=t[6],c=t[7],l=t[8],u=t[9],h=t[10],f=t[11];return t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[4]=i*s+l*n,r[5]=o*s+u*n,r[6]=a*s+h*n,r[7]=c*s+f*n,r[8]=l*s-i*n,r[9]=u*s-o*n,r[10]=h*s-a*n,r[11]=f*s-c*n,r}function ac(r,t,e){let n=Math.sin(e),s=Math.cos(e),i=t[0],o=t[1],a=t[2],c=t[3],l=t[8],u=t[9],h=t[10],f=t[11];return t!==r&&(r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=i*s-l*n,r[1]=o*s-u*n,r[2]=a*s-h*n,r[3]=c*s-f*n,r[8]=i*n+l*s,r[9]=o*n+u*s,r[10]=a*n+h*s,r[11]=c*n+f*s,r}function cc(r,t,e){let n=Math.sin(e),s=Math.cos(e),i=t[0],o=t[1],a=t[2],c=t[3],l=t[4],u=t[5],h=t[6],f=t[7];return t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=i*s+l*n,r[1]=o*s+u*n,r[2]=a*s+h*n,r[3]=c*s+f*n,r[4]=l*s-i*n,r[5]=u*s-o*n,r[6]=h*s-a*n,r[7]=f*s-c*n,r}function Zg(r,t){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function Kg(r,t){return r[0]=t[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Jg(r,t,e){let n=e[0],s=e[1],i=e[2],o=Math.sqrt(n*n+s*s+i*i),a,c,l;return o<1e-6?null:(o=1/o,n*=o,s*=o,i*=o,c=Math.sin(t),a=Math.cos(t),l=1-a,r[0]=n*n*l+a,r[1]=s*n*l+i*c,r[2]=i*n*l-s*c,r[3]=0,r[4]=n*s*l-i*c,r[5]=s*s*l+a,r[6]=i*s*l+n*c,r[7]=0,r[8]=n*i*l+s*c,r[9]=s*i*l-n*c,r[10]=i*i*l+a,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function Qg(r,t){let e=Math.sin(t),n=Math.cos(t);return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=n,r[6]=e,r[7]=0,r[8]=0,r[9]=-e,r[10]=n,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function t_(r,t){let e=Math.sin(t),n=Math.cos(t);return r[0]=n,r[1]=0,r[2]=-e,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=e,r[9]=0,r[10]=n,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function e_(r,t){let e=Math.sin(t),n=Math.cos(t);return r[0]=n,r[1]=e,r[2]=0,r[3]=0,r[4]=-e,r[5]=n,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function kh(r,t,e){let n=t[0],s=t[1],i=t[2],o=t[3],a=n+n,c=s+s,l=i+i,u=n*a,h=n*c,f=n*l,p=s*c,_=s*l,x=i*l,y=o*a,T=o*c,I=o*l;return r[0]=1-(p+x),r[1]=h+I,r[2]=f-T,r[3]=0,r[4]=h-I,r[5]=1-(u+x),r[6]=_+y,r[7]=0,r[8]=f+T,r[9]=_-y,r[10]=1-(u+p),r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function n_(r,t){let e=new ot(3),n=-t[0],s=-t[1],i=-t[2],o=t[3],a=t[4],c=t[5],l=t[6],u=t[7],h=n*n+s*s+i*i+o*o;return h>0?(e[0]=(a*o+u*n+c*i-l*s)*2/h,e[1]=(c*o+u*s+l*n-a*i)*2/h,e[2]=(l*o+u*i+a*s-c*n)*2/h):(e[0]=(a*o+u*n+c*i-l*s)*2,e[1]=(c*o+u*s+l*n-a*i)*2,e[2]=(l*o+u*i+a*s-c*n)*2),kh(r,t,e),r}function r_(r,t){return r[0]=t[12],r[1]=t[13],r[2]=t[14],r}function Eh(r,t){let e=t[0],n=t[1],s=t[2],i=t[4],o=t[5],a=t[6],c=t[8],l=t[9],u=t[10];return r[0]=Math.sqrt(e*e+n*n+s*s),r[1]=Math.sqrt(i*i+o*o+a*a),r[2]=Math.sqrt(c*c+l*l+u*u),r}function s_(r,t){let e=new ot(3);Eh(e,t);let n=1/e[0],s=1/e[1],i=1/e[2],o=t[0]*n,a=t[1]*s,c=t[2]*i,l=t[4]*n,u=t[5]*s,h=t[6]*i,f=t[8]*n,p=t[9]*s,_=t[10]*i,x=o+u+_,y=0;return x>0?(y=Math.sqrt(x+1)*2,r[3]=.25*y,r[0]=(h-p)/y,r[1]=(f-c)/y,r[2]=(a-l)/y):o>u&&o>_?(y=Math.sqrt(1+o-u-_)*2,r[3]=(h-p)/y,r[0]=.25*y,r[1]=(a+l)/y,r[2]=(f+c)/y):u>_?(y=Math.sqrt(1+u-o-_)*2,r[3]=(f-c)/y,r[0]=(a+l)/y,r[1]=.25*y,r[2]=(h+p)/y):(y=Math.sqrt(1+_-o-u)*2,r[3]=(a-l)/y,r[0]=(f+c)/y,r[1]=(h+p)/y,r[2]=.25*y),r}function i_(r,t,e,n){t[0]=n[12],t[1]=n[13],t[2]=n[14];let s=n[0],i=n[1],o=n[2],a=n[4],c=n[5],l=n[6],u=n[8],h=n[9],f=n[10];e[0]=Math.sqrt(s*s+i*i+o*o),e[1]=Math.sqrt(a*a+c*c+l*l),e[2]=Math.sqrt(u*u+h*h+f*f);let p=1/e[0],_=1/e[1],x=1/e[2],y=s*p,T=i*_,I=o*x,k=a*p,S=c*_,P=l*x,L=u*p,F=h*_,D=f*x,R=y+S+D,O=0;return R>0?(O=Math.sqrt(R+1)*2,r[3]=.25*O,r[0]=(P-F)/O,r[1]=(L-I)/O,r[2]=(T-k)/O):y>S&&y>D?(O=Math.sqrt(1+y-S-D)*2,r[3]=(P-F)/O,r[0]=.25*O,r[1]=(T+k)/O,r[2]=(L+I)/O):S>D?(O=Math.sqrt(1+S-y-D)*2,r[3]=(L-I)/O,r[0]=(T+k)/O,r[1]=.25*O,r[2]=(P+F)/O):(O=Math.sqrt(1+D-y-S)*2,r[3]=(T-k)/O,r[0]=(L+I)/O,r[1]=(P+F)/O,r[2]=.25*O),r}function o_(r,t,e,n){let s=t[0],i=t[1],o=t[2],a=t[3],c=s+s,l=i+i,u=o+o,h=s*c,f=s*l,p=s*u,_=i*l,x=i*u,y=o*u,T=a*c,I=a*l,k=a*u,S=n[0],P=n[1],L=n[2];return r[0]=(1-(_+y))*S,r[1]=(f+k)*S,r[2]=(p-I)*S,r[3]=0,r[4]=(f-k)*P,r[5]=(1-(h+y))*P,r[6]=(x+T)*P,r[7]=0,r[8]=(p+I)*L,r[9]=(x-T)*L,r[10]=(1-(h+_))*L,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function a_(r,t,e,n,s){let i=t[0],o=t[1],a=t[2],c=t[3],l=i+i,u=o+o,h=a+a,f=i*l,p=i*u,_=i*h,x=o*u,y=o*h,T=a*h,I=c*l,k=c*u,S=c*h,P=n[0],L=n[1],F=n[2],D=s[0],R=s[1],O=s[2],V=(1-(x+T))*P,j=(p+S)*P,q=(_-k)*P,H=(p-S)*L,mt=(1-(f+T))*L,Ee=(y+I)*L,Jn=(_+k)*F,El=(y-I)*F,Sl=(1-(f+x))*F;return r[0]=V,r[1]=j,r[2]=q,r[3]=0,r[4]=H,r[5]=mt,r[6]=Ee,r[7]=0,r[8]=Jn,r[9]=El,r[10]=Sl,r[11]=0,r[12]=e[0]+D-(V*D+H*R+Jn*O),r[13]=e[1]+R-(j*D+mt*R+El*O),r[14]=e[2]+O-(q*D+Ee*R+Sl*O),r[15]=1,r}function lc(r,t){let e=t[0],n=t[1],s=t[2],i=t[3],o=e+e,a=n+n,c=s+s,l=e*o,u=n*o,h=n*a,f=s*o,p=s*a,_=s*c,x=i*o,y=i*a,T=i*c;return r[0]=1-h-_,r[1]=u+T,r[2]=f-y,r[3]=0,r[4]=u-T,r[5]=1-l-_,r[6]=p+x,r[7]=0,r[8]=f+y,r[9]=p-x,r[10]=1-l-h,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function uc(r,t,e,n,s,i,o){let a=1/(e-t),c=1/(s-n),l=1/(i-o);return r[0]=i*2*a,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=i*2*c,r[6]=0,r[7]=0,r[8]=(e+t)*a,r[9]=(s+n)*c,r[10]=(o+i)*l,r[11]=-1,r[12]=0,r[13]=0,r[14]=o*i*2*l,r[15]=0,r}function Sh(r,t,e,n,s){let i=1/Math.tan(t/2);if(r[0]=i/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=i,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,s!=null&&s!==1/0){let o=1/(n-s);r[10]=(s+n)*o,r[14]=2*s*n*o}else r[10]=-1,r[14]=-2*n;return r}var hc=Sh;function c_(r,t,e,n,s){let i=1/Math.tan(t/2);if(r[0]=i/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=i,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,s!=null&&s!==1/0){let o=1/(n-s);r[10]=s*o,r[14]=s*n*o}else r[10]=-1,r[14]=-n;return r}function l_(r,t,e,n){let s=Math.tan(t.upDegrees*Math.PI/180),i=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),c=2/(o+a),l=2/(s+i);return r[0]=c,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=l,r[6]=0,r[7]=0,r[8]=-((o-a)*c*.5),r[9]=(s-i)*l*.5,r[10]=n/(e-n),r[11]=-1,r[12]=0,r[13]=0,r[14]=n*e/(e-n),r[15]=0,r}function Ah(r,t,e,n,s,i,o){let a=1/(t-e),c=1/(n-s),l=1/(i-o);return r[0]=-2*a,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*c,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*l,r[11]=0,r[12]=(t+e)*a,r[13]=(s+n)*c,r[14]=(o+i)*l,r[15]=1,r}var fc=Ah;function u_(r,t,e,n,s,i,o){let a=1/(t-e),c=1/(n-s),l=1/(i-o);return r[0]=-2*a,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*c,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=l,r[11]=0,r[12]=(t+e)*a,r[13]=(s+n)*c,r[14]=i*l,r[15]=1,r}function pc(r,t,e,n){let s,i,o,a,c,l,u,h,f,p,_=t[0],x=t[1],y=t[2],T=n[0],I=n[1],k=n[2],S=e[0],P=e[1],L=e[2];return Math.abs(_-S)<1e-6&&Math.abs(x-P)<1e-6&&Math.abs(y-L)<1e-6?Th(r):(h=_-S,f=x-P,p=y-L,s=1/Math.sqrt(h*h+f*f+p*p),h*=s,f*=s,p*=s,i=I*p-k*f,o=k*h-T*p,a=T*f-I*h,s=Math.sqrt(i*i+o*o+a*a),s?(s=1/s,i*=s,o*=s,a*=s):(i=0,o=0,a=0),c=f*a-p*o,l=p*i-h*a,u=h*o-f*i,s=Math.sqrt(c*c+l*l+u*u),s?(s=1/s,c*=s,l*=s,u*=s):(c=0,l=0,u=0),r[0]=i,r[1]=c,r[2]=h,r[3]=0,r[4]=o,r[5]=l,r[6]=f,r[7]=0,r[8]=a,r[9]=u,r[10]=p,r[11]=0,r[12]=-(i*_+o*x+a*y),r[13]=-(c*_+l*x+u*y),r[14]=-(h*_+f*x+p*y),r[15]=1,r)}function h_(r,t,e,n){let s=t[0],i=t[1],o=t[2],a=n[0],c=n[1],l=n[2],u=s-e[0],h=i-e[1],f=o-e[2],p=u*u+h*h+f*f;p>0&&(p=1/Math.sqrt(p),u*=p,h*=p,f*=p);let _=c*f-l*h,x=l*u-a*f,y=a*h-c*u;return p=_*_+x*x+y*y,p>0&&(p=1/Math.sqrt(p),_*=p,x*=p,y*=p),r[0]=_,r[1]=x,r[2]=y,r[3]=0,r[4]=h*y-f*x,r[5]=f*_-u*y,r[6]=u*x-h*_,r[7]=0,r[8]=u,r[9]=h,r[10]=f,r[11]=0,r[12]=s,r[13]=i,r[14]=o,r[15]=1,r}function f_(r){return`mat4(${r[0]}, ${r[1]}, ${r[2]}, ${r[3]}, ${r[4]}, ${r[5]}, ${r[6]}, ${r[7]}, ${r[8]}, ${r[9]}, ${r[10]}, ${r[11]}, ${r[12]}, ${r[13]}, ${r[14]}, ${r[15]})`}function p_(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]+r[3]*r[3]+r[4]*r[4]+r[5]*r[5]+r[6]*r[6]+r[7]*r[7]+r[8]*r[8]+r[9]*r[9]+r[10]*r[10]+r[11]*r[11]+r[12]*r[12]+r[13]*r[13]+r[14]*r[14]+r[15]*r[15])}function d_(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r[3]=t[3]+e[3],r[4]=t[4]+e[4],r[5]=t[5]+e[5],r[6]=t[6]+e[6],r[7]=t[7]+e[7],r[8]=t[8]+e[8],r[9]=t[9]+e[9],r[10]=t[10]+e[10],r[11]=t[11]+e[11],r[12]=t[12]+e[12],r[13]=t[13]+e[13],r[14]=t[14]+e[14],r[15]=t[15]+e[15],r}function Ih(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r[3]=t[3]-e[3],r[4]=t[4]-e[4],r[5]=t[5]-e[5],r[6]=t[6]-e[6],r[7]=t[7]-e[7],r[8]=t[8]-e[8],r[9]=t[9]-e[9],r[10]=t[10]-e[10],r[11]=t[11]-e[11],r[12]=t[12]-e[12],r[13]=t[13]-e[13],r[14]=t[14]-e[14],r[15]=t[15]-e[15],r}function m_(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r[3]=t[3]*e,r[4]=t[4]*e,r[5]=t[5]*e,r[6]=t[6]*e,r[7]=t[7]*e,r[8]=t[8]*e,r[9]=t[9]*e,r[10]=t[10]*e,r[11]=t[11]*e,r[12]=t[12]*e,r[13]=t[13]*e,r[14]=t[14]*e,r[15]=t[15]*e,r}function g_(r,t,e,n){return r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r[3]=t[3]+e[3]*n,r[4]=t[4]+e[4]*n,r[5]=t[5]+e[5]*n,r[6]=t[6]+e[6]*n,r[7]=t[7]+e[7]*n,r[8]=t[8]+e[8]*n,r[9]=t[9]+e[9]*n,r[10]=t[10]+e[10]*n,r[11]=t[11]+e[11]*n,r[12]=t[12]+e[12]*n,r[13]=t[13]+e[13]*n,r[14]=t[14]+e[14]*n,r[15]=t[15]+e[15]*n,r}function __(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]&&r[3]===t[3]&&r[4]===t[4]&&r[5]===t[5]&&r[6]===t[6]&&r[7]===t[7]&&r[8]===t[8]&&r[9]===t[9]&&r[10]===t[10]&&r[11]===t[11]&&r[12]===t[12]&&r[13]===t[13]&&r[14]===t[14]&&r[15]===t[15]}function y_(r,t){let e=r[0],n=r[1],s=r[2],i=r[3],o=r[4],a=r[5],c=r[6],l=r[7],u=r[8],h=r[9],f=r[10],p=r[11],_=r[12],x=r[13],y=r[14],T=r[15],I=t[0],k=t[1],S=t[2],P=t[3],L=t[4],F=t[5],D=t[6],R=t[7],O=t[8],V=t[9],j=t[10],q=t[11],H=t[12],mt=t[13],Ee=t[14],Jn=t[15];return Math.abs(e-I)<=1e-6*Math.max(1,Math.abs(e),Math.abs(I))&&Math.abs(n-k)<=1e-6*Math.max(1,Math.abs(n),Math.abs(k))&&Math.abs(s-S)<=1e-6*Math.max(1,Math.abs(s),Math.abs(S))&&Math.abs(i-P)<=1e-6*Math.max(1,Math.abs(i),Math.abs(P))&&Math.abs(o-L)<=1e-6*Math.max(1,Math.abs(o),Math.abs(L))&&Math.abs(a-F)<=1e-6*Math.max(1,Math.abs(a),Math.abs(F))&&Math.abs(c-D)<=1e-6*Math.max(1,Math.abs(c),Math.abs(D))&&Math.abs(l-R)<=1e-6*Math.max(1,Math.abs(l),Math.abs(R))&&Math.abs(u-O)<=1e-6*Math.max(1,Math.abs(u),Math.abs(O))&&Math.abs(h-V)<=1e-6*Math.max(1,Math.abs(h),Math.abs(V))&&Math.abs(f-j)<=1e-6*Math.max(1,Math.abs(f),Math.abs(j))&&Math.abs(p-q)<=1e-6*Math.max(1,Math.abs(p),Math.abs(q))&&Math.abs(_-H)<=1e-6*Math.max(1,Math.abs(_),Math.abs(H))&&Math.abs(x-mt)<=1e-6*Math.max(1,Math.abs(x),Math.abs(mt))&&Math.abs(y-Ee)<=1e-6*Math.max(1,Math.abs(y),Math.abs(Ee))&&Math.abs(T-Jn)<=1e-6*Math.max(1,Math.abs(T),Math.abs(Jn))}var x_=kr,b_=Ih;var Lt={};Qn(Lt,{add:()=>E_,ceil:()=>S_,clone:()=>w_,copy:()=>T_,create:()=>Ph,cross:()=>F_,dist:()=>Y_,distance:()=>Oh,div:()=>q_,divide:()=>Ch,dot:()=>D_,equals:()=>W_,exactEquals:()=>$_,floor:()=>A_,forEach:()=>J_,fromValues:()=>v_,inverse:()=>R_,len:()=>Z_,length:()=>Nh,lerp:()=>V_,max:()=>P_,min:()=>I_,mul:()=>H_,multiply:()=>Lh,negate:()=>O_,normalize:()=>N_,random:()=>U_,round:()=>M_,scale:()=>L_,scaleAndAdd:()=>C_,set:()=>k_,sqrDist:()=>X_,sqrLen:()=>K_,squaredDistance:()=>Rh,squaredLength:()=>Dh,str:()=>j_,sub:()=>G_,subtract:()=>Mh,transformMat4:()=>dc,transformQuat:()=>B_,zero:()=>z_});function Ph(){let r=new ot(4);return ot!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function w_(r){let t=new ot(4);return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t}function v_(r,t,e,n){let s=new ot(4);return s[0]=r,s[1]=t,s[2]=e,s[3]=n,s}function T_(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r}function k_(r,t,e,n,s){return r[0]=t,r[1]=e,r[2]=n,r[3]=s,r}function E_(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r[3]=t[3]+e[3],r}function Mh(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r[3]=t[3]-e[3],r}function Lh(r,t,e){return r[0]=t[0]*e[0],r[1]=t[1]*e[1],r[2]=t[2]*e[2],r[3]=t[3]*e[3],r}function Ch(r,t,e){return r[0]=t[0]/e[0],r[1]=t[1]/e[1],r[2]=t[2]/e[2],r[3]=t[3]/e[3],r}function S_(r,t){return r[0]=Math.ceil(t[0]),r[1]=Math.ceil(t[1]),r[2]=Math.ceil(t[2]),r[3]=Math.ceil(t[3]),r}function A_(r,t){return r[0]=Math.floor(t[0]),r[1]=Math.floor(t[1]),r[2]=Math.floor(t[2]),r[3]=Math.floor(t[3]),r}function I_(r,t,e){return r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.min(t[2],e[2]),r[3]=Math.min(t[3],e[3]),r}function P_(r,t,e){return r[0]=Math.max(t[0],e[0]),r[1]=Math.max(t[1],e[1]),r[2]=Math.max(t[2],e[2]),r[3]=Math.max(t[3],e[3]),r}function M_(r,t){return r[0]=Ut(t[0]),r[1]=Ut(t[1]),r[2]=Ut(t[2]),r[3]=Ut(t[3]),r}function L_(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r[3]=t[3]*e,r}function C_(r,t,e,n){return r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r[3]=t[3]+e[3]*n,r}function Oh(r,t){let e=t[0]-r[0],n=t[1]-r[1],s=t[2]-r[2],i=t[3]-r[3];return Math.sqrt(e*e+n*n+s*s+i*i)}function Rh(r,t){let e=t[0]-r[0],n=t[1]-r[1],s=t[2]-r[2],i=t[3]-r[3];return e*e+n*n+s*s+i*i}function Nh(r){let t=r[0],e=r[1],n=r[2],s=r[3];return Math.sqrt(t*t+e*e+n*n+s*s)}function Dh(r){let t=r[0],e=r[1],n=r[2],s=r[3];return t*t+e*e+n*n+s*s}function O_(r,t){return r[0]=-t[0],r[1]=-t[1],r[2]=-t[2],r[3]=-t[3],r}function R_(r,t){return r[0]=1/t[0],r[1]=1/t[1],r[2]=1/t[2],r[3]=1/t[3],r}function N_(r,t){let e=t[0],n=t[1],s=t[2],i=t[3],o=e*e+n*n+s*s+i*i;return o>0&&(o=1/Math.sqrt(o)),r[0]=e*o,r[1]=n*o,r[2]=s*o,r[3]=i*o,r}function D_(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]*t[3]}function F_(r,t,e,n){let s=e[0]*n[1]-e[1]*n[0],i=e[0]*n[2]-e[2]*n[0],o=e[0]*n[3]-e[3]*n[0],a=e[1]*n[2]-e[2]*n[1],c=e[1]*n[3]-e[3]*n[1],l=e[2]*n[3]-e[3]*n[2],u=t[0],h=t[1],f=t[2],p=t[3];return r[0]=h*l-f*c+p*a,r[1]=-(u*l)+f*o-p*i,r[2]=u*c-h*o+p*s,r[3]=-(u*a)+h*i-f*s,r}function V_(r,t,e,n){let s=t[0],i=t[1],o=t[2],a=t[3];return r[0]=s+n*(e[0]-s),r[1]=i+n*(e[1]-i),r[2]=o+n*(e[2]-o),r[3]=a+n*(e[3]-a),r}function U_(r,t){t=t===void 0?1:t;let e,n,s,i,o,a;do e=re()*2-1,n=re()*2-1,o=e*e+n*n;while(o>=1);do s=re()*2-1,i=re()*2-1,a=s*s+i*i;while(a>=1);let c=Math.sqrt((1-o)/a);return r[0]=t*e,r[1]=t*n,r[2]=t*s*c,r[3]=t*i*c,r}function dc(r,t,e){let n=t[0],s=t[1],i=t[2],o=t[3];return r[0]=e[0]*n+e[4]*s+e[8]*i+e[12]*o,r[1]=e[1]*n+e[5]*s+e[9]*i+e[13]*o,r[2]=e[2]*n+e[6]*s+e[10]*i+e[14]*o,r[3]=e[3]*n+e[7]*s+e[11]*i+e[15]*o,r}function B_(r,t,e){let n=t[0],s=t[1],i=t[2],o=e[0],a=e[1],c=e[2],l=e[3],u=l*n+a*i-c*s,h=l*s+c*n-o*i,f=l*i+o*s-a*n,p=-o*n-a*s-c*i;return r[0]=u*l+p*-o+h*-c-f*-a,r[1]=h*l+p*-a+f*-o-u*-c,r[2]=f*l+p*-c+u*-a-h*-o,r[3]=t[3],r}function z_(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=0,r}function j_(r){return`vec4(${r[0]}, ${r[1]}, ${r[2]}, ${r[3]})`}function $_(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]&&r[3]===t[3]}function W_(r,t){let e=r[0],n=r[1],s=r[2],i=r[3],o=t[0],a=t[1],c=t[2],l=t[3];return Math.abs(e-o)<=1e-6*Math.max(1,Math.abs(e),Math.abs(o))&&Math.abs(n-a)<=1e-6*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(s-c)<=1e-6*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(i-l)<=1e-6*Math.max(1,Math.abs(i),Math.abs(l))}var G_=Mh,H_=Lh,q_=Ch,Y_=Oh,X_=Rh,Z_=Nh,K_=Dh,J_=(function(){let r=Ph();return function(t,e,n,s,i,o){let a,c;for(e||(e=4),n||(n=0),s?c=Math.min(s*e+n,t.length):c=t.length,a=n;a<c;a+=e)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],r[3]=t[a+3],i(r,r,o),t[a]=r[0],t[a+1]=r[1],t[a+2]=r[2],t[a+3]=r[3];return t}})();var Vh=(function(r){return r[r.COL0ROW0=0]="COL0ROW0",r[r.COL0ROW1=1]="COL0ROW1",r[r.COL0ROW2=2]="COL0ROW2",r[r.COL0ROW3=3]="COL0ROW3",r[r.COL1ROW0=4]="COL1ROW0",r[r.COL1ROW1=5]="COL1ROW1",r[r.COL1ROW2=6]="COL1ROW2",r[r.COL1ROW3=7]="COL1ROW3",r[r.COL2ROW0=8]="COL2ROW0",r[r.COL2ROW1=9]="COL2ROW1",r[r.COL2ROW2=10]="COL2ROW2",r[r.COL2ROW3=11]="COL2ROW3",r[r.COL3ROW0=12]="COL3ROW0",r[r.COL3ROW1=13]="COL3ROW1",r[r.COL3ROW2=14]="COL3ROW2",r[r.COL3ROW3=15]="COL3ROW3",r})(Vh||{}),Q_=45*Math.PI/180,ty=1,mc=.1,gc=500,ey=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),Q=class extends ai{static get IDENTITY(){return ry()}static get ZERO(){return ny()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return Vh}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,n,s,i,o,a,c,l,u,h,f,p,_,x,y){return this[0]=t,this[1]=e,this[2]=n,this[3]=s,this[4]=i,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this[9]=u,this[10]=h,this[11]=f,this[12]=p,this[13]=_,this[14]=x,this[15]=y,this.check()}setRowMajor(t,e,n,s,i,o,a,c,l,u,h,f,p,_,x,y){return this[0]=t,this[1]=i,this[2]=l,this[3]=p,this[4]=e,this[5]=o,this[6]=u,this[7]=_,this[8]=n,this[9]=a,this[10]=h,this[11]=x,this[12]=s,this[13]=c,this[14]=f,this[15]=y,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(ey)}fromObject(t){return this.check()}fromQuaternion(t){return lc(this,t),this.check()}frustum(t){let{left:e,right:n,bottom:s,top:i,near:o=mc,far:a=gc}=t;return a===1/0?sy(this,e,n,s,i,o):uc(this,e,n,s,i,o,a),this.check()}lookAt(t){let{eye:e,center:n=[0,0,0],up:s=[0,1,0]}=t;return pc(this,e,n,s),this.check()}ortho(t){let{left:e,right:n,bottom:s,top:i,near:o=mc,far:a=gc}=t;return fc(this,e,n,s,i,o,a),this.check()}orthographic(t){let{fovy:e=Q_,aspect:n=ty,focalDistance:s=1,near:i=mc,far:o=gc}=t;Fh(e);let a=e/2,c=s*Math.tan(a),l=c*n;return this.ortho({left:-l,right:l,bottom:-c,top:c,near:i,far:o})}perspective(t){let{fovy:e=45*Math.PI/180,aspect:n=1,near:s=.1,far:i=500}=t;return Fh(e),hc(this,e,n,s,i),this.check()}determinant(){return nc(this)}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];let n=this.getScale(e),s=1/n[0],i=1/n[1],o=1/n[2];return t[0]=this[0]*s,t[1]=this[1]*i,t[2]=this[2]*o,t[3]=0,t[4]=this[4]*s,t[5]=this[5]*i,t[6]=this[6]*o,t[7]=0,t[8]=this[8]*s,t[9]=this[9]*i,t[10]=this[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];let n=this.getScale(e),s=1/n[0],i=1/n[1],o=1/n[2];return t[0]=this[0]*s,t[1]=this[1]*i,t[2]=this[2]*o,t[3]=this[4]*s,t[4]=this[5]*i,t[5]=this[6]*o,t[6]=this[8]*s,t[7]=this[9]*i,t[8]=this[10]*o,t}transpose(){return tc(this,this),this.check()}invert(){return ec(this,this),this.check()}multiplyLeft(t){return kr(this,t,this),this.check()}multiplyRight(t){return kr(this,this,t),this.check()}rotateX(t){return oc(this,this,t),this.check()}rotateY(t){return ac(this,this,t),this.check()}rotateZ(t){return cc(this,this,t),this.check()}rotateXYZ(t){return this.rotateX(t[0]).rotateY(t[1]).rotateZ(t[2])}rotateAxis(t,e){return ic(this,this,t,e),this.check()}scale(t){return sc(this,this,Array.isArray(t)?t:[t,t,t]),this.check()}translate(t){return rc(this,this,t),this.check()}transform(t,e){return t.length===4?(e=dc(e||[-0,-0,-0,-0],t,this),ei(e,4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){let{length:n}=t,s;switch(n){case 2:s=Wa(e||[-0,-0],t,this);break;case 3:s=Tr(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return ei(s,t.length),s}transformAsVector(t,e){let n;switch(t.length){case 2:n=dh(e||[-0,-0],t,this);break;case 3:n=si(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return ei(n,t.length),n}transformPoint(t,e){return this.transformAsPoint(t,e)}transformVector(t,e){return this.transformAsPoint(t,e)}transformDirection(t,e){return this.transformAsVector(t,e)}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,n){return this.identity().translate([t,e,n])}},ci,li;function ny(){return ci||(ci=new Q([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(ci)),ci}function ry(){return li||(li=new Q,Object.freeze(li)),li}function Fh(r){if(r>Math.PI*2)throw Error("expected radians")}function sy(r,t,e,n,s,i){let o=2*i/(e-t),a=2*i/(s-n),c=(e+t)/(e-t),l=(s+n)/(s-n),u=-1,h=-1,f=-2*i;return r[0]=o,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=a,r[6]=0,r[7]=0,r[8]=c,r[9]=l,r[10]=u,r[11]=h,r[12]=0,r[13]=0,r[14]=f,r[15]=0,r}var Uh=1e-6,iy=6371e3,me=class r{constructor({phi:t=0,theta:e=0,radius:n=1,bearing:s,pitch:i,altitude:o,radiusScale:a=iy}={}){this.phi=t,this.theta=e,this.radius=n||o||1,this.radiusScale=a||1,s!==void 0&&(this.bearing=s),i!==void 0&&(this.pitch=i),this.check()}toString(){return this.formatString(ut)}formatString({printTypes:t=!1}){let e=vr;return`${t?"Spherical":""}[rho:${e(this.radius)},theta:${e(this.theta)},phi:${e(this.phi)}]`}equals(t){return Mt(this.radius,t.radius)&&Mt(this.theta,t.theta)&&Mt(this.phi,t.phi)}exactEquals(t){return this.radius===t.radius&&this.theta===t.theta&&this.phi===t.phi}get bearing(){return 180-Me(this.phi)}set bearing(t){this.phi=Math.PI-Rn(t)}get pitch(){return Me(this.theta)}set pitch(t){this.theta=Rn(t)}get longitude(){return Me(this.phi)}get latitude(){return Me(this.theta)}get lng(){return Me(this.phi)}get lat(){return Me(this.theta)}get z(){return(this.radius-1)*this.radiusScale}set(t,e,n){return this.radius=t,this.phi=e,this.theta=n,this.check()}clone(){return new r().copy(this)}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this.check()}fromLngLatZ([t,e,n]){return this.radius=1+n/this.radiusScale,this.phi=Rn(e),this.theta=Rn(t),this.check()}fromVector3(t){return this.radius=ii(t),this.radius>0&&(this.theta=Math.atan2(t[0],t[1]),this.phi=Math.acos(X(t[2]/this.radius,-1,1))),this.check()}toVector3(){return new rt(0,0,this.radius).rotateX({radians:this.theta}).rotateZ({radians:this.phi})}makeSafe(){return this.phi=Math.max(Uh,Math.min(Math.PI-Uh,this.phi)),this}check(){if(!Number.isFinite(this.phi)||!Number.isFinite(this.theta)||!(this.radius>0))throw new Error("SphericalCoordinates: some fields set to invalid numbers");return this}};function _c(r,t=[],e=0){let n=Math.fround(r),s=r-n;return t[e]=n,t[e+1]=s,t}function Bh(r){return r-Math.fround(r)}function zh(r){let t=new Float32Array(32);for(let e=0;e<4;++e)for(let n=0;n<4;++n){let s=e*4+n;_c(r[n*4+e],t,s*2)}return t}var oy=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,yc={name:"fp32",vs:oy};var jh=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`;var ay={ONE:1},xc={name:"fp64arithmetic",vs:jh,defaultUniforms:ay,uniformTypes:{ONE:"f32"},fp64ify:_c,fp64LowPart:Bh,fp64ifyMatrix4:zh};var cy=[0,1,1,1],ly=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,uy=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,ui={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:cy},vs:ly,fs:uy,getUniforms:hy};function hy(r={},t){let e={};if(r.highlightedObjectColor!==void 0)if(r.highlightedObjectColor===null)e.isHighlightActive=!1;else{e.isHighlightActive=!0;let n=r.highlightedObjectColor.slice(0,3);e.highlightedObjectColor=n}if(r.highlightColor){let n=Array.from(r.highlightColor,s=>s/255);Number.isFinite(n[3])||(n[3]=1),e.highlightColor=n}return r.isActive!==void 0&&(e.isActive=!!r.isActive,e.isAttribute=!!r.isAttribute),r.useFloatColors!==void 0&&(e.useFloatColors=!!r.useFloatColors),e}var bc=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`;var $h=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  pointLightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`;var fy=5,py=255,hi=(function(r){return r[r.POINT=0]="POINT",r[r.DIRECTIONAL=1]="DIRECTIONAL",r})(hi||{}),Ke={props:{},uniforms:{},name:"lighting",defines:{},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:hi.POINT,directionalLightCount:0,pointLightCount:0,ambientColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:$h,vs:bc,fs:bc,getUniforms:dy};function dy(r,t={}){if(r=r&&d({},r),!r)return d({},Ke.defaultUniforms);r.lights&&(r=M(d(d({},r),gy(r.lights)),{lights:void 0}));let{ambientLight:e,pointLights:n,directionalLights:s}=r||{};if(!(e||n&&n.length>0||s&&s.length>0))return M(d({},Ke.defaultUniforms),{enabled:0});let o=d(d(d({},Ke.defaultUniforms),t),my({ambientLight:e,pointLights:n,directionalLights:s}));return r.enabled!==void 0&&(o.enabled=r.enabled?1:0),o}function my({ambientLight:r,pointLights:t=[],directionalLights:e=[]}){let n={};n.ambientColor=wc(r);let s=0;for(let i of t){n.lightType=hi.POINT;let o=s;n[`lightColor${o}`]=wc(i),n[`lightPosition${o}`]=i.position,n[`lightAttenuation${o}`]=i.attenuation||[1,0,0],s++}for(let i of e){n.lightType=hi.DIRECTIONAL;let o=s;n[`lightColor${o}`]=wc(i),n[`lightDirection${o}`]=i.direction,s++}return s>fy&&W.warn("MAX_LIGHTS exceeded")(),n.directionalLightCount=e.length,n.pointLightCount=t.length,n}function gy(r){let t={pointLights:[],directionalLights:[]};for(let e of r||[])switch(e.type){case"ambient":t.ambientLight=e;break;case"directional":t.directionalLights?.push(e);break;case"point":t.pointLights?.push(e);break;default:}return t}function wc(r={}){let{color:t=[0,0,0],intensity:e=1}=r;return t.map(n=>n*e/py)}var fi=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,pi=`#define MAX_LIGHTS 3

uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`;var di=`struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`;var mi={props:{},name:"gouraudMaterial",vs:pi.replace("phongMaterial","gouraudMaterial"),fs:fi.replace("phongMaterial","gouraudMaterial"),source:di.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:!0},dependencies:[Ke],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(r){let t=d({},r);return t.specularColor&&(t.specularColor=t.specularColor.map(e=>e/255)),d(d({},mi.defaultUniforms),t)}};var gi={name:"phongMaterial",dependencies:[Ke],source:di,vs:fi,fs:pi,defines:{LIGHTING_FRAGMENT:!0},uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(r){let t=d({},r);return t.specularColor&&(t.specularColor=t.specularColor.map(e=>e/255)),d(d({},gi.defaultUniforms),t)}};var Wh=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,vc={name:"layer",vs:Wh,fs:Wh,getUniforms:r=>({opacity:Math.pow(r.opacity,.45454545454545453)}),uniformTypes:{opacity:"f32"}};var _y=`

struct ColorUniforms {
  opacity: f32,
};

var<private> color: ColorUniforms = ColorUniforms(1.0);
// TODO (kaapp) avoiding binding index collisions to handle layer opacity 
// requires some thought.
// @group(0) @binding(0) var<uniform> color: ColorUniforms;

@must_use
fn deckgl_premultiplied_alpha(fragColor: vec4<f32>) -> vec4<f32> {
    return vec4(fragColor.rgb * fragColor.a, fragColor.a); 
};
`,Gh={name:"color",dependencies:[],source:_y,getUniforms:r=>({}),uniformTypes:{opacity:"f32"}};var yy=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Hh="#define SMOOTH_EDGE_RADIUS 0.5",xy=`${Hh}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,by=`${Hh}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,_i={name:"geometry",source:yy,vs:xy,fs:by};var J=(function(r){return r[r.Start=1]="Start",r[r.Move=2]="Move",r[r.End=4]="End",r[r.Cancel=8]="Cancel",r})(J||{}),nt=(function(r){return r[r.None=0]="None",r[r.Left=1]="Left",r[r.Right=2]="Right",r[r.Up=4]="Up",r[r.Down=8]="Down",r[r.Horizontal=3]="Horizontal",r[r.Vertical=12]="Vertical",r[r.All=15]="All",r})(nt||{});var U=(function(r){return r[r.Possible=1]="Possible",r[r.Began=2]="Began",r[r.Changed=4]="Changed",r[r.Ended=8]="Ended",r[r.Recognized=8]="Recognized",r[r.Cancelled=16]="Cancelled",r[r.Failed=32]="Failed",r})(U||{});var qh="compute",Tc="auto",Er="manipulation",Je="none",Sr="pan-x",Ar="pan-y";function kc(r){if(r.includes(Je))return Je;let t=r.includes(Sr),e=r.includes(Ar);return t&&e?Je:t||e?t?Sr:Ar:r.includes(Er)?Er:Tc}var Ir=class{constructor(t,e){this.actions="",this.manager=t,this.set(e)}set(t){t===qh&&(t=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=t,this.actions=t)}update(){this.set(this.manager.options.touchAction)}compute(){let t=[];for(let e of this.manager.recognizers)e.options.enable&&(t=t.concat(e.getTouchAction()));return kc(t.join(" "))}};function Dn(r){return r.trim().split(/\s+/g)}function yi(r,t,e){if(r)for(let n of Dn(t))r.addEventListener(n,e,!1)}function xi(r,t,e){if(r)for(let n of Dn(t))r.removeEventListener(n,e,!1)}function Ec(r){return(r.ownerDocument||r).defaultView}function Sc(r,t){let e=r;for(;e;){if(e===t)return!0;e=e.parentNode}return!1}function bi(r){let t=r.length;if(t===1)return{x:Math.round(r[0].clientX),y:Math.round(r[0].clientY)};let e=0,n=0,s=0;for(;s<t;)e+=r[s].clientX,n+=r[s].clientY,s++;return{x:Math.round(e/t),y:Math.round(n/t)}}function Ac(r){let t=[],e=0;for(;e<r.pointers.length;)t[e]={clientX:Math.round(r.pointers[e].clientX),clientY:Math.round(r.pointers[e].clientY)},e++;return{timeStamp:Date.now(),pointers:t,center:bi(t),deltaX:r.deltaX,deltaY:r.deltaY}}function wi(r,t){let e=t.x-r.x,n=t.y-r.y;return Math.sqrt(e*e+n*n)}function Ic(r,t){let e=t.clientX-r.clientX,n=t.clientY-r.clientY;return Math.sqrt(e*e+n*n)}function Yh(r,t){let e=t.x-r.x,n=t.y-r.y;return Math.atan2(n,e)*180/Math.PI}function Pc(r,t){let e=t.clientX-r.clientX,n=t.clientY-r.clientY;return Math.atan2(n,e)*180/Math.PI}function vi(r,t){return r===t?nt.None:Math.abs(r)>=Math.abs(t)?r<0?nt.Left:nt.Right:t<0?nt.Up:nt.Down}function Xh(r,t){let e=t.center,n=r.offsetDelta,s=r.prevDelta,i=r.prevInput;return(t.eventType===J.Start||i?.eventType===J.End)&&(s=r.prevDelta={x:i?.deltaX||0,y:i?.deltaY||0},n=r.offsetDelta={x:e.x,y:e.y}),{deltaX:s.x+(e.x-n.x),deltaY:s.y+(e.y-n.y)}}function Ti(r,t,e){return{x:t/r||0,y:e/r||0}}function Zh(r,t){return Ic(t[0],t[1])/Ic(r[0],r[1])}function Kh(r,t){return Pc(t[1],t[0])-Pc(r[1],r[0])}function Jh(r,t){let e=r.lastInterval||t,n=t.timeStamp-e.timeStamp,s,i,o,a;if(t.eventType!==J.Cancel&&(n>25||e.velocity===void 0)){let c=t.deltaX-e.deltaX,l=t.deltaY-e.deltaY,u=Ti(n,c,l);i=u.x,o=u.y,s=Math.abs(u.x)>Math.abs(u.y)?u.x:u.y,a=vi(c,l),r.lastInterval=t}else s=e.velocity,i=e.velocityX,o=e.velocityY,a=e.direction;t.velocity=s,t.velocityX=i,t.velocityY=o,t.direction=a}function Qh(r,t){let{session:e}=r,{pointers:n}=t,{length:s}=n;e.firstInput||(e.firstInput=Ac(t)),s>1&&!e.firstMultiple?e.firstMultiple=Ac(t):s===1&&(e.firstMultiple=!1);let{firstInput:i,firstMultiple:o}=e,a=o?o.center:i.center,c=t.center=bi(n);t.timeStamp=Date.now(),t.deltaTime=t.timeStamp-i.timeStamp,t.angle=Yh(a,c),t.distance=wi(a,c);let{deltaX:l,deltaY:u}=Xh(e,t);t.deltaX=l,t.deltaY=u,t.offsetDirection=vi(t.deltaX,t.deltaY);let h=Ti(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=h.x,t.overallVelocityY=h.y,t.overallVelocity=Math.abs(h.x)>Math.abs(h.y)?h.x:h.y,t.scale=o?Zh(o.pointers,n):1,t.rotation=o?Kh(o.pointers,n):0,t.maxPointers=e.prevInput?t.pointers.length>e.prevInput.maxPointers?t.pointers.length:e.prevInput.maxPointers:t.pointers.length;let f=r.element;return Sc(t.srcEvent.target,f)&&(f=t.srcEvent.target),t.target=f,Jh(e,t),t}function tf(r,t,e){let n=e.pointers.length,s=e.changedPointers.length,i=t&J.Start&&n-s===0,o=t&(J.End|J.Cancel)&&n-s===0;e.isFirst=!!i,e.isFinal=!!o,i&&(r.session={}),e.eventType=t;let a=Qh(r,e);r.emit("hammer.input",a),r.recognize(a),r.session.prevInput=a}var Pr=class{constructor(t){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=e=>{this.manager.options.enable&&this.handler(e)},this.manager=t,this.element=t.element,this.target=t.options.inputTarget||t.element}callback(t,e){tf(this.manager,t,e)}init(){yi(this.element,this.evEl,this.domHandler),yi(this.target,this.evTarget,this.domHandler),yi(Ec(this.element),this.evWin,this.domHandler)}destroy(){xi(this.element,this.evEl,this.domHandler),xi(this.target,this.evTarget,this.domHandler),xi(Ec(this.element),this.evWin,this.domHandler)}};var vy={pointerdown:J.Start,pointermove:J.Move,pointerup:J.End,pointercancel:J.Cancel,pointerout:J.Cancel},Ty="pointerdown",ky="pointermove pointerup pointercancel",Mr=class extends Pr{constructor(t){super(t),this.evEl=Ty,this.evWin=ky,this.store=this.manager.session.pointerEvents=[],this.init()}handler(t){let{store:e}=this,n=!1,s=vy[t.type],i=t.pointerType,o=i==="touch",a=e.findIndex(c=>c.pointerId===t.pointerId);s&J.Start&&(t.buttons||o)?a<0&&(e.push(t),a=e.length-1):s&(J.End|J.Cancel)&&(n=!0),!(a<0)&&(e[a]=t,this.callback(s,{pointers:e,changedPointers:[t],eventType:s,pointerType:i,srcEvent:t}),n&&e.splice(a,1))}};var Ey=["","webkit","Moz","MS","ms","o"];function ef(r,t){let e=t[0].toUpperCase()+t.slice(1);for(let n of Ey){let s=n?n+e:t;if(s in r)return s}}var Sy=1,nf=2,rf={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}},Lr=class{constructor(t,e){this.options=M(d(d({},rf),e),{cssProps:d(d({},rf.cssProps),e.cssProps),inputTarget:e.inputTarget||t}),this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=t,this.input=new Mr(this),this.touchAction=new Ir(this,this.options.touchAction),this.toggleCssProps(!0)}set(t){return Object.assign(this.options,t),t.touchAction&&this.touchAction.update(),t.inputTarget&&(this.input.destroy(),this.input.target=t.inputTarget,this.input.init()),this}stop(t){this.session.stopped=t?nf:Sy}recognize(t){let{session:e}=this;if(e.stopped)return;this.session.prevented&&t.srcEvent.preventDefault();let n,{recognizers:s}=this,{curRecognizer:i}=e;(!i||i&&i.state&U.Recognized)&&(i=e.curRecognizer=null);let o=0;for(;o<s.length;)n=s[o],e.stopped!==nf&&(!i||n===i||n.canRecognizeWith(i))?n.recognize(t):n.reset(),!i&&n.state&(U.Began|U.Changed|U.Ended)&&(i=e.curRecognizer=n),o++}get(t){let{recognizers:e}=this;for(let n=0;n<e.length;n++)if(e[n].options.event===t)return e[n];return null}add(t){if(Array.isArray(t)){for(let n of t)this.add(n);return this}let e=this.get(t.options.event);return e&&this.remove(e),this.recognizers.push(t),t.manager=this,this.touchAction.update(),t}remove(t){if(Array.isArray(t)){for(let n of t)this.remove(n);return this}let e=typeof t=="string"?this.get(t):t;if(e){let{recognizers:n}=this,s=n.indexOf(e);s!==-1&&(n.splice(s,1),this.touchAction.update())}return this}on(t,e){if(!t||!e)return;let{handlers:n}=this;for(let s of Dn(t))n[s]=n[s]||[],n[s].push(e)}off(t,e){if(!t)return;let{handlers:n}=this;for(let s of Dn(t))e?n[s]&&n[s].splice(n[s].indexOf(e),1):delete n[s]}emit(t,e){let n=this.handlers[t]&&this.handlers[t].slice();if(!n||!n.length)return;let s=e;s.type=t,s.preventDefault=function(){e.srcEvent.preventDefault()};let i=0;for(;i<n.length;)n[i](s),i++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(t){let{element:e}=this;if(e){for(let[n,s]of Object.entries(this.options.cssProps)){let i=ef(e.style,n);t?(this.oldCssProps[i]=e.style[i],e.style[i]=s):e.style[i]=this.oldCssProps[i]||""}t||(this.oldCssProps={})}}};var Ay=1;function sf(){return Ay++}function Mc(r){return r&U.Cancelled?"cancel":r&U.Ended?"end":r&U.Changed?"move":r&U.Began?"start":""}var ge=class{constructor(t){this.options=t,this.id=sf(),this.state=U.Possible,this.simultaneous={},this.requireFail=[]}set(t){return Object.assign(this.options,t),this.manager.touchAction.update(),this}recognizeWith(t){if(Array.isArray(t)){for(let s of t)this.recognizeWith(s);return this}let e;if(typeof t=="string"){if(e=this.manager.get(t),!e)throw new Error(`Cannot find recognizer ${t}`)}else e=t;let{simultaneous:n}=this;return n[e.id]||(n[e.id]=e,e.recognizeWith(this)),this}dropRecognizeWith(t){if(Array.isArray(t)){for(let n of t)this.dropRecognizeWith(n);return this}let e;return typeof t=="string"?e=this.manager.get(t):e=t,e&&delete this.simultaneous[e.id],this}requireFailure(t){if(Array.isArray(t)){for(let s of t)this.requireFailure(s);return this}let e;if(typeof t=="string"){if(e=this.manager.get(t),!e)throw new Error(`Cannot find recognizer ${t}`)}else e=t;let{requireFail:n}=this;return n.indexOf(e)===-1&&(n.push(e),e.requireFailure(this)),this}dropRequireFailure(t){if(Array.isArray(t)){for(let n of t)this.dropRequireFailure(n);return this}let e;if(typeof t=="string"?e=this.manager.get(t):e=t,e){let n=this.requireFail.indexOf(e);n>-1&&this.requireFail.splice(n,1)}return this}hasRequireFailures(){return!!this.requireFail.find(t=>t.options.enable)}canRecognizeWith(t){return!!this.simultaneous[t.id]}emit(t){if(!t)return;let{state:e}=this;e<U.Ended&&this.manager.emit(this.options.event+Mc(e),t),this.manager.emit(this.options.event,t),t.additionalEvent&&this.manager.emit(t.additionalEvent,t),e>=U.Ended&&this.manager.emit(this.options.event+Mc(e),t)}tryEmit(t){this.canEmit()?this.emit(t):this.state=U.Failed}canEmit(){let t=0;for(;t<this.requireFail.length;){if(!(this.requireFail[t].state&(U.Failed|U.Possible)))return!1;t++}return!0}recognize(t){let e=d({},t);if(!this.options.enable){this.reset(),this.state=U.Failed;return}this.state&(U.Recognized|U.Cancelled|U.Failed)&&(this.state=U.Possible),this.state=this.process(e),this.state&(U.Began|U.Changed|U.Ended|U.Cancelled)&&this.tryEmit(e)}getEventNames(){return[this.options.event]}reset(){}};var _e=class extends ge{attrTest(t){let e=this.options.pointers;return e===0||t.pointers.length===e}process(t){let{state:e}=this,{eventType:n}=t,s=e&(U.Began|U.Changed),i=this.attrTest(t);return s&&(n&J.Cancel||!i)?e|U.Cancelled:s||i?n&J.End?e|U.Ended:e&U.Began?e|U.Changed:U.Began:U.Failed}};var Qe=class extends ge{constructor(t={}){super(d({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},t)),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[Er]}process(t){let{options:e}=this,n=t.pointers.length===e.pointers,s=t.distance<e.threshold,i=t.deltaTime<e.time;if(this.reset(),t.eventType&J.Start&&this.count===0)return this.failTimeout();if(s&&i&&n){if(t.eventType!==J.End)return this.failTimeout();let o=this.pTime?t.timeStamp-this.pTime<e.interval:!0,a=!this.pCenter||wi(this.pCenter,t.center)<e.posThreshold;if(this.pTime=t.timeStamp,this.pCenter=t.center,!a||!o?this.count=1:this.count+=1,this._input=t,this.count%e.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=U.Recognized,this.tryEmit(this._input)},e.interval),U.Began):U.Recognized}return U.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=U.Failed},this.options.interval),U.Failed}reset(){clearTimeout(this._timer)}emit(t){this.state===U.Recognized&&(t.tapCount=this.count,this.manager.emit(this.options.event,t))}};var Iy=["","start","move","end","cancel","up","down","left","right"],Le=class extends _e{constructor(t={}){super(d({enable:!0,pointers:1,event:"pan",threshold:10,direction:nt.All},t)),this.pX=null,this.pY=null}getTouchAction(){let{options:{direction:t}}=this,e=[];return t&nt.Horizontal&&e.push(Ar),t&nt.Vertical&&e.push(Sr),e}getEventNames(){return Iy.map(t=>this.options.event+t)}directionTest(t){let{options:e}=this,n=!0,{distance:s}=t,{direction:i}=t,o=t.deltaX,a=t.deltaY;return i&e.direction||(e.direction&nt.Horizontal?(i=o===0?nt.None:o<0?nt.Left:nt.Right,n=o!==this.pX,s=Math.abs(t.deltaX)):(i=a===0?nt.None:a<0?nt.Up:nt.Down,n=a!==this.pY,s=Math.abs(t.deltaY))),t.direction=i,n&&s>e.threshold&&!!(i&e.direction)}attrTest(t){return super.attrTest(t)&&(!!(this.state&U.Began)||!(this.state&U.Began)&&this.directionTest(t))}emit(t){this.pX=t.deltaX,this.pY=t.deltaY;let e=nt[t.direction].toLowerCase();e&&(t.additionalEvent=this.options.event+e),super.emit(t)}};var Py=["","start","move","end","cancel","in","out"],Fn=class extends _e{constructor(t={}){super(d({enable:!0,event:"pinch",threshold:0,pointers:2},t))}getTouchAction(){return[Je]}getEventNames(){return Py.map(t=>this.options.event+t)}attrTest(t){return super.attrTest(t)&&(Math.abs(t.scale-1)>this.options.threshold||!!(this.state&U.Began))}emit(t){if(t.scale!==1){let e=t.scale<1?"in":"out";t.additionalEvent=this.options.event+e}super.emit(t)}};var se=class{constructor(t,e,n){this.element=t,this.callback=e,this.options=n}};var of=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",TA=typeof window<"u"?window:global;var Oy=of.indexOf("firefox")!==-1,af=4.000244140625,Ry=40,Ny=.25,ki=class extends se{constructor(t,e,n){super(t,e,d({enable:!0},n)),this.handleEvent=s=>{if(!this.options.enable)return;let i=s.deltaY;globalThis.WheelEvent&&(Oy&&s.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(i/=globalThis.devicePixelRatio),s.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(i*=Ry)),i!==0&&i%af===0&&(i=Math.floor(i/af)),s.shiftKey&&i&&(i=i*Ny),this.callback({type:"wheel",center:{x:s.clientX,y:s.clientY},delta:-i,srcEvent:s,pointerType:"mouse",target:s.target})},t.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(t,e){t==="wheel"&&(this.options.enable=e)}};var cf=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],Ei=class extends se{constructor(t,e,n){super(t,e,d({enable:!0},n)),this.handleEvent=i=>{this.handleOverEvent(i),this.handleOutEvent(i),this.handleEnterEvent(i),this.handleLeaveEvent(i),this.handleMoveEvent(i)},this.pressed=!1;let{enable:s}=this.options;this.enableMoveEvent=s,this.enableLeaveEvent=s,this.enableEnterEvent=s,this.enableOutEvent=s,this.enableOverEvent=s,cf.forEach(i=>t.addEventListener(i,this.handleEvent))}destroy(){cf.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){switch(t){case"pointermove":this.enableMoveEvent=e;break;case"pointerover":this.enableOverEvent=e;break;case"pointerout":this.enableOutEvent=e;break;case"pointerenter":this.enableEnterEvent=e;break;case"pointerleave":this.enableLeaveEvent=e;break;default:}}handleOverEvent(t){this.enableOverEvent&&t.type==="mouseover"&&this._emit("pointerover",t)}handleOutEvent(t){this.enableOutEvent&&t.type==="mouseout"&&this._emit("pointerout",t)}handleEnterEvent(t){this.enableEnterEvent&&t.type==="mouseenter"&&this._emit("pointerenter",t)}handleLeaveEvent(t){this.enableLeaveEvent&&t.type==="mouseleave"&&this._emit("pointerleave",t)}handleMoveEvent(t){if(this.enableMoveEvent)switch(t.type){case"mousedown":t.button>=0&&(this.pressed=!0);break;case"mousemove":t.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",t);break;case"mouseup":this.pressed=!1;break;default:}}_emit(t,e){this.callback({type:t,center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})}};var lf=["keydown","keyup"],Si=class extends se{constructor(t,e,n){super(t,e,d({enable:!0,tabIndex:0},n)),this.handleEvent=s=>{let i=s.target||s.srcElement;i.tagName==="INPUT"&&i.type==="text"||i.tagName==="TEXTAREA"||(this.enableDownEvent&&s.type==="keydown"&&this.callback({type:"keydown",srcEvent:s,key:s.key,target:s.target}),this.enableUpEvent&&s.type==="keyup"&&this.callback({type:"keyup",srcEvent:s,key:s.key,target:s.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,t.tabIndex=this.options.tabIndex,t.style.outline="none",lf.forEach(s=>t.addEventListener(s,this.handleEvent))}destroy(){lf.forEach(t=>this.element.removeEventListener(t,this.handleEvent))}enableEventType(t,e){t==="keydown"&&(this.enableDownEvent=e),t==="keyup"&&(this.enableUpEvent=e)}};var Ai=class extends se{constructor(t,e,n){super(t,e,n),this.handleEvent=s=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:s.clientX,y:s.clientY},srcEvent:s,pointerType:"mouse",target:s.target})},t.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(t,e){t==="contextmenu"&&(this.options.enable=e)}};var Dy={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4},Fy=0,Vy=1,Uy=2,By=1,zy=2,jy=4;function uf(r){let t=Dy[r.srcEvent.type];if(!t)return null;let{buttons:e,button:n}=r.srcEvent,s=!1,i=!1,o=!1;return t===2?(s=!!(e&By),i=!!(e&jy),o=!!(e&zy)):(s=n===Fy,i=n===Vy,o=n===Uy),{leftButton:s,middleButton:i,rightButton:o}}function hf(r,t){let e=r.center;if(!e)return null;let n=t.getBoundingClientRect(),s=n.width/t.offsetWidth||1,i=n.height/t.offsetHeight||1,o={x:(e.x-n.left-t.clientLeft)/s,y:(e.y-n.top-t.clientTop)/i};return{center:e,offsetCenter:o}}var $y={srcElement:"root",priority:0},Ii=class{constructor(t,e){this.handleEvent=n=>{if(this.isEmpty())return;let s=this._normalizeEvent(n),i=n.srcEvent.target;for(;i&&i!==s.rootElement;){if(this._emit(s,i),s.handled)return;i=i.parentNode}this._emit(s,"root")},this.eventManager=t,this.recognizerName=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(t,e,n,s=!1,i=!1){let{handlers:o,handlersByElement:a}=this,c=d(d({},$y),n),l=a.get(c.srcElement);l||(l=[],a.set(c.srcElement,l));let u={type:t,handler:e,srcElement:c.srcElement,priority:c.priority};s&&(u.once=!0),i&&(u.passive=!0),o.push(u),this._active=this._active||!u.passive;let h=l.length-1;for(;h>=0&&!(l[h].priority>=u.priority);)h--;l.splice(h+1,0,u)}remove(t,e){let{handlers:n,handlersByElement:s}=this;for(let i=n.length-1;i>=0;i--){let o=n[i];if(o.type===t&&o.handler===e){n.splice(i,1);let a=s.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&s.delete(o.srcElement)}}this._active=n.some(i=>!i.passive)}_emit(t,e){let n=this.handlersByElement.get(e);if(n){let s=!1,i=()=>{t.handled=!0},o=()=>{t.handled=!0,s=!0},a=[];for(let c=0;c<n.length;c++){let{type:l,handler:u,once:h}=n[c];if(u(M(d({},t),{type:l,stopPropagation:i,stopImmediatePropagation:o})),h&&a.push(n[c]),s)break}for(let c=0;c<a.length;c++){let{type:l,handler:u}=a[c];this.remove(l,u)}}}_normalizeEvent(t){let e=this.eventManager.getElement();return M(d(d(d({},t),uf(t)),hf(t,e)),{preventDefault:()=>{t.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:e})}};function Wy(r){if("recognizer"in r)return r;let t,e=Array.isArray(r)?[...r]:[r];if(typeof e[0]=="function"){let n=e.shift(),s=e.shift()||{};t=new n(s)}else t=e.shift();return{recognizer:t,recognizeWith:typeof e[0]=="string"?[e[0]]:e[0],requireFailure:typeof e[1]=="string"?[e[1]]:e[1]}}var Cr=class{constructor(t=null,e={}){if(this._onBasicInput=n=>{this.manager.emit(n.srcEvent.type,n)},this._onOtherEvent=n=>{this.manager.emit(n.type,n)},this.options=d({recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{}},e),this.events=new Map,this.element=t,!!t){this.manager=new Lr(t,this.options);for(let n of this.options.recognizers){let{recognizer:s,recognizeWith:i,requireFailure:o}=Wy(n);this.manager.add(s),i&&s.recognizeWith(i),o&&s.requireFailure(o)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new ki(t,this._onOtherEvent,{enable:!1}),this.moveInput=new Ei(t,this._onOtherEvent,{enable:!1}),this.keyInput=new Si(t,this._onOtherEvent,{enable:!1,tabIndex:e.tabIndex}),this.contextmenuInput=new Ai(t,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(t,e,n){this._addEventHandler(t,e,n,!1)}once(t,e,n){this._addEventHandler(t,e,n,!0)}watch(t,e,n){this._addEventHandler(t,e,n,!1,!0)}off(t,e){this._removeEventHandler(t,e)}_toggleRecognizer(t,e){let{manager:n}=this;if(!n)return;let s=n.get(t);s&&(s.set({enable:e}),n.touchAction.update()),this.wheelInput?.enableEventType(t,e),this.moveInput?.enableEventType(t,e),this.keyInput?.enableEventType(t,e),this.contextmenuInput?.enableEventType(t,e)}_addEventHandler(t,e,n,s,i){if(typeof t!="string"){n=e;for(let[l,u]of Object.entries(t))this._addEventHandler(l,u,n,s,i);return}let{manager:o,events:a}=this;if(!o)return;let c=a.get(t);if(!c){let l=this._getRecognizerName(t)||t;c=new Ii(this,l),a.set(t,c),o&&o.on(t,c.handleEvent)}c.add(t,e,n,s,i),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(t,e){if(typeof t!="string"){for(let[i,o]of Object.entries(t))this._removeEventHandler(i,o);return}let{events:n}=this,s=n.get(t);if(s&&(s.remove(t,e),s.isEmpty())){let{recognizerName:i}=s,o=!1;for(let a of n.values())if(a.recognizerName===i&&!a.isEmpty()){o=!0;break}o||this._toggleRecognizer(i,!1)}}_getRecognizerName(t){return this.manager.recognizers.find(e=>e.getEventNames().includes(t))?.options.event}};var G={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(G,"IDENTITY",{get:()=>($.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});var pt={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},tn={common:0,meters:1,pixels:2},Or={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},Lc={multipan:[Le,{threshold:10,direction:nt.Vertical,pointers:2}],pinch:[Fn,{},null,["multipan"]],pan:[Le,{threshold:1},["pinch"],["multipan"]],dblclick:[Qe,{event:"dblclick",taps:2}],click:[Qe,{event:"click"},null,["dblclick"]]},Gy={DRAW:"draw",MASK:"mask",TERRAIN:"terrain"};function Hy(r,t){if(r===t)return!0;if(Array.isArray(r)){let e=r.length;if(!t||t.length!==e)return!1;for(let n=0;n<e;n++)if(r[n]!==t[n])return!1;return!0}return!1}function Gt(r){let t={},e;return n=>{for(let s in n)if(!Hy(n[s],t[s])){e=r(n),t=n;break}return e}}var ff=[0,0,0,0],qy=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],pf=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Yy=[0,0,0],df=[0,0,0],Xy=Gt(Ky);function Cc(r,t,e=df){e.length<3&&(e=[e[0],e[1],0]);let n=e,s,i=!0;switch(t===G.LNGLAT_OFFSETS||t===G.METER_OFFSETS?s=e:s=r.isGeospatial?[Math.fround(r.longitude),Math.fround(r.latitude),0]:null,r.projectionMode){case pt.WEB_MERCATOR:(t===G.LNGLAT||t===G.CARTESIAN)&&(s=[0,0,0],i=!1);break;case pt.WEB_MERCATOR_AUTO_OFFSET:t===G.LNGLAT?n=s:t===G.CARTESIAN&&(n=[Math.fround(r.center[0]),Math.fround(r.center[1]),0],s=r.unprojectPosition(n),n[0]-=e[0],n[1]-=e[1],n[2]-=e[2]);break;case pt.IDENTITY:n=r.position.map(Math.fround),n[2]=n[2]||0;break;case pt.GLOBE:i=!1,s=null;break;default:i=!1}return{geospatialOrigin:s,shaderCoordinateOrigin:n,offsetMode:i}}function Zy(r,t,e){let{viewMatrixUncentered:n,projectionMatrix:s}=r,{viewMatrix:i,viewProjectionMatrix:o}=r,a=ff,c=ff,l=r.cameraPosition,{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:f}=Cc(r,t,e);return f&&(c=r.projectPosition(u||h),l=[l[0]-c[0],l[1]-c[1],l[2]-c[2]],c[3]=1,a=Lt.transformMat4([],c,o),i=n||i,o=ft.multiply([],s,i),o=ft.multiply([],o,qy)),{viewMatrix:i,viewProjectionMatrix:o,projectionCenter:a,originCommon:c,cameraPosCommon:l,shaderCoordinateOrigin:h,geospatialOrigin:u}}function Pi({viewport:r,devicePixelRatio:t=1,modelMatrix:e=null,coordinateSystem:n=G.DEFAULT,coordinateOrigin:s=df,autoWrapLongitude:i=!1}){n===G.DEFAULT&&(n=r.isGeospatial?G.LNGLAT:G.CARTESIAN);let o=Xy({viewport:r,devicePixelRatio:t,coordinateSystem:n,coordinateOrigin:s});return o.wrapLongitude=i,o.modelMatrix=e||pf,o}function Ky({viewport:r,devicePixelRatio:t,coordinateSystem:e,coordinateOrigin:n}){let{projectionCenter:s,viewProjectionMatrix:i,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:c,geospatialOrigin:l}=Zy(r,e,n),u=r.getDistanceScales(),h=[r.width*t,r.height*t],f=Lt.transformMat4([],[0,0,-r.focalDistance,1],r.projectionMatrix)[3]||1,p={coordinateSystem:e,projectionMode:r.projectionMode,coordinateOrigin:c,commonOrigin:o.slice(0,3),center:s,pseudoMeters:!!r._pseudoMeters,viewportSize:h,devicePixelRatio:t,focalDistance:f,commonUnitsPerMeter:u.unitsPerMeter,commonUnitsPerWorldUnit:u.unitsPerMeter,commonUnitsPerWorldUnit2:Yy,scale:r.scale,wrapLongitude:!1,viewProjectionMatrix:i,modelMatrix:pf,cameraPosition:a};if(l){let _=r.getDistanceScales(l);switch(e){case G.METER_OFFSETS:p.commonUnitsPerWorldUnit=_.unitsPerMeter,p.commonUnitsPerWorldUnit2=_.unitsPerMeter2;break;case G.LNGLAT:case G.LNGLAT_OFFSETS:r._pseudoMeters||(p.commonUnitsPerMeter=_.unitsPerMeter),p.commonUnitsPerWorldUnit=_.unitsPerDegree,p.commonUnitsPerWorldUnit2=_.unitsPerDegree2;break;case G.CARTESIAN:p.commonUnitsPerWorldUnit=[1,1,_.unitsPerMeter[2]],p.commonUnitsPerWorldUnit2=[0,0,_.unitsPerMeter2[2]];break;default:break}}return p}var Jy=Object.keys(G).map(r=>`const COORDINATE_SYSTEM_${r}: i32 = ${G[r]};`).join(""),Qy=Object.keys(pt).map(r=>`const PROJECTION_MODE_${r}: i32 = ${pt[r]};`).join(""),tx=Object.keys(tn).map(r=>`const UNIT_${r.toUpperCase()}: i32 = ${tn[r]};`).join(""),ex=`${Jy}
${Qy}
${tx}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,mf=`${ex}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the z\u2011axis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`;var nx=Object.keys(G).map(r=>`const int COORDINATE_SYSTEM_${r} = ${G[r]};`).join(""),rx=Object.keys(pt).map(r=>`const int PROJECTION_MODE_${r} = ${pt[r]};`).join(""),sx=Object.keys(tn).map(r=>`const int UNIT_${r.toUpperCase()} = ${tn[r]};`).join(""),gf=`${nx}
${rx}
${sx}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`;var ix={};function ox(r=ix){return"viewport"in r?Pi(r):{}}var en={name:"project",dependencies:[yc,_i],source:mf,vs:gf,getUniforms:ox,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}};var ax=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,cx=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,_f={name:"project32",dependencies:[en],source:ax,vs:cx};function Oc(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Ce(r,t){let e=Lt.transformMat4([],t,r);return Lt.scale(e,e,1/e[3]),e}function Rc(r,t){let e=r%t;return e<0?t+e:e}function yf(r,t,e){return e*t+(1-e)*r}function Rr(r,t,e){return r<t?t:r>e?e:r}function lx(r){return Math.log(r)*Math.LOG2E}var Vn=Math.log2||lx;function Ht(r,t){if(!r)throw new Error(t||"@math.gl/web-mercator: assertion failed.")}var qt=Math.PI,xf=qt/4,Bt=qt/180,Nc=180/qt,Un=512,Mi=4003e4,St=85.051129,bf=1.5;function Nr(r){return Math.pow(2,r)}function Li(r){return Vn(r)}function Yt(r){let[t,e]=r;Ht(Number.isFinite(t)),Ht(Number.isFinite(e)&&e>=-90&&e<=90,"invalid latitude");let n=t*Bt,s=e*Bt,i=Un*(n+qt)/(2*qt),o=Un*(qt+Math.log(Math.tan(xf+s*.5)))/(2*qt);return[i,o]}function At(r){let[t,e]=r,n=t/Un*(2*qt)-qt,s=2*(Math.atan(Math.exp(e/Un*(2*qt)-qt))-xf);return[n*Nc,s*Nc]}function Dr(r){let{latitude:t}=r;Ht(Number.isFinite(t));let e=Math.cos(t*Bt);return Li(Mi*e)-9}function Fr(r){let t=Math.cos(r*Bt);return Un/Mi/t}function Bn(r){let{latitude:t,longitude:e,highPrecision:n=!1}=r;Ht(Number.isFinite(t)&&Number.isFinite(e));let s=Un,i=Math.cos(t*Bt),o=s/360,a=o/i,c=s/Mi/i,l={unitsPerMeter:[c,c,c],metersPerUnit:[1/c,1/c,1/c],unitsPerDegree:[o,a,c],degreesPerUnit:[1/o,1/a,1/c]};if(n){let u=Bt*Math.tan(t*Bt)/i,h=o*u/2,f=s/Mi*u,p=f/a*c;l.unitsPerDegree2=[0,h,f],l.unitsPerMeter2=[p,0,p]}return l}function Vr(r,t){let[e,n,s]=r,[i,o,a]=t,{unitsPerMeter:c,unitsPerMeter2:l}=Bn({longitude:e,latitude:n,highPrecision:!0}),u=Yt(r);u[0]+=i*(c[0]+l[0]*o),u[1]+=o*(c[1]+l[1]*o);let h=At(u),f=(s||0)+(a||0);return Number.isFinite(s)||Number.isFinite(a)?[h[0],h[1],f]:h}function Ci(r){let{height:t,pitch:e,bearing:n,altitude:s,scale:i,center:o}=r,a=Oc();ft.translate(a,a,[0,0,-s]),ft.rotateX(a,a,-e*Bt),ft.rotateZ(a,a,n*Bt);let c=i/t;return ft.scale(a,a,[c,c,c]),o&&ft.translate(a,a,Et.negate([],o)),a}function Dc(r){let{width:t,height:e,altitude:n,pitch:s=0,offset:i,center:o,scale:a,nearZMultiplier:c=1,farZMultiplier:l=1}=r,{fovy:u=ye(bf)}=r;n!==void 0&&(u=ye(n));let h=u*Bt,f=s*Bt,p=xe(u),_=p;o&&(_+=o[2]*a/Math.cos(f)/e);let x=h*(.5+(i?i[1]:0)/e),y=Math.sin(x)*_/Math.sin(Rr(Math.PI/2-f-x,.01,Math.PI-.01)),T=Math.sin(f)*y+_,I=_*10,k=Math.min(T*l,I);return{fov:h,aspect:t/e,focalDistance:p,near:c,far:k}}function ye(r){return 2*Math.atan(.5/r)*Nc}function xe(r){return .5/Math.tan(.5*r*Bt)}function zn(r,t){let[e,n,s=0]=r;return Ht(Number.isFinite(e)&&Number.isFinite(n)&&Number.isFinite(s)),Ce(t,[e,n,s,1])}function zt(r,t,e=0){let[n,s,i]=r;if(Ht(Number.isFinite(n)&&Number.isFinite(s),"invalid pixel coordinate"),Number.isFinite(i))return Ce(t,[n,s,i,1]);let o=Ce(t,[n,s,0,1]),a=Ce(t,[n,s,1,1]),c=o[2],l=a[2],u=c===l?0:((e||0)-c)/(l-c);return ht.lerp([],o,a,u)}function Oi(r){let{width:t,height:e,bounds:n,minExtent:s=0,maxZoom:i=24,offset:o=[0,0]}=r,[[a,c],[l,u]]=n,h=ux(r.padding),f=Yt([a,Rr(u,-St,St)]),p=Yt([l,Rr(c,-St,St)]),_=[Math.max(Math.abs(p[0]-f[0]),s),Math.max(Math.abs(p[1]-f[1]),s)],x=[t-h.left-h.right-Math.abs(o[0])*2,e-h.top-h.bottom-Math.abs(o[1])*2];Ht(x[0]>0&&x[1]>0);let y=x[0]/_[0],T=x[1]/_[1],I=(h.right-h.left)/2/y,k=(h.top-h.bottom)/2/T,S=[(p[0]+f[0])/2+I,(p[1]+f[1])/2+k],P=At(S),L=Math.min(i,Vn(Math.abs(Math.min(y,T))));return Ht(Number.isFinite(L)),{longitude:P[0],latitude:P[1],zoom:L}}function ux(r=0){return typeof r=="number"?{top:r,bottom:r,left:r,right:r}:(Ht(Number.isFinite(r.top)&&Number.isFinite(r.bottom)&&Number.isFinite(r.left)&&Number.isFinite(r.right)),r)}var wf=Math.PI/180;function Ri(r,t=0){let{width:e,height:n,unproject:s}=r,i={targetZ:t},o=s([0,n],i),a=s([e,n],i),c,l,u=r.fovy?.5*r.fovy*wf:Math.atan(.5/r.altitude),h=(90-r.pitch)*wf;return u>h-.01?(c=vf(r,0,t),l=vf(r,e,t)):(c=s([0,0],i),l=s([e,0],i)),[o,a,l,c]}function vf(r,t,e){let{pixelUnprojectionMatrix:n}=r,s=Ce(n,[t,0,1,1]),i=Ce(n,[t,r.height,1,1]),a=(e*r.distanceScales.unitsPerMeter[2]-s[2])/(i[2]-s[2]),c=ht.lerp([],s,i,a),l=At(c);return l.push(e),l}var Tf=512;function Fc(r){let{width:t,height:e,pitch:n=0}=r,{longitude:s,latitude:i,zoom:o,bearing:a=0}=r;(s<-180||s>180)&&(s=Rc(s+180,360)-180),(a<-180||a>180)&&(a=Rc(a+180,360)-180);let c=Vn(e/Tf);if(o<=c)o=c,i=0;else{let l=e/2/Math.pow(2,o),u=At([0,l])[1];if(i<u)i=u;else{let h=At([0,Tf-l])[1];i>h&&(i=h)}}return{width:t,height:e,longitude:s,latitude:i,zoom:o,pitch:n,bearing:a}}var kf=.01,fx=["longitude","latitude","zoom"],Ef={curve:1.414,speed:1.2};function Vc(r,t,e,n){let{startZoom:s,startCenterXY:i,uDelta:o,w0:a,u1:c,S:l,rho:u,rho2:h,r0:f}=Sf(r,t,n);if(c<kf){let S={};for(let P of fx){let L=r[P],F=t[P];S[P]=yf(L,F,e)}return S}let p=e*l,_=Math.cosh(f)/Math.cosh(f+u*p),x=a*((Math.cosh(f)*Math.tanh(f+u*p)-Math.sinh(f))/h)/c,y=1/_,T=s+Li(y),I=ht.scale([],o,x);ht.add(I,I,i);let k=At(I);return{longitude:k[0],latitude:k[1],zoom:T}}function Uc(r,t,e){let n=d(d({},Ef),e),{screenSpeed:s,speed:i,maxDuration:o}=n,{S:a,rho:c}=Sf(r,t,n),l=1e3*a,u;return Number.isFinite(s)?u=l/(s/c):u=l/i,Number.isFinite(o)&&u>o?0:u}function Sf(r,t,e){e=Object.assign({},Ef,e);let n=e.curve,s=r.zoom,i=[r.longitude,r.latitude],o=Nr(s),a=t.zoom,c=[t.longitude,t.latitude],l=Nr(a-s),u=Yt(i),h=Yt(c),f=ht.sub([],h,u),p=Math.max(r.width,r.height),_=p/l,x=ht.length(f)*o,y=Math.max(x,kf),T=n*n,I=(_*_-p*p+T*T*y*y)/(2*p*T*y),k=(_*_-p*p-T*T*y*y)/(2*_*T*y),S=Math.log(Math.sqrt(I*I+1)-I),P=Math.log(Math.sqrt(k*k+1)-k),L=(P-S)/n;return{startZoom:s,startCenterXY:u,uDelta:f,w0:p,u1:x,S:L,rho:n,rho2:T,r0:S,r1:P}}var Af=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,dx=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,mx=`
${Af}
${dx}
`,gx=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,_x=`
${Af}
${gx}
`,yx=Gt(Tx),xx=Gt(kx),bx=[0,0,0,1],wx=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function vx(r,t){let[e,n,s]=r,i=zt([e,n,s],t);return Number.isFinite(s)?i:[i[0],i[1],0]}function Tx({viewport:r,center:t}){return new Q(r.viewProjectionMatrix).invert().transform(t)}function kx({viewport:r,shadowMatrices:t}){let e=[],n=r.pixelUnprojectionMatrix,s=r.isGeospatial?void 0:1,i=[[0,0,s],[r.width,0,s],[0,r.height,s],[r.width,r.height,s],[0,0,-1],[r.width,0,-1],[0,r.height,-1],[r.width,r.height,-1]].map(o=>vx(o,n));for(let o of t){let a=o.clone().translate(new rt(r.center).negate()),c=i.map(u=>a.transform(u)),l=new Q().ortho({left:Math.min(...c.map(u=>u[0])),right:Math.max(...c.map(u=>u[0])),bottom:Math.min(...c.map(u=>u[1])),top:Math.max(...c.map(u=>u[1])),near:Math.min(...c.map(u=>-u[2])),far:Math.max(...c.map(u=>-u[2]))});e.push(l.multiplyRight(o))}return e}function Ex(r){let{shadowEnabled:t=!0,project:e}=r;if(!t||!e||!r.shadowMatrices||!r.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};let n=en.getUniforms(e),s=yx({viewport:e.viewport,center:n.center}),i=[],o=xx({shadowMatrices:r.shadowMatrices,viewport:e.viewport}).slice();for(let c=0;c<r.shadowMatrices.length;c++){let l=o[c],u=l.clone().translate(new rt(e.viewport.center).negate());n.coordinateSystem===G.LNGLAT&&n.projectionMode===pt.WEB_MERCATOR?(o[c]=u,i[c]=s):(o[c]=l.clone().multiplyRight(wx),i[c]=u.transform(s))}let a={drawShadowMap:!!r.drawToShadowMap,useShadowMap:r.shadowMaps?r.shadowMaps.length>0:!1,color:r.shadowColor||bx,lightId:r.shadowLightId||0,lightCount:r.shadowMatrices.length,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};for(let c=0;c<o.length;c++)a[`viewProjectionMatrix${c}`]=o[c],a[`projectCenter${c}`]=i[c];for(let c=0;c<2;c++)a[`shadow_uShadowMap${c}`]=r.shadowMaps&&r.shadowMaps[c]||r.dummyShadowMap;return a}var Ur={name:"shadow",dependencies:[en],vs:mx,fs:_x,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:Ex,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}};var If=M(d({},ui),{defaultUniforms:M(d({},ui.defaultUniforms),{useFloatColors:!1}),inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}});var Sx=[_i],Ax=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],Ix=[];function Bc(r){let t=fr.getDefaultShaderAssembler();for(let n of Sx)t.addDefaultModule(n);t._hookFunctions.length=0;let e=r==="glsl"?Ax:Ix;for(let n of e)t.addShaderHook(n);return t}var Px=[255,255,255],Mx=1,Lx=0,Br=class{constructor(t={}){this.type="ambient";let{color:e=Px}=t,{intensity:n=Mx}=t;this.id=t.id||`ambient-${Lx++}`,this.color=e,this.intensity=n}};var Cx=[255,255,255],Ox=1,Rx=[0,0,-1],Nx=0,Oe=class{constructor(t={}){this.type="directional";let{color:e=Cx}=t,{intensity:n=Ox}=t,{direction:s=Rx}=t,{_shadow:i=!1}=t;this.id=t.id||`directional-${Nx++}`,this.color=e,this.intensity=n,this.type="directional",this.direction=new rt(s).normalize().toArray(),this.shadow=i}getProjectedLight(t){return this}};var jn=class{constructor(t,e={id:"pass"}){let{id:n}=e;this.id=n,this.device=t,this.props=d({},e)}setProps(t){Object.assign(this.props,t)}render(t){}cleanup(){}};var be=class extends jn{constructor(){super(...arguments),this._lastRenderIndex=-1}render(t){let[e,n]=this.device.canvasContext.getDrawingBufferSize(),s=t.clearCanvas??!0,i=t.clearColor??(s?[0,0,0,0]:!1),o=s?1:!1,a=s?0:!1,c=t.colorMask??15,l={viewport:[0,0,e,n]};t.colorMask&&(l.colorMask=c),t.scissorRect&&(l.scissorRect=t.scissorRect);let u=this.device.beginRenderPass({framebuffer:t.target,parameters:l,clearColor:i,clearDepth:o,clearStencil:a});try{return this._drawLayers(u,t)}finally{u.end(),this.device.submit()}}_drawLayers(t,e){let{target:n,shaderModuleProps:s,viewports:i,views:o,onViewportActive:a,clearStack:c=!0}=e;e.pass=e.pass||"unknown",c&&(this._lastRenderIndex=-1);let l=[];for(let u of i){let h=o&&o[u.id];a?.(u);let f=this._getDrawLayerParams(u,e),p=u.subViewports||[u];for(let _ of p){let x=this._drawLayersInViewport(t,{target:n,shaderModuleProps:s,viewport:_,view:h,pass:e.pass,layers:e.layers},f);l.push(x)}}return l}_getDrawLayerParams(t,{layers:e,pass:n,isPicking:s=!1,layerFilter:i,cullRect:o,effects:a,shaderModuleProps:c},l=!1){let u=[],h=Mf(this._lastRenderIndex+1),f={layer:e[0],viewport:t,isPicking:s,renderPass:n,cullRect:o},p={};for(let _=0;_<e.length;_++){let x=e[_],y=this._shouldDrawLayer(x,f,i,p),T={shouldDrawLayer:y};y&&!l&&(T.shouldDrawLayer=!0,T.layerRenderIndex=h(x,y),T.shaderModuleProps=this._getShaderModuleProps(x,a,n,c),T.layerParameters=d(d({},x.context.deck?.props.parameters),this.getLayerParameters(x,_,t))),u[_]=T}return u}_drawLayersInViewport(t,{layers:e,shaderModuleProps:n,pass:s,target:i,viewport:o,view:a},c){let l=Dx(this.device,{shaderModuleProps:n,target:i,viewport:o});if(a){let{clear:h,clearColor:f,clearDepth:p,clearStencil:_}=a.props;if(h){let x=[0,0,0,0],y=1,T=0;Array.isArray(f)?x=[...f.slice(0,3),f[3]||255].map(k=>k/255):f===!1&&(x=!1),p!==void 0&&(y=p),_!==void 0&&(T=_),this.device.beginRenderPass({framebuffer:i,parameters:{viewport:l,scissorRect:l},clearColor:x,clearDepth:y,clearStencil:T}).end()}}let u={totalCount:e.length,visibleCount:0,compositeCount:0,pickableCount:0};t.setParameters({viewport:l});for(let h=0;h<e.length;h++){let f=e[h],p=c[h],{shouldDrawLayer:_}=p;if(_&&f.props.pickable&&u.pickableCount++,f.isComposite&&u.compositeCount++,f.isDrawable&&p.shouldDrawLayer){let{layerRenderIndex:x,shaderModuleProps:y,layerParameters:T}=p;u.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,x),y.project&&(y.project.viewport=o),f.context.renderPass=t;try{f._drawLayer({renderPass:t,shaderModuleProps:y,uniforms:{layerIndex:x},parameters:T})}catch(I){f.raiseError(I,`drawing ${f} to ${s}`)}}}return u}shouldDrawLayer(t){return!0}getShaderModuleProps(t,e,n){return null}getLayerParameters(t,e,n){return t.props.parameters}_shouldDrawLayer(t,e,n,s){if(!(t.props.visible&&this.shouldDrawLayer(t)))return!1;e.layer=t;let o=t.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(e))return!1;e.layer=o,o=o.parent}if(n){let a=e.layer.id;if(a in s||(s[a]=n(e)),!s[a])return!1}return t.activateViewport(e.viewport),!0}_getShaderModuleProps(t,e,n,s){let i=this.device.canvasContext.cssToDeviceRatio(),o=t.internalState?.propsInTransition||t.props,a={layer:o,picking:{isActive:!1},project:{viewport:t.context.viewport,devicePixelRatio:i,modelMatrix:o.modelMatrix,coordinateSystem:o.coordinateSystem,coordinateOrigin:o.coordinateOrigin,autoWrapLongitude:t.wrapLongitude}};if(e)for(let c of e)Pf(a,c.getShaderModuleProps?.(t,a));return Pf(a,this.getShaderModuleProps(t,e,a),s)}};function Mf(r=0,t={}){let e={},n=(s,i)=>{let o=s.props._offset,a=s.id,c=s.parent&&s.parent.id,l;if(c&&!(c in t)&&n(s.parent,!1),c in e){let u=e[c]=e[c]||Mf(t[c],t);l=u(s,i),e[a]=u}else Number.isFinite(o)?(l=o+(t[c]||0),e[a]=null):l=r;return i&&l>=r&&(r=l+1),t[a]=l,l};return n}function Dx(r,{shaderModuleProps:t,target:e,viewport:n}){let s=t?.project?.devicePixelRatio??r.canvasContext.cssToDeviceRatio(),[,i]=r.canvasContext.getDrawingBufferSize(),o=e?e.height:i,a=n;return[a.x*s,o-(a.y+a.height)*s,a.width*s,a.height*s]}function Pf(r,...t){for(let e of t)if(e)for(let n in e)r[n]?Object.assign(r[n],e[n]):r[n]=e[n];return r}var Ni=class extends be{constructor(t,e){super(t,e);let n=t.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}}),s=t.createTexture({format:"depth16unorm",width:1,height:1});this.fbo=t.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[n],depthStencilAttachment:s})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(t){let e=this.fbo,n=this.device.canvasContext.cssToDeviceRatio(),s=t.viewports[0],i=s.width*n,o=s.height*n,a=[1,1,1,1];(i!==e.width||o!==e.height)&&e.resize({width:i,height:o}),super.render(M(d({},t),{clearColor:a,target:e,pass:"shadow"}))}getLayerParameters(t,e,n){return M(d({},t.props.parameters),{blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"})}shouldDrawLayer(t){return t.props.shadowEnabled!==!1}getShaderModuleProps(t,e,n){return{shadow:{project:n.project,drawToShadowMap:!0}}}};var Fx={color:[255,255,255],intensity:1},Lf=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],Vx=[0,0,0,200/255],$n=class{constructor(t={}){this.id="lighting-effect",this.shadowColor=Vx,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(t)}setup(t){this.context=t;let{device:e,deck:n}=t;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(e),n._addDefaultShaderModule(Ur),this.dummyShadowMap=e.createTexture({width:1,height:1}))}setProps(t){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(let e in t){let n=t[e];switch(n.type){case"ambient":this.ambientLight=n;break;case"directional":this.directionalLights.push(n);break;case"point":this.pointLights.push(n);break;default:}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(e=>e.shadow),this.context&&this.setup(this.context),this.props=t}preRender({layers:t,layerFilter:e,viewports:n,onViewportActive:s,views:i}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:t,layerFilter:e,viewports:n,onViewportActive:s,views:i,shaderModuleProps:{shadow:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(t,e){let n=this.shadow?{project:e.project,shadowMaps:this.shadowPasses.map(o=>o.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},s={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(o=>o.getProjectedLight({layer:t})),pointLights:this.pointLights.map(o=>o.getProjectedLight({layer:t}))},i=t.props.material;return{shadow:n,lighting:s,phongMaterial:i,gouraudMaterial:i}}cleanup(t){for(let e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,t.deck._removeDefaultShaderModule(Ur))}_calculateMatrices(){let t=[];for(let e of this.directionalLights){let n=new Q().lookAt({eye:new rt(e.direction).negate()});t.push(n)}return t}_createShadowPasses(t){for(let e=0;e<this.directionalLights.length;e++){let n=new Ni(t);this.shadowPasses[e]=n}}_applyDefaultLights(){let{ambientLight:t,pointLights:e,directionalLights:n}=this;!t&&e.length===0&&n.length===0&&(this.ambientLight=new Br(Fx),this.directionalLights.push(new Oe(Lf[0]),new Oe(Lf[1])))}};var zc=class{constructor(t={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(t)}setOptions(t){Object.assign(this.opts,t)}allocate(t,e,{size:n=1,type:s,padding:i=0,copy:o=!1,initialize:a=!1,maxCount:c}){let l=s||t&&t.constructor||Float32Array,u=e*n+i;if(ArrayBuffer.isView(t)){if(u<=t.length)return t;if(u*t.BYTES_PER_ELEMENT<=t.buffer.byteLength)return new l(t.buffer,0,u)}let h=1/0;c&&(h=c*n+i);let f=this._allocate(l,u,a,h);return t&&o?f.set(t):a||f.fill(0,0,4),this._release(t),f}release(t){this._release(t)}_allocate(t,e,n,s){let i=Math.max(Math.ceil(e*this.opts.overAlloc),1);i>s&&(i=s);let o=this._pool,a=t.BYTES_PER_ELEMENT*i,c=o.findIndex(l=>l.byteLength>=a);if(c>=0){let l=new t(o.splice(c,1)[0],0,i);return n&&l.fill(0),l}return new t(i)}_release(t){if(!ArrayBuffer.isView(t))return;let e=this._pool,{buffer:n}=t,{byteLength:s}=n,i=e.findIndex(o=>o.byteLength>=s);i<0?e.push(n):(i>0||e.length<this.opts.poolSize)&&e.splice(i,0,n),e.length>this.opts.poolSize&&e.shift()}},Xt=new zc;function Gn(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function nn(r,t){let e=r%t;return e<0?t+e:e}function Of(r){return[r[12],r[13],r[14]]}function Rf(r){return{left:Wn(r[3]+r[0],r[7]+r[4],r[11]+r[8],r[15]+r[12]),right:Wn(r[3]-r[0],r[7]-r[4],r[11]-r[8],r[15]-r[12]),bottom:Wn(r[3]+r[1],r[7]+r[5],r[11]+r[9],r[15]+r[13]),top:Wn(r[3]-r[1],r[7]-r[5],r[11]-r[9],r[15]-r[13]),near:Wn(r[3]+r[2],r[7]+r[6],r[11]+r[10],r[15]+r[14]),far:Wn(r[3]-r[2],r[7]-r[6],r[11]-r[10],r[15]-r[14])}}var Cf=new rt;function Wn(r,t,e,n){Cf.set(r,t,e);let s=Cf.len();return{distance:n/s,normal:new rt(-r/s,-t/s,-e/s)}}function Nf(r){return r-Math.fround(r)}var zr;function Di(r,t){let{size:e=1,startIndex:n=0}=t,s=t.endIndex!==void 0?t.endIndex:r.length,i=(s-n)/e;zr=Xt.allocate(zr,i,{type:Float32Array,size:e*2});let o=n,a=0;for(;o<s;){for(let c=0;c<e;c++){let l=r[o++];zr[a+c]=l,zr[a+c+e]=Nf(l)}a+=e*2}return zr.subarray(0,i*e*2)}function Df(r){let t=null,e=!1;for(let n of r)n&&(t?(e||(t=[[t[0][0],t[0][1]],[t[1][0],t[1][1]]],e=!0),t[0][0]=Math.min(t[0][0],n[0][0]),t[0][1]=Math.min(t[0][1],n[0][1]),t[1][0]=Math.max(t[1][0],n[1][0]),t[1][1]=Math.max(t[1][1],n[1][1])):t=n);return t}var Ux=Math.PI/180,Bx=Gn(),Ff=[0,0,0],zx={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function jx({width:r,height:t,orthographic:e,fovyRadians:n,focalDistance:s,padding:i,near:o,far:a}){let c=r/t,l=e?new Q().orthographic({fovy:n,aspect:c,focalDistance:s,near:o,far:a}):new Q().perspective({fovy:n,aspect:c,near:o,far:a});if(i){let{left:u=0,right:h=0,top:f=0,bottom:p=0}=i,_=X((u+r-h)/2,0,r)-r/2,x=X((f+t-p)/2,0,t)-t/2;l[8]-=_*2/r,l[9]+=x*2/t}return l}var $x=(()=>{class r{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||zx,this.focalDistance=e.focalDistance||1,this.position=e.position||Ff,this.modelMatrix=e.modelMatrix||null;let{longitude:n,latitude:s}=e;this.isGeospatial=Number.isFinite(s)&&Number.isFinite(n),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?pt.WEB_MERCATOR:pt.WEB_MERCATOR_AUTO_OFFSET:pt.IDENTITY}equals(e){return e instanceof r?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&Mt(e.projectionMatrix,this.projectionMatrix)&&Mt(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:n=!0}={}){let s=this.projectPosition(e),i=zn(s,this.pixelProjectionMatrix),[o,a]=i,c=n?a:this.height-a;return e.length===2?[o,c]:[o,c,i[2]]}unproject(e,{topLeft:n=!0,targetZ:s}={}){let[i,o,a]=e,c=n?o:this.height-o,l=s&&s*this.distanceScales.unitsPerMeter[2],u=zt([i,c,a],this.pixelUnprojectionMatrix,l),[h,f,p]=this.unprojectPosition(u);return Number.isFinite(a)?[h,f,p]:Number.isFinite(s)?[h,f,s]:[h,f]}projectPosition(e){let[n,s]=this.projectFlat(e),i=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[n,s,i]}unprojectPosition(e){let[n,s]=this.unprojectFlat(e),i=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[n,s,i]}projectFlat(e){if(this.isGeospatial){let n=Yt(e);return n[1]=X(n[1],-318,830),n}return e}unprojectFlat(e){return this.isGeospatial?At(e):e}getBounds(e={}){let n={targetZ:e.z||0},s=this.unproject([0,0],n),i=this.unproject([this.width,0],n),o=this.unproject([0,this.height],n),a=this.unproject([this.width,this.height],n);return[Math.min(s[0],i[0],o[0],a[0]),Math.min(s[1],i[1],o[1],a[1]),Math.max(s[0],i[0],o[0],a[0]),Math.max(s[1],i[1],o[1],a[1])]}getDistanceScales(e){return e&&this.isGeospatial?Bn({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:n,width:s=1,height:i=1}){return e<this.x+this.width&&this.x<e+s&&n<this.y+this.height&&this.y<n+i}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,Rf(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,n,s){return null}_initProps(e){let n=e.longitude,s=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=Dr({latitude:s})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||Bn({latitude:s,longitude:n}));let i=Math.pow(2,this.zoom);this.scale=i;let{position:o,modelMatrix:a}=e,c=Ff;if(o&&(c=a?new Q(a).transformAsVector(o,[]):o),this.isGeospatial){let l=this.projectPosition([n,s,0]);this.center=new rt(c).scale(this.distanceScales.unitsPerMeter).add(l)}else this.center=this.projectPosition(c)}_initMatrices(e){let{viewMatrix:n=Bx,projectionMatrix:s=null,orthographic:i=!1,fovyRadians:o,fovy:a=75,near:c=.1,far:l=1e3,padding:u=null,focalDistance:h=1}=e;this.viewMatrixUncentered=n,this.viewMatrix=new Q().multiplyRight(n).translate(new rt(this.center).negate()),this.projectionMatrix=s||jx({width:this.width,height:this.height,orthographic:i,fovyRadians:o||a*Ux,focalDistance:h,padding:u,near:c,far:l});let f=Gn();ft.multiply(f,f,this.projectionMatrix),ft.multiply(f,f,this.viewMatrix),this.viewProjectionMatrix=f,this.viewMatrixInverse=ft.invert([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=Of(this.viewMatrixInverse);let p=Gn(),_=Gn();ft.scale(p,p,[this.width/2,-this.height/2,1]),ft.translate(p,p,[1,-1,0]),ft.multiply(_,p,this.viewProjectionMatrix),this.pixelProjectionMatrix=_,this.pixelUnprojectionMatrix=ft.invert(Gn(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||$.warn("Pixel project matrix not invertible")()}}return r.displayName="Viewport",r})(),Ct=$x;var Wx=(()=>{class r extends Ct{constructor(e={}){let{latitude:n=0,longitude:s=0,zoom:i=0,pitch:o=0,bearing:a=0,nearZMultiplier:c=.1,farZMultiplier:l=1.01,nearZ:u,farZ:h,orthographic:f=!1,projectionMatrix:p,repeat:_=!1,worldOffset:x=0,position:y,padding:T,legacyMeterSizes:I=!1}=e,{width:k,height:S,altitude:P=1.5}=e,L=Math.pow(2,i);k=k||1,S=S||1;let F,D=null;if(p)P=p[5]/2,F=ye(P);else{e.fovy?(F=e.fovy,P=xe(F)):F=ye(P);let O;if(T){let{top:V=0,bottom:j=0}=T;O=[0,X((V+S-j)/2,0,S)-S/2]}D=Dc({width:k,height:S,scale:L,center:y&&[0,0,y[2]*Fr(n)],offset:O,pitch:o,fovy:F,nearZMultiplier:c,farZMultiplier:l}),Number.isFinite(u)&&(D.near=u),Number.isFinite(h)&&(D.far=h)}let R=Ci({height:S,pitch:o,bearing:a,scale:L,altitude:P});x&&(R=new Q().translate([512*x,0,0]).multiplyLeft(R)),super(M(d(M(d({},e),{width:k,height:S,viewMatrix:R,longitude:s,latitude:n,zoom:i}),D),{fovy:F,focalDistance:P})),this.latitude=n,this.longitude=s,this.zoom=i,this.pitch=o,this.bearing=a,this.altitude=P,this.fovy=F,this.orthographic=f,this._subViewports=_?[]:null,this._pseudoMeters=I,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),n=Math.floor((e[0]+180)/360),s=Math.ceil((e[2]-180)/360);for(let i=n;i<=s;i++){let o=i?new r(M(d({},this),{worldOffset:i})):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[n,s]=this.projectFlat(e),i=(e[2]||0)*Fr(e[1]);return[n,s,i]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[n,s]=this.unprojectFlat(e),i=(e[2]||0)/Fr(s);return[n,s,i]}addMetersToLngLat(e,n){return Vr(e,n)}panByPosition(e,n,s){let i=zt(n,this.pixelUnprojectionMatrix),o=this.projectFlat(e),a=ht.add([],o,ht.negate([],i)),c=ht.add([],this.center,a),[l,u]=this.unprojectFlat(c);return{longitude:l,latitude:u}}getBounds(e={}){let n=Ri(this,e.z||0);return[Math.min(n[0][0],n[1][0],n[2][0],n[3][0]),Math.min(n[0][1],n[1][1],n[2][1],n[3][1]),Math.max(n[0][0],n[1][0],n[2][0],n[3][0]),Math.max(n[0][1],n[1][1],n[2][1],n[3][1])]}fitBounds(e,n={}){let{width:s,height:i}=this,{longitude:o,latitude:a,zoom:c}=Oi(d({width:s,height:i,bounds:e},n));return new r({width:s,height:i,longitude:o,latitude:a,zoom:c})}}return r.displayName="WebMercatorViewport",r})(),rn=Wx;var Vf=[0,0,0];function jc(r,t,e=!1){let n=t.projectPosition(r);if(e&&t instanceof rn){let[s,i,o=0]=r,a=t.getDistanceScales([s,i]);n[2]=o*a.unitsPerMeter[2]}return n}function Gx(r){let{viewport:t,modelMatrix:e,coordinateOrigin:n}=r,{coordinateSystem:s,fromCoordinateSystem:i,fromCoordinateOrigin:o}=r;return s===G.DEFAULT&&(s=t.isGeospatial?G.LNGLAT:G.CARTESIAN),i===void 0&&(i=s),o===void 0&&(o=n),{viewport:t,coordinateSystem:s,coordinateOrigin:n,modelMatrix:e,fromCoordinateSystem:i,fromCoordinateOrigin:o}}function $c(r,{viewport:t,modelMatrix:e,coordinateSystem:n,coordinateOrigin:s,offsetMode:i}){let[o,a,c=0]=r;switch(e&&([o,a,c]=Lt.transformMat4([],[o,a,c,1],e)),n){case G.LNGLAT:return jc([o,a,c],t,i);case G.LNGLAT_OFFSETS:return jc([o+s[0],a+s[1],c+(s[2]||0)],t,i);case G.METER_OFFSETS:return jc(Vr(s,[o,a,c]),t,i);case G.CARTESIAN:default:return t.isGeospatial?[o+s[0],a+s[1],c+s[2]]:t.projectPosition([o,a,c])}}function Fi(r,t){let{viewport:e,coordinateSystem:n,coordinateOrigin:s,modelMatrix:i,fromCoordinateSystem:o,fromCoordinateOrigin:a}=Gx(t),{autoOffset:c=!0}=t,{geospatialOrigin:l=Vf,shaderCoordinateOrigin:u=Vf,offsetMode:h=!1}=c?Cc(e,n,s):{},f=$c(r,{viewport:e,modelMatrix:i,coordinateSystem:o,coordinateOrigin:a,offsetMode:h});if(h){let p=e.projectPosition(l||u);Et.sub(f,f,p)}return f}var Hx=[255,255,255],qx=1,Yx=[1,0,0],Xx=[0,0,1],Zx=0,jr=class{constructor(t={}){this.type="point";let{color:e=Hx}=t,{intensity:n=qx}=t,{position:s=Xx}=t;this.id=t.id||`point-${Zx++}`,this.color=e,this.intensity=n,this.type="point",this.position=s,this.attenuation=Kx(t),this.projectedLight=d({},this)}getProjectedLight({layer:t}){let{projectedLight:e}=this,n=t.context.viewport,{coordinateSystem:s,coordinateOrigin:i}=t.props,o=Fi(this.position,{viewport:n,coordinateSystem:s,coordinateOrigin:i,fromCoordinateSystem:n.isGeospatial?G.LNGLAT:G.CARTESIAN,fromCoordinateOrigin:[0,0,0]});return e.color=this.color,e.intensity=this.intensity,e.position=o,e}};function Kx(r){return r.attenuation?r.attenuation:Yx}var Wc=class extends jr{getProjectedLight({layer:t}){let{projectedLight:e}=this,n=t.context.viewport,{coordinateSystem:s,coordinateOrigin:i,modelMatrix:o}=t.props,{cameraPosition:a}=Pi({viewport:n,modelMatrix:o,coordinateSystem:s,coordinateOrigin:i});return e.color=this.color,e.intensity=this.intensity,e.position=a,e}};var sn=Math.PI/180,Jx=1e3*60*60*24,Qx=2440588,t0=2451545,Vi=sn*23.4397,e0=357.5291,n0=.98560028,r0=280.147,s0=360.9856235;function Uf(r,t,e){let n=sn*-e,s=sn*t,i=o0(r),o=d0(i),a=h0(i,n)-o.rightAscension;return{azimuth:l0(a,s,o.declination),altitude:u0(a,s,o.declination)}}function Ui(r,t,e){let{azimuth:n,altitude:s}=Uf(r,t,e);return[Math.sin(n)*Math.cos(s),Math.cos(n)*Math.cos(s),-Math.sin(s)]}function i0(r){return(typeof r=="number"?r:r.getTime())/Jx-.5+Qx}function o0(r){return i0(r)-t0}function a0(r,t){let e=r;return Math.atan2(Math.sin(e)*Math.cos(Vi)-Math.tan(t)*Math.sin(Vi),Math.cos(e))}function c0(r,t){let e=r;return Math.asin(Math.sin(t)*Math.cos(Vi)+Math.cos(t)*Math.sin(Vi)*Math.sin(e))}function l0(r,t,e){let n=r,s=t,i=e;return Math.atan2(Math.sin(n),Math.cos(n)*Math.sin(s)-Math.tan(i)*Math.cos(s))}function u0(r,t,e){let n=r,s=t,i=e;return Math.asin(Math.sin(s)*Math.sin(i)+Math.cos(s)*Math.cos(i)*Math.cos(n))}function h0(r,t){return sn*(r0+s0*r)-t}function f0(r){return sn*(e0+n0*r)}function p0(r){let t=r,e=sn*(1.9148*Math.sin(t)+.02*Math.sin(2*t)+3e-4*Math.sin(3*t)),n=sn*102.9372;return t+e+n+Math.PI}function d0(r){let t=f0(r),e=p0(t);return{declination:c0(e,0),rightAscension:a0(e,0)}}var Gc=class extends Oe{constructor(t){super(t),this.timestamp=t.timestamp}getProjectedLight({layer:t}){let{viewport:e}=t.context;if(e.resolution&&e.resolution>0){let[s,i,o]=Ui(this.timestamp,0,0);this.direction=[s,-o,i]}else{let{latitude:s,longitude:i}=e;this.direction=Ui(this.timestamp,s,i)}return this}};var m0=1,g0=1,on=class{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(t){let{delay:e=0,duration:n=Number.POSITIVE_INFINITY,rate:s=1,repeat:i=1}=t,o=m0++,a={time:0,delay:e,duration:n,rate:s,repeat:i};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(t){this.channels.delete(t);for(let[e,n]of this.animations)n.channel===t&&this.detachAnimation(e)}isFinished(t){let e=this.channels.get(t);return e===void 0?!1:this.time>=e.delay+e.duration*e.repeat}getTime(t){if(t===void 0)return this.time;let e=this.channels.get(t);return e===void 0?-1:e.time}setTime(t){this.time=Math.max(0,t);let e=this.channels.values();for(let s of e)this._setChannelTime(s,this.time);let n=this.animations.values();for(let s of n){let{animation:i,channel:o}=s;i.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(t,e){let n=g0++;return this.animations.set(n,{animation:t,channel:e}),t.setTime(this.getTime(e)),n}detachAnimation(t){this.animations.delete(t)}update(t){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=t),this.setTime(this.time+(t-this.lastEngineTime)),this.lastEngineTime=t)}_setChannelTime(t,e){let n=e-t.delay,s=t.duration*t.repeat;n>=s?t.time=t.duration*t.rate:(t.time=Math.max(0,n)%t.duration,t.time*=t.rate)}};function Bf(r){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(r):setTimeout(r,1e3/60)}function zf(r){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(r):clearTimeout(r)}var _0=0,$r=class r{static defaultAnimationLoopProps={device:null,onAddHTML:()=>"",onInitialize:()=>B(null,null,function*(){return null}),onRender:()=>{},onFinalize:()=>{},onError:t=>console.error(t),stats:er.stats.get(`animation-loop-${_0++}`),autoResizeViewport:!1};device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(t){if(this.props=d(d({},r.defaultAnimationLoopProps),t),t=this.props,!t.device)throw new Error("No device provided");this.stats=t.stats||new xn({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:t.autoResizeViewport}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}reportError(t){this.props.onError(t),this._error=t}setNeedsRedraw(t){return this.needsRedraw=this.needsRedraw||t,this}setProps(t){return"autoResizeViewport"in t&&(this.props.autoResizeViewport=t.autoResizeViewport||!1),this}start(){return B(this,null,function*(){if(this._running)return this;this._running=!0;try{let t;return this._initialized||(this._initialized=!0,yield this._initDevice(),this._initialize(),yield this.props.onInitialize(this._getAnimationProps())),this._running?(t!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(t){let e=t instanceof Error?t:new Error("Unknown error");throw this.props.onError(e),e}})}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(t){return this.timeline=t,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(t=>{this._resolveNextFrame=t})),this._nextFramePromise}toDataURL(){return B(this,null,function*(){if(this.setNeedsRedraw("toDataURL"),yield this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")})}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeViewport()}_setDisplay(t){this.display&&(this.display.destroy(),this.display.animationLoop=null),t&&(t.animationLoop=this),this.display=t}_requestAnimationFrame(){this._running&&(this._animationFrameId=Bf(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(zf(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(t){if(this.display){this.display._renderFrame(t);return}this.props.onRender(this._getAnimationProps()),this.device?.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeViewport()}_initializeAnimationProps(){let t=this.device?.getDefaultCanvasContext();if(!this.device||!t)throw new Error("loop");let e=t?.canvas,n=t.props.useDevicePixels;this.animationProps={animationLoop:this,device:this.device,canvasContext:t,canvas:e,useDevicePixels:n,timeline:this.timeline,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;let{width:t,height:e,aspect:n}=this._getSizeAndAspect();(t!==this.animationProps.width||e!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),n!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=t,this.animationProps.height=e,this.animationProps.aspect=n,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}_initDevice(){return B(this,null,function*(){if(this.device=yield this.props.device,!this.device)throw new Error("No device provided");this.canvas=this.device.getDefaultCanvasContext().canvas||null})}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){let t=document.createElement("div");document.body.appendChild(t),t.style.position="relative";let e=document.createElement("div");e.style.position="absolute",e.style.left="10px",e.style.bottom="10px",e.style.width="300px",e.style.background="white",this.canvas instanceof HTMLCanvasElement&&t.appendChild(this.canvas),t.appendChild(e);let n=this.props.onAddHTML(e);n&&(e.innerHTML=n)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};let[t,e]=this.device?.getDefaultCanvasContext().getDevicePixelSize()||[1,1],n=1,s=this.device?.getDefaultCanvasContext().canvas;return s&&s.clientHeight?n=s.clientWidth/s.clientHeight:t>0&&e>0&&(n=t/e),{width:t,height:e,aspect:n}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(t){t instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[t.offsetX,t.offsetY])}_onMouseleave(t){this._getAnimationProps()._mousePosition=null}};var Hc={};function xt(r="id"){Hc[r]=Hc[r]||1;let t=Hc[r]++;return`${r}-${t}`}var Bi=class{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(t){if(this.id=t.id||xt("geometry"),this.topology=t.topology,this.indices=t.indices||null,this.attributes=t.attributes,this.vertexCount=t.vertexCount,this.bufferLayout=t.bufferLayout||[],this.indices&&!(this.indices.usage&gt.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){this.indices?.destroy();for(let t of Object.values(this.attributes))t.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(t){return t.byteLength/12}};function jf(r,t){if(t instanceof Bi)return t;let e=y0(r,t),{attributes:n,bufferLayout:s}=x0(r,t);return new Bi({topology:t.topology||"triangle-list",bufferLayout:s,vertexCount:t.vertexCount,indices:e,attributes:n})}function y0(r,t){if(!t.indices)return;let e=t.indices.value;return r.createBuffer({usage:gt.INDEX,data:e})}function x0(r,t){let e=[],n={};for(let[i,o]of Object.entries(t.attributes)){let a=i;switch(i){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}if(o){n[a]=r.createBuffer({data:o.value,id:`${i}-buffer`});let{value:c,size:l,normalized:u}=o;e.push({name:a,format:Pl(c,l,u)})}}let s=t._calculateVertexCount(t.attributes,t.indices);return{attributes:n,bufferLayout:e,vertexCount:s}}var zi=class r{static defaultProps=d({},bn.defaultProps);static getDefaultPipelineFactory(t){return t._lumaData.defaultPipelineFactory=t._lumaData.defaultPipelineFactory||new r(t),t._lumaData.defaultPipelineFactory}device;cachingEnabled;destroyPolicy;debug;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};get[Symbol.toStringTag](){return"PipelineFactory"}toString(){return`PipelineFactory(${this.device.id})`}constructor(t){this.device=t,this.cachingEnabled=t.props._cachePipelines,this.destroyPolicy=t.props._cacheDestroyPolicy,this.debug=t.props.debugFactories}createRenderPipeline(t){if(!this.cachingEnabled)return this.device.createRenderPipeline(t);let e=d(d({},bn.defaultProps),t),n=this._renderPipelineCache,s=this._hashRenderPipeline(e),i=n[s]?.pipeline;return i?(n[s].useCount++,this.debug&&W.log(3,`${this}: ${n[s].pipeline} reused, count=${n[s].useCount}, (id=${t.id})`)()):(i=this.device.createRenderPipeline(M(d({},e),{id:e.id?`${e.id}-cached`:xt("unnamed-cached")})),i.hash=s,n[s]={pipeline:i,useCount:1},this.debug&&W.log(3,`${this}: ${i} created, count=${n[s].useCount}`)()),i}createComputePipeline(t){if(!this.cachingEnabled)return this.device.createComputePipeline(t);let e=d(d({},Io.defaultProps),t),n=this._computePipelineCache,s=this._hashComputePipeline(e),i=n[s]?.pipeline;return i?(n[s].useCount++,this.debug&&W.log(3,`${this}: ${n[s].pipeline} reused, count=${n[s].useCount}, (id=${t.id})`)()):(i=this.device.createComputePipeline(M(d({},e),{id:e.id?`${e.id}-cached`:void 0})),i.hash=s,n[s]={pipeline:i,useCount:1},this.debug&&W.log(3,`${this}: ${i} created, count=${n[s].useCount}`)()),i}release(t){if(!this.cachingEnabled){t.destroy();return}let e=this._getCache(t),n=t.hash;e[n].useCount--,e[n].useCount===0?(this._destroyPipeline(t),this.debug&&W.log(3,`${this}: ${t} released and destroyed`)()):e[n].useCount<0?(W.error(`${this}: ${t} released, useCount < 0, resetting`)(),e[n].useCount=0):this.debug&&W.log(3,`${this}: ${t} released, count=${e[n].useCount}`)()}_destroyPipeline(t){let e=this._getCache(t);switch(this.destroyPolicy){case"never":return!1;case"unused":return delete e[t.hash],t.destroy(),!0}}_getCache(t){let e;if(t instanceof Io&&(e=this._computePipelineCache),t instanceof bn&&(e=this._renderPipelineCache),!e)throw new Error(`${this}`);if(!e[t.hash])throw new Error(`${this}: ${t} matched incorrect entry`);return e}_hashComputePipeline(t){let{type:e}=this.device,n=this._getHash(t.shader.source);return`${e}/C/${n}`}_hashRenderPipeline(t){let e=t.vs?this._getHash(t.vs.source):0,n=t.fs?this._getHash(t.fs.source):0,s="-",i=this._getHash(JSON.stringify(t.bufferLayout)),{type:o}=this.device;switch(o){case"webgl":return`${o}/R/${e}/${n}V${s}BL${i}`;case"webgpu":default:let a=this._getHash(JSON.stringify(t.parameters));return`${o}/R/${e}/${n}V${s}T${t.topology}P${a}BL${i}`}}_getHash(t){return this._hashes[t]===void 0&&(this._hashes[t]=this._hashCounter++),this._hashes[t]}};var ji=class r{static defaultProps=d({},Ll.defaultProps);static getDefaultShaderFactory(t){return t._lumaData.defaultShaderFactory||=new r(t),t._lumaData.defaultShaderFactory}device;cachingEnabled;destroyPolicy;debug;_cache={};get[Symbol.toStringTag](){return"ShaderFactory"}toString(){return`${this[Symbol.toStringTag]}(${this.device.id})`}constructor(t){this.device=t,this.cachingEnabled=t.props._cacheShaders,this.destroyPolicy=t.props._cacheDestroyPolicy,this.debug=!0}createShader(t){if(!this.cachingEnabled)return this.device.createShader(t);let e=this._hashShader(t),n=this._cache[e];if(n)n.useCount++,this.debug&&W.log(3,`${this}: Reusing shader ${n.shader.id} count=${n.useCount}`)();else{let s=this.device.createShader(M(d({},t),{id:t.id?`${t.id}-cached`:void 0}));this._cache[e]=n={shader:s,useCount:1},this.debug&&W.log(3,`${this}: Created new shader ${s.id}`)()}return n.shader}release(t){if(!this.cachingEnabled){t.destroy();return}let e=this._hashShader(t),n=this._cache[e];if(n)if(n.useCount--,n.useCount===0)this.destroyPolicy==="unused"&&(delete this._cache[e],n.shader.destroy(),this.debug&&W.log(3,`${this}: Releasing shader ${t.id}, destroyed`)());else{if(n.useCount<0)throw new Error(`ShaderFactory: Shader ${t.id} released too many times`);this.debug&&W.log(3,`${this}: Releasing shader ${t.id} count=${n.useCount}`)()}}_hashShader(t){return`${t.stage}:${t.source}`}};function $f(r,t){let e={},n="Values";if(r.attributes.length===0&&!r.varyings?.length)return{"No attributes or varyings":{[n]:"N/A"}};for(let s of r.attributes)if(s){let i=`${s.location} ${s.name}: ${s.type}`;e[`in ${i}`]={[n]:s.stepMode||"vertex"}}for(let s of r.varyings||[]){let i=`${s.location} ${s.name}`;e[`out ${i}`]={[n]:JSON.stringify(s)}}return e}var dt=null,qc=null;function Wf(r,{id:t,minimap:e,opaque:n,top:s="0",left:i="0",rgbaScale:o=1}){dt||(dt=document.createElement("canvas"),dt.id=t,dt.title=t,dt.style.zIndex="100",dt.style.position="absolute",dt.style.top=s,dt.style.left=i,dt.style.border="blue 5px solid",dt.style.transform="scaleY(-1)",document.body.appendChild(dt),qc=dt.getContext("2d")),(dt.width!==r.width||dt.height!==r.height)&&(dt.width=r.width/2,dt.height=r.height/2,dt.style.width="400px",dt.style.height="400px");let a=r.device.readPixelsToArrayWebGL(r),c=qc?.createImageData(r.width,r.height);if(c){for(let u=0;u<a.length;u+=4)c.data[0+u+0]=a[u+0]*o,c.data[0+u+1]=a[u+1]*o,c.data[0+u+2]=a[u+2]*o,c.data[0+u+3]=n?255:a[u+3]*o;qc?.putImageData(c,0,0)}}function $i(r,t,e){if(r===t)return!0;if(!e||!r||!t)return!1;if(Array.isArray(r)){if(!Array.isArray(t)||r.length!==t.length)return!1;for(let n=0;n<r.length;n++)if(!$i(r[n],t[n],e-1))return!1;return!0}if(Array.isArray(t))return!1;if(typeof r=="object"&&typeof t=="object"){let n=Object.keys(r),s=Object.keys(t);if(n.length!==s.length)return!1;for(let i of n)if(!t.hasOwnProperty(i)||!$i(r[i],t[i],e-1))return!1;return!0}return!1}var Hn=class{bufferLayouts;constructor(t){this.bufferLayouts=t}getBufferLayout(t){return this.bufferLayouts.find(e=>e.name===t)||null}getAttributeNamesForBuffer(t){return t.attributes?t.attributes?.map(e=>e.attribute):[t.name]}mergeBufferLayouts(t,e){let n=[...t];for(let s of e){let i=n.findIndex(o=>o.name===s.name);i<0?n.push(s):n[i]=s}return n}getBufferIndex(t){let e=this.bufferLayouts.findIndex(n=>n.name===t);return e===-1&&W.warn(`BufferLayout: Missing buffer for "${t}".`)(),e}};function Gf(r,t){let e=Object.fromEntries(r.attributes.map(s=>[s.name,s.location])),n=t.slice();return n.sort((s,i)=>{let o=s.attributes?s.attributes.map(u=>u.attribute):[s.name],a=i.attributes?i.attributes.map(u=>u.attribute):[i.name],c=Math.min(...o.map(u=>e[u])),l=Math.min(...a.map(u=>e[u]));return c-l}),n}function Hf(r){return ArrayBuffer.isView(r)&&!(r instanceof DataView)}function qf(r){return Array.isArray(r)?r.length===0||typeof r[0]=="number":!1}function Yc(r){return Hf(r)||qf(r)}function b0(r){return Yc(r)||typeof r=="number"||typeof r=="boolean"}function Yf(r){let t={bindings:{},uniforms:{}};return Object.keys(r).forEach(e=>{let n=r[e];b0(n)?t.uniforms[e]=n:t.bindings[e]=n}),t}var Wi=class{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(t,e){Object.assign(this.options,e);let n=kn(Object.values(t).filter(s=>s.dependencies));for(let s of n)t[s.name]=s;W.log(1,"Creating ShaderInputs with modules",Object.keys(t))(),this.modules=t,this.moduleUniforms={},this.moduleBindings={};for(let[s,i]of Object.entries(t))this._addModule(i),i.name&&s!==i.name&&!this.options.disableWarnings&&W.warn(`Module name: ${s} vs ${i.name}`)()}destroy(){}setProps(t){for(let e of Object.keys(t)){let n=e,s=t[n]||{},i=this.modules[n];if(!i){this.options.disableWarnings||W.warn(`Module ${e} not found`)();continue}let o=this.moduleUniforms[n],a=this.moduleBindings[n],c=i.getUniforms?.(s,o)||s,{uniforms:l,bindings:u}=Yf(c);this.moduleUniforms[n]=d(d({},o),l),this.moduleBindings[n]=d(d({},a),u)}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){let t={};for(let e of Object.values(this.moduleBindings))Object.assign(t,e);return t}getDebugTable(){let t={};for(let[e,n]of Object.entries(this.moduleUniforms))for(let[s,i]of Object.entries(n))t[`${e}.${s}`]={type:this.modules[e].uniformTypes?.[s],value:String(i)};return t}_addModule(t){let e=t.name;this.moduleUniforms[e]=t.defaultUniforms||{},this.moduleBindings[e]={}}};var w0="";function Xf(r,t){return B(this,null,function*(){let e=new Image;return e.crossOrigin=t?.crossOrigin||"anonymous",e.src=r.startsWith("http")?r:w0+r,yield e.decode(),t?yield createImageBitmap(e,t):yield createImageBitmap(e)})}var v0=["+X","-X","+Y","-Y","+Z","-Z"];var T0=["+X","-X","+Y","-Y","+Z","-Z"],qn=class r{device;id;props;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(t,e){this.device=t;let n=xt("async-texture");this.props=d(M(d({},r.defaultProps),{id:n}),e),this.id=this.props.id,e=d({},e),typeof e?.data=="string"&&e.dimension==="2d"&&(e.data=Xf(e.data)),e.mipmaps&&(e.mipLevels="auto"),this.ready=new Promise((s,i)=>{this.resolveReady=()=>{this.isReady=!0,s()},this.rejectReady=i}),this.initAsync(e)}initAsync(t){return B(this,null,function*(){let e=t.data,n=yield Zf(e).then(void 0,this.rejectReady);if(this.destroyed)return;let s=this.props.width&&this.props.height?{width:this.props.width,height:this.props.height}:this.getTextureDataSize(n);if(!s)throw new Error("Texture size could not be determined");let i=M(d(d({},s),t),{data:void 0,mipLevels:1}),o=this.device.getMipLevelCount(i.width,i.height);if(i.mipLevels=this.props.mipLevels==="auto"?o:Math.min(o,this.props.mipLevels),this.texture=this.device.createTexture(i),this.sampler=this.texture.sampler,this.view=this.texture.view,t.data)switch(this.props.dimension){case"1d":this._setTexture1DData(this.texture,n);break;case"2d":this._setTexture2DData(n);break;case"3d":this._setTexture3DData(this.texture,n);break;case"2d-array":this._setTextureArrayData(this.texture,n);break;case"cube":this._setTextureCubeData(this.texture,n);break;case"cube-array":this._setTextureCubeArrayData(this.texture,n);break}this.props.mipmaps&&this.generateMipmaps(),W.info(1,`${this} loaded`),this.resolveReady()})}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}generateMipmaps(){this.texture.generateMipmapsWebGL()}setSampler(t={}){this.texture.setSampler(t instanceof us?t:this.device.createSampler(t))}resize(t){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(t.width===this.texture.width&&t.height===this.texture.height)return!1;if(this.texture){let e=this.texture;this.texture=e.clone(t),e.destroy()}return!0}isTextureLevelData(t){let e=t?.data;return ArrayBuffer.isView(e)}getTextureDataSize(t){if(!t||ArrayBuffer.isView(t))return null;if(Array.isArray(t))return this.getTextureDataSize(t[0]);if(this.device.isExternalImage(t))return this.device.getExternalImageSize(t);if(t&&typeof t=="object"&&t.constructor===Object){let n=Object.values(t)[0];return{width:n.width,height:n.height}}throw new Error("texture size deduction failed")}getCubeFaceDepth(t){switch(t){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(t)}}setTextureData(t){}_setTexture1DData(t,e){throw new Error("setTexture1DData not supported in WebGL.")}_setTexture2DData(t,e=0){if(!this.texture)throw new Error("Texture not initialized");let n=this._normalizeTextureData(t);n.length>1&&this.props.mipmaps!==!1&&W.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let s=0;s<n.length;s++){let i=n[s];this.device.isExternalImage(i)?this.texture.copyExternalImage({image:i,depth:e,mipLevel:s,flipY:!0}):this.texture.copyImageData({data:i.data,mipLevel:s})}}_setTexture3DData(t,e){if(this.texture?.props.dimension!=="3d")throw new Error(this.id);for(let n=0;n<e.length;n++)this._setTexture2DData(e[n],n)}_setTextureCubeData(t,e){if(this.texture?.props.dimension!=="cube")throw new Error(this.id);for(let[n,s]of Object.entries(e)){let i=T0.indexOf(n);this._setTexture2DData(s,i)}}_setTextureArrayData(t,e){if(this.texture?.props.dimension!=="2d-array")throw new Error(this.id);for(let n=0;n<e.length;n++)this._setTexture2DData(e[n],n)}_setTextureCubeArrayData(t,e){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}_setTextureCubeFaceData(t,e,n,s=0){Array.isArray(e)&&e.length>1&&this.props.mipmaps!==!1&&W.warn(`${this.id} has mipmap and multiple LODs.`)();let i=v0.indexOf(n);this._setTexture2DData(e,i)}_normalizeTextureData(t){let e=this.texture,n;return ArrayBuffer.isView(t)?n=[{data:t,width:e.width,height:e.height}]:Array.isArray(t)?n=t:n=[t],n}static defaultProps=M(d({},Ue.defaultProps),{data:null,mipmaps:!1})};function Zf(r){return B(this,null,function*(){if(r=yield r,Array.isArray(r))return yield Promise.all(r.map(Zf));if(r&&typeof r=="object"&&r.constructor===Object){let t=r,e=yield Promise.all(Object.values(t)),n=Object.keys(t),s={};for(let i=0;i<n.length;i++)s[n[i]]=e[i];return s}return r})}var an=2,k0=1e4,ie=class r{static defaultProps=M(d({},bn.defaultProps),{source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:fr.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0});device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(t,e){this.props=d(d({},r.defaultProps),e),e=this.props,this.id=e.id||xt("model"),this.device=t,Object.assign(this.userData,e.userData);let n=Object.fromEntries(this.props.modules?.map(c=>[c.name,c])||[]),s=e.shaderInputs||new Wi(n,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(s);let i=S0(t),o=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){let{source:c,getUniforms:l}=this.props.shaderAssembler.assembleWGSLShader(M(d({platformInfo:i},this.props),{modules:o}));this.source=c,this._getModuleUniforms=l,this.props.shaderLayout||=za(this.source)}else{let{vs:c,fs:l,getUniforms:u}=this.props.shaderAssembler.assembleGLSLShaderPair(M(d({platformInfo:i},this.props),{modules:o}));this.vs=c,this.fs=l,this._getModuleUniforms=u}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,e.geometry&&this.setGeometry(e.geometry),this.pipelineFactory=e.pipelineFactory||zi.getDefaultPipelineFactory(this.device),this.shaderFactory=e.shaderFactory||ji.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=t.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in e&&(this.isInstanced=e.isInstanced),e.instanceCount&&this.setInstanceCount(e.instanceCount),e.vertexCount&&this.setVertexCount(e.vertexCount),e.indexBuffer&&this.setIndexBuffer(e.indexBuffer),e.attributes&&this.setAttributes(e.attributes),e.constantAttributes&&this.setConstantAttributes(e.constantAttributes),e.bindings&&this.setBindings(e.bindings),e.transformFeedback&&(this.transformFeedback=e.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");let t=this._needsRedraw;return this._needsRedraw=!1,t}setNeedsRedraw(t){this._needsRedraw||=t}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(t){let e=this._areBindingsLoading();if(e)return W.info(an,`>>> DRAWING ABORTED ${this.id}: ${e} not loaded`)(),!1;try{t.pushDebugGroup(`${this}.predraw(${t})`),this.predraw()}finally{t.popDebugGroup()}let n;try{t.pushDebugGroup(`${this}.draw(${t})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();let s=this._getBindings();this.pipeline.setBindings(s,{disableWarnings:this.props.disableWarnings});let{indexBuffer:i}=this.vertexArray,o=i?i.byteLength/(i.indexType==="uint32"?4:2):void 0;n=this.pipeline.draw({renderPass:t,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:o,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{t.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(t),n?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",n}setGeometry(t){this._gpuGeometry?.destroy();let e=t&&jf(this.device,t);if(e){this.setTopology(e.topology||"triangle-list");let n=new Hn(this.bufferLayout);this.bufferLayout=n.mergeBufferLayouts(e.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(e)}this._gpuGeometry=e}setTopology(t){t!==this.topology&&(this.topology=t,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(t){let e=new Hn(this.bufferLayout);this.bufferLayout=this._gpuGeometry?e.mergeBufferLayouts(t,this._gpuGeometry.bufferLayout):t,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(t){$i(t,this.parameters,2)||(this.parameters=t,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(t){this.instanceCount=t,this.isInstanced===void 0&&t>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(t){this.vertexCount=t,this.setNeedsRedraw("vertexCount")}setShaderInputs(t){this.shaderInputs=t,this._uniformStore=new Ol(this.shaderInputs.modules);for(let[e,n]of Object.entries(this.shaderInputs.modules))if(E0(n)){let s=this._uniformStore.getManagedUniformBuffer(this.device,e);this.bindings[`${e}Uniforms`]=s}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(t){Object.assign(this.bindings,t),this.setNeedsRedraw("bindings")}setTransformFeedback(t){this.transformFeedback=t,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(t){this.vertexArray.setIndexBuffer(t),this.setNeedsRedraw("indexBuffer")}setAttributes(t,e){let n=e?.disableWarnings??this.props.disableWarnings;t.indices&&W.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=Gf(this.pipeline.shaderLayout,this.bufferLayout);let s=new Hn(this.bufferLayout);for(let[i,o]of Object.entries(t)){let a=s.getBufferLayout(i);if(!a){n||W.warn(`Model(${this.id}): Missing layout for buffer "${i}".`)();continue}let c=s.getAttributeNamesForBuffer(a),l=!1;for(let u of c){let h=this._attributeInfos[u];if(h){let f=this.device.type==="webgpu"?s.getBufferIndex(h.bufferName):h.location;this.vertexArray.setBuffer(f,o),l=!0}}!l&&!n&&W.warn(`Model(${this.id}): Ignoring buffer "${o.id}" for unknown attribute "${i}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(t,e){for(let[n,s]of Object.entries(t)){let i=this._attributeInfos[n];i?this.vertexArray.setConstantWebGL(i.location,s):(e?.disableWarnings??this.props.disableWarnings)||W.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${n}"`)()}this.setNeedsRedraw("constants")}_areBindingsLoading(){for(let t of Object.values(this.bindings))if(t instanceof qn&&!t.isReady)return t.id;return!1}_getBindings(){let t={};for(let[e,n]of Object.entries(this.bindings))n instanceof qn?n.isReady&&(t[e]=n.texture):t[e]=n;return t}_getBindingsUpdateTimestamp(){let t=0;for(let e of Object.values(this.bindings))e instanceof Ml?t=Math.max(t,e.texture.updateTimestamp):e instanceof gt||e instanceof Ue?t=Math.max(t,e.updateTimestamp):e instanceof qn?t=e.texture?Math.max(t,e.texture.updateTimestamp):1/0:e instanceof us||(t=Math.max(t,e.buffer.updateTimestamp));return t}_setGeometryAttributes(t){let e=d({},t.attributes);for(let[n]of Object.entries(e))!this.pipeline.shaderLayout.attributes.find(s=>s.name===n)&&n!=="positions"&&delete e[n];this.vertexCount=t.vertexCount,this.setIndexBuffer(t.indices||null),this.setAttributes(t.attributes,{disableWarnings:!0}),this.setAttributes(e,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(t){this._pipelineNeedsUpdate||=t,this.setNeedsRedraw(t)}_updatePipeline(){if(this._pipelineNeedsUpdate){let t=null,e=null;this.pipeline&&(W.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),t=this.pipeline.vs,e=this.pipeline.fs),this._pipelineNeedsUpdate=!1;let n=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders}),s=null;this.source?s=n:this.fs&&(s=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline(M(d({},this.props),{bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:n,fs:s})),this._attributeInfos=Cl(this.pipeline.shaderLayout,this.bufferLayout),t&&this.shaderFactory.release(t),e&&this.shaderFactory.release(e)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){let t=W.level>3?0:k0;W.level<2||Date.now()-this._lastLogTime<t||(this._lastLogTime=Date.now(),this._logOpen=!0,W.group(an,`>>> DRAWING MODEL ${this.id}`,{collapsed:W.level<=2})())}_logDrawCallEnd(){if(this._logOpen){let t=$f(this.pipeline.shaderLayout,this.id);W.table(an,t)();let e=this.shaderInputs.getDebugTable();W.table(an,e)();let n=this._getAttributeDebugTable();W.table(an,this._attributeInfos)(),W.table(an,n)(),W.groupEnd(an)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(t){let e=this.device.props.debugFramebuffers;if(this._drawCount++,!e)return;let n=t.props.framebuffer;n&&Wf(n,{id:n.id,minimap:!0})}_getAttributeDebugTable(){let t={};for(let[e,n]of Object.entries(this._attributeInfos)){let s=this.vertexArray.attributes[n.location];t[n.location]={name:e,type:n.shaderType,values:s?this._getBufferOrConstantValues(s,n.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){let{indexBuffer:e}=this.vertexArray,n=e.indexType==="uint32"?new Uint32Array(e.debugData):new Uint16Array(e.debugData);t.indices={name:"indices",type:e.indexType,values:n.toString()}}return t}_getBufferOrConstantValues(t,e){let n=ls(e);return(t instanceof gt?new n(t.debugData):t).toString()}};function E0(r){return!!(r.uniformTypes&&!A0(r.uniformTypes))}function S0(r){return{type:r.type,shaderLanguage:r.info.shadingLanguage,shaderLanguageVersion:r.info.shadingLanguageVersion,gpu:r.info.gpu,features:r.features}}function A0(r){for(let t in r)return!1;return!0}var Re=class r{device;model;transformFeedback;static defaultProps=M(d({},ie.defaultProps),{outputs:void 0,feedbackBuffers:void 0});static isSupported(t){return t?.info?.type==="webgl"}constructor(t,e=r.defaultProps){if(!r.isSupported(t))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=t,this.model=new ie(this.device,d({id:e.id||"buffer-transform-model",fs:e.fs||pr(),topology:e.topology||"point-list",varyings:e.outputs||e.varyings},e)),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:e.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(t){t?.inputBuffers&&this.model.setAttributes(t.inputBuffers),t?.outputBuffers&&this.transformFeedback.setBuffers(t.outputBuffers);let e=this.device.beginRenderPass(t);this.model.draw(e),e.end()}getBuffer(t){return this.transformFeedback.getBuffer(t)}readAsync(t){let e=this.getBuffer(t);if(!e)throw new Error("BufferTransform#getBuffer");if(e instanceof gt)return e.readAsync();let{buffer:n,byteOffset:s=0,byteLength:i=n.byteLength}=e;return n.readAsync(s,i)}};var I0="transform_output",Xc=class{device;model;sampler;currentIndex=0;samplerTextureMap=null;bindings=[];resources={};constructor(t,e){this.device=t,this.sampler=t.createSampler({addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",minFilter:"nearest",magFilter:"nearest",mipmapFilter:"nearest"}),this.model=new ie(this.device,d({id:e.id||xt("texture-transform-model"),fs:e.fs||pr({input:e.targetTextureVarying,inputChannels:e.targetTextureChannels,output:I0}),vertexCount:e.vertexCount},e)),this._initialize(e),Object.seal(this)}destroy(){this.model.destroy();for(let t of this.bindings)t.framebuffer?.destroy()}delete(){this.destroy()}run(t){let{framebuffer:e}=this.bindings[this.currentIndex],n=this.device.beginRenderPass(d({framebuffer:e},t));this.model.draw(n),n.end(),this.device.submit()}getTargetTexture(){let{targetTexture:t}=this.bindings[this.currentIndex];return t}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}_initialize(t){this._updateBindings(t)}_updateBindings(t){this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t)}_updateBinding(t,{sourceBuffers:e,sourceTextures:n,targetTexture:s}){if(t||(t={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(t.sourceTextures,n),Object.assign(t.sourceBuffers,e),s){t.targetTexture=s;let{width:i,height:o}=s;t.framebuffer&&t.framebuffer.destroy(),t.framebuffer=this.device.createFramebuffer({id:"transform-framebuffer",width:i,height:o,colorAttachments:[s]}),t.framebuffer.resize({width:i,height:o})}return t}_setSourceTextureParameters(){let t=this.currentIndex,{sourceTextures:e}=this.bindings[t];for(let n in e)e[n].sampler=this.sampler}};var cn=class{id;topology;vertexCount;indices;attributes;userData={};constructor(t){let{attributes:e={},indices:n=null,vertexCount:s=null}=t;this.id=t.id||xt("geometry"),this.topology=t.topology,n&&(this.indices=ArrayBuffer.isView(n)?{value:n,size:1}:n),this.attributes={};for(let[i,o]of Object.entries(e)){let a=ArrayBuffer.isView(o)?{value:o}:o;if(!ArrayBuffer.isView(a.value))throw new Error(`${this._print(i)}: must be typed array or object with value as typed array`);if((i==="POSITION"||i==="positions")&&!a.size&&(a.size=3),i==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=a}else this.attributes[i]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=s||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?d({indices:this.indices},this.attributes):this.attributes}_print(t){return`Geometry ${this.id} attribute ${t}`}_setAttributes(t,e){return this}_calculateVertexCount(t,e){if(e)return e.value.length;let n=1/0;for(let s of Object.values(t)){let{value:i,size:o,constant:a}=s;!a&&i&&o!==void 0&&o>=1&&(n=Math.min(n,i.length/o))}return n}};var P0=`struct VertexInputs {
  @location(0) clipSpacePosition: vec2<f32>,
  @location(1) texCoord: vec2<f32>,
  @location(2) coordinate: vec2<f32>  
}

struct FragmentInputs {
  @builtin(position) Position : vec4<f32>,
  @location(0) position : vec2<f32>,
  @location(1) coordinate : vec2<f32>,
  @location(2) uv : vec2<f32>
};

@vertex
fn vertexMain(inputs: VertexInputs) -> FragmentInputs {
  var outputs: FragmentInputs;
  outputs.Position = vec4(inputs.clipSpacePosition, 0., 1.);
  outputs.position = inputs.clipSpacePosition;
  outputs.coordinate = inputs.coordinate;
  outputs.uv = inputs.texCoord;
  return outputs;
}
`,M0=`#version 300 es
in vec2 clipSpacePositions;
in vec2 texCoords;
in vec2 coordinates;

out vec2 position;
out vec2 coordinate;
out vec2 uv;

void main(void) {
  gl_Position = vec4(clipSpacePositions, 0., 1.);
  position = clipSpacePositions;
  coordinate = coordinates;
  uv = texCoords;
}
`,Kf=[-1,-1,1,-1,-1,1,1,1],Wr=class extends ie{constructor(t,e){let n=Kf.map(s=>s===-1?0:s);e.source&&(e=M(d({},e),{source:`${P0}
${e.source}`})),super(t,M(d({id:e.id||xt("clip-space")},e),{vs:M0,vertexCount:4,geometry:new cn({topology:"triangle-strip",vertexCount:4,attributes:{clipSpacePositions:{size:2,value:new Float32Array(Kf)},texCoords:{size:2,value:new Float32Array(n)},coordinates:{size:2,value:new Float32Array(n)}}})}))}};var Zc=class extends cn{constructor(t={}){let{id:e=xt("cube-geometry"),indices:n=!0}=t;super(n?M(d({},t),{id:e,topology:"triangle-list",indices:{size:1,value:L0},attributes:d(d({},V0),t.attributes)}):M(d({},t),{id:e,topology:"triangle-list",indices:void 0,attributes:d(d({},U0),t.attributes)}))}},L0=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),C0=new Float32Array([-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1]),O0=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]),R0=new Float32Array([0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1]),N0=new Float32Array([1,-1,1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,-1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,-1,1,1,1,-1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1]),D0=new Float32Array([1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,1,0,1,1,0,0,1,1,0,1,0,0,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,1,0,0]),F0=new Float32Array([1,0,1,1,0,0,1,1,0,0,0,1,1,0,0,1,1,0,1,1,0,0,0,1,1,1,1,1,1,0,1,1,1,0,0,1,1,1,0,1,1,1,1,1,1,0,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1,1,1,0,1,0,0,1,1,0,1,1,1,0,1,0,1,0,0,0,1,0,0,1,1,0,1,0,1,1,1,1,1,0,1,1,1,0,0,1,1,0,0,1,1,1,0,1,1,1,1,1,1,1,0,0,1,0,0,0,1,0,1,0,1,1,1,0,1,1,0,0,1,0,1,0,1]),V0={POSITION:{size:3,value:C0},NORMAL:{size:3,value:O0},TEXCOORD_0:{size:2,value:R0}},U0={POSITION:{size:3,value:N0},TEXCOORD_0:{size:2,value:D0},COLOR_0:{size:3,value:F0}};var B0=`uniform screenUniforms {
  vec2 texSize;
} screen;
`,Jf={name:"screen",fs:B0,uniformTypes:{texSize:"vec2<f32>"}};var Gi=class extends jn{constructor(t,e){super(t,e);let{module:n,fs:s,id:i}=e,o={depthWriteEnabled:!1,depthCompare:"always",depthBias:0,blend:!0,blendColorSrcFactor:"one",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"};this.model=new Wr(t,{id:i,fs:s,modules:[n,Jf],parameters:o})}render(t){this._renderPass(this.device,t)}delete(){this.model.destroy(),this.model=null}_renderPass(t,e){let{clearCanvas:n,inputBuffer:s,outputBuffer:i}=e,o=[s.width,s.height],a={texSrc:s.colorAttachments[0],texSize:o};this.model.shaderInputs.setProps(d({screen:a},e.moduleProps));let c=this.device.beginRenderPass({framebuffer:i,parameters:{viewport:[0,0,...o]},clearColor:n?[0,0,0,0]:!1,clearDepth:1,clearStencil:!1});this.model.draw(c),c.end()}};var Kc=class{constructor(t,e){this.id=`${t.name}-pass`,this.props=e,Ss(t),this.module=t}setup({device:t}){this.passes=z0(t,this.module,this.id)}setProps(t){this.props=t}preRender(){}postRender(t){let e=this.passes,{target:n}=t,s=t.inputBuffer,i=t.swapBuffer;for(let o=0;o<e.length;o++){let a=o===e.length-1,c=n!==void 0&&a;c&&(i=n);let l=!c||!!t.clearCanvas,u={},h=this.module.passes[o].uniforms;u[this.module.name]=d(d({},this.props),h),e[o].render({clearCanvas:l,inputBuffer:s,outputBuffer:i,moduleProps:u});let f=i;i=s,s=f}return s}cleanup(){if(this.passes){for(let t of this.passes)t.delete();this.passes=void 0}}};function z0(r,t,e){return t.passes.map((n,s)=>{let i=W0(t,n),o=`${e}-${s}`;return new Gi(r,{id:o,module:t,fs:i})})}var Qf=`#version 300 es
uniform sampler2D texSrc;

in vec2 position;
in vec2 coordinate;
in vec2 uv;

out vec4 fragColor;
`,j0=r=>`${Qf}
void main() {
  fragColor = texture(texSrc, coordinate);
  fragColor = ${r}(fragColor, screen.texSize, coordinate);
}
`,$0=r=>`${Qf}
void main() {
  fragColor = ${r}(texSrc, screen.texSize, coordinate);
}
`;function W0(r,t){if(t.filter){let e=typeof t.filter=="string"?t.filter:`${r.name}_filterColor_ext`;return j0(e)}if(t.sampler){let e=typeof t.sampler=="string"?t.sampler:`${r.name}_sampleColor`;return $0(e)}return""}var G0={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant",blendAlphaDstFactor:"zero"},ln=class extends be{constructor(){super(...arguments),this._colorEncoderState=null}render(t){return"pickingFBO"in t?this._drawPickingBuffer(t):super.render(t)}_drawPickingBuffer({layers:t,layerFilter:e,views:n,viewports:s,onViewportActive:i,pickingFBO:o,deviceRect:{x:a,y:c,width:l,height:u},cullRect:h,effects:f,pass:p="picking",pickZ:_,shaderModuleProps:x}){this.pickZ=_;let y=this._resetColorEncoder(_),T=[a,c,l,u],I=super.render({target:o,layers:t,layerFilter:e,views:n,viewports:s,onViewportActive:i,cullRect:h,effects:f?.filter(S=>S.useInPicking),pass:p,isPicking:!0,shaderModuleProps:x,clearColor:[0,0,0,0],colorMask:15,scissorRect:T});return this._colorEncoderState=null,{decodePickingColor:y&&q0.bind(null,y),stats:I}}shouldDrawLayer(t){let{pickable:e,operation:n}=t.props;return e&&n.includes("draw")||n.includes("terrain")||n.includes("mask")}getShaderModuleProps(t,e,n){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(t,e,n){let s=d({},t.props.parameters),{pickable:i,operation:o}=t.props;return!this._colorEncoderState||o.includes("terrain")?s.blend=!1:i&&o.includes("draw")&&(Object.assign(s,G0),s.blend=!0,s.blendColor=H0(this._colorEncoderState,t,n)),s}_resetColorEncoder(t){return this._colorEncoderState=t?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}};function H0(r,t,e){let{byLayer:n,byAlpha:s}=r,i,o=n.get(t);return o?(o.viewports.push(e),i=o.a):(i=n.size+1,i<=255?(o={a:i,layer:t,viewports:[e]},n.set(t,o),s[i]=o):($.warn("Too many pickable layers, only picking the first 255")(),i=0)),[0,0,0,i/255]}function q0(r,t){let e=r.byAlpha[t[3]];return e&&{pickedLayer:e.layer,pickedViewports:e.viewports,pickedObjectIndex:e.layer.decodePickingColor(t)}}var Ne={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Yn=Symbol.for("component"),jt=Symbol.for("propTypes"),Hi=Symbol.for("deprecatedProps"),we=Symbol.for("asyncPropDefaults"),oe=Symbol.for("asyncPropOriginal"),Zt=Symbol.for("asyncPropResolved");function un(r,t=()=>!0){return Array.isArray(r)?tp(r,t,[]):t(r)?[r]:[]}function tp(r,t,e){let n=-1;for(;++n<r.length;){let s=r[n];Array.isArray(s)?tp(s,t,e):t(s)&&e.push(s)}return e}function Jc({target:r,source:t,start:e=0,count:n=1}){let s=t.length,i=n*s,o=0;for(let a=e;o<s;o++)r[a++]=t[o];for(;o<i;)o<i-o?(r.copyWithin(e+o,e,e+o),o*=2):(r.copyWithin(e+o,e,e+i-o),o=i);return r}var qi=class{constructor(t,e,n){this._loadCount=0,this._subscribers=new Set,this.id=t,this.context=n,this.setData(e)}subscribe(t){this._subscribers.add(t)}unsubscribe(t){this._subscribers.delete(t)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(t,e){if(t===this._data&&!e)return;this._data=t;let n=++this._loadCount,s=t;typeof t=="string"&&(s=Tn(t)),s instanceof Promise?(this.isLoaded=!1,this._loader=s.then(i=>{this._loadCount===n&&(this.isLoaded=!0,this._error=void 0,this._content=i)}).catch(i=>{this._loadCount===n&&(this.isLoaded=!0,this._error=i||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=t);for(let i of this._subscribers)i.onChange(this.getData())}};var Yi=class{constructor(t){this.protocol=t.protocol||"resource://",this._context={device:t.device,gl:t.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(t){return t.startsWith(this.protocol)?!0:t in this._resources}add({resourceId:t,data:e,forceUpdate:n=!1,persistent:s=!0}){let i=this._resources[t];i?i.setData(e,n):(i=new qi(t,e,this._context),this._resources[t]=i),i.persistent=s}remove(t){let e=this._resources[t];e&&(e.delete(),delete this._resources[t])}unsubscribe({consumerId:t}){let e=this._consumers[t];if(e){for(let n in e){let s=e[n],i=this._resources[s.resourceId];i&&i.unsubscribe(s)}delete this._consumers[t],this.prune()}}subscribe({resourceId:t,onChange:e,consumerId:n,requestId:s="default"}){let{_resources:i,protocol:o}=this;t.startsWith(o)&&(t=t.replace(o,""),i[t]||this.add({resourceId:t,data:null,persistent:!1}));let a=i[t];if(this._track(n,s,a,e),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let t in this._resources)this._resources[t].delete()}_track(t,e,n,s){let i=this._consumers,o=i[t]=i[t]||{},a=o[e],c=a&&a.resourceId&&this._resources[a.resourceId];c&&(c.unsubscribe(a),this.prune()),n&&(a?(a.onChange=s,a.resourceId=n.id):a={onChange:s,resourceId:n.id},o[e]=a,n.subscribe(a))}_prune(){this._pruneRequest=null;for(let t of Object.keys(this._resources)){let e=this._resources[t];!e.persistent&&!e.inUse()&&(e.delete(),delete this._resources[t])}}};var Y0="layerManager.setLayers",X0="layerManager.activateViewport",Gr=class{constructor(t,e){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=a=>{st(X0,this,a),a&&(this.context.viewport=a)};let{deck:n,stats:s,viewport:i,timeline:o}=e||{};this.layers=[],this.resourceManager=new Yi({device:t,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:t,gl:t?.gl,deck:n,shaderAssembler:Bc(t?.info?.shadingLanguage||"glsl"),defaultShaderModules:[vc],renderPass:void 0,stats:s||new xn({id:"deck.gl"}),viewport:i||new Ct({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new on,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(let t of this.layers)this._finalizeLayer(t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);for(let n of this.layers){let s=n.getNeedsRedraw(t);e=e||s}return e}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(t){this._needsRedraw=this._needsRedraw||t}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t}getLayers({layerIds:t}={}){return t?this.layers.filter(e=>t.find(n=>e.id.indexOf(n)===0)):this.layers}setProps(t){"debug"in t&&(this._debug=t.debug),"userData"in t&&(this.context.userData=t.userData),"layers"in t&&(this._nextLayers=t.layers),"onError"in t&&(this.context.onError=t.onError)}setLayers(t,e){st(Y0,this,e,t),this._lastRenderedLayers=t;let n=un(t,Boolean);for(let s of n)s.context=this.context;this._updateLayers(this.layers,n)}updateLayers(){let t=this.needsUpdate();t&&(this.setNeedsRedraw(`updating layers: ${t}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,t)),this._nextLayers=null}addDefaultShaderModule(t){let{defaultShaderModules:e}=this.context;e.find(n=>n.name===t.name)||(e.push(t),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(t){let{defaultShaderModules:e}=this.context,n=e.findIndex(s=>s.name===t.name);n>=0&&(e.splice(n,1),this._defaultShaderModulesChanged=!0)}_handleError(t,e,n){n.raiseError(e,`${t} of ${n}`)}_updateLayers(t,e){let n={};for(let o of t)n[o.id]?$.warn(`Multiple old layers with same id ${o.id}`)():n[o.id]=o;if(this._defaultShaderModulesChanged){for(let o of t)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}let s=[];this._updateSublayersRecursively(e,n,s),this._finalizeOldLayers(n);let i=!1;for(let o of s)if(o.hasUniformTransition()){i=`Uniform transition in ${o}`;break}this._needsUpdate=i,this.layers=s}_updateSublayersRecursively(t,e,n){for(let s of t){s.context=this.context;let i=e[s.id];i===null&&$.warn(`Multiple new layers with same id ${s.id}`)(),e[s.id]=null;let o=null;try{this._debug&&i!==s&&s.validateProps(),i?(this._transferLayerState(i,s),this._updateLayer(s)):this._initializeLayer(s),n.push(s),o=s.isComposite?s.getSubLayers():null}catch(a){this._handleError("matching",a,s)}o&&this._updateSublayersRecursively(o,e,n)}}_finalizeOldLayers(t){for(let e in t){let n=t[e];n&&this._finalizeLayer(n)}}_initializeLayer(t){try{t._initialize(),t.lifecycle=Ne.INITIALIZED}catch(e){this._handleError("initialization",e,t)}}_transferLayerState(t,e){e._transferState(t),e.lifecycle=Ne.MATCHED,e!==t&&(t.lifecycle=Ne.AWAITING_GC)}_updateLayer(t){try{t._update()}catch(e){this._handleError("update",e,t)}}_finalizeLayer(t){this._needsRedraw=this._needsRedraw||`finalized ${t}`,t.lifecycle=Ne.AWAITING_FINALIZATION;try{t._finalize(),t.lifecycle=Ne.FINALIZED}catch(e){this._handleError("finalization",e,t)}}};function at(r,t,e){if(r===t)return!0;if(!e||!r||!t)return!1;if(Array.isArray(r)){if(!Array.isArray(t)||r.length!==t.length)return!1;for(let n=0;n<r.length;n++)if(!at(r[n],t[n],e-1))return!1;return!0}if(Array.isArray(t))return!1;if(typeof r=="object"&&typeof t=="object"){let n=Object.keys(r),s=Object.keys(t);if(n.length!==s.length)return!1;for(let i of n)if(!t.hasOwnProperty(i)||!at(r[i],t[i],e-1))return!1;return!0}return!1}var Xi=class{constructor(t){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=t.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=t.eventManager,this._eventCallbacks={onViewStateChange:t.onViewStateChange,onInteractionStateChange:t.onInteractionStateChange},Object.seal(this),this.setProps(t)}finalize(){for(let t in this.controllers){let e=this.controllers[t];e&&e.finalize()}this.controllers={}}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t,this._needsRedraw=this._needsRedraw||t}updateViewStates(){for(let t in this.controllers){let e=this.controllers[t];e&&e.updateTransition()}}getViewports(t){return t?this._viewports.filter(e=>e.containsPixel(t)):this._viewports}getViews(){let t={};return this.views.forEach(e=>{t[e.id]=e}),t}getView(t){return this.views.find(e=>e.id===t)}getViewState(t){let e=typeof t=="string"?this.getView(t):t,n=e&&this.viewState[e.getViewStateId()]||this.viewState;return e?e.filterViewState(n):n}getViewport(t){return this._viewportMap[t]}unproject(t,e){let n=this.getViewports(),s={x:t[0],y:t[1]};for(let i=n.length-1;i>=0;--i){let o=n[i];if(o.containsPixel(s)){let a=t.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,e)}}return null}setProps(t){t.views&&this._setViews(t.views),t.viewState&&this._setViewState(t.viewState),("width"in t||"height"in t)&&this._setSize(t.width,t.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(t,e){(t!==this.width||e!==this.height)&&(this.width=t,this.height=e,this.setNeedsUpdate("Size changed"))}_setViews(t){t=un(t,Boolean),this._diffViews(t,this.views)&&this.setNeedsUpdate("views changed"),this.views=t}_setViewState(t){t?(!at(t,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=t):$.warn("missing `viewState` or `initialViewState`")()}_createController(t,e){let n=e.type;return new n({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:i=>this.getView(t.id)?.makeViewport({viewState:i,width:this.width,height:this.height})})}_updateController(t,e,n,s){let i=t.controller;if(i&&n){let o=M(d(d({},e),i),{id:t.id,x:n.x,y:n.y,width:n.width,height:n.height});return(!s||s.constructor!==i.type)&&(s=this._createController(t,o)),s&&s.setProps(o),s}return null}_rebuildViewports(){let{views:t}=this,e=this.controllers;this._viewports=[],this.controllers={};let n=!1;for(let s=t.length;s--;){let i=t[s],o=this.getViewState(i),a=i.makeViewport({viewState:o,width:this.width,height:this.height}),c=e[i.id],l=!!i.controller;l&&!c&&(n=!0),(n||!l)&&c&&(c.finalize(),c=null),this.controllers[i.id]=this._updateController(i,o,a,c),a&&this._viewports.unshift(a)}for(let s in e){let i=e[s];i&&!this.controllers[s]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(t=>{t.id&&(this._viewportMap[t.id]=this._viewportMap[t.id]||t)})}_diffViews(t,e){return t.length!==e.length?!0:t.some((n,s)=>!t[s].equals(e[s]))}};var Z0=/([0-9]+\.?[0-9]*)(%|px)/;function ve(r){switch(typeof r){case"number":return{position:r,relative:!1};case"string":let t=Z0.exec(r);if(t&&t.length>=3){let e=t[2]==="%",n=parseFloat(t[1]);return{position:e?n/100:n,relative:e}}default:throw new Error(`Could not parse position string ${r}`)}}function Te(r,t){return r.relative?Math.round(r.position*t):r.position}var Ot=class{constructor(t){let{id:e,x:n=0,y:s=0,width:i="100%",height:o="100%",padding:a=null}=t;this.id=e||this.constructor.displayName||"view",this.props=M(d({},t),{id:this.id}),this._x=ve(n),this._y=ve(s),this._width=ve(i),this._height=ve(o),this._padding=a&&{left:ve(a.left||0),right:ve(a.right||0),top:ve(a.top||0),bottom:ve(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(t){return this===t?!0:this.constructor===t.constructor&&at(this.props,t.props,2)}clone(t){let e=this.constructor;return new e(d(d({},this.props),t))}makeViewport({width:t,height:e,viewState:n}){n=this.filterViewState(n);let s=this.getDimensions({width:t,height:e});if(!s.height||!s.width)return null;let i=this.getViewportType(n);return new i(d(d(d({},n),this.props),s))}getViewStateId(){let{viewState:t}=this.props;return typeof t=="string"?t:t?.id||this.id}filterViewState(t){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;let e=d({},t);for(let n in this.props.viewState)n!=="id"&&(e[n]=this.props.viewState[n]);return e}return t}getDimensions({width:t,height:e}){let n={x:Te(this._x,t),y:Te(this._y,e),width:Te(this._width,t),height:Te(this._height,e)};return this._padding&&(n.padding={left:Te(this._padding.left,t),top:Te(this._padding.top,e),right:Te(this._padding.right,t),bottom:Te(this._padding.bottom,e)}),n}get controller(){let t=this.props.controller;return t?t===!0?{type:this.ControllerType}:typeof t=="function"?{type:t}:d({type:this.ControllerType},t):null}};var ae=class{constructor(t){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=t}get inProgress(){return this._inProgress}start(t){this.cancel(),this.settings=t,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){let{_timeline:t,settings:e}=this;this._handle=t.addChannel({delay:t.getTime(),duration:e.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var ep=()=>{},Zi={BREAK:1,SNAP_TO_END:2,IGNORE:3},K0=r=>r,J0=Zi.BREAK,Ki=class{constructor(t){this._onTransitionUpdate=e=>{let{time:n,settings:{interpolator:s,startProps:i,endProps:o,duration:a,easing:c}}=e,l=c(n/a),u=s.interpolateProps(i,o,l);this.propsInTransition=this.getControllerState(d(d({},this.props),u)).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=t.getControllerState,this.propsInTransition=null,this.transition=new ae(t.timeline),this.onViewStateChange=t.onViewStateChange||ep,this.onStateChange=t.onStateChange||ep}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(t){let e=!1,n=this.props;if(this.props=t,!n||this._shouldIgnoreViewportChange(n,t))return!1;if(this._isTransitionEnabled(t)){let s=n;if(this.transition.inProgress){let{interruption:i,endProps:o}=this.transition.settings;s=d(d({},n),i===Zi.SNAP_TO_END?o:this.propsInTransition||n)}this._triggerTransition(s,t),e=!0}else this.transition.cancel();return e}updateTransition(){this.transition.update()}_isTransitionEnabled(t){let{transitionDuration:e,transitionInterpolator:n}=t;return(e>0||e==="auto")&&!!n}_isUpdateDueToCurrentTransition(t){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(t,this.propsInTransition):!1}_shouldIgnoreViewportChange(t,e){return this.transition.inProgress?this.transition.settings.interruption===Zi.IGNORE||this._isUpdateDueToCurrentTransition(e):this._isTransitionEnabled(e)?e.transitionInterpolator.arePropsEqual(t,e):!0}_triggerTransition(t,e){let n=this.getControllerState(t),s=this.getControllerState(e).shortestPathFrom(n),i=e.transitionInterpolator,o=i.getDuration?i.getDuration(t,e):e.transitionDuration;if(o===0)return;let a=i.initializeProps(t,s);this.propsInTransition={};let c={duration:o,easing:e.transitionEasing||K0,interpolator:i,interruption:e.transitionInterruption||J0,startProps:a.start,endProps:a.end,onStart:e.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(e.onTransitionInterrupt),onEnd:this._onTransitionEnd(e.onTransitionEnd)};this.transition.start(c),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(t){return e=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),t?.(e)}}};function et(r,t){if(!r)throw new Error(t||"deck.gl: assertion failed.")}var hn=class{constructor(t){let{compare:e,extract:n,required:s}=t;this._propsToCompare=e,this._propsToExtract=n||e,this._requiredProps=s}arePropsEqual(t,e){for(let n of this._propsToCompare)if(!(n in t)||!(n in e)||!Mt(t[n],e[n]))return!1;return!0}initializeProps(t,e){let n={},s={};for(let i of this._propsToExtract)(i in t||i in e)&&(n[i]=t[i],s[i]=e[i]);return this._checkRequiredProps(n),this._checkRequiredProps(s),{start:n,end:s}}getDuration(t,e){return e.transitionDuration}_checkRequiredProps(t){this._requiredProps&&this._requiredProps.forEach(e=>{let n=t[e];et(Number.isFinite(n)||Array.isArray(n),`${e} is required for transition`)})}};var Ji=Math.PI/180,np=180/Math.PI,Qi=6370972,Xn=256;function Q0(){let r=Xn/Qi,t=Math.PI/180*Xn;return{unitsPerMeter:[r,r,r],unitsPerMeter2:[0,0,0],metersPerUnit:[1/r,1/r,1/r],unitsPerDegree:[t,t,r],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/t,1/t,1/r]}}var t1=(()=>{class r extends Ct{constructor(e={}){let{longitude:n=0,zoom:s=0,nearZMultiplier:i=.5,farZMultiplier:o=1,resolution:a=10}=e,{latitude:c=0,height:l,altitude:u=1.5,fovy:h}=e;c=Math.max(Math.min(c,St),-St),l=l||1,h?u=xe(h):h=ye(u);let f=Math.pow(2,s-fn(c)),p=e.nearZ??i,_=e.farZ??(u+Xn*2*f/l)*o,x=new Q().lookAt({eye:[0,-u,0],up:[0,0,1]});x.rotateX(c*Ji),x.rotateZ(-n*Ji),x.scale(f/l),super(M(d({},e),{height:l,viewMatrix:x,longitude:n,latitude:c,zoom:s,distanceScales:Q0(),fovy:h,focalDistance:u,near:p,far:_})),this.scale=f,this.latitude=c,this.longitude=n,this.fovy=h,this.resolution=a}get projectionMode(){return pt.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){let n={targetZ:e.z||0},s=this.unproject([0,this.height/2],n),i=this.unproject([this.width/2,0],n),o=this.unproject([this.width,this.height/2],n),a=this.unproject([this.width/2,this.height],n);return o[0]<this.longitude&&(o[0]+=360),s[0]>this.longitude&&(s[0]-=360),[Math.min(s[0],o[0],i[0],a[0]),Math.min(s[1],o[1],i[1],a[1]),Math.max(s[0],o[0],i[0],a[0]),Math.max(s[1],o[1],i[1],a[1])]}unproject(e,{topLeft:n=!0,targetZ:s}={}){let[i,o,a]=e,c=n?o:this.height-o,{pixelUnprojectionMatrix:l}=this,u;if(Number.isFinite(a))u=Qc(l,[i,c,a,1]);else{let _=Qc(l,[i,c,-1,1]),x=Qc(l,[i,c,1,1]),y=((s||0)/Qi+1)*Xn,T=Et.sqrLen(Et.sub([],_,x)),I=Et.sqrLen(_),k=Et.sqrLen(x),P=4*((4*I*k-(T-I-k)**2)/16)/T,L=Math.sqrt(I-P),F=Math.sqrt(Math.max(0,y*y-P)),D=(L-F)/Math.sqrt(T);u=Et.lerp([],_,x,D)}let[h,f,p]=this.unprojectPosition(u);return Number.isFinite(a)?[h,f,p]:Number.isFinite(s)?[h,f,s]:[h,f]}projectPosition(e){let[n,s,i=0]=e,o=n*Ji,a=s*Ji,c=Math.cos(a),l=(i/Qi+1)*Xn;return[Math.sin(o)*c*l,-Math.cos(o)*c*l,Math.sin(a)*l]}unprojectPosition(e){let[n,s,i]=e,o=Et.len(e),a=Math.asin(i/o),l=Math.atan2(n,-s)*np,u=a*np,h=(o/Xn-1)*Qi;return[l,u,h]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition([e,n,s],i,o){let c=.25/Math.pow(2,this.zoom-fn(this.latitude)),l=e+c*(o[0]-i[0]),u=n-c*(o[1]-i[1]);u=Math.max(Math.min(u,St),-St);let h={longitude:l,latitude:u,zoom:s-fn(n)};return h.zoom+=fn(h.latitude),h}}return r.displayName="GlobeViewport",r})(),Hr=t1;function fn(r){let t=Math.PI*Math.cos(r*Math.PI/180);return Math.log2(t)}function Qc(r,t){let e=Lt.transformMat4([],t,r);return Lt.scale(e,e,1/e[3]),e}var e1=["longitude","latitude","zoom","bearing","pitch"],n1=["longitude","latitude","zoom"],Tt=class extends hn{constructor(t={}){let e=Array.isArray(t)?t:t.transitionProps,n=Array.isArray(t)?{}:t;n.transitionProps=Array.isArray(e)?{compare:e,required:e}:e||{compare:e1,required:n1},super(n.transitionProps),this.opts=n}initializeProps(t,e){let n=super.initializeProps(t,e),{makeViewport:s,around:i}=this.opts;if(s&&i)if(s(t)instanceof Hr)$.warn("around not supported in GlobeView")();else{let a=s(t),c=s(e),l=a.unproject(i);n.start.around=i,Object.assign(n.end,{around:c.project(l),aroundPosition:l,width:e.width,height:e.height})}return n}interpolateProps(t,e,n){let s={};for(let i of this._propsToExtract)s[i]=de(t[i]||0,e[i]||0,n);if(e.aroundPosition&&this.opts.makeViewport){let i=this.opts.makeViewport(d(d({},e),s));Object.assign(s,i.panByPosition(e.aroundPosition,de(t.around,e.around,n)))}return s}};var ke={transitionDuration:0},r1=300,to=r=>1-(1-r)*(1-r),Zn={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},pn={},Rt=class{constructor(t){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new Ki(M(d({},t),{getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)})),this.handleEvent=this.handleEvent.bind(this),this.eventManager=t.eventManager,this.onViewStateChange=t.onViewStateChange||(()=>{}),this.onStateChange=t.onStateChange||(()=>{}),this.makeViewport=t.makeViewport}set events(t){this.toggleEvents(this._customEvents,!1),this.toggleEvents(t,!0),this._customEvents=t,this.props&&this.setProps(this.props)}finalize(){for(let t in this._events)this._events[t]&&this.eventManager?.off(t,this.handleEvent);this.transitionManager.finalize()}handleEvent(t){this._controllerState=void 0;let e=this._eventStartBlocked;switch(t.type){case"panstart":return e?!1:this._onPanStart(t);case"panmove":return this._onPan(t);case"panend":return this._onPanEnd(t);case"pinchstart":return e?!1:this._onPinchStart(t);case"pinchmove":return this._onPinch(t);case"pinchend":return this._onPinchEnd(t);case"multipanstart":return e?!1:this._onMultiPanStart(t);case"multipanmove":return this._onMultiPan(t);case"multipanend":return this._onMultiPanEnd(t);case"dblclick":return this._onDoubleClick(t);case"wheel":return this._onWheel(t);case"keydown":return this._onKeyDown(t);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState(d(d({makeViewport:this.makeViewport},this.props),this.state)),this._controllerState}getCenter(t){let{x:e,y:n}=this.props,{offsetCenter:s}=t;return[s.x-e,s.y-n]}isPointInBounds(t,e){let{width:n,height:s}=this.props;if(e&&e.handled)return!1;let i=t[0]>=0&&t[0]<=n&&t[1]>=0&&t[1]<=s;return i&&e&&e.stopPropagation(),i}isFunctionKeyPressed(t){let{srcEvent:e}=t;return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(t){let e=setTimeout(()=>{this._eventStartBlocked===e&&(this._eventStartBlocked=null)},t);this._eventStartBlocked=e}setProps(t){t.dragMode&&(this.dragMode=t.dragMode),this.props=t,"transitionInterpolator"in t||(t.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(t);let{inertia:e}=t;this.inertia=Number.isFinite(e)?e:e===!0?r1:0;let{scrollZoom:n=!0,dragPan:s=!0,dragRotate:i=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:c=!1,keyboard:l=!0}=t,u=!!this.onViewStateChange;this.toggleEvents(Zn.WHEEL,u&&n),this.toggleEvents(Zn.PAN,u),this.toggleEvents(Zn.PINCH,u&&(a||c)),this.toggleEvents(Zn.MULTI_PAN,u&&c),this.toggleEvents(Zn.DOUBLE_CLICK,u&&o),this.toggleEvents(Zn.KEYBOARD,u&&l),this.scrollZoom=n,this.dragPan=s,this.dragRotate=i,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=c,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(t,e){this.eventManager&&t.forEach(n=>{this._events[n]!==e&&(this._events[n]=e,e?this.eventManager.on(n,this.handleEvent):this.eventManager.off(n,this.handleEvent))})}updateViewport(t,e=null,n={}){let s=d(d({},t.getViewportProps()),e),i=this.controllerState!==t;if(this.state=t.getState(),this._setInteractionState(n),i){let o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:s,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(t){this.onViewStateChange(M(d({},t),{interactionState:this._interactionState,viewId:this.props.id}))}_setInteractionState(t){Object.assign(this._interactionState,t),this.onStateChange(this._interactionState)}_onPanStart(t){let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let n=this.isFunctionKeyPressed(t)||t.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(n=!n);let s=this.controllerState[n?"panStart":"rotateStart"]({pos:e});return this._panMove=n,this.updateViewport(s,ke,{isDragging:!0}),!0}_onPan(t){return this.isDragging()?this._panMove?this._onPanMove(t):this._onPanRotate(t):!1}_onPanEnd(t){return this.isDragging()?this._panMove?this._onPanMoveEnd(t):this._onPanRotateEnd(t):!1}_onPanMove(t){if(!this.dragPan)return!1;let e=this.getCenter(t),n=this.controllerState.pan({pos:e});return this.updateViewport(n,ke,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(t){let{inertia:e}=this;if(this.dragPan&&e&&t.velocity){let n=this.getCenter(t),s=[n[0]+t.velocityX*e/2,n[1]+t.velocityY*e/2],i=this.controllerState.pan({pos:s}).panEnd();this.updateViewport(i,M(d({},this._getTransitionProps()),{transitionDuration:e,transitionEasing:to}),{isDragging:!1,isPanning:!0})}else{let n=this.controllerState.panEnd();this.updateViewport(n,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(t){if(!this.dragRotate)return!1;let e=this.getCenter(t),n=this.controllerState.rotate({pos:e});return this.updateViewport(n,ke,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(t){let{inertia:e}=this;if(this.dragRotate&&e&&t.velocity){let n=this.getCenter(t),s=[n[0]+t.velocityX*e/2,n[1]+t.velocityY*e/2],i=this.controllerState.rotate({pos:s}).rotateEnd();this.updateViewport(i,M(d({},this._getTransitionProps()),{transitionDuration:e,transitionEasing:to}),{isDragging:!1,isRotating:!0})}else{let n=this.controllerState.rotateEnd();this.updateViewport(n,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(t){if(!this.scrollZoom)return!1;let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;t.srcEvent.preventDefault();let{speed:n=.01,smooth:s=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:i}=t,o=2/(1+Math.exp(-Math.abs(i*n)));i<0&&o!==0&&(o=1/o);let a=s?M(d({},this._getTransitionProps({around:e})),{transitionDuration:250}):ke,c=this.controllerState.zoom({pos:e,scale:o});return this.updateViewport(c,a,{isZooming:!0,isPanning:!0}),s||this._setInteractionState({isZooming:!1,isPanning:!1}),!0}_onMultiPanStart(t){let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let n=this.controllerState.rotateStart({pos:e});return this.updateViewport(n,ke,{isDragging:!0}),!0}_onMultiPan(t){if(!this.touchRotate||!this.isDragging())return!1;let e=this.getCenter(t);e[0]-=t.deltaX;let n=this.controllerState.rotate({pos:e});return this.updateViewport(n,ke,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(t){if(!this.isDragging())return!1;let{inertia:e}=this;if(this.touchRotate&&e&&t.velocityY){let n=this.getCenter(t),s=[n[0],n[1]+=t.velocityY*e/2],i=this.controllerState.rotate({pos:s});this.updateViewport(i,M(d({},this._getTransitionProps()),{transitionDuration:e,transitionEasing:to}),{isDragging:!1,isRotating:!0}),this.blockEvents(e)}else{let n=this.controllerState.rotateEnd();this.updateViewport(n,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(t){let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let n=this.controllerState.zoomStart({pos:e}).rotateStart({pos:e});return pn._startPinchRotation=t.rotation,pn._lastPinchEvent=t,this.updateViewport(n,ke,{isDragging:!0}),!0}_onPinch(t){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let e=this.controllerState;if(this.touchZoom){let{scale:n}=t,s=this.getCenter(t);e=e.zoom({pos:s,scale:n})}if(this.touchRotate){let{rotation:n}=t;e=e.rotate({deltaAngleX:pn._startPinchRotation-n})}return this.updateViewport(e,ke,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),pn._lastPinchEvent=t,!0}_onPinchEnd(t){if(!this.isDragging())return!1;let{inertia:e}=this,{_lastPinchEvent:n}=pn;if(this.touchZoom&&e&&n&&t.scale!==n.scale){let s=this.getCenter(t),i=this.controllerState.rotateEnd(),o=Math.log2(t.scale),a=(o-Math.log2(n.scale))/(t.deltaTime-n.deltaTime),c=Math.pow(2,o+a*e/2);i=i.zoom({pos:s,scale:c}).zoomEnd(),this.updateViewport(i,M(d({},this._getTransitionProps({around:s})),{transitionDuration:e,transitionEasing:to}),{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(e)}else{let s=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(s,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return pn._startPinchRotation=null,pn._lastPinchEvent=null,!0}_onDoubleClick(t){if(!this.doubleClickZoom)return!1;let e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let n=this.isFunctionKeyPressed(t),s=this.controllerState.zoom({pos:e,scale:n?.5:2});return this.updateViewport(s,this._getTransitionProps({around:e}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(t){if(!this.keyboard)return!1;let e=this.isFunctionKeyPressed(t),{zoomSpeed:n,moveSpeed:s,rotateSpeedX:i,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this,c,l={};switch(t.srcEvent.code){case"Minus":c=e?a.zoomOut(n).zoomOut(n):a.zoomOut(n),l.isZooming=!0;break;case"Equal":c=e?a.zoomIn(n).zoomIn(n):a.zoomIn(n),l.isZooming=!0;break;case"ArrowLeft":e?(c=a.rotateLeft(i),l.isRotating=!0):(c=a.moveLeft(s),l.isPanning=!0);break;case"ArrowRight":e?(c=a.rotateRight(i),l.isRotating=!0):(c=a.moveRight(s),l.isPanning=!0);break;case"ArrowUp":e?(c=a.rotateUp(o),l.isRotating=!0):(c=a.moveUp(s),l.isPanning=!0);break;case"ArrowDown":e?(c=a.rotateDown(o),l.isRotating=!0):(c=a.moveDown(s),l.isPanning=!0);break;default:return!1}return this.updateViewport(c,this._getTransitionProps(),l),!0}_getTransitionProps(t){let{transition:e}=this;return!e||!e.transitionInterpolator?ke:t?M(d({},e),{transitionInterpolator:new Tt(M(d(d({},t),e.transitionInterpolator.opts),{makeViewport:this.controllerState.makeViewport}))}):e}};var De=class{constructor(t,e){this._viewportProps=this.applyConstraints(t),this._state=e}getViewportProps(){return this._viewportProps}getState(){return this._state}};var rp=5,s1=1.2,qr=class extends De{constructor(t){let{width:e,height:n,latitude:s,longitude:i,zoom:o,bearing:a=0,pitch:c=0,altitude:l=1.5,position:u=[0,0,0],maxZoom:h=20,minZoom:f=0,maxPitch:p=60,minPitch:_=0,startPanLngLat:x,startZoomLngLat:y,startRotatePos:T,startBearing:I,startPitch:k,startZoom:S,normalize:P=!0}=t;et(Number.isFinite(i)),et(Number.isFinite(s)),et(Number.isFinite(o)),super({width:e,height:n,latitude:s,longitude:i,zoom:o,bearing:a,pitch:c,altitude:l,maxZoom:h,minZoom:f,maxPitch:p,minPitch:_,normalize:P,position:u},{startPanLngLat:x,startZoomLngLat:y,startRotatePos:T,startBearing:I,startPitch:k,startZoom:S}),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanLngLat:this._unproject(t)})}pan({pos:t,startPos:e}){let n=this.getState().startPanLngLat||this._unproject(e);if(!n)return this;let i=this.makeViewport(this.getViewportProps()).panByPosition(n,t);return this._getUpdatedState(i)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:n=0}){let{startRotatePos:s,startBearing:i,startPitch:o}=this.getState();if(!s||i===void 0||o===void 0)return this;let a;return t?a=this._getNewRotation(t,s,o,i):a={bearing:i+e,pitch:o+n},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:t}){return this._getUpdatedState({startZoomLngLat:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:n}){let{startZoom:s,startZoomLngLat:i}=this.getState();if(i||(s=this.getViewportProps().zoom,i=this._unproject(e)||this._unproject(t)),!i)return this;let{maxZoom:o,minZoom:a}=this.getViewportProps(),c=s+Math.log2(n);c=X(c,a,o);let l=this.makeViewport(M(d({},this.getViewportProps()),{zoom:c}));return this._getUpdatedState(d({zoom:c},l.panByPosition(i,t)))}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(t=2){return this._zoomFromCenter(t)}zoomOut(t=2){return this._zoomFromCenter(1/t)}moveLeft(t=100){return this._panFromCenter([t,0])}moveRight(t=100){return this._panFromCenter([-t,0])}moveUp(t=100){return this._panFromCenter([0,t])}moveDown(t=100){return this._panFromCenter([0,-t])}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}shortestPathFrom(t){let e=t.getViewportProps(),n=d({},this.getViewportProps()),{bearing:s,longitude:i}=n;return Math.abs(s-e.bearing)>180&&(n.bearing=s<0?s+360:s-360),Math.abs(i-e.longitude)>180&&(n.longitude=i<0?i+360:i-360),n}applyConstraints(t){let{maxZoom:e,minZoom:n,zoom:s}=t;t.zoom=X(s,n,e);let{maxPitch:i,minPitch:o,pitch:a}=t;t.pitch=X(a,o,i);let{normalize:c=!0}=t;return c&&Object.assign(t,Fc(t)),t}_zoomFromCenter(t){let{width:e,height:n}=this.getViewportProps();return this.zoom({pos:[e/2,n/2],scale:t})}_panFromCenter(t){let{width:e,height:n}=this.getViewportProps();return this.pan({startPos:[e/2,n/2],pos:[e/2+t[0],n/2+t[1]]})}_getUpdatedState(t){return new this.constructor(d(d(d({makeViewport:this.makeViewport},this.getViewportProps()),this.getState()),t))}_unproject(t){let e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_getNewRotation(t,e,n,s){let i=t[0]-e[0],o=t[1]-e[1],a=t[1],c=e[1],{width:l,height:u}=this.getViewportProps(),h=i/l,f=0;o>0?Math.abs(u-c)>rp&&(f=o/(c-u)*s1):o<0&&c>rp&&(f=1-a/c),f=X(f,-1,1);let{minPitch:p,maxPitch:_}=this.getViewportProps(),x=s+180*h,y=n;return f>0?y=n+f*(_-n):f<0&&(y=n-f*(p-n)),{pitch:y,bearing:x}}},Yr=class extends Rt{constructor(){super(...arguments),this.ControllerState=qr,this.transition={transitionDuration:300,transitionInterpolator:new Tt({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(t){t.position=t.position||[0,0,0];let e=this.props;super.setProps(t),(!e||e.height!==t.height)&&this.updateViewport(new this.ControllerState(d(d({makeViewport:this.makeViewport},t),this.state)))}};var i1=(()=>{class r extends Ot{constructor(e={}){super(e)}getViewportType(){return rn}get ControllerType(){return Yr}}return r.displayName="MapView",r})(),tl=i1;var o1=new $n;function a1(r,t){let e=r.order??1/0,n=t.order??1/0;return e-n}var eo=class{constructor(t){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=t,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(t){let e=this._defaultEffects;if(!e.find(n=>n.id===t.id)){let n=e.findIndex(s=>a1(s,t)>0);n<0?e.push(t):e.splice(n,0,t),t.setup(this._context),this._setEffects(this.effects)}}setProps(t){"effects"in t&&(at(t.effects,this.effects,1)||this._setEffects(t.effects))}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}getEffects(){return this._resolvedEffects}_setEffects(t){let e={};for(let s of this.effects)e[s.id]=s;let n=[];for(let s of t){let i=e[s.id],o=s;i&&i!==s?i.setProps?(i.setProps(s.props),o=i):i.cleanup(this._context):i||s.setup(this._context),n.push(o),delete e[s.id]}for(let s in e)e[s].cleanup(this._context);this.effects=n,this._resolvedEffects=n.concat(this._defaultEffects),t.some(s=>s instanceof $n)||this._resolvedEffects.push(o1),this._needsRedraw="effects changed"}finalize(){for(let t of this._resolvedEffects)t.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}};var no=class extends be{shouldDrawLayer(t){let{operation:e}=t.props;return e.includes("draw")||e.includes("terrain")}};var c1="deckRenderer.renderLayers",Xr=class{constructor(t){this.device=t,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new no(t),this.pickLayersPass=new ln(t),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(t){this.layerFilter!==t.layerFilter&&(this.layerFilter=t.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==t.drawPickingColors&&(this.drawPickingColors=t.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(t){if(!t.viewports.length)return;let e=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,n=d({layerFilter:this.layerFilter,isPicking:this.drawPickingColors},t);n.effects&&this._preRender(n.effects,n);let s=this.lastPostProcessEffect?this.renderBuffers[0]:n.target;this.lastPostProcessEffect&&(n.clearColor=[0,0,0,0],n.clearCanvas=!0);let i=e.render(M(d({},n),{target:s}));n.effects&&(this.lastPostProcessEffect&&(n.clearCanvas=t.clearCanvas===void 0?!0:t.clearCanvas),this._postRender(n.effects,n)),this.renderCount++,st(c1,this,i,t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}finalize(){let{renderBuffers:t}=this;for(let e of t)e.delete();t.length=0}_preRender(t,e){this.lastPostProcessEffect=null,e.preRenderStats=e.preRenderStats||{};for(let n of t)e.preRenderStats[n.id]=n.preRender(e),n.postRender&&(this.lastPostProcessEffect=n.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){let{renderBuffers:t}=this,e=this.device.canvasContext.getDrawingBufferSize(),[n,s]=e;t.length===0&&[0,1].map(i=>{let o=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"},width:n,height:s});t.push(this.device.createFramebuffer({id:`deck-renderbuffer-${i}`,colorAttachments:[o]}))});for(let i of t)i.resize(e)}_postRender(t,e){let{renderBuffers:n}=this,s=M(d({},e),{inputBuffer:n[0],swapBuffer:n[1]});for(let i of t)if(i.postRender){s.target=i.id===this.lastPostProcessEffect?e.target:void 0;let o=i.postRender(s);s.inputBuffer=o,s.swapBuffer=o===n[0]?n[1]:n[0]}}};var l1={pickedColor:null,pickedObjectIndex:-1};function el({pickedColors:r,decodePickingColor:t,deviceX:e,deviceY:n,deviceRadius:s,deviceRect:i}){let{x:o,y:a,width:c,height:l}=i,u=s*s,h=-1,f=0;for(let p=0;p<l;p++){let _=p+a-n,x=_*_;if(x>u)f+=4*c;else for(let y=0;y<c;y++){if(r[f+3]-1>=0){let I=y+o-e,k=I*I+x;k<=u&&(u=k,h=f)}f+=4}}if(h>=0){let p=r.slice(h,h+4),_=t(p);if(_){let x=Math.floor(h/4/c),y=h/4-x*c;return M(d({},_),{pickedColor:p,pickedX:o+y,pickedY:a+x})}$.error("Picked non-existent layer. Is picking buffer corrupt?")()}return l1}function nl({pickedColors:r,decodePickingColor:t}){let e=new Map;if(r){for(let n=0;n<r.length;n+=4)if(r[n+3]-1>=0){let i=r.slice(n,n+4),o=i.join(",");if(!e.has(o)){let a=t(i);a?e.set(o,M(d({},a),{color:i})):$.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(e.values())}function ro({pickInfo:r,viewports:t,pixelRatio:e,x:n,y:s,z:i}){let o=t[0];t.length>1&&(o=u1(r?.pickedViewports||t,{x:n,y:s}));let a;if(o){let c=[n-o.x,s-o.y];i!==void 0&&(c[2]=i),a=o.unproject(c)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:n,y:s,pixel:[n,s],coordinate:a,devicePixel:r&&"pickedX"in r?[r.pickedX,r.pickedY]:void 0,pixelRatio:e}}function rl(r){let{pickInfo:t,lastPickedInfo:e,mode:n,layers:s}=r,{pickedColor:i,pickedLayer:o,pickedObjectIndex:a}=t,c=o?[o]:[];if(n==="hover"){let h=e.index,f=e.layerId,p=o?o.props.id:null;if(p!==f||a!==h){if(p!==f){let _=s.find(x=>x.props.id===f);_&&c.unshift(_)}e.layerId=p,e.index=a,e.info=null}}let l=ro(r),u=new Map;return u.set(null,l),c.forEach(h=>{let f=d({},l);h===o&&(f.color=i,f.index=a,f.picked=!0),f=so({layer:h,info:f,mode:n});let p=f.layer;h===o&&n==="hover"&&(e.info=f),u.set(p.id,f),n==="hover"&&p.updateAutoHighlight(f)}),u}function so({layer:r,info:t,mode:e}){for(;r&&t;){let n=t.layer||null;t.sourceLayer=n,t.layer=r,t=r.getPickingInfo({info:t,mode:e,sourceLayer:n}),r=r.parent}return t}function u1(r,t){for(let e=r.length-1;e>=0;e--){let n=r[e];if(n.containsPixel(t))return n}return r[0]}var io=class{constructor(t){this._pickable=!0,this.device=t,this.pickLayersPass=new ln(t),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(t){"layerFilter"in t&&(this.layerFilter=t.layerFilter),"_pickable"in t&&(this._pickable=t._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObjectAsync(t){return this._pickClosestObjectAsync(t)}pickObjectsAsync(t){return this._pickVisibleObjectsAsync(t)}pickObject(t){return this._pickClosestObject(t)}pickObjects(t){return this._pickVisibleObjects(t)}getLastPickedObject({x:t,y:e,layers:n,viewports:s},i=this.lastPickedInfo.info){let o=i&&i.layer&&i.layer.id,a=i&&i.viewport&&i.viewport.id,c=o?n.find(f=>f.id===o):null,l=a&&s.find(f=>f.id===a)||s[0],u=l&&l.unproject([t-l.x,e-l.y]),h={x:t,y:e,viewport:l,coordinate:u,layer:c};return d(d({},i),h)}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){let e=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=e}let{canvas:t}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:t.width,height:t.height}),this.depthFBO?.resize({width:t.width,height:t.height})}_getPickable(t){if(this._pickable===!1)return null;let e=t.filter(n=>this.pickLayersPass.shouldDrawLayer(n)&&!n.isComposite);return e.length?e:null}_pickClosestObjectAsync(f){return B(this,arguments,function*({layers:t,views:e,viewports:n,x:s,y:i,radius:o=0,depth:a=1,mode:c="query",unproject3D:l,onViewportActive:u,effects:h}){let p=this.device.canvasContext.cssToDeviceRatio(),_=this._getPickable(t);if(!_||n.length===0)return{result:[],emptyInfo:ro({viewports:n,x:s,y:i,pixelRatio:p})};this._resizeBuffer();let x=this.device.canvasContext.cssToDevicePixels([s,i],!0),y=[x.x+Math.floor(x.width/2),x.y+Math.floor(x.height/2)],T=Math.round(o*p),{width:I,height:k}=this.pickingFBO,S=this._getPickingRect({deviceX:y[0],deviceY:y[1],deviceRadius:T,deviceWidth:I,deviceHeight:k}),P={x:s-o,y:i-o,width:o*2+1,height:o*2+1},L,F=[],D=new Set;for(let R=0;R<a;R++){let O;if(S){let j=this._drawAndSample({layers:_,views:e,viewports:n,onViewportActive:u,deviceRect:S,cullRect:P,effects:h,pass:`picking:${c}`});O=el(M(d({},j),{deviceX:y[0],deviceY:y[1],deviceRadius:T,deviceRect:S}))}else O={pickedColor:null,pickedObjectIndex:-1};let V;if(O.pickedLayer&&l&&this.depthFBO){let{pickedColors:j}=this._drawAndSample({layers:[O.pickedLayer],views:e,viewports:n,onViewportActive:u,deviceRect:{x:O.pickedX,y:O.pickedY,width:1,height:1},cullRect:P,effects:h,pass:`picking:${c}:z`},!0);j[3]&&(V=j[0])}O.pickedLayer&&R+1<a&&(D.add(O.pickedLayer),O.pickedLayer.disablePickingIndex(O.pickedObjectIndex)),L=rl({pickInfo:O,lastPickedInfo:this.lastPickedInfo,mode:c,layers:_,viewports:n,x:s,y:i,z:V,pixelRatio:p});for(let j of L.values())j.layer&&F.push(j);if(!O.pickedColor)break}for(let R of D)R.restorePickingColors();return{result:F,emptyInfo:L.get(null)}})}_pickClosestObject({layers:t,views:e,viewports:n,x:s,y:i,radius:o=0,depth:a=1,mode:c="query",unproject3D:l,onViewportActive:u,effects:h}){let f=this.device.canvasContext.cssToDeviceRatio(),p=this._getPickable(t);if(!p||n.length===0)return{result:[],emptyInfo:ro({viewports:n,x:s,y:i,pixelRatio:f})};this._resizeBuffer();let _=this.device.canvasContext.cssToDevicePixels([s,i],!0),x=[_.x+Math.floor(_.width/2),_.y+Math.floor(_.height/2)],y=Math.round(o*f),{width:T,height:I}=this.pickingFBO,k=this._getPickingRect({deviceX:x[0],deviceY:x[1],deviceRadius:y,deviceWidth:T,deviceHeight:I}),S={x:s-o,y:i-o,width:o*2+1,height:o*2+1},P,L=[],F=new Set;for(let D=0;D<a;D++){let R;if(k){let V=this._drawAndSample({layers:p,views:e,viewports:n,onViewportActive:u,deviceRect:k,cullRect:S,effects:h,pass:`picking:${c}`});R=el(M(d({},V),{deviceX:x[0],deviceY:x[1],deviceRadius:y,deviceRect:k}))}else R={pickedColor:null,pickedObjectIndex:-1};let O;if(R.pickedLayer&&l&&this.depthFBO){let{pickedColors:V}=this._drawAndSample({layers:[R.pickedLayer],views:e,viewports:n,onViewportActive:u,deviceRect:{x:R.pickedX,y:R.pickedY,width:1,height:1},cullRect:S,effects:h,pass:`picking:${c}:z`},!0);V[3]&&(O=V[0])}R.pickedLayer&&D+1<a&&(F.add(R.pickedLayer),R.pickedLayer.disablePickingIndex(R.pickedObjectIndex)),P=rl({pickInfo:R,lastPickedInfo:this.lastPickedInfo,mode:c,layers:p,viewports:n,x:s,y:i,z:O,pixelRatio:f});for(let V of P.values())V.layer&&L.push(V);if(!R.pickedColor)break}for(let D of F)D.restorePickingColors();return{result:L,emptyInfo:P.get(null)}}_pickVisibleObjectsAsync(f){return B(this,arguments,function*({layers:t,views:e,viewports:n,x:s,y:i,width:o=1,height:a=1,mode:c="query",maxObjects:l=null,onViewportActive:u,effects:h}){let p=this._getPickable(t);if(!p||n.length===0)return[];this._resizeBuffer();let _=this.device.canvasContext.cssToDeviceRatio(),x=this.device.canvasContext.cssToDevicePixels([s,i],!0),y=x.x,T=x.y+x.height,I=this.device.canvasContext.cssToDevicePixels([s+o,i+a],!0),k=I.x+I.width,S=I.y,P={x:y,y:S,width:k-y,height:T-S},L=this._drawAndSample({layers:p,views:e,viewports:n,onViewportActive:u,deviceRect:P,cullRect:{x:s,y:i,width:o,height:a},effects:h,pass:`picking:${c}`}),F=nl(L),D=new Map,R=[],O=Number.isFinite(l);for(let V=0;V<F.length&&!(O&&R.length>=l);V++){let j=F[V],q={color:j.pickedColor,layer:null,index:j.pickedObjectIndex,picked:!0,x:s,y:i,pixelRatio:_};q=so({layer:j.pickedLayer,info:q,mode:c});let H=q.layer.id;D.has(H)||D.set(H,new Set);let mt=D.get(H),Ee=q.object??q.index;mt.has(Ee)||(mt.add(Ee),R.push(q))}return R})}_pickVisibleObjects({layers:t,views:e,viewports:n,x:s,y:i,width:o=1,height:a=1,mode:c="query",maxObjects:l=null,onViewportActive:u,effects:h}){let f=this._getPickable(t);if(!f||n.length===0)return[];this._resizeBuffer();let p=this.device.canvasContext.cssToDeviceRatio(),_=this.device.canvasContext.cssToDevicePixels([s,i],!0),x=_.x,y=_.y+_.height,T=this.device.canvasContext.cssToDevicePixels([s+o,i+a],!0),I=T.x+T.width,k=T.y,S={x,y:k,width:I-x,height:y-k},P=this._drawAndSample({layers:f,views:e,viewports:n,onViewportActive:u,deviceRect:S,cullRect:{x:s,y:i,width:o,height:a},effects:h,pass:`picking:${c}`}),L=nl(P),F=new Map,D=[],R=Number.isFinite(l);for(let O=0;O<L.length&&!(R&&D.length>=l);O++){let V=L[O],j={color:V.pickedColor,layer:null,index:V.pickedObjectIndex,picked:!0,x:s,y:i,pixelRatio:p};j=so({layer:V.pickedLayer,info:j,mode:c});let q=j.layer.id;F.has(q)||F.set(q,new Set);let H=F.get(q),mt=j.object??j.index;H.has(mt)||(H.add(mt),D.push(j))}return D}_drawAndSampleAsync(u){return B(this,arguments,function*({layers:t,views:e,viewports:n,onViewportActive:s,deviceRect:i,cullRect:o,effects:a,pass:c},l=!1){let h=l?this.depthFBO:this.pickingFBO,f={layers:t,layerFilter:this.layerFilter,views:e,viewports:n,onViewportActive:s,pickingFBO:h,deviceRect:i,cullRect:o,effects:a,pass:c,pickZ:l,preRenderStats:{},isPicking:!0};for(let k of a)k.useInPicking&&(f.preRenderStats[k.id]=k.preRender(f));let{decodePickingColor:p}=this.pickLayersPass.render(f),{x:_,y:x,width:y,height:T}=i,I=new(l?Float32Array:Uint8Array)(y*T*4);return this.device.readPixelsToArrayWebGL(h,{sourceX:_,sourceY:x,sourceWidth:y,sourceHeight:T,target:I}),{pickedColors:I,decodePickingColor:p}})}_drawAndSample({layers:t,views:e,viewports:n,onViewportActive:s,deviceRect:i,cullRect:o,effects:a,pass:c},l=!1){let u=l?this.depthFBO:this.pickingFBO,h={layers:t,layerFilter:this.layerFilter,views:e,viewports:n,onViewportActive:s,pickingFBO:u,deviceRect:i,cullRect:o,effects:a,pass:c,pickZ:l,preRenderStats:{},isPicking:!0};for(let I of a)I.useInPicking&&(h.preRenderStats[I.id]=I.preRender(h));let{decodePickingColor:f}=this.pickLayersPass.render(h),{x:p,y:_,width:x,height:y}=i,T=new(l?Float32Array:Uint8Array)(x*y*4);return this.device.readPixelsToArrayWebGL(u,{sourceX:p,sourceY:_,sourceWidth:x,sourceHeight:y,target:T}),{pickedColors:T,decodePickingColor:f}}_getPickingRect({deviceX:t,deviceY:e,deviceRadius:n,deviceWidth:s,deviceHeight:i}){let o=Math.max(0,t-n),a=Math.max(0,e-n),c=Math.min(s,t+n+1)-o,l=Math.min(i,e+n+1)-a;return c<=0||l<=0?null:{x:o,y:a,width:c,height:l}}};var h1={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},f1="top-left",sp="root",oo=class{constructor({deck:t,parentElement:e}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=t,e?.classList.add("deck-widget-container"),this.parentElement=e}getWidgets(){return this.resolvedWidgets}setProps(t){if(t.widgets&&!at(t.widgets,this.widgets,1)){let e=t.widgets.filter(Boolean);this._setWidgets(e)}}finalize(){for(let t of this.getWidgets())this._removeWidget(t);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(let t in this.containers)this.containers[t].remove()}addDefault(t){this.defaultWidgets.find(e=>e.id===t.id)||(this._addWidget(t),this.defaultWidgets.push(t),this._setWidgets(this.widgets))}onRedraw({viewports:t,layers:e}){let n=t.reduce((s,i)=>(s[i.id]=i,s),{});for(let s of this.getWidgets()){let{viewId:i}=s;if(i){let o=n[i];o&&(s.onViewportChange&&s.onViewportChange(o),s.onRedraw?.({viewports:[o],layers:e}))}else{if(s.onViewportChange)for(let o of t)s.onViewportChange(o);s.onRedraw?.({viewports:t,layers:e})}}this.lastViewports=n,this._updateContainers()}onHover(t,e){for(let n of this.getWidgets()){let{viewId:s}=n;(!s||s===t.viewport?.id)&&n.onHover?.(t,e)}}onEvent(t,e){let n=Or[e.type];if(n)for(let s of this.getWidgets()){let{viewId:i}=s;(!i||i===t.viewport?.id)&&s[n]?.(t,e)}}_setWidgets(t){let e={};for(let n of this.resolvedWidgets)e[n.id]=n;this.resolvedWidgets.length=0;for(let n of this.defaultWidgets)e[n.id]=null,this.resolvedWidgets.push(n);for(let n of t){let s=e[n.id];s?s.viewId!==n.viewId||s.placement!==n.placement?(this._removeWidget(s),this._addWidget(n)):n!==s&&(s.setProps(n.props),n=s):this._addWidget(n),e[n.id]=null,this.resolvedWidgets.push(n)}for(let n in e){let s=e[n];s&&this._removeWidget(s)}this.widgets=t}_addWidget(t){let{viewId:e=null,placement:n=f1}=t,s=t.props._container??e;t.widgetManager=this,t.deck=this.deck,t.rootElement=t._onAdd({deck:this.deck,viewId:e}),t.rootElement&&this._getContainer(s,n).append(t.rootElement),t.updateHTML()}_removeWidget(t){t.onRemove?.(),t.rootElement&&t.rootElement.remove(),t.rootElement=void 0,t.deck=void 0,t.widgetManager=void 0}_getContainer(t,e){if(t&&typeof t!="string")return t;let n=t||sp,s=this.containers[n];s||(s=document.createElement("div"),s.style.pointerEvents="none",s.style.position="absolute",s.style.overflow="hidden",this.parentElement?.append(s),this.containers[n]=s);let i=s.querySelector(`.${e}`);return i||(i=globalThis.document.createElement("div"),i.className=e,i.style.position="absolute",i.style.zIndex="2",Object.assign(i.style,h1[e]),s.append(i)),i}_updateContainers(){let t=this.deck.width,e=this.deck.height;for(let n in this.containers){let s=this.lastViewports[n]||null,i=n===sp||s,o=this.containers[n];i?(o.style.display="block",o.style.left=`${s?s.x:0}px`,o.style.top=`${s?s.y:0}px`,o.style.width=`${s?s.width:t}px`,o.style.height=`${s?s.height:e}px`):o.style.display="none"}}};function ao(r,t){t&&Object.entries(t).map(([e,n])=>{e.startsWith("--")?r.style.setProperty(e,n):r.style[e]=n})}function sl(r,t){t&&Object.keys(t).map(e=>{e.startsWith("--")?r.style.removeProperty(e):r.style[e]=""})}var co=(()=>{class r{constructor(e){this.viewId=null,this.props=d(d({},this.constructor.defaultProps),e),this.id=this.props.id}setProps(e){let n=this.props,s=this.rootElement;s&&n.className!==e.className&&(n.className&&s.classList.remove(n.className),e.className&&s.classList.add(e.className)),s&&!at(n.style,e.style,1)&&(sl(s,n.style),ao(s,e.style)),Object.assign(this.props,e),this.updateHTML()}updateHTML(){this.rootElement&&this.onRenderHTML(this.rootElement)}onCreateRootElement(){let e=["deck-widget",this.className,this.props.className],n=document.createElement("div");return e.filter(s=>typeof s=="string"&&s.length>0).forEach(s=>n.classList.add(s)),ao(n,this.props.style),n}_onAdd(e){return this.onAdd(e)??this.onCreateRootElement()}onAdd(e){}onRemove(){}onViewportChange(e){}onRedraw(e){}onHover(e,n){}onClick(e,n){}onDrag(e,n){}onDragStart(e,n){}onDragEnd(e,n){}}return r.defaultProps={id:"widget",style:{},_container:null,className:""},r})();var p1={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"},Zr=class extends co{constructor(t={}){super(t),this.id="default-tooltip",this.placement="fill",this.className="deck-tooltip",this.isVisible=!1,this.setProps(t)}onCreateRootElement(){let t=document.createElement("div");return t.className=this.className,Object.assign(t.style,p1),t}onRenderHTML(t){}onViewportChange(t){this.isVisible&&t.id===this.lastViewport?.id&&!t.equals(this.lastViewport)&&this.setTooltip(null),this.lastViewport=t}onHover(t){let{deck:e}=this,n=e&&e.props.getTooltip;if(!n)return;let s=n(t);this.setTooltip(s,t.x,t.y)}setTooltip(t,e,n){let s=this.rootElement;if(s){if(typeof t=="string")s.innerText=t;else if(t)t.text&&(s.innerText=t.text),t.html&&(s.innerHTML=t.html),t.className&&(s.className=t.className);else{this.isVisible=!1,s.style.display="none";return}this.isVisible=!0,s.style.display="block",s.style.transform=`translate(${e}px, ${n}px)`,t&&typeof t=="object"&&"style"in t&&Object.assign(s.style,t.style)}}};Zr.defaultProps=d({},co.defaultProps);function Fe(){}var d1=({isDragging:r})=>r?"grabbing":"grab",ip={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Fe,onWebGLInitialized:Fe,onResize:Fe,onViewStateChange:Fe,onInteractionStateChange:Fe,onBeforeRender:Fe,onAfterRender:Fe,onLoad:Fe,onError:r=>$.error(r.message,r.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:d1,getTooltip:null,debug:!1,drawPickingColors:!1},m1=(()=>{class r{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new xn({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=s=>{let{_pickRequest:i}=this;if(s.type==="pointerleave")i.x=-1,i.y=-1,i.radius=0;else{if(s.leftButton||s.rightButton)return;{let o=s.offsetCenter;if(!o)return;i.x=o.x,i.y=o.y,i.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:i.x,y:i.y}),i.event=s},this._onEvent=s=>{let i=Or[s.type],o=s.offsetCenter;if(!i||!o||!this.layerManager)return;let a=this.layerManager.getLayers(),c=this.deckPicker.getLastPickedObject({x:o.x,y:o.y,layers:a,viewports:this.getViewports(o)},this._lastPointerDownInfo),{layer:l}=c,u=l&&(l[i]||l.props[i]),h=this.props[i],f=!1;u&&(f=u.call(l,c,s)),f||(h?.(c,s),this.widgetManager.onEvent(c,s))},this._onPointerDown=s=>{if(this.device?.type==="webgpu")return;let i=s.offsetCenter,o=this._pick("pickObject","pickObject Time",{x:i.x,y:i.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=o.result[0]||o.emptyInfo},this.props=d(d({},ip),e),e=this.props,e.viewState&&e.initialViewState&&$.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let n=this.device;if(!n&&e.gl){e.gl instanceof WebGLRenderingContext&&$.error("WebGL1 context not supported.")();let s=this.props.deviceProps?.onResize;n=hs.attach(e.gl,M(d({},this.props.deviceProps),{onResize:(i,o)=>{let{width:a,height:c}=i.canvas;i.drawingBufferWidth=a,i.drawingBufferHeight=c,this._needsRedraw="Canvas resized",s?.(i,o)}}))}n||(n=this._createDevice(e)),this.animationLoop=this._createAnimationLoop(n,e),this.setProps(e),e._typedArrayManagerProps&&Xt.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&$.removed("onLayerHover","onHover")(),"onLayerClick"in e&&$.removed("onLayerClick","onClick")(),e.initialViewState&&!at(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);let n=Object.create(this.props);Object.assign(n,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),e.device&&e.device.id!==this.device?.id&&(this.animationLoop?.stop(),this.canvas!==e.device.canvasContext?.canvas&&(this.canvas?.remove(),this.eventManager?.destroy(),this.canvas=null),$.log(`recreating animation loop for new device! id=${e.device.id}`)(),this.animationLoop=this._createAnimationLoop(e.device,e),this.animationLoop.start()),this.animationLoop?.setProps(n),e.useDevicePixels!==void 0&&this.device?.canvasContext&&this.device.canvasContext.setProps({useDevicePixels:e.useDevicePixels}),this.layerManager&&(this.viewManager.setProps(n),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(n),this.effectManager.setProps(n),this.deckRenderer.setProps(n),this.deckPicker.setProps(n),this.widgetManager.setProps(n)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let n=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);let s=this.viewManager.needsRedraw(e),i=this.layerManager.needsRedraw(e),o=this.effectManager.needsRedraw(e),a=this.deckRenderer.needsRedraw(e);return n=n||s||i||o||a,n}redraw(e){if(!this.layerManager)return;let n=this.needsRedraw({clearRedrawFlags:!0});n=e||n,n&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(n):this._drawLayers(n))}get isInitialized(){return this.viewManager!==null}getViews(){return et(this.viewManager),this.viewManager.views}getViewports(e){return et(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){let n=this._pick("pickObject","pickObject Time",e).result;return n.length?n[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,n=!1){for(let s in e)this.layerManager.resourceManager.add({resourceId:s,data:e[s],forceUpdate:n})}_removeResources(e){for(let n of e)this.layerManager.resourceManager.remove(n)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){this.layerManager?.removeDefaultShaderModule(e)}_pick(e,n,s){et(this.deckPicker);let{stats:i}=this;i.get("Pick Count").incrementCount(),i.get(n).timeStart();let o=this.deckPicker[e](d({layers:this.layerManager.getLayers(s),views:this.viewManager.getViews(),viewports:this.getViewports(s),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects()},s));return i.get(n).timeEnd(),o}_createCanvas(e){let n=e.canvas;return typeof n=="string"&&(n=document.getElementById(n),et(n)),n||(n=document.createElement("canvas"),n.id=e.id||"deckgl-overlay",e.width&&typeof e.width=="number"&&(n.width=e.width),e.height&&typeof e.height=="number"&&(n.height=e.height),(e.parent||document.body).appendChild(n)),Object.assign(n.style,e.style),n}_setCanvasSize(e){if(!this.canvas)return;let{width:n,height:s}=e;if(n||n===0){let i=Number.isFinite(n)?`${n}px`:n;this.canvas.style.width=i}if(s||s===0){let i=Number.isFinite(s)?`${s}px`:s;this.canvas.style.position=e.style?.position||"absolute",this.canvas.style.height=i}}_updateCanvasSize(){let{canvas:e}=this;if(!e)return;let n=e.clientWidth??e.width,s=e.clientHeight??e.height;(n!==this.width||s!==this.height)&&(this.width=n,this.height=s,this.viewManager?.setProps({width:n,height:s}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:n,height:s}))}_createAnimationLoop(e,n){let{gl:s,onError:i}=n;return new $r({device:e,autoResizeDrawingBuffer:!s,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:i})}_createDevice(e){let n=this.props.deviceProps?.createCanvasContext,s=typeof n=="object"?n:void 0,i=d({adapters:[],_cacheShaders:!0,_cachePipelines:!0},e.deviceProps);i.adapters.includes(hs)||i.adapters.push(hs);let o={alphaMode:this.props.deviceProps?.type==="webgpu"?"premultiplied":void 0},a=this.props.deviceProps?.onResize;return er.createDevice(M(d({_reuseDevices:!0,type:"webgl"},i),{createCanvasContext:M(d(d({},o),s),{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!0}),onResize:(c,l)=>{this._needsRedraw="Canvas resized",a?.(c,l)}}))}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let{views:e}=this.props,n=Array.isArray(e)?e:e?[e]:[new tl({id:"default-view"})];return n.length&&this.props.controller&&(n[0].props.controller=this.props.controller),n}_onContextLost(){let{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;let{_pickRequest:e}=this;if(e.event){let{result:n,emptyInfo:s}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=n.length>0;let i=s,o=!1;for(let a of n)i=a,o=a.layer?.onHover(a,e.event)||o;o||(this.props.onHover?.(i,e.event),this.widgetManager.onHover(i,e.event)),e.event=null}}_updateCursor(){let e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas,!this.canvas.isConnected&&this.props.parent&&this.props.parent.insertBefore(this.canvas,this.props.parent.firstChild)),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);let n=new on;n.play(),this.animationLoop.attachTimeline(n),this.eventManager=new Cr(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(Lc).map(i=>{let[o,a,c,l]=Lc[i],u=this.props.eventRecognizerOptions?.[i],h=M(d(d({},a),u),{event:i});return{recognizer:new o(h),recognizeWith:c,requestFailure:l}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(let i in Or)this.eventManager.on(i,this._onEvent);this.viewManager=new Xi({timeline:n,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let s=this.viewManager.getViewports()[0];this.layerManager=new Gr(this.device,{deck:this,stats:this.stats,viewport:s,timeline:n}),this.effectManager=new eo({deck:this,device:this.device}),this.deckRenderer=new Xr(this.device),this.deckPicker=new io(this.device),this.widgetManager=new oo({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new Zr),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,n){let{device:s,gl:i}=this.layerManager.context;this.props.onBeforeRender({device:s,gl:i});let o=d({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects()},n);this.deckRenderer?.renderLayers(o),o.pass==="screen"&&this.widgetManager.onRedraw({viewports:o.viewports,layers:o.layers}),this.props.onAfterRender({device:s,gl:i})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),$.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){let n=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState=M(d({},this.viewState),{[e.viewId]:n}),this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){let{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();let n=this.animationLoop.stats;e.get("GPU Time").addTime(n.get("GPU Time").lastTiming),e.get("CPU Time").addTime(n.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:e,stats:n}=this;e.fps=n.get("frameRate").getHz(),e.setPropsTime=n.get("setProps Time").time,e.updateAttributesTime=n.get("Update Attributes").time,e.framesRedrawn=n.get("Redraw Count").count,e.pickTime=n.get("pickObject Time").time+n.get("pickMultipleObjects Time").time+n.get("pickObjects Time").time,e.pickCount=n.get("Pick Count").count,e.gpuTime=n.get("GPU Time").time,e.cpuTime=n.get("CPU Time").time,e.gpuTimePerFrame=n.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=n.get("CPU Time").getAverageTime();let s=er.stats.get("Memory Usage");e.bufferMemory=s.get("Buffer Memory").count,e.textureMemory=s.get("Texture Memory").count,e.renderbufferMemory=s.get("Renderbuffer Memory").count,e.gpuMemory=s.get("GPU Memory").count}}return r.defaultProps=ip,r.VERSION=ua,r})(),g1=m1;function op(r){switch(r){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return ls(r)}}var ap=Il;function Kr(r,t,e){let n=e==="webgpu"&&t.type==="uint8"?"unorm8":t.type;return{attribute:r,format:t.size>1?`${n}x${t.size}`:t.type,byteOffset:t.offset||0}}function Ve(r){return r.stride||r.size*r.bytesPerElement}function cp(r,t){return r.type===t.type&&r.size===t.size&&Ve(r)===Ve(t)&&(r.offset||0)===(t.offset||0)}function il(r,t){t.offset&&$.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let e=Ve(r),n=t.vertexOffset!==void 0?t.vertexOffset:r.vertexOffset||0,s=t.elementOffset||0,i=n*e+s*r.bytesPerElement+(r.offset||0);return M(d({},t),{offset:i,stride:e})}function _1(r,t){let e=il(r,t);return{high:e,low:M(d({},e),{offset:e.offset+r.size*4})}}var lo=class{constructor(t,e,n){this._buffer=null,this.device=t,this.id=e.id||"",this.size=e.size||1;let s=e.logicalType||e.type,i=s==="float64",{defaultValue:o}=e;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0);let a;i?a="float32":!s&&e.isIndexed?a="uint32":a=s||"float32";let c=op(s||a);this.doublePrecision=i,i&&e.fp64===!1&&(c=Float32Array),this.value=null,this.settings=M(d({},e),{defaultType:c,defaultValue:o,logicalType:s,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:c.BYTES_PER_ELEMENT}),this.state=M(d({},n),{externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1})}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){let t=this.getAccessor();return t.vertexOffset?t.vertexOffset*Ve(t):0}get numInstances(){return this.state.numInstances}set numInstances(t){this.state.numInstances=t}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Xt.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(t=this.id,e=null){let n={};if(this.state.constant){let s=this.value;if(e){let i=il(this.getAccessor(),e),o=i.offset/s.BYTES_PER_ELEMENT,a=i.size||this.size;n[t]=s.subarray(o,o+a)}else n[t]=s}else n[t]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?n[`${t}64Low`]=n[t]:n[`${t}64Low`]=new Float32Array(this.size)),n}_getBufferLayout(t=this.id,e=null){let n=this.getAccessor(),s=[],i={name:this.id,byteStride:Ve(n),attributes:s};if(this.doublePrecision){let o=_1(n,e||{});s.push(Kr(t,d(d({},n),o.high),this.device.type),Kr(`${t}64Low`,d(d({},n),o.low),this.device.type))}else if(e){let o=il(n,e);s.push(Kr(t,d(d({},n),o),this.device.type))}else s.push(Kr(t,n,this.device.type));return i}setAccessor(t){this.state.bufferAccessor=t}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let t=null;if(this.state.constant&&this.value){let e=Array.from(this.value);t=[e,e]}else{let{value:e,numInstances:n,size:s}=this,i=n*s;if(e&&i&&e.length>=i){let o=new Array(s).fill(1/0),a=new Array(s).fill(-1/0);for(let c=0;c<i;)for(let l=0;l<s;l++){let u=e[c++];u<o[l]&&(o[l]=u),u>a[l]&&(a[l]=u)}t=[o,a]}}return this.state.bounds=t,t}setData(t){let{state:e}=this,n;ArrayBuffer.isView(t)?n={value:t}:t instanceof gt?n={buffer:t}:n=t;let s=d(d({},this.settings),n);if(ArrayBuffer.isView(n.value)){if(!n.type)if(this.doublePrecision&&n.value instanceof Float64Array)s.type="float32";else{let o=ap(n.value);s.type=s.normalized?o.replace("int","norm"):o}s.bytesPerElement=n.value.BYTES_PER_ELEMENT,s.stride=Ve(s)}if(e.bounds=null,n.constant){let i=n.value;if(i=this._normalizeValue(i,[],0),this.settings.normalized&&(i=this.normalizeConstant(i)),!(!e.constant||!this._areValuesEqual(i,this.value)))return!1;e.externalBuffer=null,e.constant=!0,this.value=ArrayBuffer.isView(i)?i:new Float32Array(i)}else if(n.buffer){let i=n.buffer;e.externalBuffer=i,e.constant=!1,this.value=n.value||null}else if(n.value){this._checkExternalBuffer(n);let i=n.value;e.externalBuffer=null,e.constant=!1,this.value=i;let{buffer:o}=this,a=Ve(s),c=(s.vertexOffset||0)*a;if(this.doublePrecision&&i instanceof Float64Array&&(i=Di(i,s)),this.settings.isIndexed){let u=this.settings.defaultType;i.constructor!==u&&(i=new u(i))}let l=i.byteLength+c+a*2;(!o||o.byteLength<l)&&(o=this._createBuffer(l)),o.write(i,c)}return this.setAccessor(s),!0}updateSubBuffer(t={}){this.state.bounds=null;let e=this.value,{startOffset:n=0,endOffset:s}=t;this.buffer.write(this.doublePrecision&&e instanceof Float64Array?Di(e,{size:this.size,startIndex:n,endIndex:s}):e.subarray(n,s),n*e.BYTES_PER_ELEMENT+this.byteOffset)}allocate(t,e=!1){let{state:n}=this,s=n.allocatedValue,i=Xt.allocate(s,t+1,{size:this.size,type:this.settings.defaultType,copy:e});this.value=i;let{byteOffset:o}=this,{buffer:a}=this;return(!a||a.byteLength<i.byteLength+o)&&(a=this._createBuffer(i.byteLength+o),e&&s&&a.write(s instanceof Float64Array?Di(s,this):s,o)),n.allocatedValue=i,n.constant=!1,n.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(t){let{value:e}=t;if(!ArrayBuffer.isView(e))throw new Error(`Attribute ${this.id} value is not TypedArray`);let n=this.settings.defaultType,s=!1;if(this.doublePrecision&&(s=e.BYTES_PER_ELEMENT<4),s)throw new Error(`Attribute ${this.id} does not support ${e.constructor.name}`);!(e instanceof n)&&this.settings.normalized&&!("normalized"in t)&&$.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(t){switch(this.settings.type){case"snorm8":return new Float32Array(t).map(e=>(e+128)/255*2-1);case"snorm16":return new Float32Array(t).map(e=>(e+32768)/65535*2-1);case"unorm8":return new Float32Array(t).map(e=>e/255);case"unorm16":return new Float32Array(t).map(e=>e/65535);default:return t}}_normalizeValue(t,e,n){let{defaultValue:s,size:i}=this.settings;if(Number.isFinite(t))return e[n]=t,e;if(!t){let o=i;for(;--o>=0;)e[n+o]=s[o];return e}switch(i){case 4:e[n+3]=Number.isFinite(t[3])?t[3]:s[3];case 3:e[n+2]=Number.isFinite(t[2])?t[2]:s[2];case 2:e[n+1]=Number.isFinite(t[1])?t[1]:s[1];case 1:e[n+0]=Number.isFinite(t[0])?t[0]:s[0];break;default:let o=i;for(;--o>=0;)e[n+o]=Number.isFinite(t[o])?t[o]:s[o]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;let{size:n}=this;for(let s=0;s<n;s++)if(t[s]!==e[s])return!1;return!0}_createBuffer(t){this._buffer&&this._buffer.destroy();let{isIndexed:e,type:n}=this.settings;return this._buffer=this.device.createBuffer(M(d({},this._buffer?.props),{id:this.id,usage:(e?gt.INDEX:gt.VERTEX)|gt.COPY_DST,indexType:e?n:void 0,byteLength:t})),this._buffer}};var lp=[],up=[];function Jr(r,t=0,e=1/0){let n=lp,s={index:-1,data:r,target:[]};return r?typeof r[Symbol.iterator]=="function"?n=r:r.length>0&&(up.length=r.length,n=up):n=lp,(t>0||Number.isFinite(e))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(t,e),s.index=t-1),{iterable:n,objectInfo:s}}function uo(r){return r&&r[Symbol.asyncIterator]}function ho(r,t){let{size:e,stride:n,offset:s,startIndices:i,nested:o}=t,a=r.BYTES_PER_ELEMENT,c=n?n/a:e,l=s?s/a:0,u=Math.floor((r.length-l)/c);return(h,{index:f,target:p})=>{if(!i){let T=f*c+l;for(let I=0;I<e;I++)p[I]=r[T+I];return p}let _=i[f],x=i[f+1]||u,y;if(o){y=new Array(x-_);for(let T=_;T<x;T++){let I=T*c+l;p=new Array(e);for(let k=0;k<e;k++)p[k]=r[I+k];y[T-_]=p}}else if(c===e)y=r.subarray(_*e+l,x*e+l);else{y=new r.constructor((x-_)*e);let T=0;for(let I=_;I<x;I++){let k=I*c+l;for(let S=0;S<e;S++)y[T++]=r[k+S]}}return y}}var hp=[],Qr=[[0,1/0]];function fp(r,t){if(r===Qr||(t[0]<0&&(t[0]=0),t[0]>=t[1]))return r;let e=[],n=r.length,s=0;for(let i=0;i<n;i++){let o=r[i];o[1]<t[0]?(e.push(o),s=i+1):o[0]>t[1]?e.push(o):t=[Math.min(o[0],t[0]),Math.max(o[1],t[1])]}return e.splice(s,0,t),e}var x1={interpolation:{duration:0,easing:r=>r},spring:{stiffness:.05,damping:.5}};function fo(r,t){if(!r)return null;Number.isFinite(r)&&(r={type:"interpolation",duration:r});let e=r.type||"interpolation";return M(d(d(d({},x1[e]),t),r),{type:e})}var dn=class extends lo{constructor(t,e){super(t,e,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Qr}),this.constant=!1,this.settings.update=e.update||(e.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:t=!1}={}){let e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}layoutChanged(){return this.state.layoutChanged}setAccessor(t){var e;(e=this.state).layoutChanged||(e.layoutChanged=!cp(t,this.getAccessor())),super.setAccessor(t)}getUpdateTriggers(){let{accessor:t}=this.settings;return[this.id].concat(typeof t!="function"&&t||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;let{accessor:e}=this.settings,n=this.settings.transition,s=Array.isArray(e)?t[e.find(i=>t[i])]:t[e];return fo(s,n)}setNeedsUpdate(t=this.id,e){if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){let{startRow:n=0,endRow:s=1/0}=e;this.state.updateRanges=fp(this.state.updateRanges,[n,s])}else this.state.updateRanges=Qr}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=hp}setNeedsRedraw(t=this.id){this.state.needsRedraw=this.state.needsRedraw||t}allocate(t){let{state:e,settings:n}=this;return n.noAlloc?!1:n.update?(super.allocate(t,e.updateRanges!==Qr),!0):!1}updateBuffer({numInstances:t,data:e,props:n,context:s}){if(!this.needsUpdate())return!1;let{state:{updateRanges:i},settings:{update:o,noAlloc:a}}=this,c=!0;if(o){for(let[l,u]of i)o.call(s,this,{data:e,startRow:l,endRow:u,props:n,numInstances:t});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[l,u]of i){let h=Number.isFinite(l)?this.getVertexOffset(l):0,f=Number.isFinite(u)?this.getVertexOffset(u):a||!Number.isFinite(t)?this.value.length:t*this.size;super.updateSubBuffer({startOffset:h,endOffset:f})}this._checkAttributeArray()}else c=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),c}setConstantValue(t,e){let n=this.device.type==="webgpu";if(n||e===void 0||typeof e=="function"){if(n&&typeof e!="function"){let o=this._normalizeValue(e,[],0);this._areValuesEqual(o,this.value)||this.setNeedsUpdate("WebGPU constant updated")}return!1}let s=this.settings.transform&&t?this.settings.transform.call(t,e):e;return this.setData({constant:!0,value:s})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(t){let{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t)),!0):(e.lastExternalBuffer=null,!1)}setBinaryValue(t,e=null){let{state:n,settings:s}=this;if(!t)return n.binaryValue=null,n.binaryAccessor=null,!1;if(s.noAlloc)return!1;if(n.binaryValue===t)return this.clearNeedsUpdate(),!0;if(n.binaryValue=t,this.setNeedsRedraw(),s.transform||e!==this.startIndices){ArrayBuffer.isView(t)&&(t={value:t});let o=t;et(ArrayBuffer.isView(o.value),`invalid ${s.accessor}`);let a=!!o.size&&o.size!==this.size;return n.binaryAccessor=ho(o.value,{size:o.size||this.size,stride:o.stride,offset:o.offset,startIndices:e,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){let{startIndices:e}=this;return(e?t<e.length?e[t]:this.numInstances:t)*this.size}getValue(){let t=this.settings.shaderAttributes,e=super.getValue();if(!t)return e;for(let n in t)Object.assign(e,super.getValue(n,t[n]));return e}getBufferLayout(t){this.state.layoutChanged=!1;let e=this.settings.shaderAttributes,n=super._getBufferLayout(),{stepMode:s}=this.settings;if(s==="dynamic"?n.stepMode=t?t.isInstanced?"instance":"vertex":"instance":n.stepMode=s??"vertex",!e)return n;for(let i in e){let o=super._getBufferLayout(i,e[i]);n.attributes.push(...o.attributes)}return n}_autoUpdater(t,{data:e,startRow:n,endRow:s,props:i,numInstances:o}){if(t.constant&&this.context.device.type!=="webgpu")return;let{settings:a,state:c,value:l,size:u,startIndices:h}=t,{accessor:f,transform:p}=a,_=c.binaryAccessor||(typeof f=="function"?f:i[f]);typeof _!="function"&&typeof f=="string"&&(_=()=>i[f]),et(typeof _=="function",`accessor "${f}" is not a function`);let x=t.getVertexOffset(n),{iterable:y,objectInfo:T}=Jr(e,n,s);for(let I of y){T.index++;let k=_(I,T);if(p&&(k=p.call(this,k)),h){let S=(T.index<h.length-1?h[T.index+1]:o)-h[T.index];if(k&&Array.isArray(k[0])){let P=x;for(let L of k)t._normalizeValue(L,l,P),P+=u}else k&&k.length>u?l.set(k,x):(t._normalizeValue(k,T.target,0),Jc({target:l,source:T.target,start:x,count:S}));x+=S*u}else t._normalizeValue(k,l,x),x+=u}}_validateAttributeUpdaters(){let{settings:t}=this;if(!(t.noAlloc||typeof t.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){let{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let n=!0;switch(e){case 4:n=n&&Number.isFinite(t[3]);case 3:n=n&&Number.isFinite(t[2]);case 2:n=n&&Number.isFinite(t[1]);case 1:n=n&&Number.isFinite(t[0]);break;default:n=!1}if(!n)throw new Error(`Illegal attribute generated for ${this.id}`)}}};function ol(r){let{source:t,target:e,start:n=0,size:s,getData:i}=r,o=r.end||e.length,a=t.length,c=o-n;if(a>c){e.set(t.subarray(0,c),n);return}if(e.set(t,n),!i)return;let l=a;for(;l<c;){let u=i(l,t);for(let h=0;h<s;h++)e[n+l]=u[h]||0,l++}}function pp({source:r,target:t,size:e,getData:n,sourceStartIndices:s,targetStartIndices:i}){if(!s||!i)return ol({source:r,target:t,size:e,getData:n}),t;let o=0,a=0,c=n&&((u,h)=>n(u+a,h)),l=Math.min(s.length,i.length);for(let u=1;u<l;u++){let h=s[u]*e,f=i[u]*e;ol({source:r.subarray(o,h),target:t,start:a,end:f,size:e,getData:c}),o=h,a=f}return a<t.length&&ol({source:[],target:t,start:a,size:e,getData:c}),t}function dp(r){let{device:t,settings:e,value:n}=r,s=new dn(t,e);return s.setData({value:n instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:e.normalized}),s}function po(r){switch(r){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${r}"`)}}function mo(r){switch(r){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function go(r){r.push(r.shift())}function mp(r,t){let{doublePrecision:e,settings:n,value:s,size:i}=r,o=e&&s instanceof Float64Array?2:1,a=0,{shaderAttributes:c}=r.settings;if(c)for(let l of Object.values(c))a=Math.max(a,l.vertexOffset??0);return(n.noAlloc?s.length:(t+a)*i)*o}function _o({device:r,source:t,target:e}){return(!e||e.byteLength<t.byteLength)&&(e?.destroy(),e=r.createBuffer({byteLength:t.byteLength,usage:t.usage})),e}function yo({device:r,buffer:t,attribute:e,fromLength:n,toLength:s,fromStartIndices:i,getData:o=a=>a}){let a=e.doublePrecision&&e.value instanceof Float64Array?2:1,c=e.size*a,l=e.byteOffset,u=e.settings.bytesPerElement<4?l/e.settings.bytesPerElement*4:l,h=e.startIndices,f=i&&h,p=e.isConstant;if(!f&&t&&n>=s)return t;let _=e.value instanceof Float64Array?Float32Array:e.value.constructor,x=p?e.value:new _(e.getBuffer().readSyncWebGL(l,s*_.BYTES_PER_ELEMENT).buffer);if(e.settings.normalized&&!p){let k=o;o=(S,P)=>e.normalizeConstant(k(S,P))}let y=p?(k,S)=>o(x,S):(k,S)=>o(x.subarray(k+l,k+l+c),S),T=t?new Float32Array(t.readSyncWebGL(u,n*4).buffer):new Float32Array(0),I=new Float32Array(s);return pp({source:T,target:I,sourceStartIndices:i,targetStartIndices:h,size:c,getData:y}),(!t||t.byteLength<I.byteLength+u)&&(t?.destroy(),t=r.createBuffer({byteLength:I.byteLength+u,usage:35050})),t.write(I,u),t}var Kn=class{constructor({device:t,attribute:e,timeline:n}){this.buffers=[],this.currentLength=0,this.device=t,this.transition=new ae(n),this.attribute=e,this.attributeInTransition=dp(e),this.currentStartIndices=e.startIndices}get inProgress(){return this.transition.inProgress}start(t,e,n=1/0){this.settings=t,this.currentStartIndices=this.attribute.startIndices,this.currentLength=mp(this.attribute,e),this.transition.start(M(d({},t),{duration:n}))}update(){let t=this.transition.update();return t&&this.onUpdate(),t}setBuffer(t){this.attributeInTransition.setData({buffer:t,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(let t of this.buffers)t.destroy();this.buffers.length=0}};var xo=class extends Kn{constructor({device:t,attribute:e,timeline:n}){super({device:t,attribute:e,timeline:n}),this.type="interpolation",this.transform=T1(t,e)}start(t,e){let n=this.currentLength,s=this.currentStartIndices;if(super.start(t,e,t.duration),t.duration<=0){this.transition.cancel();return}let{buffers:i,attribute:o}=this;go(i),i[0]=yo({device:this.device,buffer:i[0],attribute:o,fromLength:n,toLength:this.currentLength,fromStartIndices:s,getData:t.enter}),i[1]=_o({device:this.device,source:i[0],target:i[1]}),this.setBuffer(i[1]);let{transform:a}=this,c=a.model,l=Math.floor(this.currentLength/o.size);_p(o)&&(l/=2),c.setVertexCount(l),o.isConstant?(c.setAttributes({aFrom:i[0]}),c.setConstantAttributes({aTo:o.value})):c.setAttributes({aFrom:i[0],aTo:o.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:i[1]})}onUpdate(){let{duration:t,easing:e}=this.settings,{time:n}=this.transition,s=n/t;e&&(s=e(s));let{model:i}=this.transform,o={time:s};i.shaderInputs.setProps({interpolation:o}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}};var b1=`uniform interpolationUniforms {
  float time;
} interpolation;
`,gp={name:"interpolation",vs:b1,uniformTypes:{time:"f32"}},w1=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,v1=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function _p(r){return r.doublePrecision&&r.value instanceof Float64Array}function T1(r,t){let e=t.size,n=po(e),s=mo(e),i=t.getBufferLayout();return _p(t)?new Re(r,{vs:v1,bufferLayout:[{name:"aFrom",byteStride:8*e,attributes:[{attribute:"aFrom",format:s,byteOffset:0},{attribute:"aFrom64Low",format:s,byteOffset:4*e}]},{name:"aTo",byteStride:8*e,attributes:[{attribute:"aTo",format:s,byteOffset:0},{attribute:"aTo64Low",format:s,byteOffset:4*e}]}],modules:[xc,gp],defines:{ATTRIBUTE_TYPE:n,ATTRIBUTE_SIZE:e},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new Re(r,{vs:w1,bufferLayout:[{name:"aFrom",format:s},{name:"aTo",format:i.attributes[0].format}],modules:[gp],defines:{ATTRIBUTE_TYPE:n},varyings:["vCurrent"],disableWarnings:!0})}var bo=class extends Kn{constructor({device:t,attribute:e,timeline:n}){super({device:t,attribute:e,timeline:n}),this.type="spring",this.texture=P1(t),this.framebuffer=M1(t,this.texture),this.transform=I1(t,e)}start(t,e){let n=this.currentLength,s=this.currentStartIndices;super.start(t,e);let{buffers:i,attribute:o}=this;for(let c=0;c<2;c++)i[c]=yo({device:this.device,buffer:i[c],attribute:o,fromLength:n,toLength:this.currentLength,fromStartIndices:s,getData:t.enter});i[2]=_o({device:this.device,source:i[0],target:i[2]}),this.setBuffer(i[1]);let{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/o.size)),o.isConstant?a.setConstantAttributes({aTo:o.value}):a.setAttributes({aTo:o.getBuffer()})}onUpdate(){let{buffers:t,transform:e,framebuffer:n,transition:s}=this,i=this.settings;e.model.setAttributes({aPrev:t[0],aCur:t[1]}),e.transformFeedback.setBuffers({vNext:t[2]});let o={stiffness:i.stiffness,damping:i.damping};e.model.shaderInputs.setProps({spring:o}),e.run({framebuffer:n,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),go(t),this.setBuffer(t[1]),this.device.readPixelsToArrayWebGL(n)[0]>0||s.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}};var k1=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,E1={name:"spring",vs:k1,uniformTypes:{damping:"f32",stiffness:"f32"}},S1=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,A1=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function I1(r,t){let e=po(t.size),n=mo(t.size);return new Re(r,{vs:S1,fs:A1,bufferLayout:[{name:"aPrev",format:n},{name:"aCur",format:n},{name:"aTo",format:t.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[E1],defines:{ATTRIBUTE_TYPE:e},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function P1(r){return r.createTexture({data:new Uint8Array(4),format:"rgba8unorm",width:1,height:1})}function M1(r,t){return r.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[t]})}var L1={interpolation:xo,spring:bo},wo=class{constructor(t,{id:e,timeline:n}){if(!t)throw new Error("AttributeTransitionManager is constructed without device");this.id=e,this.device=t,this.timeline=n,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(let t in this.transitions)this._removeTransition(t)}update({attributes:t,transitions:e,numInstances:n}){this.numInstances=n||1;for(let s in t){let i=t[s],o=i.getTransitionSetting(e);o&&this._updateAttribute(s,i,o)}for(let s in this.transitions){let i=t[s];(!i||!i.getTransitionSetting(e))&&this._removeTransition(s)}}hasAttribute(t){let e=this.transitions[t];return e&&e.inProgress}getAttributes(){let t={};for(let e in this.transitions){let n=this.transitions[e];n.inProgress&&(t[e]=n.attributeInTransition)}return t}run(){if(this.numInstances===0)return!1;for(let e in this.transitions)this.transitions[e].update()&&(this.needsRedraw=!0);let t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].delete(),delete this.transitions[t]}_updateAttribute(t,e,n){let s=this.transitions[t],i=!s||s.type!==n.type;if(i){s&&this._removeTransition(t);let o=L1[n.type];o?this.transitions[t]=new o({attribute:e,timeline:this.timeline,device:this.device}):($.error(`unsupported transition type '${n.type}'`)(),i=!1)}(i||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(n,this.numInstances))}};var yp="attributeManager.invalidate",C1="attributeManager.updateStart",O1="attributeManager.updateEnd",R1="attribute.updateStart",N1="attribute.allocate",D1="attribute.updateEnd",ts=class{constructor(t,{id:e="attribute-manager",stats:n,timeline:s}={}){this.mergeBoundsMemoized=Gt(Df),this.id=e,this.device=t,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=n,this.attributeTransitionManager=new wo(t,{id:`${e}-transitions`,timeline:s}),Object.seal(this)}finalize(){for(let t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(t={clearRedrawFlags:!1}){let e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(t){this._add(t)}addInstanced(t){this._add(t,{stepMode:"instance"})}remove(t){for(let e of t)this.attributes[e]!==void 0&&(this.attributes[e].delete(),delete this.attributes[e])}invalidate(t,e){let n=this._invalidateTrigger(t,e);st(yp,this,t,n)}invalidateAll(t){for(let e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);st(yp,this,"all")}update({data:t,numInstances:e,startIndices:n=null,transitions:s,props:i={},buffers:o={},context:a={}}){let c=!1;st(C1,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let l in this.attributes){let u=this.attributes[l],h=u.settings.accessor;u.startIndices=n,u.numInstances=e,i[l]&&$.removed(`props.${l}`,`data.attributes.${l}`)(),u.setExternalBuffer(o[l])||u.setBinaryValue(typeof h=="string"?o[h]:void 0,t.startIndices)||typeof h=="string"&&!o[h]&&u.setConstantValue(a,i[h])||u.needsUpdate()&&(c=!0,this._updateAttribute({attribute:u,numInstances:e,data:t,props:i,context:a})),this.needsRedraw=this.needsRedraw||u.needsRedraw()}c&&st(O1,this,e),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:e,transitions:s})}updateTransition(){let{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return d(d({},this.attributes),this.attributeTransitionManager.getAttributes())}getBounds(t){let e=t.map(n=>this.attributes[n]?.getBounds());return this.mergeBoundsMemoized(e)}getChangedAttributes(t={clearChangedFlags:!1}){let{attributes:e,attributeTransitionManager:n}=this,s=d({},n.getAttributes());for(let i in e){let o=e[i];o.needsRedraw(t)&&!n.hasAttribute(i)&&(s[i]=o)}return s}getBufferLayouts(t){return Object.values(this.getAttributes()).map(e=>e.getBufferLayout(t))}_add(t,e){for(let n in t){let s=t[n],i=d(M(d({},s),{id:n,size:s.isIndexed&&1||s.size||1}),e);this.attributes[n]=new dn(this.device,i)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){let t={};for(let e in this.attributes)this.attributes[e].getUpdateTriggers().forEach(s=>{t[s]||(t[s]=[]),t[s].push(e)});this.updateTriggers=t}_invalidateTrigger(t,e){let{attributes:n,updateTriggers:s}=this,i=s[t];return i&&i.forEach(o=>{let a=n[o];a&&a.setNeedsUpdate(a.id,e)}),i}_updateAttribute(t){let{attribute:e,numInstances:n}=t;if(st(R1,e),e.constant){e.setConstantValue(t.context,e.value);return}e.allocate(n)&&st(N1,e,n),e.updateBuffer(t)&&(this.needsRedraw=!0,st(D1,e,n))}};var vo=class extends ae{get value(){return this._value}_onUpdate(){let{time:t,settings:{fromValue:e,toValue:n,duration:s,easing:i}}=this,o=i(t/s);this._value=de(e,n,o)}};var xp=1e-5;function bp(r,t,e,n,s){let i=t-r,a=(e-t)*s,c=-i*n;return a+c+i+t}function F1(r,t,e,n,s){if(Array.isArray(e)){let i=[];for(let o=0;o<e.length;o++)i[o]=bp(r[o],t[o],e[o],n,s);return i}return bp(r,t,e,n,s)}function wp(r,t){if(Array.isArray(r)){let e=0;for(let n=0;n<r.length;n++){let s=r[n]-t[n];e+=s*s}return Math.sqrt(e)}return Math.abs(r-t)}var To=class extends ae{get value(){return this._currValue}_onUpdate(){let{fromValue:t,toValue:e,damping:n,stiffness:s}=this.settings,{_prevValue:i=t,_currValue:o=t}=this,a=F1(i,o,e,n,s),c=wp(a,e),l=wp(a,o);c<xp&&l<xp&&(a=e,this.end()),this._prevValue=o,this._currValue=a}};var V1={interpolation:vo,spring:To},ko=class{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,n,s){let{transitions:i}=this;if(i.has(t)){let c=i.get(t),{value:l=c.settings.fromValue}=c;e=l,this.remove(t)}if(s=fo(s),!s)return;let o=V1[s.type];if(!o){$.error(`unsupported transition type '${s.type}'`)();return}let a=new o(this.timeline);a.start(M(d({},s),{fromValue:e,toValue:n})),i.set(t,a)}remove(t){let{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){let t={};for(let[e,n]of this.transitions)n.update(),t[e]=n.value,n.inProgress||this.remove(e);return t}clear(){for(let t of this.transitions.keys())this.remove(t)}};function Tp(r){let t=r[jt];for(let e in t){let n=t[e],{validate:s}=n;if(s&&!s(r[e],n))throw new Error(`Invalid prop ${e}: ${r[e]}`)}}function kp(r,t){let e=cl({newProps:r,oldProps:t,propTypes:r[jt],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=B1(r,t),s=!1;return n||(s=z1(r,t)),{dataChanged:n,propsChanged:e,updateTriggersChanged:s,extensionsChanged:j1(r,t),transitionsChanged:U1(r,t)}}function U1(r,t){if(!r.transitions)return!1;let e={},n=r[jt],s=!1;for(let i in r.transitions){let o=n[i],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&al(r[i],t[i],o)&&(e[i]=!0,s=!0)}return s?e:!1}function cl({newProps:r,oldProps:t,ignoreProps:e={},propTypes:n={},triggerName:s="props"}){if(t===r)return!1;if(typeof r!="object"||r===null)return`${s} changed shallowly`;if(typeof t!="object"||t===null)return`${s} changed shallowly`;for(let i of Object.keys(r))if(!(i in e)){if(!(i in t))return`${s}.${i} added`;let o=al(r[i],t[i],n[i]);if(o)return`${s}.${i} ${o}`}for(let i of Object.keys(t))if(!(i in e)){if(!(i in r))return`${s}.${i} dropped`;if(!Object.hasOwnProperty.call(r,i)){let o=al(r[i],t[i],n[i]);if(o)return`${s}.${i} ${o}`}}return!1}function al(r,t,e){let n=e&&e.equal;return n&&!n(r,t,e)||!n&&(n=r&&t&&r.equals,n&&!n.call(r,t))?"changed deeply":!n&&t!==r?"changed shallowly":null}function B1(r,t){if(t===null)return"oldProps is null, initial diff";let e=!1,{dataComparator:n,_dataDiff:s}=r;return n?n(r.data,t.data)||(e="Data comparator detected a change"):r.data!==t.data&&(e="A new data container was supplied"),e&&s&&(e=s(r.data,t.data)||e),e}function z1(r,t){if(t===null)return{all:!0};if("all"in r.updateTriggers&&vp(r,t,"all"))return{all:!0};let e={},n=!1;for(let s in r.updateTriggers)s!=="all"&&vp(r,t,s)&&(e[s]=!0,n=!0);return n?e:!1}function j1(r,t){if(t===null)return!0;let e=t.extensions,{extensions:n}=r;if(n===e)return!1;if(!e||!n||n.length!==e.length)return!0;for(let s=0;s<n.length;s++)if(!n[s].equals(e[s]))return!0;return!1}function vp(r,t,e){let n=r.updateTriggers[e];n=n??{};let s=t.updateTriggers[e];return s=s??{},cl({oldProps:s,newProps:n,triggerName:e})}var $1="count(): argument not an object",W1="count(): argument not a container";function ll(r){if(!H1(r))throw new Error($1);if(typeof r.count=="function")return r.count();if(Number.isFinite(r.size))return r.size;if(Number.isFinite(r.length))return r.length;if(G1(r))return Object.keys(r).length;throw new Error(W1)}function G1(r){return r!==null&&typeof r=="object"&&r.constructor===Object}function H1(r){return r!==null&&typeof r=="object"}function Eo(r,t){if(!t)return r;let e=d(d({},r),t);if("defines"in t&&(e.defines=d(d({},r.defines),t.defines)),"modules"in t&&(e.modules=(r.modules||[]).concat(t.modules),t.modules.some(n=>n.name==="project64"))){let n=e.modules.findIndex(s=>s.name==="project32");n>=0&&e.modules.splice(n,1)}if("inject"in t)if(!r.inject)e.inject=t.inject;else{let n=d({},r.inject);for(let s in t.inject)n[s]=(n[s]||"")+t.inject[s];e.inject=n}return e}var q1={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},ul={};function Ep(r,t,e,n){if(e instanceof Ue)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let s=null;e.compressed&&(s={minFilter:"linear",mipmapFilter:e.data.length>1?"nearest":"linear"});let{width:i,height:o}=e.data,a=t.createTexture(M(d({},e),{sampler:d(d(d({},q1),s),n),mipLevels:t.getMipLevelCount(i,o)}));return a.generateMipmapsWebGL(),ul[a.id]=r,a}function Sp(r,t){!t||!(t instanceof Ue)||ul[t.id]===r&&(t.delete(),delete ul[t.id])}var Y1={boolean:{validate(r,t){return!0},equal(r,t,e){return!!r==!!t}},number:{validate(r,t){return Number.isFinite(r)&&(!("max"in t)||r<=t.max)&&(!("min"in t)||r>=t.min)}},color:{validate(r,t){return t.optional&&!r||hl(r)&&(r.length===3||r.length===4)},equal(r,t,e){return at(r,t,1)}},accessor:{validate(r,t){let e=So(r);return e==="function"||e===So(t.value)},equal(r,t,e){return typeof t=="function"?!0:at(r,t,1)}},array:{validate(r,t){return t.optional&&!r||hl(r)},equal(r,t,e){let{compare:n}=e,s=Number.isInteger(n)?n:n?1:0;return n?at(r,t,s):r===t}},object:{equal(r,t,e){if(e.ignore)return!0;let{compare:n}=e,s=Number.isInteger(n)?n:n?1:0;return n?at(r,t,s):r===t}},function:{validate(r,t){return t.optional&&!r||typeof r=="function"},equal(r,t,e){return!e.compare&&e.ignore!==!1||r===t}},data:{transform:(r,t,e)=>{if(!r)return r;let{dataTransform:n}=e.props;return n?n(r):typeof r.shape=="string"&&r.shape.endsWith("-table")&&Array.isArray(r.data)?r.data:r}},image:{transform:(r,t,e)=>{let n=e.context;return!n||!n.device?null:Ep(e.id,n.device,r,d(d({},t.parameters),e.props.textureParameters))},release:(r,t,e)=>{Sp(e.id,r)}}};function Ap(r){let t={},e={},n={};for(let[s,i]of Object.entries(r)){let o=i?.deprecatedFor;if(o)n[s]=Array.isArray(o)?o:[o];else{let a=X1(s,i);t[s]=a,e[s]=a.value}}return{propTypes:t,defaultProps:e,deprecatedProps:n}}function X1(r,t){switch(So(t)){case"object":return es(r,t);case"array":return es(r,{type:"array",value:t,compare:!1});case"boolean":return es(r,{type:"boolean",value:t});case"number":return es(r,{type:"number",value:t});case"function":return es(r,{type:"function",value:t,compare:!0});default:return{name:r,type:"unknown",value:t}}}function es(r,t){return"type"in t?d(d({name:r},Y1[t.type]),t):"value"in t?d({name:r,type:So(t.value)},t):{name:r,type:"object",value:t}}function hl(r){return Array.isArray(r)||ArrayBuffer.isView(r)}function So(r){return hl(r)?"array":r===null?"null":typeof r}function Ip(r,t){let e;for(let i=t.length-1;i>=0;i--){let o=t[i];"extensions"in o&&(e=o.extensions)}let n=fl(r.constructor,e),s=Object.create(n);s[Yn]=r,s[oe]={},s[Zt]={};for(let i=0;i<t.length;++i){let o=t[i];for(let a in o)s[a]=o[a]}return Object.freeze(s),s}var Z1="_mergedDefaultProps";function fl(r,t){if(!(r instanceof ns.constructor))return{};let e=Z1;if(t)for(let s of t){let i=s.constructor;i&&(e+=`:${i.extensionName||i.name}`)}let n=Pp(r,e);return n||(r[e]=K1(r,t||[]))}function K1(r,t){if(!r.prototype)return null;let n=Object.getPrototypeOf(r),s=fl(n),i=Pp(r,"defaultProps")||{},o=Ap(i),a=Object.assign(Object.create(null),s,o.defaultProps),c=Object.assign(Object.create(null),s?.[jt],o.propTypes),l=Object.assign(Object.create(null),s?.[Hi],o.deprecatedProps);for(let u of t){let h=fl(u.constructor);h&&(Object.assign(a,h),Object.assign(c,h[jt]),Object.assign(l,h[Hi]))}return J1(a,r),tb(a,c),Q1(a,l),a[jt]=c,a[Hi]=l,t.length===0&&!pl(r,"_propTypes")&&(r._propTypes=c),a}function J1(r,t){let e=nb(t);Object.defineProperties(r,{id:{writable:!0,value:e}})}function Q1(r,t){for(let e in t)Object.defineProperty(r,e,{enumerable:!1,set(n){let s=`${this.id}: ${e}`;for(let i of t[e])pl(this,i)||(this[i]=n);$.deprecated(s,t[e].join("/"))()}})}function tb(r,t){let e={},n={};for(let s in t){let i=t[s],{name:o,value:a}=i;i.async&&(e[o]=a,n[o]=eb(o))}r[we]=e,r[oe]={},Object.defineProperties(r,n)}function eb(r){return{enumerable:!0,set(t){typeof t=="string"||t instanceof Promise||uo(t)?this[oe][r]=t:this[Zt][r]=t},get(){if(this[Zt]){if(r in this[Zt])return this[Zt][r]||this[we][r];if(r in this[oe]){let t=this[Yn]&&this[Yn].internalState;if(t&&t.hasAsyncProp(r))return t.getAsyncProp(r)||this[we][r]}}return this[we][r]}}}function pl(r,t){return Object.prototype.hasOwnProperty.call(r,t)}function Pp(r,t){return pl(r,t)&&r[t]}function nb(r){let t=r.componentName;return t||$.warn(`${r.name}.componentName not specified`)(),t||r.name}var rb=0,sb=(()=>{class r{constructor(...e){this.props=Ip(this,e),this.id=this.props.id,this.count=rb++}clone(e){let{props:n}=this,s={};for(let i in n[we])i in n[Zt]?s[i]=n[Zt][i]:i in n[oe]&&(s[i]=n[oe][i]);return new this.constructor(d(d(d({},n),s),e))}}return r.componentName="Component",r.defaultProps={},r})(),ns=sb;var ib=Object.freeze({}),rs=class{constructor(t){this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let t in this.asyncProps){let e=this.asyncProps[t];e&&e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||ib}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){let e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){let e=this.asyncProps[t];return!!(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(let e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){this.component=t[Yn]||this.component;let e=t[Zt]||{},n=t[oe]||t,s=t[we]||{};for(let i in e){let o=e[i];this._createAsyncPropData(i,s[i]),this._updateAsyncProp(i,o),e[i]=this.getAsyncProp(i)}for(let i in n){let o=n[i];this._createAsyncPropData(i,s[i]),this._updateAsyncProp(i,o)}}_fetch(t,e){return null}_onResolve(t,e){}_onError(t,e){}_updateAsyncProp(t,e){if(this._didAsyncInputValueChange(t,e)){if(typeof e=="string"&&(e=this._fetch(t,e)),e instanceof Promise){this._watchPromise(t,e);return}if(uo(e)){this._resolveAsyncIterable(t,e);return}this._setPropValue(t,e)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let t in this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}}_didAsyncInputValueChange(t,e){let n=this.asyncProps[t];return e===n.resolvedValue||e===n.lastValue?!1:(n.lastValue=e,!0)}_setPropValue(t,e){this._freezeAsyncOldProps();let n=this.asyncProps[t];n&&(e=this._postProcessValue(n,e),n.resolvedValue=e,n.pendingLoadCount++,n.resolvedLoadCount=n.pendingLoadCount)}_setAsyncPropValue(t,e,n){let s=this.asyncProps[t];s&&n>=s.resolvedLoadCount&&e!==void 0&&(this._freezeAsyncOldProps(),s.resolvedValue=e,s.resolvedLoadCount=n,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){let n=this.asyncProps[t];if(n){n.pendingLoadCount++;let s=n.pendingLoadCount;e.then(i=>{this.component&&(i=this._postProcessValue(n,i),this._setAsyncPropValue(t,i,s),this._onResolve(t,i))}).catch(i=>{this._onError(t,i)})}}_resolveAsyncIterable(t,e){return B(this,null,function*(){if(t!=="data"){this._setPropValue(t,e);return}let n=this.asyncProps[t];if(!n)return;n.pendingLoadCount++;let s=n.pendingLoadCount,i=[],o=0;try{for(var a=_n(e),c,l,u;c=!(l=yield a.next()).done;c=!1){let h=l.value;if(!this.component)return;let{dataTransform:f}=this.component.props;f?i=f(h,i):i=i.concat(h),Object.defineProperty(i,"__diff",{enumerable:!1,value:[{startRow:o,endRow:i.length}]}),o=i.length,this._setAsyncPropValue(t,i,s)}}catch{u=[l]}finally{try{c&&(l=a.return)&&(yield l.call(a))}finally{if(u)throw u[0]}}this._onResolve(t,i)})}_postProcessValue(t,e){let n=t.type;return n&&this.component&&(n.release&&n.release(t.resolvedValue,n,this.component),n.transform)?n.transform(e,n,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){let s=this.component&&this.component.props[jt];this.asyncProps[t]={type:s&&s[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}};var Ao=class extends rs{constructor({attributeManager:t,layer:e}){super(e),this.attributeManager=t,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(t,e){let n=this.layer,s=n?.props.fetch;return s?s(e,{propName:t,layer:n}):super._fetch(t,e)}_onResolve(t,e){let n=this.layer;if(n){let s=n.props.onDataLoad;t==="data"&&s&&s(e,{propName:t,layer:n})}}_onError(t,e){let n=this.layer;n&&n.raiseError(e,`loading ${t} of ${this.layer}`)}};var ob="layer.changeFlag",ab="layer.initialize",cb="layer.update",lb="layer.finalize",ub="layer.matched",Mp=2**24-1,hb=Object.freeze([]),fb=Gt(({oldViewport:r,viewport:t})=>r.equals(t)),Kt=new Uint8ClampedArray(0),pb={data:{type:"data",value:hb,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:r=>r&&r.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(r,{propName:t,layer:e,loaders:n,loadOptions:s,signal:i})=>{let{resourceManager:o}=e.context;s=s||e.getLoadOptions(),n=n||e.props.loaders,i&&(s=M(d({},s),{fetch:M(d({},s?.fetch),{signal:i})}));let a=o.contains(r);return!a&&!s&&(o.add({resourceId:r,data:Tn(r,n),persistent:!1}),a=!0),a?o.subscribe({resourceId:r,onChange:c=>e.internalState?.reloadAsyncProp(t,c),consumerId:e.id,requestId:t}):Tn(r,n,s)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:G.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:r})=>[0,-r*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},db=(()=>{class r extends ns{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Ne.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){et(this.internalState);let n=this.internalState.viewport||this.context.viewport,s=$c(e,{viewport:n,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[i,o,a]=zn(s,n.pixelProjectionMatrix);return e.length===2?[i,o]:[i,o,a]}unproject(e){return et(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,n){et(this.internalState);let s=this.internalState.viewport||this.context.viewport;return Fi(e,d({viewport:s,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem},n))}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){let e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(let n of this.getModels())n.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===G.DEFAULT||e===G.LNGLAT||e===G.CARTESIAN}onHover(e,n){return this.props.onHover&&this.props.onHover(e,n)||!1}onClick(e,n){return this.props.onClick&&this.props.onClick(e,n)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,n=[]){return n[0]=e+1&255,n[1]=e+1>>8&255,n[2]=e+1>>8>>8&255,n}decodePickingColor(e){et(e instanceof Uint8Array);let[n,s,i]=e;return n+s*256+i*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:ll(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){e=Eo(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(let n of this.props.extensions)e=Eo(e,n.getShaders.call(this,n));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let n=this.getAttributeManager(),{dataChanged:s}=e.changeFlags;if(s&&n)if(Array.isArray(s))for(let i of s)n.invalidateAll(i);else n.invalidateAll();if(n){let{props:i}=e,o=this.internalState.hasPickingBuffer,a=Number.isInteger(i.highlightedObjectIndex)||i.pickable||i.extensions.some(c=>c.getNeedsPickingBuffer.call(this,c));if(o!==a){this.internalState.hasPickingBuffer=a;let{pickingColors:c,instancePickingColors:l}=n.attributes,u=c||l;u&&(a&&u.constant&&(u.constant=!1,n.invalidate(u.id)),!u.value&&!a&&(u.constant=!0,u.value=[0,0,0]))}}}finalizeState(e){for(let s of this.getModels())s.destroy();let n=this.getAttributeManager();n&&n.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let n of this.getModels())n.draw(e.renderPass)}getPickingInfo({info:e,mode:n,sourceLayer:s}){let{index:i}=e;return i>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[i]),e}raiseError(e,n){n&&(e=new Error(`${n}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;let n=this.internalState.viewport;this.internalState.viewport=e,(!n||!fb({oldViewport:n,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let n=this.getAttributeManager();n&&(e==="all"?n.invalidateAll():n.invalidate(e))}updateAttributes(e){let n=!1;for(let s in e)e[s].layoutChanged()&&(n=!0);for(let s of this.getModels())this._setModelAttributes(s,e,n)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let n=this.props,s=this.getNumInstances(),i=this.getStartIndices();e.update({data:n.data,numInstances:s,startIndices:i,props:n,transitions:n.transitions,buffers:n.data.attributes,context:this});let o=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let n=e.update(),s=Object.create(this.props);for(let i in n)Object.defineProperty(s,i,{value:n[i]});return s}return this.props}calculateInstancePickingColors(e,{numInstances:n}){if(e.constant)return;let s=Math.floor(Kt.length/4);if(this.internalState.usesPickingColorCache=!0,s<n){n>Mp&&$.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Kt=Xt.allocate(Kt,n,{size:4,copy:!0,maxCount:Math.max(n,Mp)});let i=Math.floor(Kt.length/4),o=[0,0,0];for(let a=s;a<i;a++)this.encodePickingColor(a,o),Kt[a*4+0]=o[0],Kt[a*4+1]=o[1],Kt[a*4+2]=o[2],Kt[a*4+3]=0}e.value=Kt.subarray(0,n*4)}_setModelAttributes(e,n,s=!1){if(!Object.keys(n).length)return;if(s){let c=this.getAttributeManager();e.setBufferLayout(c.getBufferLayouts(e)),n=c.getAttributes()}let i=e.userData?.excludeAttributes||{},o={},a={};for(let c in n){if(i[c])continue;let l=n[c].getValue();for(let u in l){let h=l[u];h instanceof gt?n[c].settings.isIndexed?e.setIndexBuffer(h):o[u]=h:h&&(a[u]=h)}}e.setAttributes(o),e.setConstantAttributes(a)}disablePickingIndex(e){let n=this.props.data;if(!("attributes"in n)){this._disablePickingIndex(e);return}let{pickingColors:s,instancePickingColors:i}=this.getAttributeManager().attributes,o=s||i,a=o&&n.attributes&&n.attributes[o.id];if(a&&a.value){let c=a.value,l=this.encodePickingColor(e);for(let u=0;u<n.length;u++){let h=o.getVertexOffset(u);c[h]===l[0]&&c[h+1]===l[1]&&c[h+2]===l[2]&&this._disablePickingIndex(u)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:n,instancePickingColors:s}=this.getAttributeManager().attributes,i=n||s;if(!i)return;let o=i.getVertexOffset(e),a=i.getVertexOffset(e+1);i.buffer.write(new Uint8Array(a-o),o)}restorePickingColors(){let{pickingColors:e,instancePickingColors:n}=this.getAttributeManager().attributes,s=e||n;s&&(this.internalState.usesPickingColorCache&&s.value.buffer!==Kt.buffer&&(s.value=Kt.subarray(0,s.value.length)),s.updateSubBuffer({startOffset:0}))}_initialize(){et(!this.internalState),et(Number.isFinite(this.props.coordinateSystem)),st(ab,this);let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Ao({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>($.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new ko(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(let n of this.props.extensions)n.initializeState.call(this,this.context,n);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){st(ub,this,this===e);let{state:n,internalState:s}=e;this!==e&&(this.internalState=s,this.state=n,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(st(cb,this,e),!e)return;let n=this.props,s=this.context,i=this.internalState,o=s.viewport,a=this._updateUniformTransition();i.propsInTransition=a,s.viewport=i.viewport||o,this.props=a;try{let c=this._getUpdateParams(),l=this.getModels();if(s.device)this.updateState(c);else try{this.updateState(c)}catch{}for(let h of this.props.extensions)h.updateState.call(this,c,h);this.setNeedsRedraw(),this._updateAttributes();let u=this.getModels()[0]!==l[0];this._postUpdate(c,u)}finally{s.viewport=o,this.props=n,this._clearChangeFlags(),i.needsUpdate=!1,i.resetOldProps()}}_finalize(){st(lb,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:n=null,uniforms:s={},parameters:i={}}){this._updateAttributeTransition();let o=this.props,a=this.context;this.props=this.internalState.propsInTransition||o;try{n&&this.setShaderModuleProps(n);let{getPolygonOffset:c}=this.props,l=c&&c(s)||[0,0];a.device instanceof Po&&a.device.setParametersWebGL({polygonOffset:l});for(let u of this.getModels())u.device.type==="webgpu"?u.setParameters(d(d({},u.parameters),i)):u.setParameters(i);if(a.device instanceof Po)a.device.withParametersWebGL(i,()=>{let u={renderPass:e,shaderModuleProps:n,uniforms:s,parameters:i,context:a};for(let h of this.props.extensions)h.draw.call(this,u,h);this.draw(u)});else{let u={renderPass:e,shaderModuleProps:n,uniforms:s,parameters:i,context:a};for(let h of this.props.extensions)h.draw.call(this,u,h);this.draw(u)}}finally{this.props=o}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:n}=this.internalState;for(let i in e)if(e[i]){let o=!1;switch(i){case"dataChanged":let a=e[i],c=n[i];a&&Array.isArray(c)&&(n.dataChanged=Array.isArray(a)?c.concat(a):a,o=!0);default:n[i]||(n[i]=e[i],o=!0)}o&&st(ob,this,i,e)}let s=!!(n.dataChanged||n.updateTriggersChanged||n.propsChanged||n.extensionsChanged);n.propsOrDataChanged=s,n.somethingChanged=s||n.viewportChanged||n.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,n){let s=kp(e,n);if(s.updateTriggersChanged)for(let i in s.updateTriggersChanged)s.updateTriggersChanged[i]&&this.invalidateAttribute(i);if(s.transitionsChanged)for(let i in s.transitionsChanged)this.internalState.uniformTransitions.add(i,n[i],e[i],e.transitions?.[i]);return this.setChangeFlags(s)}validateProps(){Tp(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let n={highlightedObjectColor:e.picked?e.color:null},{highlightColor:s}=this.props;e.picked&&typeof s=="function"&&(n.highlightColor=s(e)),this.setShaderModuleProps({picking:n}),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new ts(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,n){let{props:s,oldProps:i}=e,o=this.state.model;o?.isInstanced&&o.setInstanceCount(this.getNumInstances());let{autoHighlight:a,highlightedObjectIndex:c,highlightColor:l}=s;if(n||i.autoHighlight!==a||i.highlightedObjectIndex!==c||i.highlightColor!==l){let u={};Array.isArray(l)&&(u.highlightColor=l),(n||i.autoHighlight!==a||c!==i.highlightedObjectIndex)&&(u.highlightedObjectColor=Number.isFinite(c)&&c>=0?this.encodePickingColor(c):null),this.setShaderModuleProps({picking:u})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let n=!1;n=n||this.internalState.needsRedraw&&this.id;let s=this.getAttributeManager(),i=s?s.getNeedsRedraw(e):!1;if(n=n||i,n)for(let o of this.props.extensions)o.onNeedsRedraw.call(this,o);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,n}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}return r.defaultProps=pb,r.layerName="Layer",r})(),dl=db;var mb="compositeLayer.renderLayers",gb=(()=>{class r extends dl{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:n}=e;return n&&n.__source&&n.__source.parent&&n.__source.parent.id===this.id&&(e.object=n.__source.object,e.index=n.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,n){return n&&n.length}getSubLayerClass(e,n){let{_subLayerProps:s}=this.props;return s&&s[e]&&s[e].type||n}getSubLayerRow(e,n,s){return e.__source={parent:this,object:n,index:s},e}getSubLayerAccessor(e){if(typeof e=="function"){let n={index:-1,data:this.props.data,target:[]};return(s,i)=>s&&s.__source?(n.index=s.__source.index,e(s.__source.object,n)):e(s,i)}return e}getSubLayerProps(e={}){let{opacity:n,pickable:s,visible:i,parameters:o,getPolygonOffset:a,highlightedObjectIndex:c,autoHighlight:l,highlightColor:u,coordinateSystem:h,coordinateOrigin:f,wrapLongitude:p,positionFormat:_,modelMatrix:x,extensions:y,fetch:T,operation:I,_subLayerProps:k}=this.props,S={id:"",updateTriggers:{},opacity:n,pickable:s,visible:i,parameters:o,getPolygonOffset:a,highlightedObjectIndex:c,autoHighlight:l,highlightColor:u,coordinateSystem:h,coordinateOrigin:f,wrapLongitude:p,positionFormat:_,modelMatrix:x,extensions:y,fetch:T,operation:I},P=k&&e.id&&k[e.id],L=P&&P.updateTriggers,F=e.id||"sublayer";if(P){let D=this.props[jt],R=e.type?e.type._propTypes:{};for(let O in P){let V=R[O]||D[O];V&&V.type==="accessor"&&(P[O]=this.getSubLayerAccessor(P[O]))}}Object.assign(S,e,P),S.id=`${this.props.id}-${F}`,S.updateTriggers=d(d({all:this.props.updateTriggers?.all},e.updateTriggers),L);for(let D of y){let R=D.getSubLayerProps.call(this,D);R&&Object.assign(S,R,{updateTriggers:Object.assign(S.updateTriggers,R.updateTriggers)})}return S}_updateAutoHighlight(e){for(let n of this.getSubLayers())n.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,n){let s=this.internalState.subLayers,i=!s||this.needsUpdate();if(i){let o=this.renderLayers();s=un(o,Boolean),this.internalState.subLayers=s}st(mb,this,i,s);for(let o of s)o.parent=this}}return r.layerName="CompositeLayer",r})(),_b=gb;var ml=Math.PI/180;function yb({height:r,focalDistance:t,orbitAxis:e,rotationX:n,rotationOrbit:s,zoom:i}){let o=e==="Z"?[0,0,1]:[0,1,0],a=e==="Z"?[0,-t,0]:[0,0,t],c=new Q().lookAt({eye:a,up:o});c.rotateX(n*ml),e==="Z"?c.rotateZ(s*ml):c.rotateY(s*ml);let l=Math.pow(2,i)/r;return c.scale(l),c}var xb=(()=>{class r extends Ct{constructor(e){let{height:n,projectionMatrix:s,fovy:i=50,orbitAxis:o="Z",target:a=[0,0,0],rotationX:c=0,rotationOrbit:l=0,zoom:u=0}=e,h=s?s[5]/2:xe(i);super(M(d({},e),{longitude:void 0,viewMatrix:yb({height:n||1,focalDistance:h,orbitAxis:o,rotationX:c,rotationOrbit:l,zoom:u}),fovy:i,focalDistance:h,position:a,zoom:u})),this.target=a,this.orbitAxis=o,this.rotationX=c,this.rotationOrbit=l,this.fovy=i,this.projectedCenter=this.project(this.center)}unproject(e,{topLeft:n=!0}={}){let[s,i,o=this.projectedCenter[2]]=e,a=n?i:this.height-i,[c,l,u]=zt([s,a,o],this.pixelUnprojectionMatrix);return[c,l,u]}panByPosition(e,n,s){let i=this.project(e),o=[this.width/2+i[0]-n[0],this.height/2+i[1]-n[1],this.projectedCenter[2]];return{target:this.unproject(o)}}}return r.displayName="OrbitViewport",r})(),gl=xb;var bb=new Q().lookAt({eye:[0,0,1]});function wb({width:r,height:t,near:e,far:n,padding:s}){let i=-r/2,o=r/2,a=-t/2,c=t/2;if(s){let{left:l=0,right:u=0,top:h=0,bottom:f=0}=s,p=X((l+r-u)/2,0,r)-r/2,_=X((h+t-f)/2,0,t)-t/2;i-=p,o-=p,a+=_,c+=_}return new Q().ortho({left:i,right:o,bottom:a,top:c,near:e,far:n})}var vb=(()=>{class r extends Ct{constructor(e){let{width:n,height:s,near:i=.1,far:o=1e3,zoom:a=0,target:c=[0,0,0],padding:l=null,flipY:u=!0}=e,h=e.zoomX??(Array.isArray(a)?a[0]:a),f=e.zoomY??(Array.isArray(a)?a[1]:a),p=Math.min(h,f),_=Math.pow(2,p),x;if(h!==f){let y=Math.pow(2,h),T=Math.pow(2,f);x={unitsPerMeter:[y/_,T/_,1],metersPerUnit:[_/y,_/T,1]}}super(M(d({},e),{longitude:void 0,position:c,viewMatrix:bb.clone().scale([_,_*(u?-1:1),_]),projectionMatrix:wb({width:n||1,height:s||1,padding:l,near:i,far:o}),zoom:p,distanceScales:x})),this.target=c,this.zoomX=h,this.zoomY=f,this.flipY=u}projectFlat([e,n]){let{unitsPerMeter:s}=this.distanceScales;return[e*s[0],n*s[1]]}unprojectFlat([e,n]){let{metersPerUnit:s}=this.distanceScales;return[e*s[0],n*s[1]]}panByPosition(e,n,s){let i=zt(n,this.pixelUnprojectionMatrix),o=this.projectFlat(e),a=ht.add([],o,ht.negate([],i)),c=ht.add([],this.center,a);return{target:this.unprojectFlat(c)}}}return r.displayName="OrthographicViewport",r})(),_l=vb;var Tb=(()=>{class r extends Ct{constructor(e){let{longitude:n,latitude:s,modelMatrix:i,bearing:o=0,pitch:a=0,up:c=[0,0,1]}=e,u=new me({bearing:o,pitch:a===-90?1e-4:90+a}).toVector3().normalize(),h=i?new Q(i).transformAsVector(u):u,f=Number.isFinite(s)?Dr({latitude:s}):0,p=Math.pow(2,f),_=new Q().lookAt({eye:[0,0,0],center:h,up:c}).scale(p);super(M(d({},e),{zoom:f,viewMatrix:_})),this.latitude=s,this.longitude=n,this.pitch=a,this.bearing=o,this.up=c}}return r.displayName="FirstPersonViewport",r})(),yl=Tb;var mn=20,Lp=500,xl=class r extends De{constructor(t){let{width:e,height:n,position:s=[0,0,0],bearing:i=0,pitch:o=0,longitude:a=null,latitude:c=null,maxPitch:l=90,minPitch:u=-90,startRotatePos:h,startBearing:f,startPitch:p,startZoomPosition:_,startPanPos:x,startPanPosition:y}=t;super({width:e,height:n,position:s,bearing:i,pitch:o,longitude:a,latitude:c,maxPitch:l,minPitch:u},{startRotatePos:h,startBearing:f,startPitch:p,startZoomPosition:_,startPanPos:x,startPanPosition:y}),this.makeViewport=t.makeViewport}panStart({pos:t}){let{position:e}=this.getViewportProps();return this._getUpdatedState({startPanPos:t,startPanPosition:e})}pan({pos:t}){if(!t)return this;let{startPanPos:e=[0,0],startPanPosition:n=[0,0]}=this.getState(),{width:s,height:i,bearing:o,pitch:a}=this.getViewportProps(),c=Lp*(t[0]-e[0])/s,l=Lp*(t[1]-e[1])/i,u=new me({bearing:o,pitch:a}),h=new me({bearing:o,pitch:-90}),f=u.toVector3().normalize(),p=h.toVector3().cross(f).normalize();return this._getUpdatedState({position:new rt(n).add(p.scale(c)).add(f.scale(l))})}panEnd(){return this._getUpdatedState({startPanPos:null,startPanPosition:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:n=0}){let{startRotatePos:s,startBearing:i,startPitch:o}=this.getState(),{width:a,height:c}=this.getViewportProps();if(!s||i===void 0||o===void 0)return this;let l;if(t){let u=(t[0]-s[0])/a,h=(t[1]-s[1])/c;l={bearing:i-u*180,pitch:o-h*90}}else l={bearing:i-e,pitch:o-n};return this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startRotatePos:null,startBearing:null,startPitch:null})}zoomStart(){return this._getUpdatedState({startZoomPosition:this.getViewportProps().position})}zoom({pos:t,scale:e}){let n=this.getViewportProps(),s=this.getState().startZoomPosition||n.position,i=this.makeViewport(n),{projectionMatrix:o,width:a}=i,l=2*Math.atan(1/o[0])*(t[0]/a-.5),u=this.getDirection(!0);return this._move(u.rotateZ({radians:-l}),Math.log2(e)*mn,s)}zoomEnd(){return this._getUpdatedState({startZoomPosition:null})}moveLeft(t=mn){let e=this.getDirection(!0);return this._move(e.rotateZ({radians:Math.PI/2}),t)}moveRight(t=mn){let e=this.getDirection(!0);return this._move(e.rotateZ({radians:-Math.PI/2}),t)}moveUp(t=mn){let e=this.getDirection(!0);return this._move(e,t)}moveDown(t=mn){let e=this.getDirection(!0);return this._move(e.negate(),t)}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}zoomIn(t=mn){return this._move(new rt(0,0,1),t)}zoomOut(t=mn){return this._move(new rt(0,0,-1),t)}shortestPathFrom(t){let e=t.getViewportProps(),n=d({},this.getViewportProps()),{bearing:s,longitude:i}=n;return Math.abs(s-e.bearing)>180&&(n.bearing=s<0?s+360:s-360),i!==null&&e.longitude!==null&&Math.abs(i-e.longitude)>180&&(n.longitude=i<0?i+360:i-360),n}_move(t,e,n=this.getViewportProps().position){let s=t.scale(e);return this._getUpdatedState({position:new rt(n).add(s)})}getDirection(t=!1){return new me({bearing:this.getViewportProps().bearing,pitch:t?90:90+this.getViewportProps().pitch}).toVector3().normalize()}_getUpdatedState(t){return new r(d(d(d({makeViewport:this.makeViewport},this.getViewportProps()),this.getState()),t))}applyConstraints(t){let{pitch:e,maxPitch:n,minPitch:s,longitude:i,bearing:o}=t;return t.pitch=X(e,s,n),i!==null&&(i<-180||i>180)&&(t.longitude=nn(i+180,360)-180),(o<-180||o>180)&&(t.bearing=nn(o+180,360)-180),t}},ss=class extends Rt{constructor(){super(...arguments),this.ControllerState=xl,this.transition={transitionDuration:300,transitionInterpolator:new Tt(["position","pitch","bearing"])}}};var kb=(()=>{class r extends Ot{constructor(e={}){super(e)}getViewportType(){return yl}get ControllerType(){return ss}}return r.displayName="FirstPersonView",r})(),Eb=kb;var is=class extends De{constructor(t){let{width:e,height:n,rotationX:s=0,rotationOrbit:i=0,target:o=[0,0,0],zoom:a=0,minRotationX:c=-90,maxRotationX:l=90,minZoom:u=-1/0,maxZoom:h=1/0,startPanPosition:f,startRotatePos:p,startRotationX:_,startRotationOrbit:x,startZoomPosition:y,startZoom:T}=t;super({width:e,height:n,rotationX:s,rotationOrbit:i,target:o,zoom:a,minRotationX:c,maxRotationX:l,minZoom:u,maxZoom:h},{startPanPosition:f,startRotatePos:p,startRotationX:_,startRotationOrbit:x,startZoomPosition:y,startZoom:T}),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanPosition:this._unproject(t)})}pan({pos:t,startPosition:e}){let n=this.getState().startPanPosition||e;if(!n)return this;let i=this.makeViewport(this.getViewportProps()).panByPosition(n,t);return this._getUpdatedState(i)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:n=0}){let{startRotatePos:s,startRotationX:i,startRotationOrbit:o}=this.getState(),{width:a,height:c}=this.getViewportProps();if(!s||i===void 0||o===void 0)return this;let l;if(t){let u=(t[0]-s[0])/a,h=(t[1]-s[1])/c;(i<-90||i>90)&&(u*=-1),l={rotationX:i+h*180,rotationOrbit:o+u*180}}else l={rotationX:i+n,rotationOrbit:o+e};return this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(t){let e=t.getViewportProps(),n=d({},this.getViewportProps()),{rotationOrbit:s}=n;return Math.abs(s-e.rotationOrbit)>180&&(n.rotationOrbit=s<0?s+360:s-360),n}zoomStart({pos:t}){return this._getUpdatedState({startZoomPosition:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:n}){let{startZoom:s,startZoomPosition:i}=this.getState();if(i||(s=this.getViewportProps().zoom,i=this._unproject(e)||this._unproject(t)),!i)return this;let o=this._calculateNewZoom({scale:n,startZoom:s}),a=this.makeViewport(M(d({},this.getViewportProps()),{zoom:o}));return this._getUpdatedState(d({zoom:o},a.panByPosition(i,t)))}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(t=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:t})})}zoomOut(t=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/t})})}moveLeft(t=50){return this._panFromCenter([-t,0])}moveRight(t=50){return this._panFromCenter([t,0])}moveUp(t=50){return this._panFromCenter([0,-t])}moveDown(t=50){return this._panFromCenter([0,t])}rotateLeft(t=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-t})}rotateRight(t=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+t})}rotateUp(t=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-t})}rotateDown(t=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+t})}_unproject(t){let e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_calculateNewZoom({scale:t,startZoom:e}){let{maxZoom:n,minZoom:s}=this.getViewportProps();e===void 0&&(e=this.getViewportProps().zoom);let i=e+Math.log2(t);return X(i,s,n)}_panFromCenter(t){let{width:e,height:n,target:s}=this.getViewportProps();return this.pan({startPosition:s,pos:[e/2+t[0],n/2+t[1]]})}_getUpdatedState(t){return new this.constructor(d(d(d({makeViewport:this.makeViewport},this.getViewportProps()),this.getState()),t))}applyConstraints(t){let{maxZoom:e,minZoom:n,zoom:s,maxRotationX:i,minRotationX:o,rotationOrbit:a}=t;return t.zoom=Array.isArray(s)?[X(s[0],n,e),X(s[1],n,e)]:X(s,n,e),t.rotationX=X(t.rotationX,o,i),(a<-180||a>180)&&(t.rotationOrbit=nn(a+180,360)-180),t}},os=class extends Rt{constructor(){super(...arguments),this.ControllerState=is,this.transition={transitionDuration:300,transitionInterpolator:new Tt({transitionProps:{compare:["target","zoom","rotationX","rotationOrbit"],required:["target","zoom"]}})}}};var Sb=(()=>{class r extends Ot{constructor(e={}){super(e),this.props.orbitAxis=e.orbitAxis||"Z"}getViewportType(){return gl}get ControllerType(){return os}}return r.displayName="OrbitView",r})(),Ab=Sb;var bl=class extends is{constructor(t){super(t),this.zoomAxis=t.zoomAxis||"all"}_calculateNewZoom({scale:t,startZoom:e}){let{maxZoom:n,minZoom:s}=this.getViewportProps();e===void 0&&(e=this.getViewportProps().zoom);let i=Math.log2(t);if(Array.isArray(e)){let[o,a]=e;switch(this.zoomAxis){case"X":o=X(o+i,s,n);break;case"Y":a=X(a+i,s,n);break;default:let c=Math.min(o+i,a+i);c<s&&(i+=s-c),c=Math.max(o+i,a+i),c>n&&(i+=n-c),o+=i,a+=i}return[o,a]}return X(e+i,s,n)}},as=class extends Rt{constructor(){super(...arguments),this.ControllerState=bl,this.transition={transitionDuration:300,transitionInterpolator:new Tt(["target","zoom"])},this.dragMode="pan"}_onPanRotate(){return!1}};var Ib=(()=>{class r extends Ot{constructor(e={}){super(e)}getViewportType(){return _l}get ControllerType(){return as}}return r.displayName="OrthographicView",r})(),Pb=Ib;var wl=class extends qr{constructor(t){let s=t,{startPanPos:e}=s,n=Al(s,["startPanPos"]);super(n),e!==void 0&&(this._state.startPanPos=e)}panStart({pos:t}){let{latitude:e,longitude:n,zoom:s}=this.getViewportProps();return this._getUpdatedState({startPanLngLat:[n,e],startPanPos:t,startZoom:s})}pan({pos:t,startPos:e}){let n=this.getState(),s=n.startPanLngLat||this._unproject(e);if(!s)return this;let i=n.startZoom??this.getViewportProps().zoom,o=n.startPanPos||e,a=[s[0],s[1],i],l=this.makeViewport(this.getViewportProps()).panByPosition(a,t,o);return this._getUpdatedState(l)}panEnd(){return this._getUpdatedState({startPanLngLat:null,startPanPos:null,startZoom:null})}zoom({scale:t}){let n=(this.getState().startZoom||this.getViewportProps().zoom)+Math.log2(t);return this._getUpdatedState({zoom:n})}applyConstraints(t){let{longitude:e,latitude:n,maxZoom:s,minZoom:i,zoom:o}=t,a=fn(0),c=fn(n)-a;return t.zoom=X(o,i+c,s+c),(e<-180||e>180)&&(t.longitude=nn(e+180,360)-180),t.latitude=X(n,-St,St),t}},cs=class extends Rt{constructor(){super(...arguments),this.ControllerState=wl,this.transition={transitionDuration:300,transitionInterpolator:new Tt(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(t){super.setProps(t),this.dragRotate=!1,this.touchRotate=!1}};var Mb=(()=>{class r extends Ot{constructor(e={}){super(e)}getViewportType(e){return e.zoom>12?rn:Hr}get ControllerType(){return cs}}return r.displayName="GlobeView",r})(),Lb=Mb;var Cb=(()=>{class r{static get componentName(){return Object.prototype.hasOwnProperty.call(this,"extensionName")?this.extensionName:""}constructor(e){e&&(this.opts=e)}equals(e){return this===e?!0:this.constructor===e.constructor&&at(this.opts,e.opts,1)}getShaders(e){return null}getSubLayerProps(e){let{defaultProps:n}=e.constructor,s={updateTriggers:{}};for(let i in n)if(i in this.props){let o=n[i],a=this.props[i];s[i]=a,o&&o.type==="accessor"&&(s.updateTriggers[i]=this.props.updateTriggers[i],typeof a=="function"&&(s[i]=this.getSubLayerAccessor(a)))}return s}initializeState(e,n){}updateState(e,n){}onNeedsRedraw(e){}getNeedsPickingBuffer(e){return!1}draw(e,n){}finalizeState(e,n){}}return r.defaultProps={},r.extensionName="LayerExtension",r})(),Ob=Cb;var vl={bearing:0,pitch:0,position:[0,0,0]},Rb={speed:1.2,curve:1.414},Tl=class extends hn{constructor(t={}){super({compare:["longitude","latitude","zoom","bearing","pitch","position"],extract:["width","height","longitude","latitude","zoom","bearing","pitch","position"],required:["width","height","latitude","longitude","zoom"]}),this.opts=d(d({},Rb),t)}interpolateProps(t,e,n){let s=Vc(t,e,n,this.opts);for(let i in vl)s[i]=de(t[i]||vl[i],e[i]||vl[i],n);return s}getDuration(t,e){let{transitionDuration:n}=e;return n==="auto"&&(n=Uc(t,e,this.opts)),n}};var kl=class{constructor(t){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;let{attributes:e={}}=t;this.typedArrayManager=Xt,this.attributes={},this._attributeDefs=e,this.opts=t,this.updateGeometry(t)}updateGeometry(t){Object.assign(this.opts,t);let{data:e,buffers:n={},getGeometry:s,geometryBuffer:i,positionFormat:o,dataChanged:a,normalize:c=!0}=this.opts;if(this.data=e,this.getGeometry=s,this.positionSize=i&&i.size||(o==="XY"?2:3),this.buffers=n,this.normalize=c,i&&(et(e.startIndices),this.getGeometry=this.getGeometryFromBuffer(i),c||(n.vertexPositions=i)),this.geometryBuffer=n.vertexPositions,Array.isArray(a))for(let l of a)this._rebuildGeometry(l);else this._rebuildGeometry()}updatePartialGeometry({startRow:t,endRow:e}){this._rebuildGeometry({startRow:t,endRow:e})}getGeometryFromBuffer(t){let e=t.value||t;return ArrayBuffer.isView(e)?ho(e,{size:this.positionSize,offset:t.offset,stride:t.stride,startIndices:this.data.startIndices}):null}_allocate(t,e){let{attributes:n,buffers:s,_attributeDefs:i,typedArrayManager:o}=this;for(let a in i)if(a in s)o.release(n[a]),n[a]=null;else{let c=i[a];c.copy=e,n[a]=o.allocate(n[a],t,c)}}_forEachGeometry(t,e,n){let{data:s,getGeometry:i}=this,{iterable:o,objectInfo:a}=Jr(s,e,n);for(let c of o){a.index++;let l=i?i(c,a):null;t(l,a.index)}}_rebuildGeometry(t){if(!this.data)return;let{indexStarts:e,vertexStarts:n,instanceCount:s}=this,{data:i,geometryBuffer:o}=this,{startRow:a=0,endRow:c=1/0}=t||{},l={};if(t||(e=[0],n=[0]),this.normalize||!o)this._forEachGeometry((h,f)=>{let p=h&&this.normalizeGeometry(h);l[f]=p,n[f+1]=n[f]+(p?this.getGeometrySize(p):0)},a,c),s=n[n.length-1];else if(n=i.startIndices,s=n[i.length]||0,ArrayBuffer.isView(o))s=s||o.length/this.positionSize;else if(o instanceof gt){let h=this.positionSize*4;s=s||o.byteLength/h}else if(o.buffer){let h=o.stride||this.positionSize*4;s=s||o.buffer.byteLength/h}else if(o.value){let h=o.value,f=o.stride/h.BYTES_PER_ELEMENT||this.positionSize;s=s||h.length/f}this._allocate(s,!!t),this.indexStarts=e,this.vertexStarts=n,this.instanceCount=s;let u={};this._forEachGeometry((h,f)=>{let p=l[f]||h;u.vertexStart=n[f],u.indexStart=e[f];let _=f<n.length-1?n[f+1]:s;u.geometrySize=_-n[f],u.geometryIndex=f,this.updateGeometryAttributes(p,u)},a,c),this.vertexCount=e[e.length-1]}};export{Tn as a,$ as b,ua as c,Q as d,mi as e,gi as f,Gh as g,G as h,tn as i,Gy as j,Gt as k,en as l,_f as m,Yt as n,Fr as o,Ur as p,If as q,Bc as r,Br as s,Oe as t,be as u,$n as v,Nf as w,Ct as x,rn as y,jr as z,Wc as A,Gc as B,ie as C,Re as D,Xc as E,cn as F,Zc as G,Kc as H,ln as I,un as J,Jc as K,Gr as L,at as M,Ot as N,Zi as O,et as P,hn as Q,Hr as R,Tt as S,Rt as T,Yr as U,tl as V,Xr as W,ao as X,sl as Y,co as Z,g1 as _,Jr as $,dn as aa,ts as ba,cl as ca,ll as da,Eo as ea,ns as fa,rs as ga,dl as ha,_b as ia,gl as ja,_l as ka,yl as la,ss as ma,Eb as na,os as oa,Ab as pa,as as qa,Pb as ra,cs as sa,Lb as ta,Ob as ua,Tl as va,kl as wa};
