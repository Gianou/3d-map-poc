import{J as h,P as y,V as B,_ as b,b as A,n as Z,o as N,ta as X}from"./chunk-N6UF5KRC.js";import"./chunk-OQ43XKI2.js";import{a as p,b as u,c as j}from"./chunk-ATDPNAVO.js";var w="mapbox",P=512,ee=Math.PI/180;function v({map:t,gl:e,deck:r}){if(t.__deck)return t.__deck;let n=r?.props._customRender,s=r?.props.onLoad,o=u(p({},r?.props),{_customRender:()=>{t.triggerRepaint(),n?.("")}});o.parameters=p(p({},I(t,!0)),o.parameters),o.views||(o.views=g(t));let i;return(!r||r.props.gl===e)&&(Object.assign(o,{gl:e,width:null,height:null,touchAction:"unset",viewState:m(t)}),r?.isInitialized?T(r,t):o.onLoad=()=>{s?.(),T(i,t)}),r?(i=r,r.setProps(o),r.userData.isExternal=!0):(i=new b(o),t.on("remove",()=>{C(t)})),i.userData.mapboxLayers=new Set,t.__deck=i,t.on("render",()=>{i.isInitialized&&re(i,t)}),i}function T(t,e){let r=()=>{t.isInitialized?oe(t,e):e.off("move",r)};e.on("move",r)}function C(t){t.__deck?.finalize(),t.__deck=null}function I(t,e){let r=e?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return L(t)==="globe"&&(r.cullMode="back"),r}function Y(t,e){t.userData.mapboxLayers.add(e),S(t)}function W(t,e){t.userData.mapboxLayers.delete(e),S(t)}function U(t,e){S(t)}function q(t,e,r,n){let{currentViewport:s}=t.userData,o=!1;s||(s=O(t,e,n),t.userData.currentViewport=s,o=!0),t.isInitialized&&t._drawLayers("mapbox-repaint",{viewports:[s],layerFilter:i=>(!t.props.layerFilter||t.props.layerFilter(i))&&(r.id===i.layer.id||i.layer.props.operation.includes("terrain")),clearStack:o,clearCanvas:!1})}function $(t,e,r,n){let{currentViewport:s}=t.userData,o=!1;s||(s=O(t,e,n),t.userData.currentViewport=s,o=!0),t.isInitialized&&t._drawLayers("mapbox-repaint",{viewports:[s],layerFilter:i=>{if(t.props.layerFilter&&!t.props.layerFilter(i))return!1;let a=i.layer;return a.props.beforeId===r.beforeId&&a.props.slot===r.slot},clearStack:o,clearCanvas:!1})}function L(t){let e=t.getProjection?.(),r=e?.type||e?.name;if(r==="globe")return"globe";if(r&&r!=="mercator")throw new Error("Unsupported projection");return"mercator"}function g(t){return L(t)==="globe"?new X({id:w}):new B({id:w})}function m(t){let{lng:e,lat:r}=t.getCenter(),n={longitude:(e+540)%360-180,latitude:r,zoom:t.getZoom(),bearing:t.getBearing(),pitch:t.getPitch(),padding:t.getPadding(),repeat:t.getRenderWorldCopies()};return t.getTerrain?.()&&te(t,n),n}function te(t,e){if(t.getFreeCameraOptions){let{position:r}=t.getFreeCameraOptions();if(!r||r.z===void 0)return;let n=t.transform.height,{longitude:s,latitude:o,pitch:i}=e,a=r.x*P,l=(1-r.y)*P,d=r.z*P,c=Z([s,o]),f=a-c[0],_=l-c[1],x=Math.sqrt(f*f+_*_),E=i*ee,M=1.5*n,R=E<.001?M*Math.cos(E)/d:M*Math.sin(E)/x;e.zoom=Math.log2(R);let K=M*Math.cos(E)/R,Q=d-K;e.position=[0,0,Q/N(o)]}else typeof t.transform.elevation=="number"&&(e.position=[0,0,t.transform.elevation])}function O(t,e,r){let n=m(e),{views:s}=t.props,o=s&&h(s).find(l=>l.id===w)||g(e);r&&(o.props.nearZMultiplier=.2);let i=r?.nearZ??e.transform._nearZ,a=r?.farZ??e.transform._farZ;return Number.isFinite(i)&&(n.nearZ=i/e.transform.height,n.farZ=a/e.transform.height),o.makeViewport({width:t.width,height:t.height,viewState:n})}function re(t,e){let{mapboxLayers:r,isExternal:n}=t.userData;if(n){let s=Array.from(r,c=>c.id),i=h(t.props.layers,Boolean).some(c=>c&&!s.includes(c.id)),a=t.getViewports(),l=a.findIndex(c=>c.id===w),d=a.length>1||l<0;(i||d)&&(l>=0&&(a=a.slice(),a[l]=O(t,e)),t._drawLayers("mapbox-repaint",{viewports:a,layerFilter:c=>(!t.props.layerFilter||t.props.layerFilter(c))&&(c.viewport.id!==w||!s.includes(c.layer.id)),clearCanvas:!1}))}t.userData.currentViewport=null}function oe(t,e){t.setProps({viewState:m(e)}),t.needsRedraw({clearRedrawFlags:!0})}function S(t){if(t.userData.isExternal)return;let e=[];t.userData.mapboxLayers.forEach(r=>{let n=r.props.type,s=new n(r.props);e.push(s)}),t.setProps({layers:e})}var D=class{constructor(e){if(!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.map=null,this.deck=null,this.props=e}onAdd(e,r){this.map=e,this.deck=v({map:e,gl:r,deck:this.props.deck}),Y(this.deck,this)}onRemove(){this.deck&&W(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&U(this.deck,this)}render(e,r){q(this.deck,this.map,this,r)}};var F="__UNDEFINED__";function H(t,e,r,n){if(!t||!e||!t.style||!t.style._loaded)return;let s=h(n,Boolean);if(r!==n){let a=h(r,Boolean),l=new Set(a.map(d=>d.id));for(let d of s)l.delete(d.id);for(let d of l)t.getLayer(d)&&t.removeLayer(d)}for(let a of s){let l=t.getLayer(a.id);l?(l.implementation||l).setProps(a.props):t.addLayer(new D({id:a.id,deck:e,slot:a.props.slot}),a.props.beforeId)}let o=t.style._order,i={};for(let a of s){let{beforeId:l}=a.props;(!l||!o.includes(l))&&(l=F),i[l]=i[l]||[],i[l].push(a.id)}for(let a in i){let l=i[a],d=a===F?o.length:o.indexOf(a),c=a===F?void 0:a;for(let f=l.length-1;f>=0;f--){let _=l[f],x=o.indexOf(_);x!==d-1&&(t.moveLayer(_,c),x>d&&d++),d--,c=_}}}var k=class{constructor(e){y(e.id,"id is required"),this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.beforeId=e.beforeId,this.map=null,this.deck=null}onAdd(e,r){this.map=e,this.deck=v({map:e,gl:r})}render(e,r){!this.deck||!this.map||$(this.deck,this.map,this,r)}};var G="__UNDEFINED__";function V(t){return t.props.beforeId?`deck-layer-group-before:${t.props.beforeId}`:t.props.slot?`deck-layer-group-slot:${t.props.slot}`:"deck-layer-group-last"}function J(t,e,r){if(!t||!t.style||!t.style._loaded)return;let n=h(r,Boolean);if(e!==r){let i=h(e,Boolean),a=new Set(i.map(d=>V(d))),l=new Set(n.map(d=>V(d)));for(let d of a)l.has(d)||t.getLayer(d)&&t.removeLayer(d)}let s={};for(let i of n){let a=V(i),l=t.getLayer(a);if(l){let d=l.implementation||l;s[a]=d}else{let d=new k({id:a,slot:i.props.slot,beforeId:i.props.beforeId});s[a]=d,t.addLayer(d,i.props.beforeId)}}let o=t.style._order;for(let[i,a]of Object.entries(s)){let l=a.beforeId||G,d=l===G?o.length:o.indexOf(l);if(o.indexOf(i)!==d-1){let f=l===G?void 0:l;t.moveLayer(i,f)}}}var z=class{constructor(e){this._handleStyleChange=()=>{if(this._resolveLayers(this._map,this._deck,this._props.layers,this._props.layers),!this._map)return;L(this._map)&&!this._props.views&&this._deck?.setProps({views:g(this._map)})},this._updateContainerSize=()=>{if(this._map&&this._container){let{clientWidth:n,clientHeight:s}=this._map.getContainer();Object.assign(this._container.style,{width:`${n}px`,height:`${s}px`})}},this._updateViewState=()=>{let n=this._deck,s=this._map;n&&s&&(n.setProps({views:this._props.views||g(s),viewState:m(s)}),n.isInitialized&&n.redraw())},this._handleMouseEvent=n=>{let s=this._deck;if(!s||!s.isInitialized)return;let o={type:n.type,offsetCenter:n.point,srcEvent:n},i=this._lastMouseDownPoint;switch(!n.point&&i&&(o.deltaX=n.originalEvent.clientX-i.clientX,o.deltaY=n.originalEvent.clientY-i.clientY,o.offsetCenter={x:i.x+o.deltaX,y:i.y+o.deltaY}),o.type){case"mousedown":s._onPointerDown(o),this._lastMouseDownPoint=u(p({},n.point),{clientX:n.originalEvent.clientX,clientY:n.originalEvent.clientY});break;case"dragstart":o.type="panstart",s._onEvent(o);break;case"drag":o.type="panmove",s._onEvent(o);break;case"dragend":o.type="panend",s._onEvent(o);break;case"click":o.tapCount=1,s._onEvent(o);break;case"dblclick":o.type="click",o.tapCount=2,s._onEvent(o);break;case"mousemove":o.type="pointermove",s._onPointerMove(o);break;case"mouseout":o.type="pointerleave",s._onPointerMove(o);break;default:return}};let{interleaved:r=!1}=e;this._interleaved=r,this._renderLayersInGroups=e._renderLayersInGroups||!1,this._props=this.filterProps(e)}filterProps(e){let o=e,{interleaved:r=!1,useDevicePixels:n}=o,s=j(o,["interleaved","useDevicePixels"]);return!r&&n!==void 0&&(s.useDevicePixels=n),s}setProps(e){this._interleaved&&e.layers&&this._resolveLayers(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,this.filterProps(e)),this._deck&&this._map&&this._deck.setProps(u(p({},this._props),{parameters:p(p({},I(this._map,this._interleaved)),this._props.parameters)}))}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){let r=document.createElement("div");return Object.assign(r.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=r,this._deck=new b(u(p({},this._props),{parent:r,parameters:p(p({},I(e,!1)),this._props.parameters),views:this._props.views||g(e),viewState:m(e)})),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousedown",this._handleMouseEvent),e.on("dragstart",this._handleMouseEvent),e.on("drag",this._handleMouseEvent),e.on("dragend",this._handleMouseEvent),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),r}_onAddInterleaved(e){let r=e.painter.context.gl;return r instanceof WebGLRenderingContext&&A.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=v({map:e,gl:r,deck:new b(u(p({},this._props),{gl:r,parameters:p(p({},I(e,!0)),this._props.parameters)}))}),e.on("styledata",this._handleStyleChange),this._resolveLayers(e,this._deck,[],this._props.layers),document.createElement("div")}_resolveLayers(e,r,n,s){this._renderLayersInGroups?J(e,n,s):H(e,r,n,s)}onRemove(){let e=this._map;e&&(this._interleaved?this._onRemoveInterleaved(e):this._onRemoveOverlaid(e)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousedown",this._handleMouseEvent),e.off("dragstart",this._handleMouseEvent),e.off("drag",this._handleMouseEvent),e.off("dragend",this._handleMouseEvent),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent),this._deck?.finalize()}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),this._resolveLayers(e,this._deck,this._props.layers,[]),C(e)}getDefaultPosition(){return"top-left"}pickObject(e){return y(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return y(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return y(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}};export{z as MapboxOverlay};
